var MPK=MPK||{};MPK.MPKHeader=function(n){var t=new Uint32Array(n,0,7);this.blockId=t[0];this.startId=t[1];this.vtFormat=t[2];this.meshCount=t[3];this.meshOffset=t[4];this.bufferSize=t[5];this.bufferOffset=t[6];t=null};MPK.MeshData=function(n,t){var r=new Uint32Array(n,t,4),i;this.mesh_id=r[0];this.ptCount=r[1];this.idxCount=r[2];this.dataOffset=r[3];i=new Float32Array(n,t+16,4);this.baseScale=i[0];this.baseVector=new Float32Array(3);this.baseVector[0]=i[1];this.baseVector[1]=i[2];this.baseVector[2]=i[3];r=null;i=null};MPK.MPKReader=function(n){this.header=new MPK.MPKHeader(n);this.meshSize=32;this.maxSize=256;this.meshBuffer=n.slice(this.header.meshOffset,this.header.meshOffset+this.header.meshCount*this.meshSize);this.geomBuffer=n.slice(this.header.bufferOffset,this.header.bufferOffset+this.header.bufferSize);this.mesh_cur_id=-1;this.pt_pos=new Float32Array(3);var t=new ArrayBuffer(this.maxSize);this.mesh_cur=new MPK.MeshData(t,0);this.mesh_cur.baseVector=this.pt_pos};MPK.MPKReader.prototype={constructor:MPK.MPKReader,getMeshData:function(n){var t=n-this.header.startId;if(t>=0&&t<this.header.meshCount)return new MPK.MeshData(this.meshBuffer,t*this.meshSize)},getMeshInfo:function(n){var t,i,r;return n==this.mesh_cur_id?this.mesh_cur:(t=n-this.header.startId,t>=0&&t<this.header.meshCount?(i=new Uint32Array(this.meshBuffer,t*this.meshSize,4),this.mesh_cur.mesh_id=i[0],this.mesh_cur.ptCount=i[1],this.mesh_cur.idxCount=i[2],this.mesh_cur.dataOffset=i[3],r=new Float32Array(this.meshBuffer,t*this.meshSize+16,4),this.mesh_cur.baseScale=r[0],this.mesh_cur.baseVector[0]=r[1],this.mesh_cur.baseVector[1]=r[2],this.mesh_cur.baseVector[2]=r[3],this.mesh_cur_id=n,this.mesh_cur):void 0)},getPtBuffer:function(n){var i=n-this.header.startId,t;if(i>=0&&i<this.header.meshCount)return(t=this.getMeshInfo(n),t===undefined)?undefined:t.baseScale==0?new Float32Array(this.geomBuffer,t.dataOffset,t.ptCount*3):new Uint16Array(this.geomBuffer,t.dataOffset,t.ptCount*3)},getIdxBuffer:function(n){var r=n-this.header.startId,t,i;if(r>=0&&r<this.header.meshCount)return(t=this.getMeshInfo(n),t===undefined)?undefined:(i=t.dataOffset,t.baseScale==0?i+=t.ptCount*12:(i+=t.ptCount*6,t.ptCount%2==1&&(i+=2)),t.ptCount>65535?new Uint32Array(this.geomBuffer,i,t.idxCount):new Uint16Array(this.geomBuffer,i,t.idxCount))},getNormalBuffer:function(n){var r=n-this.header.startId,t,i;if((this.header.vtFormat&2)==2&&r>=0&&r<this.header.meshCount)return(t=this.getMeshInfo(n),t===undefined)?undefined:(i=t.dataOffset,t.baseScale==0?i+=t.ptCount*12:(i+=t.ptCount*6,t.ptCount%2==1&&(i+=2)),t.ptCount>65535?i+=t.idxCount*4:(i+=t.idxCount*2,t.idxCount%2==1&&(i+=2)),new Float32Array(this.geomBuffer,i,t.ptCount*3))}};self.onmessage=function(n){for(var o=n.data.msg,i=new MPK.MPKReader(o),t=i.header.startId,s=t+i.header.meshCount,r={};t<s;++t){var u=i.getPtBuffer(t),f=i.getIdxBuffer(t),e=i.getNormalBuffer(t),h=i.getMeshData(t);u!=undefined&&f!=undefined&&e!=undefined&&(r[t]={P:u,I:f,N:e,M:h})}i=null;self.postMessage(r);self.close()};