function intersectObject(n,t,i,r,u){var o,f,e,s;if(n.visible&&(!(n instanceof CLOUD.Group)||!n.fileId||!u.hasFileFilter(n.fileId))&&(o=n.raycast(t,i),r===!0&&n.children)){if(f=n.children,f.length>0&&!o)return;for(e=0,s=f.length;e<s;e++)intersectObject(f[e],t,i,!0,u)}}var CLOUD=CLOUD||{},CloudTouch,MPK;CLOUD.Version="20170222";CLOUD.GlobalData={SceneSize:1e3,TextureResRoot:"images/",SelectionColor:{color:15293,side:THREE.DoubleSide},DisableAntialias:!1,EnableDemolishByDClick:!0,UseMpkWorker:!0,MpkWorkerUrl:"../libs/mpkWorker.min.js",IncrementRender:!0,LimitFrameTime:250,maxObjectNumInPool:6e4,maxDrawCacheNum:4e4,OctantDepth:8,MaximumDepth:0,TargetDistance:1e4,ConcurrencyRequestCount:8,ShowOctant:!1,DisableOctant:!1,DEBUG:!1};CLOUD.EnumStandardView={ISO:0,Top:1,Bottom:2,Front:3,Back:4,Right:5,Left:6,SouthEast:7,SouthWest:8,NorthEast:9,NorthWest:10,BottomFront:11,BottomBack:12,BottomRight:13,BottomLeft:14,BottomSouthEast:15,BottomSouthWest:16,BottomNorthEast:17,BottomNorthWest:18,RoofFront:19,RoofBack:20,RoofRight:21,RoofLeft:22,RoofSouthEast:23,RoofSouthWest:24,RoofNorthEast:25,RoofNorthWest:26,TopTurnRight:27,TopTurnBack:28,TopTurnLeft:29,BottomTurnRight:30,BottomTurnBack:31,BottomTurnLeft:32,FrontTurnRight:33,FrontTurnTop:34,FrontTurnLeft:35,RightTurnBack:36,RightTurnTop:37,RightTurnFront:38,BackTurnRight:39,BackTurnTop:40,BackTurnLeft:41,LeftTurnFront:42,LeftTurnTop:43,LeftTurnBack:44};CLOUD.EnumObjectLevel={Default:0,Tiny:1,Small:2,Medium:5,Large:6};CLOUD.ObjectLevelLoD={0:.1,1:.2,2:1,3:4,4:5,5:5,6:6};CLOUD.SCENETYPE={Default:0,Aux:1,Child:2,Link:3};CLOUD.OPSELECTIONTYPE={Clear:0,Add:1,Remove:2};CLOUD.MPKSTATUS={UNKONW:0,LOADING:1,LOADED:2};CLOUD.EVENTS={ON_LOAD_START:0,ON_LOAD_PROGRESS:1,ON_LOAD_COMPLETE:2,ON_LOAD_EMPTYSCENE:3,ON_LOAD_SUBSCENE:10,ON_SELECTION_CHANGED:100,ON_UPDATE_SELECTION_UI:101};CLOUD.PrimitiveCount={vertexCount:0,triangleCount:0};CLOUD.Utils={box3FromArray:function(n,t){if(n instanceof Array){var i=t||new THREE.Box3;return i.min.fromArray(n,0),i.max.fromArray(n,3),i}return null},computeBBox:function(n){for(var i=new THREE.Box3,r=new THREE.Vector3,t=0,u=n.length;t<u;++t)r.fromArray(n[t],0),i.expandByPoint(r);return i},mergeBBox:function(n){var t,e;if(n.length<1)return null;var i=new THREE.Box3,r=new THREE.Vector3,u=new THREE.Vector3,f=new THREE.Box3;for(t=0,e=n.length;t<e;t++)r.set(n[t].max.x,n[t].max.y,n[t].max.z),u.set(n[t].min.x,n[t].min.y,n[t].min.z),f.set(u,r),i.union(f);return i},parseTransform:function(n,t,i){var r=!1,u;t.rotation&&(n.rotation.fromArray(t.rotation),r=!0);t.position&&(n.position.fromArray(t.position),r=!0);t.scale&&(n.scale.fromArray(t.scale),r=!0);t.quaternion&&(n.quaternion.fromArray(t.quaternion),r=!0);r&&n.updateMatrix();t.matrix&&n.matrix.fromArray(t.matrix);i&&(u=n.matrix.clone(),u.multiplyMatrices(i,n.matrix),n.matrix=u);n.matrixAutoUpdate=!1;n.boundingBox!==undefined&&(n.boundingBox=CLOUD.Utils.box3FromArray(t.bbox))},isMobileDevice:function(){var n=navigator.platform;return n.indexOf("Win")!==0&&uA.indexOf("Mac")!==0?!0:!1}};CLOUD.DomUtil={splitStr:function(n){return n.trim().split(/\s+/g)},getContainerOffsetToClient:function(n){var t,r=function(n){for(var t=0,i=0;n;)t+=n.offsetTop,i+=n.offsetLeft,n=n.offsetParent;var r=document.body,u=document.documentElement,f=window.pageYOffset||u.scrollTop||r.scrollTop,e=window.pageXOffset||u.scrollLeft||r.scrollLeft;return t-=f,i-=e,{top:t,left:i}},u=function(n){var t=n.getBoundingClientRect(),i=document.body,r=document.documentElement,u=r.clientTop||i.clientTop,f=r.clientLeft||i.clientLeft,e=t.top-u,o=t.left-f;return{top:Math.round(e),left:Math.round(o)}},f=function(n){return n.getBoundingClientRect?u(n):r(n)},i;return n!=document?(i=f(n),t={width:n.offsetWidth,height:n.offsetHeight,left:i.left,top:i.top}):t={width:window.innerWidth,height:window.innerHeight,left:0,top:0},t},setClassName:function(n,t){var i=document.getElementById(n);i&&(i.className=t)},addClassName:function(n,t){var r,i,u,f,e,o=document.getElementById(n);if(o&&(i=o,t&&typeof t=="string"&&(r=t.split(/\s+/),i.nodeType===1)))if(i.className||r.length!==1){for(u=" "+i.className+" ",f=0,e=r.length;f<e;++f)u.indexOf(" "+r[f]+" ")<0&&(u+=r[0]+" ");i.className=String.trim(u)}else i.className=t},removeClassName:function(n,t){var f,i,r,u,e,o=document.getElementById(n);if(o&&(r=o,t&&typeof t=="string"&&(f=(t||"").split(/\s+/),r.nodeType===1&&r.className))){for(i=(" "+r.className+" ").replace(O," "),u=0,e=f.length;u<e;u++)while(i.indexOf(" "+f[u]+" ")>=0)i=i.replace(" "+f[u]+" "," ");r.className=t?String.trim(i):""}},showOrHideElement:function(n,t){var i=document.getElementById(n);i&&(i.style.display=t?"":"none")},getStyleString:function(n){var t=[],i,r;for(i in n)r=n[i],t.push(i),t.push(":"),t.push(r),t.push("; ");return t.join("")},cloneStyle:function(n){var t={};for(var i in n)t[i]=n[i];return t},removeStyleAttribute:function(n,t){Array.isArray(t)||(t=[t]);t.forEach(function(t){t in n&&delete n[t]})},trimRight:function(n){var i,t;if(n.length===0)return"";for(i=n.length-1,t=i;t>=0;--t)if(n.charAt(t)!==" "){i=t;break}return n.substr(0,i+1)},trimLeft:function(n){var i,t;if(n.length===0)return"";for(i=0,t=0;t<n.length;++t)if(n.charAt(t)!==" "){i=t;break}return n.substr(i)},matchesSelector:function(n,t){if(n.matches)return n.matches(t);if(n.matchesSelector)return n.matchesSelector(t);if(n.webkitMatchesSelector)return n.webkitMatchesSelector(t);if(n.msMatchesSelector)return n.msMatchesSelector(t);if(n.mozMatchesSelector)return n.mozMatchesSelector(t);if(n.oMatchesSelector)return n.oMatchesSelector(t);if(n.querySelectorAll){for(var r=(n.document||n.ownerDocument).querySelectorAll(t),i=0;r[i]&&r[i]!==element;)i++;return r[i]?!0:!1}return!1},toTranslate3d:function(n,t){return"translate3d("+n+"px,"+t+"px,0)"},setCursorStyle:function(n,t){var i;switch(t){case"n":case"s":i="ns-resize";break;case"w":case"e":i="ew-resize";break;case"ne":case"sw":i="nesw-resize";break;case"nw":case"se":i="nwse-resize"}n.style.cursor=i}};THREE.CylinderBufferGeometry=function(n,t,i,r,u,f,e,o){function d(){var n=(r+1)*(u+1);return f===!1&&(n+=(r+1)*2+r*2),n}function g(){var n=r*u*6;return f===!1&&(n+=r*6),n}function nt(){for(var p,b=new THREE.Vector3,k=new THREE.Vector3,ut=(t-n)/i,d,f=0;f<=u;f++){var nt=[],g=f/u,tt=g*(t-n)+n;for(p=0;p<=r;p++)d=p/r,k.x=tt*Math.sin(d*o+e),k.y=-g*i+w,k.z=tt*Math.cos(d*o+e),a.setXYZ(h,k.x,k.y,k.z),b.copy(k),(n===0&&f===0||t===0&&f===u)&&(b.x=Math.sin(d*o+e),b.z=Math.cos(d*o+e)),b.setY(Math.sqrt(b.x*b.x+b.z*b.z)*ut).normalize(),v.setXYZ(h,b.x,b.y,b.z),y.setXY(h,d,1-g),nt.push(h),h++;l.push(nt)}for(p=0;p<r;p++)for(f=0;f<u;f++){var ft=l[f][p],it=l[f+1][p],et=l[f+1][p+1],rt=l[f][p+1];c.setX(s,ft);s++;c.setX(s,it);s++;c.setX(s,rt);s++;c.setX(s,it);s++;c.setX(s,et);s++;c.setX(s,rt);s++}}function k(i){for(var nt,f=new THREE.Vector2,l=new THREE.Vector3,tt=i===!0?n:t,b=i===!0?1:-1,k,d,p,g=h,u=1;u<=r;u++)a.setXYZ(h,0,w*b,0),v.setXYZ(h,0,b,0),i===!0?(f.x=u/r,f.y=0):(f.x=(u-1)/r,f.y=1),y.setXY(h,f.x,f.y),h++;for(nt=h,u=0;u<=r;u++)k=u/r,l.x=tt*Math.sin(k*o+e),l.y=w*b,l.z=tt*Math.cos(k*o+e),a.setXYZ(h,l.x,l.y,l.z),v.setXYZ(h,0,b,0),y.setXY(h,k,i===!0?1:0),h++;for(u=0;u<r;u++)d=g+u,p=nt+u,i===!0?(c.setX(s,p),s++,c.setX(s,p+1),s++,c.setX(s,d),s++):(c.setX(s,p+1),s++,c.setX(s,p),s++,c.setX(s,d),s++)}THREE.BufferGeometry.call(this);this.type="CylinderBufferGeometry";this.parameters={radiusTop:n,radiusBottom:t,height:i,radialSegments:r,heightSegments:u,openEnded:f,thetaStart:e,thetaLength:o};n=n!==undefined?n:20;t=t!==undefined?t:20;i=i!==undefined?i:100;r=Math.floor(r)||8;u=Math.floor(u)||1;f=f!==undefined?f:!1;e=e!==undefined?e:0;o=o!==undefined?o:2*Math.PI;var p=d(),b=g(),c=new THREE.BufferAttribute(new(b>65535?Uint32Array:Uint16Array)(b),1),a=new THREE.BufferAttribute(new Float32Array(p*3),3),v=new THREE.BufferAttribute(new Float32Array(p*3),3),y=new THREE.BufferAttribute(new Float32Array(p*2),2),h=0,s=0,l=[],w=i/2;nt();f===!1&&(n>0&&k(!0),t>0&&k(!1));this.setIndex(c);this.addAttribute("position",a);this.addAttribute("normal",v);this.addAttribute("uv",y)};THREE.CylinderBufferGeometry.prototype=Object.create(THREE.BufferGeometry.prototype);THREE.CylinderBufferGeometry.prototype.constructor=THREE.CylinderBufferGeometry;THREE.BoxBufferGeometry=function(n,t,i,r,u,f){function d(n,t,i){var r=0;return r+=n*t*2,r+=n*i*2,r+=i*t*2,r*4}function h(n,t,i,r,u,f,h,l,b,d,g){for(var et,tt,ot,ct=f/b,lt=h/d,at=f/2,vt=h/2,yt=l/2,rt=b+1,pt=d+1,ft=0,ut=0,nt=new THREE.Vector3,it=0;it<pt;it++)for(et=it*lt-vt,tt=0;tt<rt;tt++)ot=tt*ct-at,nt[n]=ot*r,nt[t]=et*u,nt[i]=yt,a[o]=nt.x,a[o+1]=nt.y,a[o+2]=nt.z,nt[n]=0,nt[t]=0,nt[i]=l>0?1:-1,v[o]=nt.x,v[o+1]=nt.y,v[o+2]=nt.z,y[p]=tt/b,y[p+1]=1-it/d,o+=3,p+=2,ft+=1;for(it=0;it<d;it++)for(tt=0;tt<b;tt++){var wt=c+tt+rt*it,st=c+tt+rt*(it+1),bt=c+(tt+1)+rt*(it+1),ht=c+(tt+1)+rt*it;e[s]=wt;e[s+1]=st;e[s+2]=ht;e[s+3]=st;e[s+4]=bt;e[s+5]=ht;s+=6;ut+=6}w.addGroup(k,ut,g);k+=ut;c+=ft}var w;THREE.BufferGeometry.call(this);this.type="BoxBufferGeometry";this.parameters={width:n,height:t,depth:i,widthSegments:r,heightSegments:u,depthSegments:f};w=this;r=Math.floor(r)||1;u=Math.floor(u)||1;f=Math.floor(f)||1;var l=d(r,u,f),b=l/4*6,e=new(b>65535?Uint32Array:Uint16Array)(b),a=new Float32Array(l*3),v=new Float32Array(l*3),y=new Float32Array(l*2),o=0,p=0,s=0,c=0,k=0;h("z","y","x",-1,-1,i,t,n,f,u,0);h("z","y","x",1,-1,i,t,-n,f,u,1);h("x","z","y",1,1,n,i,t,r,f,2);h("x","z","y",1,-1,n,i,-t,r,f,3);h("x","y","z",1,-1,n,t,i,r,u,4);h("x","y","z",-1,-1,n,t,-i,r,u,5);this.setIndex(new THREE.BufferAttribute(e,1));this.addAttribute("position",new THREE.BufferAttribute(a,3));this.addAttribute("normal",new THREE.BufferAttribute(v,3));this.addAttribute("uv",new THREE.BufferAttribute(y,2))};THREE.BoxBufferGeometry.prototype=Object.create(THREE.BufferGeometry.prototype);THREE.BoxBufferGeometry.prototype.constructor=THREE.BoxBufferGeometry;THREE.Spherical=function(n,t,i){this.radius=n!==undefined?n:1;this.phi=t!==undefined?t:0;this.theta=i!==undefined?i:0};THREE.Spherical.prototype={constructor:THREE.Spherical,set:function(n,t,i){return this.radius=n,this.phi=t,this.theta=i,this},clone:function(){return(new this.constructor).copy(this)},copy:function(n){return this.radius=n.radius,this.phi=n.phi,this.theta=n.theta,this},makeSafe:function(){var n=1e-6;return this.phi=Math.max(n,Math.min(Math.PI-n,this.phi)),this},setFromVector3:function(n){return this.radius=n.length(),this.radius===0?(this.theta=0,this.phi=0):(this.theta=Math.atan2(n.x,n.z),this.phi=Math.acos(THREE.Math.clamp(n.y/this.radius,-1,1))),this}};CLOUD.GeomUtil={createInstancedBufferGeometry:function(n,t){var e=t.count,u=new THREE.InstancedBufferGeometry,p,o,s,h,c,l,i,f,w;u.maxInstancedCount=e;u.addAttribute("position",n.getAttribute("position"));u.setIndex(n.index);var r=[],a=[],v=[],y=t.items;for(p in y)o=y[p],r.push(o.worldMatrix),a.push(o.userId),v.push(CLOUD.Utils.box3FromArray(o.bbox));for(s=new THREE.InstancedBufferAttribute(new Float32Array(e*4),4,1),i=0,f=s.count;i<f;i++)s.setXYZW(i,r[i][0],r[i][1],r[i][2],r[i][3]);for(u.addAttribute("componentV1",s),h=new THREE.InstancedBufferAttribute(new Float32Array(e*4),4,1),i=0,f=h.count;i<f;i++)h.setXYZW(i,r[i][4],r[i][5],r[i][6],r[i][7]);for(u.addAttribute("componentV2",h),c=new THREE.InstancedBufferAttribute(new Float32Array(e*4),4,1),i=0,f=c.count;i<f;i++)c.setXYZW(i,r[i][8],r[i][9],r[i][10],r[i][11]);for(u.addAttribute("componentV3",c),l=new THREE.InstancedBufferAttribute(new Float32Array(e*4),4,1),i=0,f=l.count;i<f;i++)l.setXYZW(i,r[i][12],r[i][13],r[i][14],r[i][15]);return u.addAttribute("componentV4",l),u.attributes.normal===undefined&&u.computeVertexNormals(),u.boundingBox=CLOUD.Utils.box3FromArray(t.bbox),w={bboxs:v,userIds:a,transformMatrixs:r},u.extProperty=w,u},parseNodeProperties:function(n,t,i,r){n.name=t.userId?t.userId:i;CLOUD.Utils.parseTransform(n,t,r)},parseSceneNode:function(n,t,i,r){var u,f;n.sceneId=t.sceneId;n.worldBoundingBox=n.boundingBox.clone();n.worldBoundingBox.applyMatrix4(i.getGlobalTransform());n.level=t.level;t.order&&(n.out=1);CLOUD.GlobalData.ShowSubSceneBox&&(u=255,u=u<<r*5,f=new CLOUD.BBoxNode(n.boundingBox,u),CLOUD.Utils.parseTransform(f,t),n.add(f))},parseCylinderNode:function(){var r=new RegExp("'","g"),t=new THREE.Vector3,i=new THREE.Vector3,n=new THREE.Vector3,u=new THREE.Vector3(0,1,0);return function(f,e){var s,o;e instanceof Object||(e=e.replace(r,'"'),e=JSON.parse(e));t.fromArray(e.startPt);i.fromArray(e.endPt);n.subVectors(i,t);s=n.length();n.normalize();o=e.radius;o<=1&&(o=100);f.scale.set(o,s,o);f.quaternion.setFromUnitVectors(u,n);f.position.copy(t).addScaledVector(n,s*.5);f.updateMatrix();f.matrixAutoUpdate=!1}}(),parseBoxNode:function(){var t=new THREE.Box3,n=new THREE.Matrix4;return function(i,r){CLOUD.Utils.parseTransform(i,r);CLOUD.Utils.box3FromArray(r.bbox,t);var u=t.size(),f=t.center();n.identity();n.scale(u);n.setPosition(f);i.matrix.multiply(n);i.matrixAutoUpdate=!1}}(),parseHermitePipe:function(n){var o=new RegExp("'","g"),t=n.params,r,i,f,u;for(t=t.replace(o,'"'),t=JSON.parse(t),r=[],i=0,f=t.ctrlPts.length/3;i<f;++i)u=new THREE.Vector3,u.fromArray(t.ctrlPts,i*3),r.push(u);var s=new THREE.CatmullRomCurve3(r),h=new THREE.TubeGeometry(s,5,t.radius,6,!1),e=new THREE.BufferGeometry;return e.fromGeometry(h),e},parsePGeomNodeInstance:function(n,t,i,r){var u=null,f,e;if(t.geomType=="pipe"||t.geomType=="tube"){if(f=CLOUD.GeomUtil.UnitCylinderInstance,u=new THREE.Mesh(f,i),!u)return null;CLOUD.GeomUtil.parseCylinderNode(u,t.params)}else if(t.geomType=="box"){if(f=CLOUD.GeomUtil.UnitBoxInstance,u=new THREE.Mesh(f,i),!u)return null;CLOUD.GeomUtil.parseBoxNode(u,t)}else if(t.geomType=="hermitepipe"){if(f=CLOUD.GeomUtil.parseHermitePipe(t),u=new THREE.Mesh(f,i),!u)return null}else return CLOUD.Logger.log("unknonw geometry!"),u;return r&&(e=r.clone(),e.multiply(u.matrix),u.matrix=e,u.matrixAutoUpdate=!1),u},EmptyGeometry:new THREE.Geometry,UnitCylinderInstance:new THREE.CylinderBufferGeometry(1,1,1,8,1,!1),UnitBoxInstance:new THREE.BoxBufferGeometry(1,1,1),initializeUnitInstances:function(){CLOUD.GeomUtil.UnitCylinderInstance.boundingBox||CLOUD.GeomUtil.UnitCylinderInstance.computeBoundingBox();CLOUD.GeomUtil.UnitBoxInstance.boundingBox||CLOUD.GeomUtil.UnitBoxInstance.computeBoundingBox()},destroyUnitInstances:function(){CLOUD.GeomUtil.UnitCylinderInstance.dispose();CLOUD.GeomUtil.UnitBoxInstance.dispose()},toMeshWorldPosition:function(n,t){var i,r;return t||(t=new THREE.Matrix4),i=new THREE.Matrix4,i.getInverse(t),r=n.clone(),r.applyMatrix4(i),r},getWorldMatrixOfMesh:function(n){for(var t=[],i=n.parent,r,u,f;i;)t.push(i.matrix),i=i.parent;if(r=new THREE.Matrix4,t.length>0)for(r=t[t.length-1],u=t.length-2;u>=0;--u)r.multiply(t[u]);return f=new THREE.Matrix4,f.multiplyMatrices(r,n.matrix),f},getBoundingBoxWorldOfMesh:function(n,t){var r=n.boundingBox,i,u;return r||(n.geometry.boundingBox||n.geometry.computeBoundingBox(),r=n.geometry.boundingBox),i=r.clone(),i.applyMatrix4(n.matrixWorld),u=new THREE.Matrix4,u.getInverse(t),i.applyMatrix4(u),i},getMeshNodeAttr:function(){var n=new THREE.Matrix4;return function(t,i,r,u,f){var c=i.getMatrixInfo(r.matrixId).matrix.clone(),o=i.getMeshAttrInfo(r.attrIndex),p=f?f.ItemId+"_"+r.ItemId:r.ItemId,l=o.meshId,h=u[o.blockId],e,s;if(!h)return null;if(e=h.getMeshInfo(o.meshId),e==undefined)return CLOUD.Logger.log("empty mesh data"),null;if(s=t[l],!s){var a=h.getPtBuffer(o.meshId),v=h.getIdxBuffer(o.meshId),y=h.getNormalBuffer(o.meshId);if(a==undefined||v==undefined||y==undefined)return CLOUD.Logger.log("empty mesh data"),null;s=new THREE.BufferGeometry;s.setIndex(new THREE.BufferAttribute(v,1));s.addAttribute("position",new THREE.BufferAttribute(a,3));s.addAttribute("normal",new THREE.BufferAttribute(y,3));t[l]=s}return n.identity(),n.setPosition(e.baseVector),n.scale(new THREE.Vector3(e.baseScale,e.baseScale,e.baseScale)),e.baseScale!=0&&c.multiply(n),f&&c.multiplyMatrices(f.matrix,c),e=null,h=null,o=null,{nodeId:p,meshId:l,matrix:c}}}(),getMeshNodeAttrOfTube:function(n,t,i,r){var e=t.getGeomInfo(i.attrIndex),o=t.getMatrixInfo(i.matrixId).matrix.clone(),a=r?r.ItemId+"_"+i.ItemId:i.ItemId,s="tube",h=n[s],c,f;h||(h=CLOUD.GeomUtil.UnitCylinderInstance,n[s]=h);var l=e.startPt,v=e.endPt,u=new THREE.Vector3;u.subVectors(v,l);c=u.length();u.normalize();f=e.radius;f<=1&&(f=100);var y=new THREE.Vector3(0,1,0),p=new THREE.Vector3(f,c,f),w=(new THREE.Quaternion).setFromUnitVectors(y,u),b=l.clone().addScaledVector(u,c*.5),k=(new THREE.Matrix4).compose(b,w,p);return o.multiply(k),r&&o.multiplyMatrices(r.matrix,o),e=null,{nodeId:a,meshId:s,matrix:o}},getMeshNodeAttrOfPipe:function(n,t,i,r){var e=t.getGeomInfo(i.attrIndex),o=t.getMatrixInfo(i.matrixId).matrix.clone(),a=r?r.ItemId+"_"+i.ItemId:i.ItemId,s="pipe",h=n[s],c,f;h||(h=CLOUD.GeomUtil.UnitCylinderInstance,n[s]=h);var l=e.startPt,v=e.endPt,u=new THREE.Vector3;u.subVectors(v,l);c=u.length();u.normalize();f=e.radius;f<=1&&(f=100);var y=new THREE.Vector3(0,1,0),p=new THREE.Vector3(f,c,f),w=(new THREE.Quaternion).setFromUnitVectors(y,u),b=l.clone().addScaledVector(u,c*.5),k=(new THREE.Matrix4).compose(b,w,p);return o.multiply(k),r&&o.multiplyMatrices(r.matrix,o),e=null,{nodeId:a,meshId:s,matrix:o}},getMeshNodeAttrOfBox:function(n,t,i,r){var u=t.getMatrixInfo(i.matrixId).matrix.clone(),h=i.boundingBox,f=h.size(),c=h.center(),l=r?r.ItemId+"_"+i.ItemId:i.ItemId,e="box",o=n[e],s;return o||(o=CLOUD.GeomUtil.UnitBoxInstance,n[e]=o),s=(new THREE.Matrix4).scale(new THREE.Vector3(f.x,f.y,f.z)),s.setPosition(c),u.multiply(s),r&&u.multiplyMatrices(r.matrix,u),{nodeId:l,meshId:e,matrix:u}}};CLOUD.MaterialUtil={DefaultMaterial:new THREE.MeshPhongMaterial({color:255,side:THREE.DoubleSide}),createInstancePhongMaterial:function(n){var t=n.clone();return t.type="phong_instanced",t.uniforms=CLOUD.ShaderMaterial.ShaderLib.phong_cust_clip.uniforms,t.vertexShader="#define USE_CUST_INSTANCED \n"+CLOUD.ShaderMaterial.ShaderLib.phong_cust_clip.vertexShader,t.fragmentShader="#define USE_CUST_INSTANCED \n"+CLOUD.ShaderMaterial.ShaderLib.phong_cust_clip.fragmentShader,t},updateBasicMaterial:function(n,t){t?(n.vertexShader="#define USE_CUST_INSTANCED \n"+CLOUD.ShaderMaterial.ShaderLib.base_cust_clip.vertexShader,n.fragmentShader="#define USE_CUST_INSTANCED \n"+CLOUD.ShaderMaterial.ShaderLib.base_cust_clip.fragmentShader):(n.vertexShader=CLOUD.ShaderMaterial.ShaderLib.base_cust_clip.vertexShader,n.fragmentShader=CLOUD.ShaderMaterial.ShaderLib.base_cust_clip.fragmentShader);n.needsUpdate=!0},setMatrixUniform:function(n){CLOUD.ShaderMaterial.ShaderLib.base_cust_clip.uniforms.transformMatrix.value=n},createPhongMaterial:function(n){var t=new THREE.MeshPhongMaterial(n);return t.type="phong_cust_clip",t.uniforms=CLOUD.ShaderMaterial.ShaderLib.phong_cust_clip.uniforms,t.vertexShader=CLOUD.ShaderMaterial.ShaderLib.phong_cust_clip.vertexShader,t.fragmentShader=CLOUD.ShaderMaterial.ShaderLib.phong_cust_clip.fragmentShader,t},createHighlightMaterial:function(){return this.createPhongMaterial(CLOUD.GlobalData.SelectionColor)},nextHighestPowerOfTwo:function(n){--n;for(var t=1;t<32;t<<=1)n=n|n>>t;return n+1},ensurePowerOfTwo:function(n){var t,i;return!THREE.Math.isPowerOfTwo(n.width)||!THREE.Math.isPowerOfTwo(n.height)?(t=document.createElement("canvas"),t.width=CLOUD.MaterialUtil.nextHighestPowerOfTwo(n.width),t.height=CLOUD.MaterialUtil.nextHighestPowerOfTwo(n.height),i=t.getContext("2d"),i.drawImage(n,0,0,n.width,n.height,0,0,t.width,t.height),t):n}};CLOUD.CameraInfo=function(n,t,i){"use strict";this.position=n;this.target=t;this.up=i};CLOUD.CameraUtil={transformCamera:function(n,t){var r=new THREE.Vector3,f=function(n){return[parseFloat(n[0]),parseFloat(n[1]),parseFloat(n[2])]},e,i,u,o;return r.fromArray(f(n.position.split(","))),e=new THREE.Vector3,e.fromArray(f(n.direction.split(","))),i=new THREE.Vector3,i.fromArray(f(n.up.split(","))),u=new THREE.Vector3,u.addVectors(r,e),r.applyMatrix4(t.rootNode.matrix),u.applyMatrix4(t.rootNode.matrix),o=new THREE.Matrix4,o.makeRotationFromEuler(t.rootNode.rotation),i.applyMatrix4(o),i.normalize(),new CLOUD.CameraInfo(r,u,i)},parseCameraInfo:function(n){var t=JSON.parse(n),u=new THREE.Vector3,i,r;return u.x=t.position.x,u.y=t.position.y,u.z=t.position.z,i=new THREE.Vector3,i.x=t.target.x,i.y=t.target.y,i.z=t.target.z,r=new THREE.Vector3,r.x=t.up.x,r.y=t.up.y,r.z=t.up.z,new CLOUD.CameraInfo(u,i,r)},intersectBoxByRay:function(n,t){var i,r,f,e,o,s,h=1/n.direction.x,c=1/n.direction.y,l=1/n.direction.z,u=n.origin;return(h>=0?(i=(t.min.x-u.x)*h,r=(t.max.x-u.x)*h):(i=(t.max.x-u.x)*h,r=(t.min.x-u.x)*h),c>=0?(f=(t.min.y-u.y)*c,e=(t.max.y-u.y)*c):(f=(t.max.y-u.y)*c,e=(t.min.y-u.y)*c),i>e||f>r)?null:((f>i||i!==i)&&(i=f),(e<r||r!==r)&&(r=e),l>=0?(o=(t.min.z-u.z)*l,s=(t.max.z-u.z)*l):(o=(t.max.z-u.z)*l,s=(t.min.z-u.z)*l),i>s||o>r)?null:((o>i||i!==i)&&(i=o),(s<r||r!==r)&&(r=s),r<0)?null:i>=0?i:r}};CLOUD.Logger={log:function(){CLOUD.GlobalData.DEBUG&&console.log.apply(console,arguments)},debug:function(){CLOUD.GlobalData.DEBUG&&console.debug.apply(console,arguments)},warn:function(){CLOUD.GlobalData.DEBUG&&console.warn.apply(console,arguments)},error:function(){CLOUD.GlobalData.DEBUG&&console.error.apply(console,arguments)},time:function(){CLOUD.GlobalData.DEBUG&&console.time.apply(console,arguments)},timeEnd:function(){CLOUD.GlobalData.DEBUG&&console.timeEnd.apply(console,arguments)}},function(n,t){const i=typeof exports=="object"?exports:typeof n=="object"?n:{};t(i);typeof define=="function"&&define.amd&&define("lru",i)}(this,function(n){function r(n,t){typeof n!="number"&&(t=n,n=0);this.size=0;this.limit=n;this.oldest=this.newest=undefined;this._keymap=new Map;t&&(this.assign(t),n<1&&(this.limit=this.size))}function o(n,r){this.key=n;this.value=r;this[t]=undefined;this[i]=undefined}function u(n){this.entry=n}function f(n){this.entry=n}function e(n){this.entry=n}const t=Symbol("newer"),i=Symbol("older");n.LRUMap=r;r.prototype._markEntryAsUsed=function(n){n!==this.newest&&(n[t]&&(n===this.oldest&&(this.oldest=n[t]),n[t][i]=n[i]),n[i]&&(n[i][t]=n[t]),n[t]=undefined,n[i]=this.newest,this.newest&&(this.newest[t]=n),this.newest=n)};r.prototype.assign=function(n){let r,f=this.limit||Number.MAX_VALUE;this._keymap.clear();let u=n[Symbol.iterator]();for(let n=u.next();!n.done;n=u.next()){let u=new o(n.value[0],n.value[1]);if(this._keymap.set(u.key,u),r?(r[t]=u,u[i]=r):this.oldest=u,r=u,f--==0)throw new Error("overflow");}this.newest=r;this.size=this._keymap.size};r.prototype.get=function(n){var t=this._keymap.get(n);if(t)return this._markEntryAsUsed(t),t.value};r.prototype.set=function(n,r){var u=this._keymap.get(n);return u?(u.value=r,this._markEntryAsUsed(u),this):(this._keymap.set(n,u=new o(n,r)),this.newest?(this.newest[t]=u,u[i]=this.newest):this.oldest=u,this.newest=u,++this.size,this.size>this.limit&&this.shift(),this)};r.prototype.shift=function(){var n=this.oldest;if(n)return this.oldest[t]?(this.oldest=this.oldest[t],this.oldest[i]=undefined):(this.oldest=undefined,this.newest=undefined),n[t]=n[i]=undefined,this._keymap.delete(n.key),--this.size,[n.key,n.value]};r.prototype.find=function(n){let t=this._keymap.get(n);return t?t.value:undefined};r.prototype.has=function(n){return this._keymap.has(n)};r.prototype["delete"]=function(n){var r=this._keymap.get(n);if(r)return this._keymap.delete(r.key),r[t]&&r[i]?(r[i][t]=r[t],r[t][i]=r[i]):r[t]?(r[t][i]=undefined,this.oldest=r[t]):r[i]?(r[i][t]=undefined,this.newest=r[i]):this.oldest=this.newest=undefined,this.size--,r.value};r.prototype.clear=function(){this.oldest=this.newest=undefined;this.size=0;this._keymap.clear()};u.prototype[Symbol.iterator]=function(){return this};u.prototype.next=function(){let n=this.entry;return n?(this.entry=n[t],{done:!1,value:[n.key,n.value]}):{done:!0,value:undefined}};f.prototype[Symbol.iterator]=function(){return this};f.prototype.next=function(){let n=this.entry;return n?(this.entry=n[t],{done:!1,value:n.key}):{done:!0,value:undefined}};e.prototype[Symbol.iterator]=function(){return this};e.prototype.next=function(){let n=this.entry;return n?(this.entry=n[t],{done:!1,value:n.value}):{done:!0,value:undefined}};r.prototype.keys=function(){return new f(this.oldest)};r.prototype.values=function(){return new e(this.oldest)};r.prototype.entries=function(){return this};r.prototype[Symbol.iterator]=function(){return new u(this.oldest)};r.prototype.forEach=function(n,i){typeof i!="object"&&(i=this);let r=this.oldest;while(r)n.call(i,r.value,r.key,this),r=r[t]};r.prototype.toJSON=function(){for(var i=new Array(this.size),r=0,n=this.oldest;n;)i[r++]={key:n.key,value:n.value},n=n[t];return i};r.prototype.toString=function(){for(var i="",n=this.oldest;n;)i+=String(n.key)+":"+n.value,n=n[t],n&&(i+=" < ");return i}});THREE.WebGLGeometriesExt=function(n,t,i){function e(n){var t=n.geometry,f=t.id,r;return u.has(f)?u.get(f):(t instanceof THREE.BufferGeometry?r=t:t instanceof THREE.Geometry&&(t._bufferGeometry===undefined&&(t._bufferGeometry=(new THREE.BufferGeometry).setFromObject(n)),r=t._bufferGeometry),u.set(f,r),i.memory.geometries++,r)}function o(n){return n instanceof THREE.InterleavedBufferAttribute?t.get(n.data).__webglBuffer:t.get(n).__webglBuffer}function r(t){var i=o(t);i!==undefined&&(n.deleteBuffer(i),s(t))}function f(n){for(var t in n)r(n[t])}function s(n){n instanceof THREE.InterleavedBufferAttribute?t.delete(n.data):t.delete(n)}var u=new LRUMap(CLOUD.GlobalData.maxDrawCacheNum);u.shift=function(){var e=LRUMap.prototype.shift.call(this),n=e[1],u;f(n.attributes);n.index&&r(n.index);u=t.get(n);u.wireframe&&r(u.wireframe);i.memory.geometries--};this.get=e};THREE.WebGLObjectsExt=function(n,t,i){function e(t){var i=f.get(t),o,s,h,u,c,e,l;t.geometry instanceof THREE.Geometry&&i.updateFromObject(t);o=i.index;s=i.attributes;o!==null&&r(o,n.ELEMENT_ARRAY_BUFFER);for(u in s)r(s[u],n.ARRAY_BUFFER);h=i.morphAttributes;for(u in h)for(c=h[u],e=0,l=c.length;e<l;e++)r(c[e],n.ARRAY_BUFFER);return i}function r(n,i){var r=n instanceof THREE.InterleavedBufferAttribute?n.data:n,u=t.get(r);u.__webglBuffer===undefined?o(u,r,i):u.version!==r.version&&s(u,r,i)}function o(t,i,r){t.__webglBuffer=n.createBuffer();n.bindBuffer(r,t.__webglBuffer);var u=i.dynamic?n.DYNAMIC_DRAW:n.STATIC_DRAW;n.bufferData(r,i.array,u);t.version=i.version}function s(t,i,r){n.bindBuffer(r,t.__webglBuffer);i.dynamic===!1||i.updateRange.count===-1?n.bufferSubData(r,0,i.array):i.updateRange.count===0?console.error("THREE.WebGLObjects.updateBuffer: dynamic THREE.BufferAttribute marked as needsUpdate but updateRange.count is 0, ensure you are using set methods or updating manually."):(n.bufferSubData(r,i.updateRange.offset*i.array.BYTES_PER_ELEMENT,i.array.subarray(i.updateRange.offset,i.updateRange.offset+i.updateRange.count)),i.updateRange.count=0);t.version=i.version}function h(n){return n instanceof THREE.InterleavedBufferAttribute?t.get(n.data).__webglBuffer:t.get(n).__webglBuffer}function c(i){var y=t.get(i),l,e,f,a,b,v;if(y.wireframe!==undefined)return y.wireframe;var c=[],p=i.index,w=i.attributes,k=w.position;if(p!==null)for(l={},e=p.array,f=0,a=e.length;f<a;f+=3){var o=e[f+0],s=e[f+1],h=e[f+2];u(l,o,s)&&c.push(o,s);u(l,s,h)&&c.push(s,h);u(l,h,o)&&c.push(h,o)}else for(e=w.position.array,f=0,a=e.length/3-1;f<a;f+=3){var o=f+0,s=f+1,h=f+2;c.push(o,s,s,h,h,o)}return b=k.count>65535?Uint32Array:Uint16Array,v=new THREE.BufferAttribute(new b(c),1),r(v,n.ELEMENT_ARRAY_BUFFER),y.wireframe=v,v}function u(n,t,i){var u,r;return(t>i&&(u=t,t=i,i=u),r=n[t],r===undefined)?(n[t]=[i],!0):r.indexOf(i)===-1?(r.push(i),!0):!1}var f=new THREE.WebGLGeometriesExt(n,t,i);this.getAttributeBuffer=h;this.getWireframeAttribute=c;this.update=e};CLOUD.RenderGroup=function(){function l(n,t){return n.material.id!==t.material.id?n.material.id-t.material.id:n.z!==t.z?n.z-t.z:n.id-t.id}function a(n,t){return n.z!==t.z?t.z-n.z:n.id-t.id}function c(n,t,i,r,u){var a,f;for(o=Date.now(),a=t.length,f=e;f<a;f++){var l=t[f],c=l.object,v=l.material,y=l.group,p=l.geometry;if(c.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,c.matrixWorld),c.normalMatrix.getNormalMatrix(c.modelViewMatrix),n.renderBufferDirect(i,r,u,p,v,c,y),s=Date.now(),h=s-o,h>CLOUD.GlobalData.LimitFrameTime)return e=f+1,!1}return e=0,!0}var n=[],t=[],u=-1,f=-1,e=0,i=!1,r=!1,o=0,s=0,h=0;this.getOpaqueObjects=function(){return n};this.getTransparentObjects=function(){return t};this.destroy=function(){n=[];t=[]};this.restart=function(){e=0;i=!1;r=!1};this.prepare=function(){this.restart();u=-1;f=-1};this.renderableCount=function(){return u+f};this.pushRenderItem=function(i,r,e,o,s){var c,l,h;e.transparent?(c=t,l=++f):(c=n,l=++u);h=c[l];h!==undefined?(h.id=i.id,h.object=i,h.geometry=r,h.material=e,h.z=o,h.group=s):(h={id:i.id,object:i,geometry:r,material:e,z:o,group:s},c[l]=h)};this.sortRenderList=function(i){n.length=u+1;t.length=f+1;i&&(n.sort(l),t.sort(a))};this.renderOpaqueObjects=function(t,r,u,f,e){return i||(i=c(t,n,r,u,f,e)),i};this.renderTransparentObjects=function(n,i,u,f,e){return r||(r=c(n,t,i,u,f,e)),r}};CLOUD.OrderedRenderer=function(){function p(){var t,r,i;for(++f,f>1e5&&(f=0),t=0,r=n.length;t<r;++t)i=n[t],i!==undefined&&i.prepare()}function w(t,i,r,u){var f=n[t.renderOrder];f===undefined&&(f=new CLOUD.RenderGroup,n[t.renderOrder]=f);f.pushRenderItem(t,i,r,u,null)}function b(){for(var r,t=0,u=n.length;t<u;++t)r=n[t],r!==undefined&&r.sortRenderList(i)}function v(n,t){var e,o,s,i,r,y;if(n.visible===!1)return!0;if(n._cullTicket!=f){if(++h,e=Date.now()-c,e>30)return!1;n._cullTicket=f;(n instanceof THREE.Mesh||n instanceof THREE.Line||n instanceof THREE.Points)&&(n.frustumCulled===!1||l.intersectsObject(n)===!0)&&(u.setFromMatrixPosition(n.matrixWorld),u.applyProjection(a),o=n.material,s=n.geometry,w(n,s,o,u.z))}if(i=n.children,i)for(r=0,y=i.length;r<y;r++)if(!v(i[r],t))return!1;return!0}function k(n,t){var r,i,f,u;for(t.length=0,r=n.children,i=0,f=r.length;i<f;i++)u=r[i],u instanceof THREE.Light&&t.push(u)}function d(n,t,r){if(!e){i=!0;return}i&&(p(),k(n,r));c=Date.now();i=v(n,t);b()}function g(){(!e||s)&&++o;o>1e4&&(o=0)}var f=0,i=!1,r=!1,h=0,y=0,c=0,o=0,n=[],l=null,a=null,u=new THREE.Vector3,e=!0,s=!0,t=null;this.updateObjectList=function(n){e=n};this.destroy=function(){for(var i,t=0,r=n.length;t<r;++t)i=n[t],i!==undefined&&i.destroy()};this.restart=function(){for(var r,t=0,u=n.length;t<u;++t)r=n[t],r!==undefined&&r.restart();h=0;y=0;s=!0;i=!0};this.setFilter=function(n){t=n};this.update=function(n,t){a=t;l=n};this.render=function(t,u,f,h,c,l,a){var p,v,y;if(g(),s){if(d(u,f,h),i)l=!0,s=!1;else return!1;t.setRenderTarget(c)}for((t.autoClear||l)&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil,e),p=u.fog,t.setRenderTicket(o),a.setBlending(THREE.NoBlending),v=n.length-1;v>=0;--v)if(y=n[v],y!==undefined&&(r=y.renderOpaqueObjects(t,f,h,p,e),!r))break;if(r)for(v=n.length-1;v>=0;--v)if(y=n[v],y!==undefined&&(r=y.renderTransparentObjects(t,f,h,p),!r))break;return a.setDepthTest(!0),a.setDepthWrite(!0),a.setColorWrite(!0),r};this.computeSelectionBBox=function(){var i,r;if(t===null||t.isSelectionSetEmpty())return null;for(t.resetSelectionBox(),i=n.length-1;i>=0;--i)r=n[i],r!==undefined&&(t.computeSelectionBox(r.getOpaqueObjects()),t.computeSelectionBox(r.getTransparentObjects()));return t.getSelectionBox()};this.computeRenderObjectsBox=function(){for(var r,u,f,i=new THREE.Box3,e=n.length-1;e>=0;--e)r=n[e],r!==undefined&&(u=t.computeRenderObjectsBox(r.getOpaqueObjects()),u.empty()||(i.expandByPoint(u.min),i.expandByPoint(u.max)),f=t.computeRenderObjectsBox(r.getTransparentObjects()),f.empty()||(i.expandByPoint(f.min),i.expandByPoint(f.max)));return i}};THREE.WebGLIncrementRenderer=function(n){function pt(n,i,r,u){gt===!0&&(n*=u,i*=u,r*=u);t.clearColor(n,i,r,u)}function fi(){i.init();t.viewport(g,nt,tt,it);pt(c.r,c.g,c.b,w)}function ei(){lt=null;d=null;ot="";k=-1;st=!0;i.reset()}function oi(n){n.preventDefault();ei();fi();u.clear()}function wt(n){var t=n.target;t.removeEventListener("dispose",wt);or(t);b.textures--}function si(n){var t=n.target;t.removeEventListener("dispose",si);sr(t);b.textures--}function hi(n){var t=n.target;t.removeEventListener("dispose",hi);hr(t)}function or(n){var i=u.get(n);if(n.image&&i.__image__webglTextureCube)t.deleteTexture(i.__image__webglTextureCube);else{if(i.__webglInit===undefined)return;t.deleteTexture(i.__webglTexture)}u.delete(n)}function sr(n){var r=u.get(n),f=u.get(n.texture),i;if(n&&f.__webglTexture!==undefined){if(t.deleteTexture(f.__webglTexture),n instanceof THREE.WebGLRenderTargetCube)for(i=0;i<6;i++)t.deleteFramebuffer(r.__webglFramebuffer[i]),t.deleteRenderbuffer(r.__webglRenderbuffer[i]);else t.deleteFramebuffer(r.__webglFramebuffer),t.deleteRenderbuffer(r.__webglRenderbuffer);u.delete(n.texture);u.delete(n)}}function hr(n){ci(n);u.delete(n)}function ci(n){var t=u.get(n).program;n.program=undefined;t!==undefined&&ut.releaseProgram(t)}function cr(n,r,u,f){var l,o,c,h;f=f||0;i.initAttributes();var p=u.attributes,a=r.getAttributes(),v=n.defaultAttributeValues;for(l in a)if(o=a[l],o>=0)if(c=p[l],c!==undefined){var y=c.itemSize,w=rt.getAttributeBuffer(c),s=t.FLOAT,e=c.array,b=c.normalized;e instanceof Float32Array?s=t.FLOAT:e instanceof Float64Array?console.warn("Unsupported data buffer format: Float64Array"):e instanceof Uint16Array?s=t.UNSIGNED_SHORT:e instanceof Int16Array?s=t.SHORT:e instanceof Uint32Array?s=t.UNSIGNED_INT:e instanceof Int32Array?s=t.INT:e instanceof Int8Array?s=t.BYTE:e instanceof Uint8Array&&(s=t.UNSIGNED_BYTE);i.enableAttribute(o);t.bindBuffer(t.ARRAY_BUFFER,w);t.vertexAttribPointer(o,y,s,!1,0,f*y*e.BYTES_PER_ELEMENT)}else if(v!==undefined&&(h=v[l],h!==undefined))switch(h.length){case 2:t.vertexAttrib2fv(o,h);break;case 3:t.vertexAttrib3fv(o,h);break;case 4:t.vertexAttrib4fv(o,h);break;default:t.vertexAttrib1fv(o,h)}i.disableUnusedAttributes()}function lr(n,t,i,r){var f=u.get(n),s=ut.getParameters(n,t,i,r),y=ut.getProgramCode(n,s),o=f.program,p=!0,h,c,e,w,l,a;if(o===undefined)n.addEventListener("dispose",hi);else if(o.code!==y)ci(n);else{if(s.shaderID!==undefined)return;p=!1}if(p&&(s.shaderID?(h=THREE.ShaderLib[s.shaderID],f.__webglShader={name:n.type,uniforms:THREE.UniformsUtils.clone(h.uniforms),vertexShader:h.vertexShader,fragmentShader:h.fragmentShader}):f.__webglShader={name:n.type,uniforms:n.uniforms,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader},n.__webglShader=f.__webglShader,o=ut.acquireProgram(n,s,y),f.program=o,n.program=o),c=o.getAttributes(),n.morphTargets)for(n.numSupportedMorphTargets=0,e=0;e<v.maxMorphTargets;e++)c["morphTarget"+e]>=0&&n.numSupportedMorphTargets++;if(n.morphNormals)for(n.numSupportedMorphNormals=0,e=0;e<v.maxMorphNormals;e++)c["morphNormal"+e]>=0&&n.numSupportedMorphNormals++;f.uniformsList=[];w=f.program.getUniforms();for(l in f.__webglShader.uniforms)a=w[l],a&&f.uniformsList.push([f.__webglShader.uniforms[l],a])}function ar(n){vr(n);n.transparent===!0?i.setBlending(n.blending,n.blendEquation,n.blendSrc,n.blendDst,n.blendEquationAlpha,n.blendSrcAlpha,n.blendDstAlpha):i.setBlending(THREE.NoBlending);i.setDepthFunc(n.depthFunc);i.setDepthTest(n.depthTest);i.setDepthWrite(n.depthWrite);i.setColorWrite(n.colorWrite);i.setPolygonOffset(n.polygonOffset,n.polygonOffsetFactor,n.polygonOffsetUnits)}function vr(n){n.side!==THREE.DoubleSide?i.enable(t.CULL_FACE):i.disable(t.CULL_FACE);i.setFlipSided(n.side===THREE.BackSide)}function yr(n,i,r,e,o){var c,w;at=0;c=u.get(e);(e.needsUpdate||!c.program)&&(lr(e,i,r,o),e.needsUpdate=!1);var b=!1,p=!1,y=!1,a=c.program,s=a.getUniforms(),h=c.__webglShader.uniforms;return a.id!==lt&&(t.useProgram(a.program),lt=a.id,b=!0,p=!0,y=!0),e.id!==k&&(k===-1&&(y=!0),k=e.id,p=!0),(b||n!==d)&&(t.uniformMatrix4fv(s.projectionMatrix,!1,n.projectionMatrix.elements),l.logarithmicDepthBuffer&&t.uniform1f(s.logDepthBufFC,2/(Math.log(n.far+1)/Math.LN2)),n!==d&&(d=n),(e instanceof THREE.ShaderMaterial||e instanceof THREE.MeshPhongMaterial||e.envMap)&&s.cameraPosition!==undefined&&(f.setFromMatrixPosition(n.matrixWorld),t.uniform3f(s.cameraPosition,f.x,f.y,f.z)),(e instanceof THREE.MeshPhongMaterial||e instanceof THREE.MeshLambertMaterial||e instanceof THREE.MeshBasicMaterial||e instanceof THREE.ShaderMaterial||e.skinning)&&s.viewMatrix!==undefined&&t.uniformMatrix4fv(s.viewMatrix,!1,n.matrixWorldInverse.elements)),e.skinning&&(o.bindMatrix&&s.bindMatrix!==undefined&&t.uniformMatrix4fv(s.bindMatrix,!1,o.bindMatrix.elements),o.bindMatrixInverse&&s.bindMatrixInverse!==undefined&&t.uniformMatrix4fv(s.bindMatrixInverse,!1,o.bindMatrixInverse.elements),l.floatVertexTextures&&o.skeleton&&o.skeleton.useVertexTexture?(s.boneTexture!==undefined&&(w=bt(),t.uniform1i(s.boneTexture,w),v.setTexture(o.skeleton.boneTexture,w)),s.boneTextureWidth!==undefined&&t.uniform1i(s.boneTextureWidth,o.skeleton.boneTextureWidth),s.boneTextureHeight!==undefined&&t.uniform1i(s.boneTextureHeight,o.skeleton.boneTextureHeight)):o.skeleton&&o.skeleton.boneMatrices&&s.boneGlobalMatrices!==undefined&&t.uniformMatrix4fv(s.boneGlobalMatrices,!1,o.skeleton.boneMatrices)),p&&(r&&e.fog&&kr(h,r),(e instanceof THREE.MeshPhongMaterial||e instanceof THREE.MeshLambertMaterial||e.lights)&&(st&&(y=!0,ru(i,n),st=!1),y?(gr(h,ii),ai(h,!0)):ai(h,!1)),(e instanceof THREE.MeshBasicMaterial||e instanceof THREE.MeshLambertMaterial||e instanceof THREE.MeshPhongMaterial)&&pr(h,e),e instanceof THREE.LineBasicMaterial?li(h,e):e instanceof THREE.LineDashedMaterial?(li(h,e),wr(h,e)):e instanceof THREE.PointsMaterial?br(h,e):e instanceof THREE.MeshPhongMaterial?dr(h,e):e instanceof THREE.MeshDepthMaterial?(h.mNear.value=n.near,h.mFar.value=n.far,h.opacity.value=e.opacity):e instanceof THREE.MeshNormalMaterial&&(h.opacity.value=e.opacity),o.receiveShadow&&!e._shadowPass&&nu(h,i,n),iu(c.uniformsList)),tu(s,o),s.modelMatrix!==undefined&&t.uniformMatrix4fv(s.modelMatrix,!1,o.matrixWorld.elements),a}function pr(n,t){var i,r,u;n.opacity.value=t.opacity;n.diffuse.value=t.color;t.emissive&&(n.emissive.value=t.emissive);n.map.value=t.map;n.specularMap.value=t.specularMap;n.alphaMap.value=t.alphaMap;t.aoMap&&(n.aoMap.value=t.aoMap,n.aoMapIntensity.value=t.aoMapIntensity);t.map?i=t.map:t.specularMap?i=t.specularMap:t.displacementMap?i=t.displacementMap:t.normalMap?i=t.normalMap:t.bumpMap?i=t.bumpMap:t.alphaMap?i=t.alphaMap:t.emissiveMap&&(i=t.emissiveMap);i!==undefined&&(i instanceof THREE.WebGLRenderTarget&&(i=i.texture),r=i.offset,u=i.repeat,n.offsetRepeat.value.set(r.x,r.y,u.x,u.y));n.envMap.value=t.envMap;n.flipEnvMap.value=t.envMap instanceof THREE.WebGLRenderTargetCube?1:-1;n.reflectivity.value=t.reflectivity;n.refractionRatio.value=t.refractionRatio}function li(n,t){n.diffuse.value=t.color;n.opacity.value=t.opacity}function wr(n,t){n.dashSize.value=t.dashSize;n.totalSize.value=t.dashSize+t.gapSize;n.scale.value=t.scale}function br(n,t){if(n.psColor.value=t.color,n.opacity.value=t.opacity,n.size.value=t.size,n.scale.value=s.height/2,n.map.value=t.map,t.map!==null){var i=t.map.offset,r=t.map.repeat;n.offsetRepeat.value.set(i.x,i.y,r.x,r.y)}}function kr(n,t){n.fogColor.value=t.color;t instanceof THREE.Fog?(n.fogNear.value=t.near,n.fogFar.value=t.far):t instanceof THREE.FogExp2&&(n.fogDensity.value=t.density)}function dr(n,t){n.specular.value=t.specular;n.shininess.value=Math.max(t.shininess,.0001);t.lightMap&&(n.lightMap.value=t.lightMap,n.lightMapIntensity.value=t.lightMapIntensity);t.emissiveMap&&(n.emissiveMap.value=t.emissiveMap);t.bumpMap&&(n.bumpMap.value=t.bumpMap,n.bumpScale.value=t.bumpScale);t.normalMap&&(n.normalMap.value=t.normalMap,n.normalScale.value.copy(t.normalScale));t.displacementMap&&(n.displacementMap.value=t.displacementMap,n.displacementScale.value=t.displacementScale,n.displacementBias.value=t.displacementBias)}function gr(n,t){n.ambientLightColor.value=t.ambient;n.directionalLightColor.value=t.directional.colors;n.directionalLightDirection.value=t.directional.positions;n.pointLightColor.value=t.point.colors;n.pointLightPosition.value=t.point.positions;n.pointLightDistance.value=t.point.distances;n.pointLightDecay.value=t.point.decays;n.spotLightColor.value=t.spot.colors;n.spotLightPosition.value=t.spot.positions;n.spotLightDistance.value=t.spot.distances;n.spotLightDirection.value=t.spot.directions;n.spotLightAngleCos.value=t.spot.anglesCos;n.spotLightExponent.value=t.spot.exponents;n.spotLightDecay.value=t.spot.decays;n.hemisphereLightSkyColor.value=t.hemi.skyColors;n.hemisphereLightGroundColor.value=t.hemi.groundColors;n.hemisphereLightDirection.value=t.hemi.positions}function ai(n,t){n.ambientLightColor.needsUpdate=t;n.directionalLightColor.needsUpdate=t;n.directionalLightDirection.needsUpdate=t;n.pointLightColor.needsUpdate=t;n.pointLightPosition.needsUpdate=t;n.pointLightDistance.needsUpdate=t;n.pointLightDecay.needsUpdate=t;n.spotLightColor.needsUpdate=t;n.spotLightPosition.needsUpdate=t;n.spotLightDistance.needsUpdate=t;n.spotLightDirection.needsUpdate=t;n.spotLightAngleCos.needsUpdate=t;n.spotLightExponent.needsUpdate=t;n.spotLightDecay.needsUpdate=t;n.hemisphereLightSkyColor.needsUpdate=t;n.hemisphereLightGroundColor.needsUpdate=t;n.hemisphereLightDirection.needsUpdate=t}function nu(n,t){var i,e,o,r,u;if(n.shadowMatrix)for(i=0,e=0,o=t.length;e<o;e++)r=t[e],r.castShadow===!0&&(r instanceof THREE.PointLight||r instanceof THREE.SpotLight||r instanceof THREE.DirectionalLight)&&(u=r.shadow,r instanceof THREE.PointLight?(f.setFromMatrixPosition(r.matrixWorld).negate(),u.matrix.identity().setPosition(f),n.shadowDarkness.value[i]=-u.darkness):n.shadowDarkness.value[i]=u.darkness,n.shadowMatrix.value[i]=u.matrix,n.shadowMap.value[i]=u.map,n.shadowMapSize.value[i]=u.mapSize,n.shadowBias.value[i]=u.bias,i++)}function tu(n,i){t.uniformMatrix4fv(n.modelViewMatrix,!1,i.modelViewMatrix.elements);n.normalMatrix&&t.uniformMatrix3fv(n.normalMatrix,!1,i.normalMatrix.elements)}function bt(){var n=at;return n>=l.maxTextures&&console.warn("WebGLRenderer: trying to use "+n+" texture units while this GPU supports only "+l.maxTextures),at+=1,n}function iu(n){for(var r,u,s,e,o,c=0,p=n.length;c<p;c++)if(r=n[c][0],r.needsUpdate!==!1){var y=r.type,i=r.value,f=n[c][1];switch(y){case"1i":t.uniform1i(f,i);break;case"1f":t.uniform1f(f,i);break;case"2f":t.uniform2f(f,i[0],i[1]);break;case"3f":t.uniform3f(f,i[0],i[1],i[2]);break;case"4f":t.uniform4f(f,i[0],i[1],i[2],i[3]);break;case"1iv":t.uniform1iv(f,i);break;case"3iv":t.uniform3iv(f,i);break;case"1fv":t.uniform1fv(f,i);break;case"2fv":t.uniform2fv(f,i);break;case"3fv":t.uniform3fv(f,i);break;case"4fv":t.uniform4fv(f,i);break;case"Matrix3fv":t.uniformMatrix3fv(f,!1,i);break;case"Matrix4fv":t.uniformMatrix4fv(f,!1,i);break;case"i":t.uniform1i(f,i);break;case"f":t.uniform1f(f,i);break;case"v2":t.uniform2f(f,i.x,i.y);break;case"v3":t.uniform3f(f,i.x,i.y,i.z);break;case"v4":t.uniform4f(f,i.x,i.y,i.z,i.w);break;case"c":t.uniform3f(f,i.r,i.g,i.b);break;case"iv1":t.uniform1iv(f,i);break;case"iv":t.uniform3iv(f,i);break;case"fv1":t.uniform1fv(f,i);break;case"fv":t.uniform3fv(f,i);break;case"v2v":r._array===undefined&&(r._array=new Float32Array(2*i.length));for(var u=0,a=0,s=i.length;u<s;u++,a+=2)r._array[a+0]=i[u].x,r._array[a+1]=i[u].y;t.uniform2fv(f,r._array);break;case"v3v":r._array===undefined&&(r._array=new Float32Array(3*i.length));for(var u=0,l=0,s=i.length;u<s;u++,l+=3)r._array[l+0]=i[u].x,r._array[l+1]=i[u].y,r._array[l+2]=i[u].z;t.uniform3fv(f,r._array);break;case"v4v":r._array===undefined&&(r._array=new Float32Array(4*i.length));for(var u=0,h=0,s=i.length;u<s;u++,h+=4)r._array[h+0]=i[u].x,r._array[h+1]=i[u].y,r._array[h+2]=i[u].z,r._array[h+3]=i[u].w;t.uniform4fv(f,r._array);break;case"m3":t.uniformMatrix3fv(f,!1,i.elements);break;case"m3v":for(r._array===undefined&&(r._array=new Float32Array(9*i.length)),u=0,s=i.length;u<s;u++)i[u].flattenToArrayOffset(r._array,u*9);t.uniformMatrix3fv(f,!1,r._array);break;case"m4":t.uniformMatrix4fv(f,!1,i.elements);break;case"m4v":for(r._array===undefined&&(r._array=new Float32Array(16*i.length)),u=0,s=i.length;u<s;u++)i[u].flattenToArrayOffset(r._array,u*16);t.uniformMatrix4fv(f,!1,r._array);break;case"t":if(e=i,o=bt(),t.uniform1i(f,o),!e)continue;e instanceof THREE.CubeTexture||Array.isArray(e.image)&&e.image.length===6?yi(e,o):e instanceof THREE.WebGLRenderTargetCube?pi(e.texture,o):e instanceof THREE.WebGLRenderTarget?v.setTexture(e.texture,o):v.setTexture(e,o);break;case"tv":for(r._array===undefined&&(r._array=[]),u=0,s=r.value.length;u<s;u++)r._array[u]=bt();for(t.uniform1iv(f,r._array),u=0,s=r.value.length;u<s;u++)(e=r.value[u],o=r._array[u],e)&&(e instanceof THREE.CubeTexture||e.image instanceof Array&&e.image.length===6?yi(e,o):e instanceof THREE.WebGLRenderTarget?v.setTexture(e.texture,o):e instanceof THREE.WebGLRenderTargetCube?pi(e.texture,o):v.setTexture(e,o));break;default:console.warn("THREE.WebGLRenderer: Unknown uniform type: "+y)}}}function ft(n,t,i,r){n[t+0]=i.r*r;n[t+1]=i.g*r;n[t+2]=i.b*r}function ru(n,t){for(var i,lt=0,at=0,vt=0,c,yt,pt,l,d,u=ii,y=t.matrixWorldInverse,g=u.directional.colors,nt=u.directional.positions,tt=u.point.colors,it=u.point.positions,dt=u.point.distances,gt=u.point.decays,rt=u.spot.colors,ut=u.spot.positions,ni=u.spot.distances,et=u.spot.directions,ti=u.spot.anglesCos,ri=u.spot.exponents,ui=u.spot.decays,ot=u.hemi.skyColors,st=u.hemi.groundColors,ht=u.hemi.positions,k=0,a=0,s=0,p=0,wt=0,bt=0,kt=0,ct=0,w=0,b=0,h=0,v=0,r=0,e=n.length;r<e;r++)if(i=n[r],c=i.color,l=i.intensity,d=i.distance,i instanceof THREE.AmbientLight){if(!i.visible)continue;lt+=c.r;at+=c.g;vt+=c.b}else if(i instanceof THREE.DirectionalLight){if(wt+=1,!i.visible)continue;o.setFromMatrixPosition(i.matrixWorld);f.setFromMatrixPosition(i.target.matrixWorld);o.sub(f);o.transformDirection(y);w=k*3;nt[w+0]=o.x;nt[w+1]=o.y;nt[w+2]=o.z;ft(g,w,c,l);k+=1}else if(i instanceof THREE.PointLight){if(bt+=1,!i.visible)continue;b=a*3;ft(tt,b,c,l);f.setFromMatrixPosition(i.matrixWorld);f.applyMatrix4(y);it[b+0]=f.x;it[b+1]=f.y;it[b+2]=f.z;dt[a]=d;gt[a]=i.distance===0?0:i.decay;a+=1}else if(i instanceof THREE.SpotLight){if(kt+=1,!i.visible)continue;h=s*3;ft(rt,h,c,l);o.setFromMatrixPosition(i.matrixWorld);f.copy(o).applyMatrix4(y);ut[h+0]=f.x;ut[h+1]=f.y;ut[h+2]=f.z;ni[s]=d;f.setFromMatrixPosition(i.target.matrixWorld);o.sub(f);o.transformDirection(y);et[h+0]=o.x;et[h+1]=o.y;et[h+2]=o.z;ti[s]=Math.cos(i.angle);ri[s]=i.exponent;ui[s]=i.distance===0?0:i.decay;s+=1}else if(i instanceof THREE.HemisphereLight){if(ct+=1,!i.visible)continue;o.setFromMatrixPosition(i.matrixWorld);o.transformDirection(y);v=p*3;ht[v+0]=o.x;ht[v+1]=o.y;ht[v+2]=o.z;yt=i.color;pt=i.groundColor;ft(ot,v,yt,l);ft(st,v,pt,l);p+=1}for(r=k*3,e=Math.max(g.length,wt*3);r<e;r++)g[r]=0;for(r=a*3,e=Math.max(tt.length,bt*3);r<e;r++)tt[r]=0;for(r=s*3,e=Math.max(rt.length,kt*3);r<e;r++)rt[r]=0;for(r=p*3,e=Math.max(ot.length,ct*3);r<e;r++)ot[r]=0;for(r=p*3,e=Math.max(st.length,ct*3);r<e;r++)st[r]=0;u.directional.length=k;u.point.length=a;u.spot.length=s;u.hemi.length=p;u.ambient[0]=lt;u.ambient[1]=at;u.ambient[2]=vt}function ht(n,i,f){var e;if(f?(t.texParameteri(n,t.TEXTURE_WRAP_S,h(i.wrapS)),t.texParameteri(n,t.TEXTURE_WRAP_T,h(i.wrapT)),t.texParameteri(n,t.TEXTURE_MAG_FILTER,h(i.magFilter)),t.texParameteri(n,t.TEXTURE_MIN_FILTER,h(i.minFilter))):(t.texParameteri(n,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(n,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),(i.wrapS!==THREE.ClampToEdgeWrapping||i.wrapT!==THREE.ClampToEdgeWrapping)&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping.",i),t.texParameteri(n,t.TEXTURE_MAG_FILTER,ki(i.magFilter)),t.texParameteri(n,t.TEXTURE_MIN_FILTER,ki(i.minFilter)),i.minFilter!==THREE.NearestFilter&&i.minFilter!==THREE.LinearFilter&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.",i)),e=r.get("EXT_texture_filter_anisotropic"),e){if(i.type===THREE.FloatType&&r.get("OES_texture_float_linear")===null)return;if(i.type===THREE.HalfFloatType&&r.get("OES_texture_half_float_linear")===null)return;(i.anisotropy>1||u.get(i).__currentAnisotropy)&&(t.texParameterf(n,e.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i.anisotropy,v.getMaxAnisotropy())),u.get(i).__currentAnisotropy=i.anisotropy)}}function uu(n,r,u){var e,s,f,c;n.__webglInit===undefined&&(n.__webglInit=!0,r.addEventListener("dispose",wt),n.__webglTexture=t.createTexture(),b.textures++);i.activeTexture(t.TEXTURE0+u);i.bindTexture(t.TEXTURE_2D,n.__webglTexture);t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,r.flipY);t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.premultiplyAlpha);t.pixelStorei(t.UNPACK_ALIGNMENT,r.unpackAlignment);r.image=vi(r.image,l.maxTextureSize);fu(r)&&ct(r.image)===!1&&(r.image=eu(r.image));var v=r.image,y=ct(v),o=h(r.format),a=h(r.type);if(ht(t.TEXTURE_2D,r,y),s=r.mipmaps,r instanceof THREE.DataTexture)if(s.length>0&&y){for(f=0,c=s.length;f<c;f++)e=s[f],i.texImage2D(t.TEXTURE_2D,f,o,e.width,e.height,0,o,a,e.data);r.generateMipmaps=!1}else i.texImage2D(t.TEXTURE_2D,0,o,v.width,v.height,0,o,a,v.data);else if(r instanceof THREE.CompressedTexture)for(f=0,c=s.length;f<c;f++)e=s[f],r.format!==THREE.RGBAFormat&&r.format!==THREE.RGBFormat?i.getCompressedTextureFormats().indexOf(o)>-1?i.compressedTexImage2D(t.TEXTURE_2D,f,o,e.width,e.height,0,e.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):i.texImage2D(t.TEXTURE_2D,f,o,e.width,e.height,0,o,a,e.data);else if(s.length>0&&y){for(f=0,c=s.length;f<c;f++)e=s[f],i.texImage2D(t.TEXTURE_2D,f,o,o,a,e);r.generateMipmaps=!1}else i.texImage2D(t.TEXTURE_2D,0,o,o,a,r.image);if(r.generateMipmaps&&y&&t.generateMipmap(t.TEXTURE_2D),n.__version=r.version,r.onUpdate)r.onUpdate(r)}function vi(n,t){var r,i,u;return n.width>t||n.height>t?(r=t/Math.max(n.width,n.height),i=document.createElement("canvas"),i.width=Math.floor(n.width*r),i.height=Math.floor(n.height*r),u=i.getContext("2d"),u.drawImage(n,0,0,n.width,n.height,0,0,i.width,i.height),console.warn("THREE.WebGLRenderer: image is too big ("+n.width+"x"+n.height+"). Resized to "+i.width+"x"+i.height,n),i):n}function ct(n){return THREE.Math.isPowerOfTwo(n.width)&&THREE.Math.isPowerOfTwo(n.height)}function fu(n){return n.wrapS!==THREE.ClampToEdgeWrapping||n.wrapT!==THREE.ClampToEdgeWrapping?!0:n.minFilter!==THREE.NearestFilter&&n.minFilter!==THREE.LinearFilter?!0:!1}function eu(n){var t,i;return n instanceof HTMLImageElement||n instanceof HTMLCanvasElement?(t=document.createElement("canvas"),t.width=THREE.Math.nearestPowerOfTwo(n.width),t.height=THREE.Math.nearestPowerOfTwo(n.height),i=t.getContext("2d"),i.drawImage(n,0,0,t.width,t.height),console.warn("THREE.WebGLRenderer: image is not power of two ("+n.width+"x"+n.height+"). Resized to "+t.width+"x"+t.height,n),t):n}function yi(n,r){var c=u.get(n),f,s,w,a,g;if(n.image.length===6)if(n.version>0&&c.__version!==n.version){c.__image__webglTextureCube||(n.addEventListener("dispose",wt),c.__image__webglTextureCube=t.createTexture(),b.textures++);i.activeTexture(t.TEXTURE0+r);i.bindTexture(t.TEXTURE_CUBE_MAP,c.__image__webglTextureCube);t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,n.flipY);var k=n instanceof THREE.CompressedTexture,y=n.image[0]instanceof THREE.DataTexture,o=[];for(f=0;f<6;f++)o[f]=!v.autoScaleCubemaps||k||y?y?n.image[f].image:n.image[f]:vi(n.image[f],l.maxCubemapSize);var nt=o[0],d=ct(nt),e=h(n.format),p=h(n.type);for(ht(t.TEXTURE_CUBE_MAP,n,d),f=0;f<6;f++)if(k)for(w=o[f].mipmaps,a=0,g=w.length;a<g;a++)s=w[a],n.format!==THREE.RGBAFormat&&n.format!==THREE.RGBFormat?i.getCompressedTextureFormats().indexOf(e)>-1?i.compressedTexImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+f,a,e,s.width,s.height,0,s.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setCubeTexture()"):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+f,a,e,s.width,s.height,0,e,p,s.data);else y?i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+f,0,e,o[f].width,o[f].height,0,e,p,o[f].data):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+f,0,e,e,p,o[f]);if(n.generateMipmaps&&d&&t.generateMipmap(t.TEXTURE_CUBE_MAP),c.__version=n.version,n.onUpdate)n.onUpdate(n)}else i.activeTexture(t.TEXTURE0+r),i.bindTexture(t.TEXTURE_CUBE_MAP,c.__image__webglTextureCube)}function pi(n,r){i.activeTexture(t.TEXTURE0+r);i.bindTexture(t.TEXTURE_CUBE_MAP,u.get(n).__webglTexture)}function wi(n,i,r){t.bindFramebuffer(t.FRAMEBUFFER,n);t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,r,u.get(i.texture).__webglTexture,0)}function bi(n,i){t.bindRenderbuffer(t.RENDERBUFFER,n);i.depthBuffer&&!i.stencilBuffer?(t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,i.width,i.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,n)):i.depthBuffer&&i.stencilBuffer?(t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,i.width,i.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,n)):t.renderbufferStorage(t.RENDERBUFFER,t.RGBA4,i.width,i.height)}function ki(n){return n===THREE.NearestFilter||n===THREE.NearestMipMapNearestFilter||n===THREE.NearestMipMapLinearFilter?t.NEAREST:t.LINEAR}function h(n){var i;if(n===THREE.RepeatWrapping)return t.REPEAT;if(n===THREE.ClampToEdgeWrapping)return t.CLAMP_TO_EDGE;if(n===THREE.MirroredRepeatWrapping)return t.MIRRORED_REPEAT;if(n===THREE.NearestFilter)return t.NEAREST;if(n===THREE.NearestMipMapNearestFilter)return t.NEAREST_MIPMAP_NEAREST;if(n===THREE.NearestMipMapLinearFilter)return t.NEAREST_MIPMAP_LINEAR;if(n===THREE.LinearFilter)return t.LINEAR;if(n===THREE.LinearMipMapNearestFilter)return t.LINEAR_MIPMAP_NEAREST;if(n===THREE.LinearMipMapLinearFilter)return t.LINEAR_MIPMAP_LINEAR;if(n===THREE.UnsignedByteType)return t.UNSIGNED_BYTE;if(n===THREE.UnsignedShort4444Type)return t.UNSIGNED_SHORT_4_4_4_4;if(n===THREE.UnsignedShort5551Type)return t.UNSIGNED_SHORT_5_5_5_1;if(n===THREE.UnsignedShort565Type)return t.UNSIGNED_SHORT_5_6_5;if(n===THREE.ByteType)return t.BYTE;if(n===THREE.ShortType)return t.SHORT;if(n===THREE.UnsignedShortType)return t.UNSIGNED_SHORT;if(n===THREE.IntType)return t.INT;if(n===THREE.UnsignedIntType)return t.UNSIGNED_INT;if(n===THREE.FloatType)return t.FLOAT;if(i=r.get("OES_texture_half_float"),i!==null&&n===THREE.HalfFloatType)return i.HALF_FLOAT_OES;if(n===THREE.AlphaFormat)return t.ALPHA;if(n===THREE.RGBFormat)return t.RGB;if(n===THREE.RGBAFormat)return t.RGBA;if(n===THREE.LuminanceFormat)return t.LUMINANCE;if(n===THREE.LuminanceAlphaFormat)return t.LUMINANCE_ALPHA;if(n===THREE.AddEquation)return t.FUNC_ADD;if(n===THREE.SubtractEquation)return t.FUNC_SUBTRACT;if(n===THREE.ReverseSubtractEquation)return t.FUNC_REVERSE_SUBTRACT;if(n===THREE.ZeroFactor)return t.ZERO;if(n===THREE.OneFactor)return t.ONE;if(n===THREE.SrcColorFactor)return t.SRC_COLOR;if(n===THREE.OneMinusSrcColorFactor)return t.ONE_MINUS_SRC_COLOR;if(n===THREE.SrcAlphaFactor)return t.SRC_ALPHA;if(n===THREE.OneMinusSrcAlphaFactor)return t.ONE_MINUS_SRC_ALPHA;if(n===THREE.DstAlphaFactor)return t.DST_ALPHA;if(n===THREE.OneMinusDstAlphaFactor)return t.ONE_MINUS_DST_ALPHA;if(n===THREE.DstColorFactor)return t.DST_COLOR;if(n===THREE.OneMinusDstColorFactor)return t.ONE_MINUS_DST_COLOR;if(n===THREE.SrcAlphaSaturateFactor)return t.SRC_ALPHA_SATURATE;if(i=r.get("WEBGL_compressed_texture_s3tc"),i!==null){if(n===THREE.RGB_S3TC_DXT1_Format)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(n===THREE.RGBA_S3TC_DXT1_Format)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(n===THREE.RGBA_S3TC_DXT3_Format)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(n===THREE.RGBA_S3TC_DXT5_Format)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(i=r.get("WEBGL_compressed_texture_pvrtc"),i!==null){if(n===THREE.RGB_PVRTC_4BPPV1_Format)return i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(n===THREE.RGB_PVRTC_2BPPV1_Format)return i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(n===THREE.RGBA_PVRTC_4BPPV1_Format)return i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(n===THREE.RGBA_PVRTC_2BPPV1_Format)return i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(i=r.get("EXT_blend_minmax"),i!==null){if(n===THREE.MinEquation)return i.MIN_EXT;if(n===THREE.MaxEquation)return i.MAX_EXT}return 0}var t,yt,r,ri,ui,a,y;n=n||{};var s=n.canvas!==undefined?n.canvas:document.createElement("canvas"),di=n.context!==undefined?n.context:null,kt=s.width,dt=s.height,e=1,gi=n.alpha!==undefined?n.alpha:!1,nr=n.depth!==undefined?n.depth:!0,tr=n.stencil!==undefined?n.stencil:!0,ir=n.antialias!==undefined?n.antialias:!1,gt=n.premultipliedAlpha!==undefined?n.premultipliedAlpha:!0,rr=n.preserveDrawingBuffer!==undefined?n.preserveDrawingBuffer:!1,c=new THREE.Color(0),w=0,ni=[];this.domElement=s;this.context=null;this.autoClear=!0;this.autoClearColor=!0;this.autoClearDepth=!0;this.autoClearStencil=!0;this.sortObjects=!0;this.gammaFactor=2;this.gammaInput=!1;this.gammaOutput=!1;this.maxMorphTargets=8;this.maxMorphNormals=4;this.autoScaleCubemaps=!0;var v=this,lt=null,et=null,k=-1,ot="",d=null,at=0,g=0,nt=0,tt=s.width,it=s.height,ur=0,fr=0,ti=new THREE.Frustum,vt=new THREE.Matrix4,f=new THREE.Vector3,o=new THREE.Vector3,st=!0,ii={ambient:[0,0,0],directional:{length:0,colors:[],positions:[]},point:{length:0,colors:[],positions:[],distances:[],decays:[]},spot:{length:0,colors:[],positions:[],distances:[],directions:[],anglesCos:[],exponents:[],decays:[]},hemi:{length:0,skyColors:[],groundColors:[],positions:[]}},b={geometries:0,textures:0},p={calls:0,vertices:0,faces:0,points:0};this.info={render:p,memory:b,programs:null};try{if(yt={alpha:gi,depth:nr,stencil:tr,antialias:ir,premultipliedAlpha:gt,preserveDrawingBuffer:rr},t=di||s.getContext("webgl",yt)||s.getContext("experimental-webgl",yt),t===null)if(s.getContext("webgl")!==null)throw"Error creating WebGL context with your selected attributes.";else throw"Error creating WebGL context.";s.addEventListener("webglcontextlost",oi,!1)}catch(er){console.error("THREE.WebGLRenderer: "+er)}r=new THREE.WebGLExtensions(t);r.get("OES_texture_float");r.get("OES_texture_float_linear");r.get("OES_texture_half_float");r.get("OES_texture_half_float_linear");r.get("OES_standard_derivatives");r.get("ANGLE_instanced_arrays");r.get("OES_element_index_uint")&&(THREE.BufferGeometry.MaxIndex=4294967296);var l=new THREE.WebGLCapabilities(t,r,n),i=new THREE.WebGLState(t,r,h),u=new THREE.WebGLProperties,rt=new THREE.WebGLObjectsExt(t,u,this.info),ut=new THREE.WebGLPrograms(this,l);this.info.programs=ut.programs;ri=new THREE.WebGLBufferRenderer(t,r,p);ui=new THREE.WebGLIndexedBufferRenderer(t,r,p);fi();this.context=t;this.capabilities=l;this.extensions=r;this.state=i;a=new THREE.WebGLShadowMap(this,ni);this.shadowMap=a;this.getContext=function(){return t};this.getContextAttributes=function(){return t.getContextAttributes()};this.forceContextLoss=function(){r.get("WEBGL_lose_context").loseContext()};this.getMaxAnisotropy=function(){var n;return function(){if(n!==undefined)return n;var i=r.get("EXT_texture_filter_anisotropic");return n=i!==null?t.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0}}();this.getPrecision=function(){return l.precision};this.getPixelRatio=function(){return e};this.setPixelRatio=function(n){n!==undefined&&(e=n)};this.getSize=function(){return{width:kt,height:dt}};this.setSize=function(n,t,i){kt=n;dt=t;s.width=n*e;s.height=t*e;i!==!1&&(s.style.width=n+"px",s.style.height=t+"px");this.setViewport(0,0,n,t)};this.setViewport=function(n,i,r,u){g=n*e;nt=i*e;tt=r*e;it=u*e;t.viewport(g,nt,tt,it)};this.getViewport=function(n){n.x=g/e;n.y=nt/e;n.z=tt/e;n.w=it/e};this.setScissor=function(n,i,r,u){t.scissor(n*e,i*e,r*e,u*e)};this.enableScissorTest=function(n){i.setScissorTest(n)};this.getClearColor=function(){return c};this.setClearColor=function(n,t){c.set(n);w=t!==undefined?t:1;pt(c.r,c.g,c.b,w)};this.getClearAlpha=function(){return w};this.setClearAlpha=function(n){w=n;pt(c.r,c.g,c.b,w)};this.clear=function(n,i,r){var u=0;(n===undefined||n)&&(u|=t.COLOR_BUFFER_BIT);(i===undefined||i)&&(u|=t.DEPTH_BUFFER_BIT);(r===undefined||r)&&(u|=t.STENCIL_BUFFER_BIT);t.clear(u)};this.clearColor=function(){t.clear(t.COLOR_BUFFER_BIT)};this.clearDepth=function(){t.clear(t.DEPTH_BUFFER_BIT)};this.clearStencil=function(){t.clear(t.STENCIL_BUFFER_BIT)};this.clearTarget=function(n,t,i,r){this.setRenderTarget(n);this.clear(t,i,r)};this.resetGLState=ei;this.dispose=function(){s.removeEventListener("webglcontextlost",oi,!1)};this.renderBufferImmediate=function(n,r,f){var s,h,e,v;if(i.initAttributes(),s=u.get(n),n.hasPositions&&!s.position&&(s.position=t.createBuffer()),n.hasNormals&&!s.normal&&(s.normal=t.createBuffer()),n.hasUvs&&!s.uv&&(s.uv=t.createBuffer()),n.hasColors&&!s.color&&(s.color=t.createBuffer()),h=r.getAttributes(),n.hasPositions&&(t.bindBuffer(t.ARRAY_BUFFER,s.position),t.bufferData(t.ARRAY_BUFFER,n.positionArray,t.DYNAMIC_DRAW),i.enableAttribute(h.position),t.vertexAttribPointer(h.position,3,t.FLOAT,!1,0,0)),n.hasNormals){if(t.bindBuffer(t.ARRAY_BUFFER,s.normal),f.type!=="MeshPhongMaterial"&&f.shading===THREE.FlatShading)for(e=0,v=n.count*3;e<v;e+=9){var o=n.normalArray,c=(o[e+0]+o[e+3]+o[e+6])/3,l=(o[e+1]+o[e+4]+o[e+7])/3,a=(o[e+2]+o[e+5]+o[e+8])/3;o[e+0]=c;o[e+1]=l;o[e+2]=a;o[e+3]=c;o[e+4]=l;o[e+5]=a;o[e+6]=c;o[e+7]=l;o[e+8]=a}t.bufferData(t.ARRAY_BUFFER,n.normalArray,t.DYNAMIC_DRAW);i.enableAttribute(h.normal);t.vertexAttribPointer(h.normal,3,t.FLOAT,!1,0,0)}n.hasUvs&&f.map&&(t.bindBuffer(t.ARRAY_BUFFER,s.uv),t.bufferData(t.ARRAY_BUFFER,n.uvArray,t.DYNAMIC_DRAW),i.enableAttribute(h.uv),t.vertexAttribPointer(h.uv,2,t.FLOAT,!1,0,0));n.hasColors&&f.vertexColors!==THREE.NoColors&&(t.bindBuffer(t.ARRAY_BUFFER,s.color),t.bufferData(t.ARRAY_BUFFER,n.colorArray,t.DYNAMIC_DRAW),i.enableAttribute(h.color),t.vertexAttribPointer(h.color,3,t.FLOAT,!1,0,0));i.disableUnusedAttributes();t.drawArrays(t.TRIANGLES,0,n.count);n.count=0};this.renderBufferDirect=function(n,r,u,f,o,s){var c,p,h,l,a,v,y;f=rt.update(s);ar(o);var w=yr(n,r,u,o,s),b=!1,k=f.id+w.id;k!==ot&&(ot=k,b=!0);c=f.index;p=f.attributes.position;c!==null?(h=ui,h.setIndex(c)):h=ri;b&&(cr(o,w,f),c!==null&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,rt.getAttributeBuffer(c)));l=Infinity;c!==null?l=c.count:p!==undefined&&(l=p.count);a=0;v=l;s instanceof THREE.Mesh?(o.wireframe===!0?(i.setLineWidth(o.wireframeLinewidth*e),h.setMode(t.LINES)):h.setMode(t.TRIANGLES),f instanceof THREE.InstancedBufferGeometry&&f.maxInstancedCount>0?h.renderInstances(f):h.render(a,v)):s instanceof THREE.Line?(y=o.linewidth,y===undefined&&(y=1),i.setLineWidth(y*e),s instanceof THREE.LineSegments?h.setMode(t.LINES):h.setMode(t.LINE_STRIP),h.render(a,v)):s instanceof THREE.Points&&(h.setMode(t.POINTS),h.render(a,v))};this.setFaceCulling=function(n,r){n===THREE.CullFaceNone?i.disable(t.CULL_FACE):(r===THREE.FrontFaceDirectionCW?t.frontFace(t.CW):t.frontFace(t.CCW),n===THREE.CullFaceBack?t.cullFace(t.BACK):n===THREE.CullFaceFront?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK),i.enable(t.CULL_FACE))};this.setTexture=function(n,r){var f=u.get(n),e;if(n.version>0&&f.__version!==n.version){if(e=n.image,e===undefined){console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined",n);return}if(e.complete===!1){console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete",n);return}uu(f,n,r);return}i.activeTexture(t.TEXTURE0+r);i.bindTexture(t.TEXTURE_2D,f.__webglTexture)};this.setRenderTarget=function(n){var s=n instanceof THREE.WebGLRenderTargetCube,f,o,a,v,y,p,r,e;if(n&&u.get(n).__webglFramebuffer===undefined){r=u.get(n);e=u.get(n.texture);n.depthBuffer===undefined&&(n.depthBuffer=!0);n.stencilBuffer===undefined&&(n.stencilBuffer=!0);n.addEventListener("dispose",si);e.__webglTexture=t.createTexture();b.textures++;var c=ct(n),l=h(n.texture.format),w=h(n.texture.type);if(s){for(r.__webglFramebuffer=[],r.__webglRenderbuffer=[],i.bindTexture(t.TEXTURE_CUBE_MAP,e.__webglTexture),ht(t.TEXTURE_CUBE_MAP,n.texture,c),f=0;f<6;f++)r.__webglFramebuffer[f]=t.createFramebuffer(),r.__webglRenderbuffer[f]=t.createRenderbuffer(),i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+f,0,l,n.width,n.height,0,l,w,null),wi(r.__webglFramebuffer[f],n,t.TEXTURE_CUBE_MAP_POSITIVE_X+f),bi(r.__webglRenderbuffer[f],n);n.texture.generateMipmaps&&c&&t.generateMipmap(t.TEXTURE_CUBE_MAP)}else r.__webglFramebuffer=t.createFramebuffer(),r.__webglRenderbuffer=n.shareDepthFrom?n.shareDepthFrom.__webglRenderbuffer:t.createRenderbuffer(),i.bindTexture(t.TEXTURE_2D,e.__webglTexture),ht(t.TEXTURE_2D,n.texture,c),i.texImage2D(t.TEXTURE_2D,0,l,n.width,n.height,0,l,w,null),wi(r.__webglFramebuffer,n,t.TEXTURE_2D),n.shareDepthFrom?n.depthBuffer&&!n.stencilBuffer?t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,r.__webglRenderbuffer):n.depthBuffer&&n.stencilBuffer&&t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,r.__webglRenderbuffer):bi(r.__webglRenderbuffer,n),n.texture.generateMipmaps&&c&&t.generateMipmap(t.TEXTURE_2D);s?i.bindTexture(t.TEXTURE_CUBE_MAP,null):i.bindTexture(t.TEXTURE_2D,null);t.bindRenderbuffer(t.RENDERBUFFER,null);t.bindFramebuffer(t.FRAMEBUFFER,null)}n?(r=u.get(n),o=s?r.__webglFramebuffer[n.activeCubeFace]:r.__webglFramebuffer,a=n.width,v=n.height,y=0,p=0):(o=null,a=tt,v=it,y=g,p=nt);o!==et&&(t.bindFramebuffer(t.FRAMEBUFFER,o),t.viewport(y,p,a,v),et=o);s&&(e=u.get(n.texture),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+n.activeCubeFace,e.__webglTexture,0));ur=a;fr=v};this.readRenderTargetPixels=function(n,i,f,e,o,s){var l,a,c;if(n instanceof THREE.WebGLRenderTarget==!1){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");return}if(l=u.get(n).__webglFramebuffer,l){a=!1;l!==et&&(t.bindFramebuffer(t.FRAMEBUFFER,l),a=!0);try{if(c=n.texture,c.format!==THREE.RGBAFormat&&h(c.format)!==t.getParameter(t.IMPLEMENTATION_COLOR_READ_FORMAT)){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");return}if(c.type!==THREE.UnsignedByteType&&h(c.type)!==t.getParameter(t.IMPLEMENTATION_COLOR_READ_TYPE)&&!(c.type===THREE.FloatType&&r.get("WEBGL_color_buffer_float"))&&!(c.type===THREE.HalfFloatType&&r.get("EXT_color_buffer_half_float"))){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");return}t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE?t.readPixels(i,f,e,o,h(c.format),h(c.type),s):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{a&&t.bindFramebuffer(t.FRAMEBUFFER,et)}}};this.supportsFloatTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),r.get("OES_texture_float")};this.supportsHalfFloatTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),r.get("OES_texture_half_float")};this.supportsStandardDerivatives=function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),r.get("OES_standard_derivatives")};this.supportsCompressedTextureS3TC=function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),r.get("WEBGL_compressed_texture_s3tc")};this.supportsCompressedTexturePVRTC=function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),r.get("WEBGL_compressed_texture_pvrtc")};this.supportsBlendMinMax=function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),r.get("EXT_blend_minmax")};this.supportsVertexTextures=function(){return l.vertexTextures};this.supportsInstancedArrays=function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),r.get("ANGLE_instanced_arrays")};this.initMaterial=function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")};this.addPrePlugin=function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")};this.addPostPlugin=function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")};this.updateShadowMap=function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")};Object.defineProperties(this,{shadowMapEnabled:{get:function(){return a.enabled},set:function(n){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled.");a.enabled=n}},shadowMapType:{get:function(){return a.type},set:function(n){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type.");a.type=n}},shadowMapCullFace:{get:function(){return a.cullFace},set:function(n){console.warn("THREE.WebGLRenderer: .shadowMapCullFace is now .shadowMap.cullFace.");a.cullFace=n}},shadowMapDebug:{get:function(){return a.debug},set:function(n){console.warn("THREE.WebGLRenderer: .shadowMapDebug is now .shadowMap.debug.");a.debug=n}}});y=new CLOUD.OrderedRenderer;this.destroy=function(){CLOUD.GeomUtil.destroyUnitInstances();rt=new THREE.WebGLObjectsExt(t,u,this.info);y.destroy();u.clear()};this.IncrementRender=function(n,t,r,u){if(t instanceof THREE.Camera==!1){console.error("THREE.WebGLIncrementRenderer.IncrementRender: camera is not an instance of THREE.Camera.");return}return ot="",k=-1,d=null,st=!0,n.autoUpdate===!0&&n.updateMatrixWorld(),t.parent===null&&t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),vt.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),ti.setFromMatrix(vt),p.calls=0,p.vertices=0,p.faces=0,p.points=0,y.update(ti,vt),y.render(this,n,t,ni,r,u,i)};this.resetIncrementRender=function(){y.restart()};this.setFilterObject=function(n){y.setFilter(n)};this.setObjectListUpdateState=function(n){y.updateObjectList(n)};this.computeSelectionBBox=function(){return y.computeSelectionBBox()};this.computeRenderObjectsBox=function(){return y.computeRenderObjectsBox()};this.setRenderTicket=function(n){rt.renderTicket=n}};CLOUD.BBoxNode=function(n,t){"use strict";var i=new THREE.BufferGeometry;i.addAttribute("position",new THREE.BufferAttribute(new Float32Array(72),3));THREE.LineSegments.call(this,i,new THREE.LineBasicMaterial({color:t}));n!==undefined&&this.updateBBox(n)};CLOUD.BBoxNode.prototype=Object.create(THREE.LineSegments.prototype);CLOUD.BBoxNode.prototype.constructor=CLOUD.BBoxNode;CLOUD.BBoxNode.prototype.unload=function(){};CLOUD.BBoxNode.prototype.updateBBox=function(n){var i=n.min,r=n.max,t=this.geometry.attributes.position.array;t[0]=r.x;t[1]=r.y;t[2]=r.z;t[3]=i.x;t[4]=r.y;t[5]=r.z;t[6]=i.x;t[7]=r.y;t[8]=r.z;t[9]=i.x;t[10]=i.y;t[11]=r.z;t[12]=i.x;t[13]=i.y;t[14]=r.z;t[15]=r.x;t[16]=i.y;t[17]=r.z;t[18]=r.x;t[19]=i.y;t[20]=r.z;t[21]=r.x;t[22]=r.y;t[23]=r.z;t[24]=r.x;t[25]=r.y;t[26]=i.z;t[27]=i.x;t[28]=r.y;t[29]=i.z;t[30]=i.x;t[31]=r.y;t[32]=i.z;t[33]=i.x;t[34]=i.y;t[35]=i.z;t[36]=i.x;t[37]=i.y;t[38]=i.z;t[39]=r.x;t[40]=i.y;t[41]=i.z;t[42]=r.x;t[43]=i.y;t[44]=i.z;t[45]=r.x;t[46]=r.y;t[47]=i.z;t[48]=r.x;t[49]=r.y;t[50]=r.z;t[51]=r.x;t[52]=r.y;t[53]=i.z;t[54]=i.x;t[55]=r.y;t[56]=r.z;t[57]=i.x;t[58]=r.y;t[59]=i.z;t[60]=i.x;t[61]=i.y;t[62]=r.z;t[63]=i.x;t[64]=i.y;t[65]=i.z;t[66]=r.x;t[67]=i.y;t[68]=r.z;t[69]=r.x;t[70]=i.y;t[71]=i.z;this.geometry.attributes.position.needsUpdate=!0;this.geometry.computeBoundingBox();this.geometry.computeBoundingSphere();this.matrixAutoUpdate=!1};THREE.CombinedCamera=function(n,t,i,r,u){THREE.Camera.call(this);this.aspect=n/t;this.fov=i;this.near=r;this.far=u;this.left=-n/2;this.right=n/2;this.top=t/2;this.bottom=-t/2;this.cameraOrtho=new THREE.OrthographicCamera(this.left,this.right,this.top,this.bottom,this.near,this.far);this.cameraPerspective=new THREE.PerspectiveCamera(this.fov,this.aspect,this.near,this.far);this.zoom=1;this.toPerspective()};THREE.CombinedCamera.prototype=Object.create(THREE.Camera.prototype);THREE.CombinedCamera.prototype.constructor=THREE.CombinedCamera;THREE.CombinedCamera.prototype.toPerspective=function(){this.near=this.cameraPerspective.near;this.far=this.cameraPerspective.far;this.cameraPerspective.fov=this.fov/this.zoom;this.cameraPerspective.updateProjectionMatrix();this.projectionMatrix=this.cameraPerspective.projectionMatrix;this.isPerspective=!0};THREE.CombinedCamera.prototype.toOrthographic=function(){var i=this.fov,r=this.cameraPerspective.aspect,u=this.cameraPerspective.near,f=this.cameraPerspective.far,e=(u+f)/2,n=Math.tan(i*Math.PI/360)*e,o=2*n,s=o*r,t=s/2;n/=this.zoom;t/=this.zoom;this.cameraOrtho.left=-t;this.cameraOrtho.right=t;this.cameraOrtho.top=n;this.cameraOrtho.bottom=-n;this.cameraOrtho.updateProjectionMatrix();this.near=this.cameraOrtho.near;this.far=this.cameraOrtho.far;this.projectionMatrix=this.cameraOrtho.projectionMatrix;this.isPerspective=!1};THREE.CombinedCamera.prototype.setSize=function(n,t){this.cameraPerspective.aspect=n/t;this.left=-n/2;this.right=n/2;this.top=t/2;this.bottom=-t/2;this.aspect=n/t};THREE.CombinedCamera.prototype.setFov=function(n){this.fov=n;this.isPerspective?this.toPerspective():this.toOrthographic()};THREE.CombinedCamera.prototype.setNearFar=function(n,t){this.isPerspective?(this.cameraPerspective.near=n,this.cameraPerspective.far=t,this.toPerspective()):(this.cameraOrtho.near=n,this.cameraOrtho.far=t,this.toOrthographic())};THREE.CombinedCamera.prototype.updateProjectionMatrix=function(){this.isPerspective?this.toPerspective():this.toOrthographic()};THREE.CombinedCamera.prototype.setLens=function(n,t){t===undefined&&(t=24);var i=2*THREE.Math.radToDeg(Math.atan(t/(n*2)));return this.setFov(i),i};THREE.CombinedCamera.prototype.setZoom=function(n){this.zoom=n;this.isPerspective?this.toPerspective():this.toOrthographic()};CLOUD.ShaderMaterial=CLOUD.ShaderMaterial||{};CLOUD.ShaderMaterial.ShaderChunk={cust_clip_pars_vertex:"#ifdef USE_CUSTOMCLIP\n\n    uniform vec4 vClipPlane[6]; \n\n    uniform int iClipPlane; \n\n    varying float fClipDistance[6];\n\n#endif\n",cust_clip_pars_fragment:"#ifdef USE_CUSTOMCLIP\n\n    uniform int iClipPlane; \n\n    varying float fClipDistance[6];\n\n#endif\n",cust_clip_vertex:"#ifdef USE_CUSTOMCLIP\n\n for(int i = 0; i < 6; i++) {\n     if (i < iClipPlane)\n         fClipDistance[i] = dot(worldPosition.xyz, vClipPlane[i].xyz) + vClipPlane[i].w;\n  }\n#endif\n",cust_clip_fragment:"#ifdef USE_CUSTOMCLIP\n\nfor(int i = 0; i < 6; i++) {\n\n    if (i < iClipPlane)\n       if (fClipDistance[i] > 0.0) discard;\n\n}\n\n#endif\n",cust_Instanced_pars_vertex:"#ifdef USE_CUST_INSTANCED\n\n    attribute vec4 componentV1;\nattribute vec4 componentV2;\nattribute vec4 componentV3;\nattribute vec4 componentV4;\n#endif\n",cust_Instanced_normal_vertex:"#ifdef USE_CUST_INSTANCED\n\n\tmat4 modelTransMatrix = mat4(componentV1, componentV2, componentV3,componentV4);\n\t objectNormal = inverseTransformDirection(objectNormal, modelTransMatrix);\n#endif\n",cust_Instanced_vertex:"#ifdef USE_CUST_INSTANCED\n\n\tvec4 newposition = mat4(componentV1, componentV2, componentV3,componentV4) * vec4( transformed, 1.0 );\n\t transformed = newposition.xyz;\n#endif\n",cust_Instanced_pars_vertex2:"#ifdef USE_CUST_INSTANCED\n\n  uniform mat4 transformMatrix; \n#endif\n",cust_Instanced_vertex2:"#ifdef USE_CUST_INSTANCED\n\n\tvec4 newposition = transformMatrix * vec4( transformed, 1.0 );\n\t transformed = newposition.xyz;\n#endif\n"};CLOUD.ShaderMaterial.UniformsLib={cust_clip:{iClipPlane:{type:"i",value:0},vClipPlane:{type:"v4v",value:[new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4]}},cus_Instanced:{transformMatrix:{type:"m4",value:new THREE.Matrix4}}};CLOUD.ShaderMaterial.ShaderLibs={r73:{phong_cust_clip:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.aomap,THREE.UniformsLib.lightmap,THREE.UniformsLib.emissivemap,THREE.UniformsLib.bumpmap,THREE.UniformsLib.normalmap,THREE.UniformsLib.displacementmap,THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,CLOUD.ShaderMaterial.UniformsLib.cust_clip,{emissive:{type:"c",value:new THREE.Color(0)},specular:{type:"c",value:new THREE.Color(1118481)},shininess:{type:"f",value:30}}]),vertexShader:["#define USE_CUSTOMCLIP","#define PHONG","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","    varying vec3 vNormal;","#endif",THREE.ShaderChunk.common,THREE.ShaderChunk.uv_pars_vertex,THREE.ShaderChunk.uv2_pars_vertex,THREE.ShaderChunk.displacementmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.lights_phong_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,THREE.ShaderChunk.logdepthbuf_pars_vertex,CLOUD.ShaderMaterial.ShaderChunk.cust_clip_pars_vertex,CLOUD.ShaderMaterial.ShaderChunk.cust_Instanced_pars_vertex,"void main() {",THREE.ShaderChunk.uv_vertex,THREE.ShaderChunk.uv2_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.beginnormal_vertex,CLOUD.ShaderMaterial.ShaderChunk.cust_Instanced_normal_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,"#ifndef FLAT_SHADED","    vNormal = normalize( transformedNormal );","#endif",THREE.ShaderChunk.begin_vertex,CLOUD.ShaderMaterial.ShaderChunk.cust_Instanced_vertex,THREE.ShaderChunk.displacementmap_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.project_vertex,THREE.ShaderChunk.logdepthbuf_vertex,"    vViewPosition = - mvPosition.xyz;",THREE.ShaderChunk.worldpos_vertex,CLOUD.ShaderMaterial.ShaderChunk.cust_clip_vertex,THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.lights_phong_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["#define USE_CUSTOMCLIP",CLOUD.ShaderMaterial.ShaderChunk.cust_clip_pars_fragment,"#define PHONG","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform float opacity;",THREE.ShaderChunk.common,THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.uv_pars_fragment,THREE.ShaderChunk.uv2_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.alphamap_pars_fragment,THREE.ShaderChunk.aomap_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.emissivemap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.lights_phong_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.bumpmap_pars_fragment,THREE.ShaderChunk.normalmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,THREE.ShaderChunk.logdepthbuf_pars_fragment,"void main() {",CLOUD.ShaderMaterial.ShaderChunk.cust_clip_fragment,"    vec3 outgoingLight = vec3( 0.0 );","    vec4 diffuseColor = vec4( diffuse, opacity );","    vec3 totalAmbientLight = ambientLightColor;","    vec3 totalEmissiveLight = emissive;","    vec3 shadowMask = vec3( 1.0 );",THREE.ShaderChunk.logdepthbuf_fragment,THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.alphamap_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.normal_phong_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.hemilight_fragment,THREE.ShaderChunk.aomap_fragment,THREE.ShaderChunk.emissivemap_fragment,THREE.ShaderChunk.lights_phong_fragment,THREE.ShaderChunk.shadowmap_fragment,"totalDiffuseLight *= shadowMask;","totalSpecularLight *= shadowMask;","#ifdef METAL","    outgoingLight += diffuseColor.rgb * ( totalDiffuseLight + totalAmbientLight ) * specular + totalSpecularLight + totalEmissiveLight;","#else","    outgoingLight += diffuseColor.rgb * ( totalDiffuseLight + totalAmbientLight ) + totalSpecularLight + totalEmissiveLight;","#endif",THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"    gl_FragColor = vec4( outgoingLight, diffuseColor.a );","}"].join("\n")},base_cust_clip:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.aomap,THREE.UniformsLib.fog,THREE.UniformsLib.shadowmap,CLOUD.ShaderMaterial.UniformsLib.cust_clip,CLOUD.ShaderMaterial.UniformsLib.cus_Instanced]),vertexShader:[THREE.ShaderChunk.common,THREE.ShaderChunk.uv_pars_vertex,THREE.ShaderChunk.uv2_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,THREE.ShaderChunk.logdepthbuf_pars_vertex,"#define USE_CUSTOMCLIP",CLOUD.ShaderMaterial.ShaderChunk.cust_clip_pars_vertex,CLOUD.ShaderMaterial.ShaderChunk.cust_Instanced_pars_vertex2,"void main() {",THREE.ShaderChunk.uv_vertex,THREE.ShaderChunk.uv2_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.skinbase_vertex,"    #ifdef USE_ENVMAP",THREE.ShaderChunk.beginnormal_vertex,CLOUD.ShaderMaterial.ShaderChunk.cust_Instanced_normal_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,"    #endif",THREE.ShaderChunk.begin_vertex,CLOUD.ShaderMaterial.ShaderChunk.cust_Instanced_vertex2,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.project_vertex,THREE.ShaderChunk.logdepthbuf_vertex,THREE.ShaderChunk.worldpos_vertex,"vec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );",CLOUD.ShaderMaterial.ShaderChunk.cust_clip_vertex,THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["#define USE_CUSTOMCLIP","uniform vec3 diffuse;","uniform float opacity;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.alphamap_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,THREE.ShaderChunk.logdepthbuf_pars_fragment,CLOUD.ShaderMaterial.ShaderChunk.cust_clip_pars_fragment,"void main() {",CLOUD.ShaderMaterial.ShaderChunk.cust_clip_fragment,"    vec3 outgoingLight = vec3( 0.0 );","    vec4 diffuseColor = vec4( diffuse, opacity );","    vec3 totalAmbientLight = vec3( 1.0 );","    vec3 shadowMask = vec3( 1.0 );",THREE.ShaderChunk.logdepthbuf_fragment,THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.alphamap_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.aomap_fragment,THREE.ShaderChunk.shadowmap_fragment,"    outgoingLight = diffuseColor.rgb * totalAmbientLight * shadowMask;",THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.fog_fragment,"    gl_FragColor = vec4( outgoingLight, diffuseColor.a );","}"].join("\n")}}};CLOUD.ShaderMaterial.ShaderLib=CLOUD.ShaderMaterial.ShaderLibs["r"+THREE.REVISION];CLOUD.ShaderMaterial.ShaderLib===undefined&&CLOUD.Logger.log("custom clip not implemented for three.js r"+THREE.REVISION+" yet!");CLOUD.Animation=function(){var i=this,n=null,s={},h={},c=1e3,l=null,t=null,r=.9995,a=null,u=!1,f=null,e=null,o=null;this.from=function(t){n=t;for(var i in n)s[i]=n[i];return this};this.to=function(n,t){return t!==undefined&&(c=t),h=n,this};this.onStart=function(n){return f=n,this};this.onUpdate=function(n){return e=n,this};this.onComplete=function(n){return o=n,this};this.start=function(i){u=!1;t&&clearInterval(t);l=Date.now();a=this.interpolate;var r=function(){var i,r=s,v=h,y=Date.now();u===!1&&(f!==null&&f.call(n),u=!0);i=(y-l)/c;i=i>1?1:i;n=a(r,v,i);i===1?(clearInterval(t),o!==null&&o.call(n)):e!==null&&e.call(n,i)};t=setInterval(r,i)};this.isAngleGreaterThanPi=function(n,t,i){var r=new THREE.Vector3,u;return(r.crossVectors(n,t),u=r.dot(i),u>=0)?!1:!0};this.conicInterpolate=function(n,t,i,r,u){var o=-Math.PI*r,f,e;u&&(o*=-1);f=new THREE.Vector3;f.addVectors(t,n).normalize();e=new THREE.Quaternion;e.setFromAxisAngle(f,o);i.copy(n);i.applyQuaternion(e)};this.slerpInterpolate=function(n,t,i,r,u,f,e,o){var p=new THREE.Vector3(1,0,0),w=new THREE.Vector3(0,0,1),h=new THREE.Vector3,c=0,a=n.dot(t),v=new THREE.Quaternion(n.x,n.y,n.z,1).normalize(),y=new THREE.Quaternion(t.x,t.y,t.z,1).normalize(),l=new THREE.Quaternion(0,0,0,1),s=new THREE.Quaternion(0,0,0,1);e===undefined&&(e=!1);o===undefined&&(o=!1);f<a?r.copy(t):f<Math.abs(a)?(h.crossVectors(n,i).normalize(),l.set(h.x,h.y,h.z,1).normalize(),u<.5?(c=u*2,THREE.Quaternion.slerp(v,l,s,c),r.set(s.x,s.y,s.z)):(c=(u-.5)*2,THREE.Quaternion.slerp(l,y,s,c),r.set(s.x,s.y,s.z))):e?this.conicInterpolate(n,t,r,u,o):(THREE.Quaternion.slerp(v,y,s,u),r.set(s.x,s.y,s.z));r.normalize()};this.linearInterpolate=function(n,t,i,r,u){var h=new THREE.Vector3(1,0,0),o=new THREE.Vector3(0,0,1),f=new THREE.Vector3,e=0,s=n.dot(t);u<s?i.copy(t):u<-s?(u>Math.abs(n.dot(o))?f.crossVectors(n,o).normalize():f.crossVectors(n,h).normalize(),r<.5?(e=r*2,i.lerpVectors(n,f,e)):(e=(r-.5)*2,i.lerpVectors(f,t,e))):i.lerpVectors(n,t,r);i.normalize()};this.interpolate=function(n,t,u){var s=new THREE.Vector3,h=new THREE.Vector3,c=new THREE.Vector3,l=new THREE.Vector3,e=n.animDir,f=n.animUp,o=t.animDir,a=t.animUp;s.crossVectors(e,f);h.crossVectors(o,a);var v=s.dot(h),y=r-1,p=v<y?!0:!1,w=i.isAngleGreaterThanPi(e,o,f);return i.slerpInterpolate(e,o,f,c,u,r,p,w),i.linearInterpolate(f,a,l,u,r),{animDir:c,animUp:l}}};CLOUD.CameraAnimator=function(){var t=500,i=13,n=!1,r=new CLOUD.Animation;this.setDuration=function(n){t=n};this.setFrameTime=function(n){i=n};this.setStandardView=function(u,f,e,o){var c,h,k,d;n=!1;var v=function(n,t){var i=n.camera.zoomToBBox(t,e);n.cameraEditor.updateCamera(i);n.render();o&&o()},s=f.camera,p=CLOUD.GlobalData.SceneSize/2,w=.9995,y=s.getWorldDirection().clone();y.normalize();c=new THREE.Vector3;c.copy(s.realUp||s.up);c.normalize();var l=f.getScene().getBoundingBox(),b=s.setStandardView(u,l),a=s.getWorldDirection().clone();a.normalize();h=new THREE.Vector3;h.copy(s.realUp||s.up);h.normalize();k=y.dot(a);d=c.dot(h);w<k&&w<d?(v(f,l),s.up.copy(THREE.Object3D.DefaultUp)):(n=!0,r.from({animDir:y,animUp:c}).to({animDir:a,animUp:h},t).onUpdate(function(){f.viewHouse&&(f.viewHouse.isAnimationFinish=!1);var n=this.animDir,t=this.animUp;f.camera.LookAt(b,n,t,p);v(f,l)}).onComplete(function(){f.viewHouse&&(f.viewHouse.isAnimationFinish=!0);f.camera.LookAt(b,a,h,p);v(f,l);n=!1;f.camera.up.copy(THREE.Object3D.DefaultUp)}).start(i))};this.isPlaying=function(){return n}};CLOUD.Filter=function(){function a(){var r,i;if(t){n.visibleIds={};r=n.visibleIds;for(i in t)r[i]=t[i]}}function v(i){var u,r;if(t){n.invisibleIds=i?{}:n.invisibleIds||{};u=n.invisibleIds;for(r in t)u[r]=t[r]}else n.invisibleIds=null}function y(){if(t){f={};for(var n in t)f[n]=t[n]}}function p(n){if(t){i=n?{}:i||{};for(var r in t)i[r]=t[r]}else i=null}var r={};r.selection=CLOUD.MaterialUtil.createHighlightMaterial();r.scene=CLOUD.MaterialUtil.createPhongMaterial({color:8947848,opacity:.1,transparent:!0,side:THREE.DoubleSide});r.darkRed=CLOUD.MaterialUtil.createPhongMaterial({color:10496040,opacity:1,transparent:!1,side:THREE.DoubleSide});r.lightBlue=CLOUD.MaterialUtil.createPhongMaterial({color:1275840,opacity:1,transparent:!1,side:THREE.DoubleSide});r.black=CLOUD.MaterialUtil.createPhongMaterial({color:0,opacity:.3,transparent:!0,side:THREE.DoubleSide});r.add=CLOUD.MaterialUtil.createPhongMaterial({color:65280,opacity:1,transparent:!0,side:THREE.DoubleSide});r.delete=CLOUD.MaterialUtil.createPhongMaterial({color:16711680,opacity:.5,transparent:!0,side:THREE.DoubleSide});r.beforeEdit=CLOUD.MaterialUtil.createPhongMaterial({color:16432389,opacity:.5,transparent:!0,side:THREE.DoubleSide});r.afterEdit=CLOUD.MaterialUtil.createPhongMaterial({color:16432389,opacity:1,transparent:!0,side:THREE.DoubleSide});var n={},h={},c=!1,i=null,f=null,e=null,o={},u={},s=null,t=null,l=new THREE.Box3;this.saveState=function(){var r={};return r.version=1,r.filter=n,r.fileFilter=h,r.overriderByScene=c,i&&(r.frozenSet=i),f&&(r.isolateSet=f),e&&(r.isolateCondition=e),r.overriderByIds=o,r.overriderByData=u,s&&(r.overriderCondition=s),t&&(r.selectionSet=t),r};this.loadState=function(r){n=r.filter;h=r.fileFilter;c=r.overriderByScene;r.frozenSet!=undefined&&(i=r.frozenSet);r.isolateSet!=undefined&&(f=r.isolateSet);r.isolateCondition!=undefined&&(e=r.isolateCondition);o=r.overriderByIds;u=r.overriderByData;r.overriderCondition&&(s=r.overriderCondition);r.selectionSet!=undefined&&(t=r.selectionSet)};this.clear=function(){n={};h={};c=!1;o={};u={};t=null;i=null;f=null;e=null;s=null};this.getVisibleFilter=function(){return n};this.getFileFilter=function(){return h};this.getOverriderByUserId=function(){return o};this.getOverriderByUserData=function(){return u};this.getSelectionSet=function(){return t};this.getDemolishSet=function(){return i};this.setVisibleConditions=function(t){n.conditions=t};this.showByUserIds=function(t){var r,i,u;if(t)for(n.visibleIds={},r=n.visibleIds,i=0,u=t.length;i<u;++i)r[t[i]]=!0;else delete n.visibleIds};this.setFilterByUserIds=function(n){this.showByUserIds(n)};this.removeShownUserIds=function(t){var r,i,u,f;if(n.visibleIds){for(r=n.visibleIds,i=0,u=t.length;i<u;++i)delete r[t[i]];for(f in r)return;delete n.visibleIds}};this.hideByUserIds=function(t){var r,i,u;if(t)for(n.invisibleIds||(n.invisibleIds={}),r=n.invisibleIds,i=0,u=t.length;i<u;++i)r[t[i]]=!0;else delete n.invisibleIds};this.removeHiddenUserIds=function(t){var r,i,u,f;if(n.invisibleIds){for(r=n.invisibleIds,i=0,u=t.length;i<u;++i)delete r[t[i]];for(f in r)return;delete n.invisibleIds}};this.addFilterByUserIds=function(t){var r,i,u;if(t)for(n.visibleIds||(n.visibleIds={}),r=n.visibleIds,i=0,u=t.length;i<u;++i)r[t[i]]=!0};this.addUserFilter=function(t,i){var r=n.filters;r===undefined&&(n.filters={},r=n.filters);r[t]===undefined&&(r[t]={});r[t][i]=!0};this.removeUserFilter=function(t,i){var r=n.filters;r&&r[t]&&(i===undefined?delete r[t]:(r[t][i]&&delete r[t][i],Object.getOwnPropertyNames(r[t]).length==0&&delete r[t]))};this.getUserFilter=function(t){return n.filters?n.filters[t]:undefined};this.clearUserFilters=function(){n={}};this.addFileFilter=function(n){h[n]=0};this.removeFileFilter=function(n){n===undefined?h={}:h[n]!==undefined&&delete h[n]};this.hasFileFilter=function(n){return h[n]!==undefined};this.isFileFilter=function(n){var i=n.userData,t;return i&&(t=i.sceneId,t)?h[t]!==undefined:!1};this.isNotNullFileFilter=function(){for(var n in h)if(h.hasOwnProperty(n))return!0;return!1};this.enableSceneOverrider=function(n){c=n};this.isSceneOverriderEnabled=function(){return c};this.setOverriderMaterial=function(n,t){var i=r[n];return i?(i.color=t,i):(i=CLOUD.MaterialUtil.createHighlightMaterial({color:t}),r[n]=i,i)};this.setOverriderByUserIds=function(n,t,i){var r,u,f;if(n===undefined){o={};return}if(t===undefined)o[n]&&delete o[n];else{for(r={},r.material=i,r.ids={},u=0,f=t.length;u<f;++u)r.ids[t[u]]=!0;o[n]=r}};this.setUserOverrider=function(n,t,i){if(n===undefined){u={};return}t===undefined?u[n]&&delete u[n]:(u[n]||(u[n]={}),u[n][t]=i)};this.removeUserOverrider=function(n,t){if(n===undefined){u={};return}u[n]&&(t===undefined?delete u[n]:delete u[n][t])};this.setConditionOverrider=function(n){s=n};this.setSelectionMaterial=function(n){r.selection.color=n};this.setSelectedIds=function(n){if(n&&n.length>0){this.clearSelectionSet();t={};for(var i=0,r=n.length;i<r;++i)t[n[i]]=!0;return!0}return t?(this.clearSelectionSet(),!0):!1};this.addSelectedIds=function(n){if(n){t||(t={});for(var i=0,r=n.length;i<r;++i)t[n[i]]=!0}};this.removeSelectedId=function(n){return t&&t[n]?(delete t[n],this.isNullSelectionSet()&&(t=null),!0):!1};this.clearSelectionSet=function(){t=null};this.addSelectedId=function(n,i,r){return(t||(t={}),r&&this.removeSelectedId(n))?!1:(t[n]=i||!0,!0)};this.isNullSelectionSet=function(){for(var n in t)return!1;return!0};this.setDemolishIds=function(n){if(n&&n.length>0){this.clearDemolishSet();i={};for(var t=0,r=n.length;t<r;++t)i[n[t]]=!0}else i=null};this.addDemolishIds=function(n){if(n){i||(i={});for(var t=0,r=n.length;t<r;++t)i[n[t]]=!0}};this.addDemolishId=function(n,t){return(i||(i={}),t&&i[n])?(delete i[n],this.isNullDemolishSet()&&(i=null),!1):(i[n]=!0,!0)};this.isNullDemolishSet=function(){for(var n in i)return!1;return!0};this.clearDemolishSet=function(){i=null};this.setIsolateCondition=function(n){e=n};this.setIsolateByUserIds=function(n){if(n&&n.length>0){f={};for(var t=0,i=n.length;t<i;++t)f[n[t]]=!0}else f=null};this.isNullIsolateSet=function(){for(var n in f)return!1;return!0};this.isNullVisibleSet=function(){for(var t in n.visibleIds)return!1;return!0};this.isNullInVisibleSet=function(){for(var t in n.invisibleIds)return!1;return!0};this.isVisible=function(t){var e,i,r,o,s,u,h,f;if(t.customTag)return!0;if((e=t.name,n.visibleIds&&n.visibleIds[e]===undefined)||n.invisibleIds&&n.invisibleIds[e])return!1;if(i=t.userData,!i)return!0;if(r=n.filters,r)for(o in r)if(s=i[o],s&&r[o][s]!==undefined)return!1;if(u=n.conditions,u){if(h=u.length,h==0)return!1;function n(n){for(var t in n)if(n[t]!=i[t])return!1;return!0}for(f=0;f<h;++f)if(n(u[f]))return!0;return!1}return!0};this.isVisibleById=function(t,i){var r,e,o,u,s,f;if(n.visibleIds&&n.visibleIds[t]===undefined||n.invisibleIds&&n.invisibleIds[t])return!1;if(!i)return!0;if(r=n.filters,r)for(e in r)if(o=i[e],o&&r[e][o]!==undefined)return!1;if(u=n.conditions,u){if(s=u.length,s==0)return!1;function n(n){for(var t in n)if(n[t]!=i[t])return!1;return!0}for(f=0;f<s;++f)if(n(u[f]))return!0;return!1}return!0};this.isSelectable=function(n){var l=n.name,s,h,a,t,r,v;if(i&&i[l]||f&&!f[l])return!1;for(t in o)if(r=o[t],r.ids[l])return!0;if(s=n.userData,!s)return!0;if(e){function n(n){for(var t in n)if(n[t]!=s[t])return!1;return!0}for(h=0,a=e.length;h<a;++h)if(t=e[h],n(t))return!0}for(t in u)if(r=u[t],v=r[s[t]],v!==undefined)return!0;return c?!1:!0};this.getOverridedMaterial=function(n){var a,y,v,l,p,h;if(n.customTag)return null;if((a=n.name,i&&i[a])||f&&!f[a])return r.scene;if(t&&t[a]!==undefined)return r.selection;for(h in o)if(y=o[h],y.ids[a])return r[y.material];if(v=n.userData,!v)return null;for(h in u){var y=u[h],b=y[v[h]],w=r[b];if(w!==undefined)return w}if(s){function n(n){for(var t in n)if(n[t]!=v[t])return!1;return!0}for(l=0,p=s.length;l<p;++l)if(h=s[l],n(h.condition))return r[h.material]}if(e){function n(n){for(var t in n)if(n[t]!=v[t])return!1;return!0}for(l=0,p=e.length;l<p;++l)if(h=e[l],n(h))return null}return c?r.scene:null};this.getOverridedMaterialById=function(n,h){var v,a,y,l;if(i&&i[n]||f&&!f[n])return r.scene;if(t&&t[n]!==undefined)return r.selection;for(l in o)if(v=o[l],v.ids[n])return r[v.material];if(!h)return null;for(l in u){var v=u[l],w=v[h[l]],p=r[w];if(p!==undefined)return p}if(s){function n(n){for(var t in n)if(n[t]!=h[t])return!1;return!0}for(a=0,y=s.length;a<y;++a)if(l=s[a],n(l.condition))return r[l.material]}if(e){function n(n){for(var t in n)if(n[t]!=h[t])return!1;return!0}for(a=0,y=e.length;a<y;++a)if(l=e[a],n(l))return null}return c?r.scene:null};this.hasHighlightMaterial=function(n,i){var l,h,c,f;if(t&&t[n]!==undefined)return!0;for(f in o)if(l=o[f],l.ids[n])return!0;if(!i)return!1;for(f in u){var l=u[f],a=l[i[f]],v=r[a];if(v!==undefined)return!0}if(s){function n(n){for(var t in n)if(n[t]!=i[t])return!1;return!0}for(h=0,c=s.length;h<c;++h)if(f=s[h],n(f.condition))return!0}if(e){function n(n){for(var t in n)if(n[t]!=i[t])return!1;return!0}for(h=0,c=e.length;h<c;++h)if(f=e[h],n(f))return!1}return!1};this.resetSelectionBox=function(){l.makeEmpty()};this.getSelectionBox=function(){return l};this.isSelectionSetEmpty=function(){return t==null};this.computeSelectionBox=function(n){var r,i,f,u;if(t==null)return!1;for(r=0;r<n.length;++r)if(i=n[r].object,t[i.name]!==undefined){if(!i.geometry){CLOUD.Logger.log("empty geometry!");continue}i.geometry.boundingBox==null&&i.geometry.computeBoundingBox();f=i.geometry.boundingBox;f&&(u=f.clone(),i.matrixWorld&&u.applyMatrix4(i.matrixWorld),l.expandByPoint(u.min),l.expandByPoint(u.max))}return!0};this.computeRenderObjectsBox=function(n){for(var t,f,i,r=new THREE.Box3,u=0;u<n.length;++u)if((t=n[u].object,this.isVisible(t))&&!t.customTag){if(!t.geometry){CLOUD.Logger.log("empty geometry!");continue}t.geometry.boundingBox==null&&t.geometry.computeBoundingBox();f=t.geometry.boundingBox;f&&(i=f.clone(),t.matrixWorld&&i.applyMatrix4(t.matrixWorld),r.expandByPoint(i.min),r.expandByPoint(i.max))}return r};this.setHideUnselected=function(n){n&&a()};this.isHideUnselected=function(){return n.visibleIds!==undefined};this.setHideSelected=function(n,t){n&&v(t)};this.setTranslucentSelected=function(n,t){n&&p(t)};this.setTranslucentUnselected=function(n){n&&y()};this.cancelTranslucentAll=function(){c=!1;i=null;f=null};this.revertAll=function(){i=null;t=null;n={};f=null;c=!1};this.isIsolateState=function(){return!this.isNullSelectionSet()||!this.isNullDemolishSet()||!this.isNullIsolateSet()||!this.isNullVisibleSet()||!this.isNullInVisibleSet()||c}};CLOUD.MeshEx=function(){THREE.Mesh.call(this);this.type="MeshEx";this.matrixAutoUpdate=!1;this.visible=!1;this.geometry=CLOUD.GeomUtil.EmptyGeometry;this.material=CLOUD.MaterialUtil.DefaultMaterial};CLOUD.MeshEx.prototype=Object.create(THREE.Mesh.prototype);CLOUD.MeshEx.prototype.constructor=CLOUD.MeshEx;CLOUD.MeshEx.prototype.init=function(n){n&&n.parent&&n.parent.add(this)};CLOUD.MeshEx.prototype.spawn=function(n){n.userId!==undefined?this.name=n.userId:n.nodeId!==undefined&&(this.name=n.nodeId);n.geometry&&(this.geometry=n.geometry);n.material&&(this.material=n.material);n.matrix?(this.matrix.copy(n.matrix),this.updateMatrixWorld(!0)):(this.matrix.identity(),this.updateMatrixWorld(!0));this.databagId=n.databagId?n.databagId:"";n.userData?this.userData=n.userData:this.userData&&(this.userData=null);this.visible=!0;this.frustumCulled=!1;this.material.visible=!0};CLOUD.MeshEx.prototype.clear=function(){this.geometry=CLOUD.GeomUtil.EmptyGeometry;this.material=CLOUD.MaterialUtil.DefaultMaterial;this.visible=!1;this.frustumCulled=!0;this.material.visible=!1};CLOUD.ObjectPool=function(n,t){this.cls=n;this.size=t||1e3;this._pool=[];this.counter=0};CLOUD.ObjectPool.prototype.init=function(n){for(var i,t=0;t<this.size;t++)i=new this.cls,i.init(n),this._pool[t]=i};CLOUD.ObjectPool.prototype.resize=function(n,t){this.size=n||1e3;this.collect();this.init(t)};CLOUD.ObjectPool.prototype.get=function(n){return this.counter>=this.size?null:(this._pool[this.counter].spawn(n),this._pool[this.counter++])};CLOUD.ObjectPool.prototype.clear=function(){for(var n=0;n<this.size;n++)this._pool[n].clear();this.counter=0};CLOUD.ObjectPool.prototype.collect=function(){this._pool=[];this.counter=0};CloudTouch=CloudTouch||{},function(){var n=1,c=2,t=4,r=8,b={touchstart:n,touchmove:c,touchend:t,touchcancel:r},k="touch",l=1,u=2,f=4,e=8,o=16,a=u|f,v=e|o,d=a|v,y=["x","y"],i=["clientX","clientY"],g=function(i,u){var e=i,f={pointers:u.touches,changedPointers:u.changedTouches,pointerType:k,srcEvent:u},s=u.touches.length,h=u.changedTouches.length,o=b[u.type],c=o&n&&s-h==0,l=o&(t|r)&&s-h==0;f.isFirst=!!c;f.isFinal=!!l;c&&(e.session={});f.eventType=o;nt(e,f);e.session.prevInput=f},p=function(n){for(var i=[],t=0;t<n.pointers.length;)i[t]={clientX:Math.round(n.pointers[t].clientX),clientY:Math.round(n.pointers[t].clientY)},t++;return{timeStamp:Date.now(),pointers:i,center:w(i),deltaX:n.deltaX||0,deltaY:n.deltaY||0}},w=function(n){var t=n.length;if(t===1)return{x:Math.round(n[0].clientX),y:Math.round(n[0].clientY)};for(var r=0,u=0,i=0;i<t;)r+=n[i].clientX,u+=n[i].clientY,i++;return{x:Math.round(r/t),y:Math.round(u/t)}},nt=function(n,t){var i=n.session,u=t.pointers,f=u.length;i.firstInput||(i.firstInput=p(t));f>1&&!i.firstMultiple?i.firstMultiple=p(t):f===1&&(i.firstMultiple=!1);var e=i.firstInput,r=i.firstMultiple,o=r?r.center:e.center,c=t.center=w(u);t.timeStamp=Date.now();t.deltaTime=t.timeStamp-e.timeStamp;t.angle=h(o,c);t.distance=s(o,c);t.scale=r?ut(r.pointers,u):1;t.rotation=r?rt(r.pointers,u):0;tt(i,t);t.offsetDirection=it(t.deltaX,t.deltaY);t.maxPointers=i.prevInput?t.pointers.length>i.prevInput.maxPointers?t.pointers.length:i.prevInput.maxPointers:t.pointers.length},tt=function(i,r){var f=r.center,e=i.offsetDelta||{},o=i.prevDelta||{},u=i.prevInput||{};(r.eventType===n||u.eventType===t)&&(o=i.prevDelta={x:u.deltaX||0,y:u.deltaY||0},e=i.offsetDelta={x:f.x,y:f.y});r.deltaX=o.x+(f.x-e.x);r.deltaY=o.y+(f.y-e.y);r.eventType===n?(r.relativeDeltaX=0,r.relativeDeltaY=0,r.relativeRotation=0,r.relativeScale=1,r.deltaAngle=0):(r.relativeDeltaX=f.x-u.center.x,r.relativeDeltaY=f.y-u.center.y,r.relativeRotation=r.rotation-u.rotation,r.relativeScale=r.scale/u.scale,r.deltaAngle=r.angle-u.angle)},it=function(n,t){return n===t?l:Math.abs(n)>=Math.abs(t)?n<0?u:f:t<0?e:o},s=function(n,t,i){i||(i=y);var r=t[i[0]]-n[i[0]],u=t[i[1]]-n[i[1]];return Math.sqrt(r*r+u*u)},h=function(n,t,i){i||(i=y);var r=t[i[0]]-n[i[0]],u=t[i[1]]-n[i[1]];return Math.atan2(u,r)},rt=function(n,t){return h(t[1],t[0],i)+h(n[1],n[0],i)},ut=function(n,t){return s(t[0],t[1],i)/s(n[0],n[1],i)};CloudTouch.proxy={INPUT_START:n,INPUT_MOVE:c,INPUT_END:t,INPUT_CANCEL:r,DIRECTION_NONE:l,DIRECTION_LEFT:u,DIRECTION_RIGHT:f,DIRECTION_UP:e,DIRECTION_DOWN:o,DIRECTION_HORIZONTAL:a,DIRECTION_VERTICAL:v,DIRECTION_ALL:d,touchsHandler:g}}();CLOUD.Object3D=function(){function u(){t.setFromEuler(n,!1)}function f(){n.setFromQuaternion(t,undefined,!1)}Object.defineProperty(this,"id",{value:THREE.Object3DIdCount++});this.name="";this.type="Object3D";this.parent=null;this.channels=new THREE.Channels;this.children=[];var i=new THREE.Vector3,n=new THREE.Euler,t=new THREE.Quaternion,r=new THREE.Vector3(1,1,1);n.onChange(u);t.onChange(f);Object.defineProperties(this,{position:{enumerable:!0,value:i},rotation:{enumerable:!0,value:n},quaternion:{enumerable:!0,value:t},scale:{enumerable:!0,value:r},modelViewMatrix:{value:new THREE.Matrix4},normalMatrix:{value:new THREE.Matrix3}});this.matrix=new THREE.Matrix4;this.matrixWorld=new THREE.Matrix4;this.matrixWorldNeedsUpdate=!0;this.visible=!0;this.renderOrder=0};CLOUD.Object3D.prototype={constructor:CLOUD.Object3D,applyMatrix:function(n){this.matrix.multiplyMatrices(n,this.matrix)},localToWorld:function(n){return n.applyMatrix4(this.matrixWorld)},worldToLocal:function(){var n=new THREE.Matrix4;return function(t){return t.applyMatrix4(n.getInverse(this.matrixWorld))}}(),getWorldPosition:function(n){var t=n||new THREE.Vector3;return t.setFromMatrixPosition(this.matrixWorld)},raycast:function(){},traverse:function(n){n(this)},traverseVisible:function(n){this.visible!==!1&&n(this)},traverseAncestors:function(n){var t=this.parent;t!==null&&(n(t),t.traverseAncestors(n))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale);this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(n){if((this.matrixWorldNeedsUpdate===!0||n)&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,n=!0),this.children)for(var t=0,i=this.children.length;t<i;t++)this.children[t].updateMatrixWorld(n)}};THREE.EventDispatcher.prototype.apply(CLOUD.Object3D.prototype);CLOUD.Group=function(){"use strict";CLOUD.Object3D.call(this);this.type="Group";this.children=[];this.boundingBox=null};CLOUD.Group.prototype=Object.create(CLOUD.Object3D.prototype);CLOUD.Group.prototype.constructor=CLOUD.Group;CLOUD.Group.prototype.raycast=function(){var n=new THREE.Matrix4,t=new THREE.Ray;return function(i){var r=this.boundingBox;return(n.getInverse(this.matrixWorld),t.copy(i.ray).applyMatrix4(n),r!==null&&t.isIntersectionBox(r)===!1)?!1:!0}}();CLOUD.Group.prototype.add=function(n){if(arguments.length>1){for(var t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return n===this?(console.error("CLOUD.Object3D.add: object can't be added as a child of itself.",n),this):(n instanceof CLOUD.Object3D||n instanceof THREE.Object3D?(n.parent!==null&&n.parent.remove(n),n.parent=this,n.dispatchEvent({type:"added"}),this.children.push(n)):console.error("CLOUD.Object3D.add: object not an instance of Object3D.",n),this)};CLOUD.Group.prototype.remove=function(n){var t,i;if(arguments.length>1)for(t=0;t<arguments.length;t++)this.remove(arguments[t]);i=this.children.indexOf(n);i!==-1&&(n.parent=null,n.dispatchEvent({type:"removed"}),this.children.splice(i,1))};CLOUD.Group.prototype.traverseVisible=function(n){var i,t,r;if(this.visible!==!1)for(n(this),i=this.children,t=0,r=i.length;t<r;t++)i[t].traverseVisible(n)};CLOUD.Group.prototype.traverse=function(n){var i,t,r;for(n(this),i=this.children,t=0,r=i.length;t<r;t++)i[t].traverse(n)};CLOUD.Camera=function(n,t,i,r,u){THREE.CombinedCamera.call(this,n,t,i,r,u);this.realUp=this.up.clone();this.target=new THREE.Vector3;this.dirty=!1;this.positionPlane=new THREE.Plane;this.projScreenMatrix=new THREE.Matrix4;this.viewProjInverse=new THREE.Matrix4};CLOUD.Camera.prototype=Object.create(THREE.CombinedCamera.prototype);CLOUD.Camera.prototype.constructor=CLOUD.Camera;CLOUD.Camera.prototype.updateMVP=function(){this.parent===null&&this.updateMatrixWorld();this.matrixWorldInverse.getInverse(this.matrixWorld);this.updatePositionPlane();this.projScreenMatrix.multiplyMatrices(this.projectionMatrix,this.matrixWorldInverse);this.viewProjInverse.getInverse(this.projScreenMatrix)};CLOUD.Camera.prototype.LookAt=function(n,t,i,r){var u=new THREE.Vector3;u.copy(t);r!==undefined&&u.setLength(r);this.position.subVectors(n,u);this.up=i;this.lookAt(n);this.realUp=i.clone();this.target=n.clone()};CLOUD.Camera.prototype.updatePositionPlane=function(){this.positionPlane.setFromNormalAndCoplanarPoint(this.getWorldDirection(),this.position)};CLOUD.Camera.prototype.setStandardView=function(n,t){var i,r,f,u;i=t?t.center():new THREE.Vector3(0,0,0);r=CLOUD.GlobalData.SceneSize/2;switch(n){case CLOUD.EnumStandardView.ISO:f=new THREE.Vector3(-CLOUD.GlobalData.SceneSize,CLOUD.GlobalData.SceneSize,CLOUD.GlobalData.SceneSize);u=new THREE.Vector3;u.subVectors(i,f);this.LookAt(i,u,THREE.Object3D.DefaultUp);break;case CLOUD.EnumStandardView.Top:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,-1),r);break;case CLOUD.EnumStandardView.Bottom:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1),r);break;case CLOUD.EnumStandardView.Front:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.Back:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.Right:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.Left:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.SouthEast:this.LookAt(i,new THREE.Vector3(-1,0,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.SouthWest:this.LookAt(i,new THREE.Vector3(1,0,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.NorthWest:this.LookAt(i,new THREE.Vector3(1,0,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.NorthEast:this.LookAt(i,new THREE.Vector3(-1,0,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomFront:this.LookAt(i,new THREE.Vector3(0,1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomBack:this.LookAt(i,new THREE.Vector3(0,1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomRight:this.LookAt(i,new THREE.Vector3(-1,1,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomLeft:this.LookAt(i,new THREE.Vector3(1,1,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomSouthEast:this.LookAt(i,new THREE.Vector3(-1,1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomSouthWest:this.LookAt(i,new THREE.Vector3(1,1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomNorthWest:this.LookAt(i,new THREE.Vector3(1,1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomNorthEast:this.LookAt(i,new THREE.Vector3(-1,1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofFront:this.LookAt(i,new THREE.Vector3(0,-1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofBack:this.LookAt(i,new THREE.Vector3(0,-1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofRight:this.LookAt(i,new THREE.Vector3(-1,-1,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofLeft:this.LookAt(i,new THREE.Vector3(1,-1,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofSouthEast:this.LookAt(i,new THREE.Vector3(-1,-1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofSouthWest:this.LookAt(i,new THREE.Vector3(1,-1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofNorthWest:this.LookAt(i,new THREE.Vector3(1,-1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofNorthEast:this.LookAt(i,new THREE.Vector3(-1,-1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.TopTurnRight:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(-1,0,0),r);break;case CLOUD.EnumStandardView.TopTurnBack:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,1),r);break;case CLOUD.EnumStandardView.TopTurnLeft:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(1,0,0),r);break;case CLOUD.EnumStandardView.BottomTurnRight:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(-1,0,0),r);break;case CLOUD.EnumStandardView.BottomTurnBack:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,-1),r);break;case CLOUD.EnumStandardView.BottomTurnLeft:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(1,0,0),r);break;case CLOUD.EnumStandardView.FrontTurnTop:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(0,-1,0),r);break;case CLOUD.EnumStandardView.FrontTurnLeft:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(1,0,0),r);break;case CLOUD.EnumStandardView.FrontTurnRight:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(-1,0,0),r);break;case CLOUD.EnumStandardView.RightTurnTop:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,-1,0),r);break;case CLOUD.EnumStandardView.RightTurnFront:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,0,-1),r);break;case CLOUD.EnumStandardView.RightTurnBack:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,0,1),r);break;case CLOUD.EnumStandardView.BackTurnTop:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(0,-1,0),r);break;case CLOUD.EnumStandardView.BackTurnLeft:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(-1,0,0),r);break;case CLOUD.EnumStandardView.BackTurnRight:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(1,0,0),r);break;case CLOUD.EnumStandardView.LeftTurnTop:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,-1,0),r);break;case CLOUD.EnumStandardView.LeftTurnBack:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,1),r);break;case CLOUD.EnumStandardView.LeftTurnFront:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,-1),r)}return this.updateProjectionMatrix(),i};CLOUD.Camera.prototype.zoomToBBox=function(n,t,i,r){var u,e,l,a,nt,tt,o,it,rt;i=i||1;t=t||.05;u=new THREE.Box3;u.copy(n);u.expandByScalar(n.size().length()*t);var s=r?r:this.getWorldDirection(),st=this.up,k=this.aspect,d=THREE.Math.degToRad(this.fov*.5),ht=u.size(),h=u.center(),ct=ht.length()*.5,g=ct/Math.sin(d)*i,c=new THREE.Vector3;c.copy(s);c.setLength(g);e=new THREE.Vector3;e.subVectors(h,c);l=new THREE.Vector3;l.crossVectors(s,st);l.normalize();a=new THREE.Vector3;a.crossVectors(s,l);a.normalize();nt=new THREE.Plane;nt.setFromNormalAndCoplanarPoint(l,e);tt=new THREE.Plane;tt.setFromNormalAndCoplanarPoint(a,e);var v=0,y=0,p=0,w=0,f=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];for(f[0].set(u.min.x,u.min.y,u.min.z),f[1].set(u.min.x,u.min.y,u.max.z),f[2].set(u.min.x,u.max.y,u.min.z),f[3].set(u.min.x,u.max.y,u.max.z),f[4].set(u.max.x,u.min.y,u.min.z),f[5].set(u.max.x,u.min.y,u.max.z),f[6].set(u.max.x,u.max.y,u.min.z),f[7].set(u.max.x,u.max.y,u.max.z),o=0;o<8;o++){it=new THREE.Vector3;it.subVectors(f[o],e);var b=Math.abs(it.dot(s)),ut=Math.abs(tt.distanceToPoint(f[o])),lt=ut*k,ft=Math.abs(nt.distanceToPoint(f[o])),at=ft/k,et=Math.max(ut,at),ot=Math.max(lt,ft);(!v||!y||et>v*b/y)&&(v=et,y=b);(!p||!w||ot>p*b/w)&&(p=ot,w=b)}return rt=v/Math.tan(d)+(g-y),k<1&&(rt=p/Math.tan(d)+(g-w)),c.copy(s).normalize().setLength(rt),e.subVectors(h,c),this.position.copy(e),this.lookAt(h),this.updateProjectionMatrix(),this.target.copy(h),h};CLOUD.Camera.prototype.computeRay=function(n,t,i){var u=new THREE.Vector2,e,r,f;return i===undefined?(u.x=window.innerWidth,u.y=window.innerHeight):(e=i===document?i.body:i,u.x=e.offsetWidth,u.y=e.offsetHeight),r=new THREE.Vector2,r.x=n/u.x*2-1,r.y=-(t/u.y)*2+1,f=new THREE.Ray,this.isPerspective?(f.origin.copy(this.position),f.direction.set(r.x,r.y,.5).unproject(this).sub(this.position).normalize()):(f.origin.set(r.x,r.y,-1).unproject(this),f.direction.set(0,0,-1).transformDirection(this.matrixWorld)),f};CLOUD.Camera.prototype.screenToWorld=function(n,t,i,r){var e=this.computeRay(n,t,i),u=this.getWorldDirection().normalize(),f=new THREE.Plane(u);return f.setFromNormalAndCoplanarPoint(u,r),e.intersectPlane(f,r)};CLOUD.Camera.prototype.clone=function(){var n=new CLOUD.Camera(this.right*2,this.top*2,this.fov,this.near,this.far);return n.position.copy(this.position),n.up.copy(this.up),this.realUp&&n.realUp.copy(this.realUp),this.target&&n.target.copy(this.target),n.aspect=this.aspect,n.fov=this.fov,n.near=this.near,n.far=this.far,n.left=this.left,n.right=this.right,n.top=this.top,n.bottom=this.bottom,n.zoom=this.zoom,n.isPerspective=this.isPerspective,this.updateProjectionMatrix(),n};CLOUD.Scene=function(){CLOUD.Group.call(this);this.type="Scene";this.autoUpdate=!1;this.filter=new CLOUD.Filter;this.raycaster=new CLOUD.Raycaster;this.raycaster.setFilter(this.filter);this.rootNode=new CLOUD.Group;this.rootNode.sceneRoot=!0;this.add(this.rootNode);this.clipWidget=null;this.clipPlanes=null;this.boundingBoxInner=new THREE.Box3;this.meshPool=new CLOUD.ObjectPool(CLOUD.MeshEx,CLOUD.GlobalData.maxObjectNumInPool);this.meshPool.init({parent:this.rootNode});this.lightOffset=new THREE.Vector3(-1,-1,-1);this.lightOffset.normalize();this.lampHead=new THREE.DirectionalLight(12040142,.8);this.lampAssist=new THREE.DirectionalLight(3355443,.8);this.add(new THREE.HemisphereLight(16777215,16777215,.6));this.add(this.lampHead);this.add(this.lampAssist);this.groupOctreeBox=new THREE.Group;this.add(this.groupOctreeBox)};CLOUD.Scene.prototype=Object.create(CLOUD.Group.prototype);CLOUD.Scene.prototype.constructor=CLOUD.Scene;CLOUD.Scene.prototype.destroy=function(){this.clearAll()};CLOUD.Scene.prototype.resizePool=function(){this.rootNode.children=[];this.meshPool.resize(CLOUD.GlobalData.maxObjectNumInPool,{parent:this.rootNode})};CLOUD.Scene.prototype.clearAll=function(){this.filter.clear();this.autoUpdate=!1;this.rootNode.children=[];this.rootNode.boundingBox=null};CLOUD.Scene.prototype.getRootNode=function(){return this.rootNode};CLOUD.Scene.prototype.getBoundingBox=function(){var n=new THREE.Box3;return function(){return n.copy(this.rootNode.boundingBox),n.applyMatrix4(this.rootNode.matrix),n}}();CLOUD.Scene.prototype.getBoundingBoxWorld=function(){return this.rootNode.boundingBox};CLOUD.Scene.prototype.getBoundingBoxInnner=function(){return this.boundingBoxInner};CLOUD.Scene.prototype.getMatrixGlobal=function(){return this.rootNode.matrix};CLOUD.Scene.prototype.getMatrixWorldGlobal=function(){return this.rootNode.matrixWorld};CLOUD.Scene.prototype.getRotationGlobal=function(){var n,t;return this.rootNode.matrix?(n=new THREE.Matrix4,n.extractRotation(this.rootNode.matrix),t=new THREE.Euler,t.setFromRotationMatrix(n),t):null};CLOUD.Scene.prototype.getHitPoint=function(n,t,i){var u=this.raycaster,r,f,o,e,s;if(u.setFromCamera(new THREE.Vector2(n,t),i),r=this.hitTestClipPlane(u.ray,u.intersectObjects(this.children,!0)),r=this.hitTestClipPlanes(u,r),r.length<1)return null;for(r.sort(function(n,t){return n.distance-t.distance}),f=0,o=r.length;f<o;++f)if((e=r[f],!(e.distance<=i.near))&&(s=e.object,this.filter.isVisible(s)))return e.point;return null};CLOUD.Scene.prototype.getTrackingPointFromBoundingBox=function(n,t){var u,e,o;if(!this.rootNode.boundingBox)return null;var s=t.origin,i=this.getBoundingBox(),f=0,r=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];for(r[0].set(i.min.x,i.min.y,i.min.z),r[1].set(i.min.x,i.min.y,i.max.z),r[2].set(i.min.x,i.max.y,i.min.z),r[3].set(i.min.x,i.max.y,i.max.z),r[4].set(i.max.x,i.min.y,i.min.z),r[5].set(i.max.x,i.min.y,i.max.z),r[6].set(i.max.x,i.max.y,i.min.z),r[7].set(i.max.x,i.max.y,i.max.z),u=0;u<8;u++)e=new THREE.Vector3,e.subVectors(r[u],s),o=e.dot(n),f<o&&(f=o);var c=n.clone().multiplyScalar(f),l=s.clone().add(c),h=new THREE.Plane;return h.setFromNormalAndCoplanarPoint(n,l),t.intersectPlane(h)};CLOUD.Scene.prototype.getNearDepthByRect=function(){function u(n){i.setFromMatrixPosition(n.matrixWorld);i.applyProjection(r);var u=i.z;u<t&&u>=0&&u<=1&&(t=u)}function f(t,i){if(!i.boundingBox||i instanceof THREE.Mesh){var r=i.geometry;r.boundingBox===null&&r.computeBoundingBox();n.copy(r.boundingBox);n.applyMatrix4(i.matrixWorld)}else n.copy(i.boundingBox),n.applyMatrix4(i.matrixWorld);return t.intersectsBox(n)}var n=new THREE.Box3,t=Infinity,r=new THREE.Matrix4,i=new THREE.Vector3;return function(n,i){function h(t){var i,r,o,e;if(t.worldBoundingBox){if(!n.intersectsBox(t.worldBoundingBox))return;u(t)}if(t.userData){if(!f(n,t))return;u(t)}if(i=t.children,i)for(r=0,o=i.length;r<o;r++)e=i[r],e.visible&&h(e)}var o,e,c,s;for(t=Infinity,r.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),o=this.rootNode.children,e=0,c=o.length;e<c;e++)s=o[e],s.visible&&h(s);return t}}();CLOUD.Scene.prototype.getClipWidget=function(){if(this.clipWidget==null){var n=new THREE.Box3;n.copy(this.rootNode.boundingBox);n.applyMatrix4(this.rootNode.matrix);this.clipWidget=new CLOUD.ClipWidget(new THREE.Vector4(0,0,1,0),n.center());this.add(this.clipWidget)}return this.clipWidget};CLOUD.Scene.prototype.getClipPlanes=function(){if(this.clipPlanes==null){var n=new THREE.Box3;n.copy(this.rootNode.boundingBox);n.applyMatrix4(this.rootNode.matrix);this.clipPlanes=new CLOUD.ClipPlanes(n.size(),n.center());this.add(this.clipPlanes)}return this.clipPlanes};CLOUD.Scene.prototype.hitTest=function(n,t){var r=this.raycaster,i;return(r.setFromCamera(n,t),i=this.hitTestClipPlane(r.ray,r.intersectObjects(this.children,!0)),i=this.hitTestClipPlanes(r,i),i.length<1)?null:(i.sort(function(n,t){return n.distance-t.distance}),i[0].point)};CLOUD.Scene.prototype.hitTestClipPlane=function(n,t){if(this.clipWidget&&this.clipWidget.isEnabled()){var i=this.clipWidget.hitTest(n);function r(n){return n.distance>=i.distance}function u(n){return n.distance<=i.distance}return i.distance==null?t:t.filter(i.sign?r:u)}return t};CLOUD.Scene.prototype.hitTestClipPlanes=function(n,t){if(this.clipPlanes&&this.clipPlanes.isEnabled()){var i=this.clipPlanes.hitTest(n);function r(n){return n.distance>=i.distance}function u(n){return n.distance<=i.distance}return i.distance==null?t:t.filter(i.sign?r:u)}return t};CLOUD.Scene.prototype.hitTestPosition=function(n,t,i){var u=this.raycaster,r,f,e;if(u.setFromCamera(n,t),r=this.hitTestClipPlane(u.ray,u.intersectObjects(this.children,!0)),r=this.hitTestClipPlanes(u,r),r.length<1){this.rootNode.boundingBox?(f=this.getBoundingBox(),e=f.center(),i(e)):i(null);return}r.sort(function(n,t){return n.distance-t.distance});i(r[0].point)};CLOUD.Scene.prototype.isPickable=function(n){return this.filter.isVisible(n)&&this.filter.isSelectable(n)};CLOUD.Scene.prototype.pick=function(n,t,i){var h=this,f=this.raycaster,r,s,e,u,o;if(f.setFromCamera(n,t),r=this.hitTestClipPlane(f.ray,f.intersectObjects(h.children,!0)),r=this.hitTestClipPlanes(f,r),s=r.length,s>0)for(r.sort(function(n,t){return n.distance-t.distance}),e=0;e<s;++e)if((u=r[e],!(u.distance<=t.near))&&(o=u.object,h.isPickable(o)&&o.geometry)){u.userId=o.name;i(u);return}i(null)};CLOUD.Scene.prototype.pickByRect=function(){function f(t,i){for(var f,o,s,h=0,c=t.planes,e=0;e<6;e++){if(f=c[e],r.x=f.normal.x>0?i.min.x:i.max.x,u.x=f.normal.x>0?i.max.x:i.min.x,r.y=f.normal.y>0?i.min.y:i.max.y,u.y=f.normal.y>0?i.max.y:i.min.y,r.z=f.normal.z>0?i.min.z:i.max.z,u.z=f.normal.z>0?i.max.z:i.min.z,o=f.distanceToPoint(r),s=f.distanceToPoint(u),o<0&&s<0)return n.IS_Leave;o*s>=0&&++h}return h==6?n.IS_Contains:n.IS_Intersection}function e(n,t){if(!t.boundingBox||t instanceof THREE.Mesh){var r=t.geometry;r.boundingBox===null&&r.computeBoundingBox();i.copy(r.boundingBox)}else i.copy(t.boundingBox);return i.applyMatrix4(t.matrixWorld),f(n,i)}var t=new THREE.Sphere,i=new THREE.Box3,n={IS_Leave:0,IS_Intersection:1,IS_Contains:2},r=new THREE.Vector3,u=new THREE.Vector3;return function(t,i,r){function l(r){var a,o,s,v,h;if((!(r instanceof CLOUD.Group)||!r.userData||!r.userData.sceneId||!u.filter.hasFileFilter(r.userData.sceneId))&&(!r.worldBoundingBox||f(t,r.worldBoundingBox)!==n.IS_Leave)){if(r.userData)if(a=e(t,r),a===n.IS_Contains)u.filter.isVisible(r)&&u.filter.isSelectable(r)&&(i===CLOUD.OPSELECTIONTYPE.Remove?u.filter.removeSelectedId(r.name):u.filter.addSelectedId(r.name,r.userData),++c);else return;if(o=r.children,o)for(s=0,v=o.length;s<v;s++)h=o[s],h.visible&&l(h)}}var u=this,c,s,o,a,h;for(i===CLOUD.OPSELECTIONTYPE.Clear&&u.filter.setSelectedIds(),c=0,s=this.rootNode.children,o=0,a=s.length;o<a;o++)h=s[o],h.visible&&l(h);r()}}();CLOUD.Scene.prototype.traverseIf=function(n){function i(n,t){for(var r,f=n.children,u=0,e=f.length;u<e;u++){if(r=f[u],!t(r,n))break;r.visible&&i(r,t)}}for(var u,r=this.rootNode.children,t=0,f=r.length;t<f;t++)u=r[t],i(u,n)};CLOUD.Scene.prototype.findSceneNode=function(n){for(var t,r=this.rootNode.children,i=0,u=r.length;i<u;i++)if(t=r[i],t.userData&&n==t.userData.sceneId)return t;return null};CLOUD.Scene.prototype.getNodeById=function(n){for(var i,r=this.rootNode.children,t=0,u=r.length;t<u;t++)if(i=r[t],n===i.name)return i;return null};CLOUD.Scene.prototype.showSceneNodes=function(n,t){for(var r,u=this.rootNode.children,i=0,f=u.length;i<f;i++)r=u[i],r.databagId===n.databagId&&(r.visible=t)};CLOUD.Scene.prototype.containsBoxInFrustum=function(){var n=new THREE.Vector3,t=new THREE.Vector3;return function(i,r){for(var u,e,o,s=i.planes,f=0;f<6;f++)if(u=s[f],n.x=u.normal.x>0?r.min.x:r.max.x,t.x=u.normal.x>0?r.max.x:r.min.x,n.y=u.normal.y>0?r.min.y:r.max.y,t.y=u.normal.y>0?r.max.y:r.min.y,n.z=u.normal.z>0?r.min.z:r.max.z,t.z=u.normal.z>0?r.max.z:r.min.z,e=u.distanceToPoint(n),o=u.distanceToPoint(t),e<0||o<0)return!1;return!0}}();CLOUD.Scene.prototype.prepareScene=function(){};CLOUD.Scene.prototype.parseRootNode=function(n){var t=this.rootNode,i=CLOUD.Utils.box3FromArray(n.view.bbox),r;if(t.boundingBox===null){t.boundingBox=i;var u=new THREE.Vector3,f=new THREE.Quaternion,e=new THREE.Vector3(1,1,1);n.view.position&&u.fromArray(n.view.position);n.view.rotation&&(r=new THREE.Euler,r.fromArray(n.view.rotation),f.setFromEuler(r,!1));n.view.scale&&e.fromArray(n.view.scale);t.matrix.compose(u,f,e);t.matrixAutoUpdate=!1;t.updateMatrixWorld(!0)}else t.boundingBox.expandByPoint(i.min),t.boundingBox.expandByPoint(i.max)};CLOUD.Scene.prototype.hasVisibleNode=function(){return this.rootNode.children[0]&&this.rootNode.children[0].visible};CLOUD.Scene.prototype.updateLights=function(n){var t=this.lampHead,i;t.position.copy(n.getWorldDirection()).multiplyScalar(-1);t.updateMatrixWorld(!0);i=this.lampAssist;i.position.copy(t.position).add(this.lightOffset).normalize();i.updateMatrixWorld()};CLOUD.Scene.prototype.updateOctreeBox=function(n){function i(n){for(var e,r=0,o=n.childOctants.length;r<o;r++){var u=n.childOctants[r],s=new THREE.Box3(u.min,u.max),f=255;f=f<<u.depth*5;e=new CLOUD.BBoxNode(s,f);t.add(e);e.updateMatrixWorld(!0);i(u)}}var t=this.groupOctreeBox;if(CLOUD.GlobalData.ShowOctant){if(t.visible=!0,t.children.length===0){var u=new THREE.Box3(n.min,n.max),r=new CLOUD.BBoxNode(u,16711680);t.add(r);r.updateMatrixWorld(!0);i(n)}}else t.visible=!1};CLOUD.Raycaster=function(n,t,i,r){"use strict";this.ray=new THREE.Ray(n,t);this.near=i||0;this.far=r||Infinity;this.params={Sprite:{},Mesh:{},PointCloud:{threshold:1},LOD:{},Line:{}}};CLOUD.Raycaster.prototype={constructor:CLOUD.Raycaster,precision:.0001,linePrecision:1,descSort:function(n,t){return n.distance-t.distance},set:function(n,t){this.ray.set(n,t)},setFilter:function(n){this.filter=n},setFromCamera:function(n,t){t instanceof THREE.CombinedCamera?t.isPerspective?(this.ray.origin.copy(t.position),this.ray.direction.set(n.x,n.y,.5).unproject(t).sub(t.position).normalize()):(this.ray.origin.set(n.x,n.y,-1).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):t instanceof THREE.PerspectiveCamera?(this.ray.origin.copy(t.position),this.ray.direction.set(n.x,n.y,.5).unproject(t).sub(t.position).normalize()):t instanceof THREE.OrthographicCamera?(this.ray.origin.set(n.x,n.y,-1).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):console.error("CLOUD.Raycaster: Unsupported camera type.")},intersectObject:function(n,t){var i=[];return intersectObject(n,this,i,t,this.filter),i},intersectObjects:function(n,t){for(var r=[],i=0,u=n.length;i<u;i++)intersectObject(n[i],this,r,t,this.filter);return r}};CLOUD.CameraEditor=function(n,t,i,r){"use strict";function vt(){return Math.PI/1800*u.autoRotateSpeed}function ct(){return Math.pow(.95,u.zoomSpeed)}function at(){var t=u.camera,i=t.position,r=u.camera.target.clone().sub(i),n;r.normalize();n=new THREE.Plane;n.setFromNormalAndCoplanarPoint(r.clone().negate(),u.pivotBall.position);n.normalize();var e=n.distanceToPoint(i),o=e*Math.tan(t.fov*.5),f=u.getContainerDimensions();return o*2/(f.height-f.top)}function yt(n){k.set(n.touches[0].clientX,n.touches[0].clientY)}function pt(n){var t=n.touches[0].clientX-n.touches[1].clientX,i=n.touches[0].clientY-n.touches[1].clientY;nt.set(0,Math.sqrt(t*t+i*i))}function wt(n){var t=(n.touches[0].clientX+n.touches[1].clientX)*.5,i=(n.touches[0].clientY+n.touches[1].clientY)*.5;y.set(t,i)}function bt(n){var i,t;d.set(n.touches[0].clientX,n.touches[0].clientY);v.subVectors(d,k);i=u.domElement===document?u.domElement.body:u.domElement;s-=2*Math.PI*v.x/i.clientWidth*u.rotateSpeed;o-=2*Math.PI*v.y/i.clientHeight*u.rotateSpeed;k.copy(d);t=at();u.pivotBall.scale.set(t,t,t);u.pivotCenter.scale.set(t,t,t);u.pivotBall.updateMatrixWorld();u.pivotCenter.updateMatrixWorld()}function kt(n){var t=n.touches[0].clientX-n.touches[1].clientX,i=n.touches[0].clientY-n.touches[1].clientY,r=Math.sqrt(t*t+i*i);(tt.set(0,r),b.subVectors(tt,nt),Math.abs(b.y)<3)||(b.y>0?h/=ct():b.y<0&&(h*=ct()),nt.copy(tt),et.x=(n.touches[0].clientX+n.touches[1].clientX)*.5,et.y=(n.touches[0].clientY+n.touches[1].clientY)*.5,u.dolly())}function dt(n){var t=(n.touches[0].clientX+n.touches[1].clientX)*.5,i=(n.touches[0].clientY+n.touches[1].clientY)*.5;(p.set(t,i),g.subVectors(p,y),Math.abs(g.x)<3&&Math.abs(g.y)<3)||(ft=u.getWorldDimension(t,i),ut.set(0,0,0),u.panOnWorld(),y.copy(p))}var rt;this.viewer=n;this.camera=t;this.domElement=i;this.enabled=!0;this.pivot=null;rt=new THREE.SphereBufferGeometry(15,64,64);this.pivotBall=new THREE.Mesh(rt,new THREE.MeshPhongMaterial({color:16777215,depthTest:!1,opacity:.5,transparent:!0}));rt=new THREE.SphereBufferGeometry(1,64,64);this.pivotCenter=new THREE.Mesh(rt,new THREE.MeshPhongMaterial({color:16711680,depthTest:!1,opacity:.5,transparent:!0}));this.movementSpeed=.0008*CLOUD.GlobalData.SceneSize;this.defaultMovementSpeed=this.movementSpeed;this.minMovementSpeed=.01;this.minDollyDistance=2;this.noZoom=!1;this.zoomSpeed=.2;this.minDistance=.1;this.maxDistance=t.far-CLOUD.GlobalData.SceneSize*2;this.defaultThroughOutDistance=.1;this.noRotate=!1;this.rotateSpeed=1;this.noPan=!1;this.keyPanSpeed=2;this.defaultKeyPanSpeed=this.keyPanSpeed;this.minKeyPanSpeed=.01;this.autoRotate=!0;this.autoRotateSpeed=2;this.minPolarAngle=0;this.maxPolarAngle=Math.PI;this.minAzimuthAngle=-Infinity;this.maxAzimuthAngle=Infinity;this.enablePassThrough=!0;this.isDisableRotate=!1;this.noKeys=!1;this.keys={ALT:18,BACKSPACE:8,LEFT:37,UP:38,RIGHT:39,BOTTOM:40,A:65,D:68,E:69,Q:81,S:83,W:87,PLUS:187,SUB:189,ZERO:48,ESC:27};this.isConstrainedAxisZ=!1;var lt=new THREE.Vector3(0,1,0),u=this,c=1e-6,k=new THREE.Vector2,d=new THREE.Vector2,v=new THREE.Vector2,y=new THREE.Vector2,p=new THREE.Vector2,g=new THREE.Vector2,w=new THREE.Vector3,l=new THREE.Vector3,ut=new THREE.Vector3,ft=new THREE.Vector2,nt=new THREE.Vector2,tt=new THREE.Vector2,b=new THREE.Vector2,et=new THREE.Vector2,it,a,o=0,s=0,h=1,ot=new THREE.Vector3,st=new THREE.Quaternion,e={NONE:-1,ROTATE:0,DOLLY:1,PAN:2},f=e.NONE,ht;this.destroy=function(){this.viewer=null};this.IsIdle=function(){return f===e.NONE};this.update=function(){return function(n,t){var v=this.camera.position,b=this.pivot!==null?this.pivot:this.camera.target,d=this,u,w;if(f!==e.NONE&&this.dirtyCamera(!0),!this.isDisableRotate&&f==e.ROTATE){var g=this.camera.target.clone().sub(v),nt=g.length(),y=v.clone().sub(b),tt=y.length(),i=null,a=this.camera.getWorldDirection();y.normalize();var p=function(n){var t=new THREE.Vector3,i=y.clone().applyQuaternion(n).normalize();v.copy(b).add(i.multiplyScalar(tt));a.applyQuaternion(n).normalize();t.copy(v).add(a.multiplyScalar(nt));d.camera.target.copy(t)},k=this.camera.realUp||this.camera.up,it=a.clone().cross(k).normalize(),rt=it.clone().cross(a).normalize();this.camera.realUp.copy(rt);this.isConstrainedAxisZ?Math.abs(s)>Math.abs(o)&&(u=lt,i=(new THREE.Quaternion).setFromAxisAngle(u,s),p(i),this.camera.realUp.applyQuaternion(i).normalize()):Math.abs(s)>Math.abs(o)?(u=this.camera.up.clone().normalize(),i=(new THREE.Quaternion).setFromAxisAngle(u,s),p(i),this.camera.realUp.applyQuaternion(i).normalize()):Math.abs(o)>.01&&(u=a.clone().cross(k).normalize(),i=(new THREE.Quaternion).setFromAxisAngle(u,o),p(i),this.camera.realUp.applyQuaternion(i).normalize(),this.adjustCameraUp())}f===e.PAN&&(this.camera.target.add(l),this.camera.position.add(l));w=new THREE.Vector3;w.copy(this.camera.up);this.camera.up.copy(this.camera.realUp);this.camera.lookAt(this.camera.target);this.camera.up.copy(w);s=0;o=0;h=1;l.set(0,0,0);n?(t!==undefined&&this.needUpdateRenderList(t),r(),this.dirtyCamera(!1),ot.copy(this.camera.position),st.copy(this.camera.quaternion)):(ot.distanceToSquared(this.camera.position)>c||8*(1-st.dot(this.camera.quaternion))>c)&&(r(),this.dirtyCamera(!1),ot.copy(this.camera.position),st.copy(this.camera.quaternion))}}();this.updateAuto=function(){var n=new THREE.Vector3,i=(new THREE.Quaternion).setFromUnitVectors(t.up,new THREE.Vector3(0,1,0)),u=i.clone().inverse(),f=new THREE.Vector3,e=new THREE.Quaternion;return function(){var l=this.camera.position,t;return n.copy(l).sub(this.camera.target),n.applyQuaternion(i),it=Math.atan2(n.x,n.z),a=Math.atan2(Math.sqrt(n.x*n.x+n.z*n.z),n.y),it+=s,a+=o,it=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,it)),a=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,a)),a=Math.max(c,Math.min(Math.PI-c,a)),t=n.length()*h,t=Math.max(this.minDistance,Math.min(this.maxDistance,t)),this.camera.target.add(w),n.x=t*Math.sin(a)*Math.sin(it),n.y=t*Math.cos(a),n.z=t*Math.sin(a)*Math.cos(it),n.applyQuaternion(u),l.copy(this.camera.target).add(n),this.camera.lookAt(this.camera.target),s=0,o=0,h=1,w.set(0,0,0),f.copy(this.camera.position),e.copy(this.camera.quaternion),r(),!0}}();this.lockAxisZ=function(n){this.isConstrainedAxisZ=n};this.updateView=function(n){n!==undefined&&this.needUpdateRenderList(n);r()};this.needUpdateRenderList=function(n){this.viewer.editorManager.isUpdateRenderList=n};this.disableRotate=function(n){this.isDisableRotate=n};this.rotateLeft=function(n){n===undefined&&(n=vt());s-=n};this.rotateUp=function(n){n===undefined&&(n=vt());o-=n};this.panLeft=function(n){var t=this.camera.matrix.elements;w.set(t[0],t[1],t[2]);w.multiplyScalar(-n);l.add(w)};this.panUp=function(n){var t=this.camera.matrix.elements;w.set(t[4],t[5],t[6]);w.multiplyScalar(n);l.add(w)};this.pan=function(n,t){var i=u.domElement===document?u.domElement.body:u.domElement;if(u.camera.fov!==undefined){var f=u.camera.position,e=f.clone().sub(u.camera.target),r=e.length();r*=Math.tan(u.camera.fov/2*Math.PI/180);u.panLeft(2*n*r/i.clientHeight);u.panUp(2*t*r/i.clientHeight)}else u.camera.top!==undefined?(u.panLeft(n*(u.camera.right-u.camera.left)/i.clientWidth),u.panUp(t*(u.camera.top-u.camera.bottom)/i.clientHeight)):CLOUD.Logger.warn("WARNING: CloudPickEditor.js encountered an unknown camera type - pan disabled.")};this.panOnWorld=function(){var n=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3;return function(){var r=this.getContainerDimensions(),u=y.x-r.left,f=y.y-r.top;n.x=u/r.width;n.y=f/r.height;u=p.x-r.left;f=p.y-r.top;t.x=u/r.width;t.y=f/r.height;i.subVectors(t,n);var e=-i.x*ft.x,o=i.y*ft.y,s=this.getWorldRight().multiplyScalar(e),h=this.getWorldUp().multiplyScalar(o);ut.addVectors(s,h);l.add(ut)}}();this.dolly=function(){var r=u.mapWindowToViewport(et.x,et.y),f=u.getHitPoint(r.x,r.y),e,n;if(f!=null){if(Math.abs(h-1)<c)return;var i=this.camera.position,o=this.getWorldEye(),t=new THREE.Vector3;t.subVectors(f,i);e=t.multiplyScalar(h-1).length();n=new THREE.Vector3;Math.abs(e)<this.minDollyDistance?n.addVectors(i,t.normalize().multiplyScalar(this.minDollyDistance)):n.addVectors(i,t);this.camera.position.copy(n);this.camera.target.copy(o.add(n))}else u.dollyByCenter()};this.dollyIn=function(n){n===undefined&&(n=ct());h/=n};this.dollyOut=function(n){n===undefined&&(n=ct());h*=n};this.dollyByPoint=function(n,t){var f,i;if(!(Math.abs(h-1)<c)){var s=this.minDollyDistance,u=this.camera.position,e=this.getWorldEye(),o=this.getTrackingPoint(n,t),r=new THREE.Vector3;r.subVectors(o,u);f=r.multiplyScalar(h-1).length();i=new THREE.Vector3;Math.abs(f)<this.minDollyDistance?i.addVectors(u,r.normalize().multiplyScalar(this.minDollyDistance)):i.addVectors(u,r);this.camera.position.copy(i);this.camera.target.copy(e.add(i))}};this.dollyByCenter=function(){if(!(Math.abs(h-1)<c)){var n=this.getWorldEye(),t=n.length(),r=t*h,u=r-t,i=n.clone().normalize();i.multiplyScalar(u);this.camera.position.add(i);this.camera.target.addVectors(this.camera.position,n)}};this.updateCamera=function(n,t){this.dirtyCamera(!0);ot.copy(this.camera.position);st.copy(this.camera.quaternion);this.camera.target.copy(n);t||u.reset()};this.dirtyCamera=function(n){this.camera.dirty=n};this.modelView=function(){var a,n,r,c,d,w,t;if(f!==e.NONE&&this.dirtyCamera(!0),a=this.pivot!==null?this.pivot:this.viewer.getScene().getBoundingBox().center(),n=this,f==e.ROTATE){var l=this.camera.position,g=this.camera.target.clone().sub(l),nt=g.length(),v=l.clone().sub(a),tt=v.length(),i=null,h=this.camera.getWorldDirection();v.normalize();var y=function(t){var i=new THREE.Vector3,r=v.clone().applyQuaternion(t).normalize();l.copy(a).add(r.multiplyScalar(tt));h.applyQuaternion(t).normalize();i.copy(l).add(h.multiplyScalar(nt));n.camera.target.copy(i)},p=this.camera.realUp||this.camera.up,b=h.clone().cross(p).normalize(),it=b.clone().cross(h).normalize();if(this.camera.realUp.copy(it),this.isConstrainedAxisZ)Math.abs(s)>Math.abs(o)&&(r=lt,i=(new THREE.Quaternion).setFromAxisAngle(r,s),y(i),this.camera.realUp.applyQuaternion(i).normalize());else if(Math.abs(s)>Math.abs(o))r=this.camera.up.clone().normalize(),i=(new THREE.Quaternion).setFromAxisAngle(r,s),y(i),this.camera.realUp.applyQuaternion(i).normalize();else if(Math.abs(o)>.01){c=1e-6;r=h.clone().cross(p).normalize();var k=new THREE.Vector3(0,1,0).clone().cross(p),rt=k.dot(b),u=Math.asin(k.length());rt<0&&(u=-u);u+o>Math.PI/2-c?o=Math.PI/2-c-u:u+o<-Math.PI/2+c&&(o=-Math.PI/2+c-u);i=(new THREE.Quaternion).setFromAxisAngle(r,o);y(i);this.camera.realUp.applyQuaternion(i).normalize();this.adjustCameraUp()}n.pivot!=null?(n.pivotBall.position.copy(n.pivot),n.pivotCenter.position.copy(n.pivot),t=at(),n.pivotBall.scale.set(t,t,t),n.pivotCenter.scale.set(t,t,t)):(d=n.viewer.getScene(),w=d.getBoundingBox().center(),n.pivotBall.position.copy(w),n.pivotCenter.position.copy(w),t=at(),n.pivotBall.scale.set(t,t,t),n.pivotCenter.scale.set(t,t,t));n.pivotBall.updateMatrixWorld();n.viewer.getScene().add(n.pivotBall);n.pivotCenter.updateMatrixWorld();n.viewer.getScene().add(n.pivotCenter)}};this.personView=function(){var l,y,r,u,h;if(f!==e.NONE&&this.dirtyCamera(!0),l=this,f==e.ROTATE){var a=this.camera.position,w=this.camera.target.clone().sub(a),b=w.length(),t=this.camera.getWorldDirection(),v=this.camera.realUp||this.camera.up,i=t.clone().cross(v).normalize(),k=i.clone().cross(t).normalize();if(this.camera.realUp.copy(k),y=function(n){var i=new THREE.Vector3;t.applyQuaternion(n).normalize();i.copy(a).add(t.multiplyScalar(b));l.camera.target.copy(i)},Math.abs(s)>Math.abs(o))r=lt,u=s;else{r=i;var p=new THREE.Vector3(0,1,0).clone().cross(v),d=p.dot(i),n=Math.asin(p.length());d<0&&(n=-n);n+o>Math.PI/4-c?o=Math.PI/4-c-n:n+o<-Math.PI/4+c&&(o=-Math.PI/4+c-n);u=o}h=(new THREE.Quaternion).setFromAxisAngle(r,u);y(h);this.camera.realUp.applyQuaternion(h).normalize()}};this.touchUpdate=function(){var n=new THREE.Vector3,t=new THREE.Quaternion;return function(i,u){var e=this.camera.position,a=this.viewer.getScene().getBoundingBox(),f;a.containsPoint(e)?this.personView(i,u):this.modelView(i,u);this.camera.target.add(l);this.camera.position.add(l);f=new THREE.Vector3;f.copy(this.camera.up);this.camera.up.copy(this.camera.realUp);this.camera.lookAt(this.camera.target);this.camera.up.copy(f);s=0;o=0;h=1;l.set(0,0,0);i?(u!==undefined&&this.needUpdateRenderList(u),r(),this.dirtyCamera(!1),n.copy(this.camera.position),t.copy(this.camera.quaternion)):(n.distanceToSquared(this.camera.position)>c||8*(1-t.dot(this.camera.quaternion))>c)&&(r(),this.dirtyCamera(!1),n.copy(this.camera.position),t.copy(this.camera.quaternion))}}();this.setState=function(n){f=n};this.reset=function(){f=e.NONE;this.update(!0)};this.beginRotate=function(n,t){u.noRotate!==!0&&(f=e.ROTATE,k.set(n,t),ht=null)};this.beginZoom=function(n,t){u.noZoom!==!0&&(f=e.DOLLY,nt.set(n,t))};this.beginPan=function(n,t){u.noPan!==!0&&(f=e.PAN,y.set(n,t),ft=this.getWorldDimension(n,t),ut.set(0,0,0))};this.endOperation=function(){f=e.NONE;this.pivot=null};this.zoom=function(n,t,i){f=e.DOLLY;t===undefined||i===undefined?(n>0?this.dollyIn(1-n):this.dollyOut(1+n),this.dollyByCenter(),this.update()):(n>0?this.dollyIn(1-n):this.dollyOut(1+n),this.dollyByPoint(t,i),this.update());f=e.NONE};this.fly=function(n,t){this.camera.translateX(n.x);this.camera.translateY(n.y);this.camera.translateZ(n.z);this.camera.quaternion.multiply(t);this.camera.rotation.setFromQuaternion(this.camera.quaternion,this.camera.rotation.order);this.camera.target.copy(this.camera.position).add(this.camera.getWorldDirection());r()};this.flyOnWorld=function(){var n=this.camera.up.clone();this.camera.realUp&&this.camera.up.copy(this.camera.realUp);this.camera.lookAt(this.camera.target);this.camera.realUp&&this.camera.up.copy(n);r()};this.processRotate=function(n){var i=f,t;f=e.ROTATE;t=u.domElement===document?u.domElement.body:u.domElement;u.rotateLeft(2*Math.PI*n.x/t.clientWidth*u.rotateSpeed);u.rotateUp(2*Math.PI*n.y/t.clientHeight*u.rotateSpeed);u.update();f=i};this.process=function(n,t,i){var r=u.domElement===document?u.domElement.body:u.domElement;if(f===e.ROTATE){if(u.noRotate===!0)return;if(d.set(n,t),v.subVectors(d,k),v.x==0&&v.y==0)return;u.rotateLeft(2*Math.PI*v.x/r.clientWidth*u.rotateSpeed);u.rotateUp(2*Math.PI*v.y/r.clientHeight*u.rotateSpeed);k.copy(d)}else if(f===e.DOLLY){if(u.noZoom===!0)return;if(tt.set(n,t),b.subVectors(tt,nt),b.x==0&&b.y==0)return;b.y>0?u.dollyOut():u.dollyIn();u.dollyByCenter();nt.copy(tt)}else if(f===e.PAN){if(u.noPan===!0)return;if(p.set(n,t),g.subVectors(p,y),g.x==0&&g.y==0)return;u.panOnWorld();y.copy(p)}f!==e.NONE&&u.update(i)};this.processTouch=function(n,t){var a=n.pointers.length,r,i,c,l;a>1?(u.noRotate!==!0&&(f=e.ROTATE,r=u.domElement===document?u.domElement.body:u.domElement,i=.5*Math.PI/180,n.deltaAngle<i&&n.deltaAngle>-i?o+=2*Math.PI*n.relativeDeltaY/r.clientWidth*u.rotateSpeed:s+=n.relativeRotation),u.noZoom!==!0&&(f=e.DOLLY,h/=n.relativeScale)):u.noPan!==!0&&(f=e.PAN,c=n.relativeDeltaX,l=n.relativeDeltaY,u.pan(c,l));f!==e.NONE&&u.update(t)};this.getContainerDimensions=function(){return CLOUD.DomUtil.getContainerOffsetToClient(this.domElement)};this.mapScreenToLocal=function(n,t,i){var r=this.getContainerDimensions();i.set(n-r.left,r.height-(t-r.top))};this.computeFrustum=function(){var n=new THREE.Matrix4,t=new THREE.Matrix4;return function(i,r,u,f,e,o){var s=this.camera,h=s.near*Math.tan(THREE.Math.degToRad(s.fov*.5)),c=h*s.aspect,l=(i-o.left)/o.width*2-1,a=(r-o.left)/o.width*2-1,v=-((u-o.top)/o.height)*2+1,y=-((f-o.top)/o.height)*2+1;n.makeFrustum(l*c,a*c,v*h,y*h,s.near,s.far);s.updateMatrixWorld();s.matrixWorldInverse.getInverse(s.matrixWorld);t.multiplyMatrices(n,s.matrixWorldInverse);e.setFromMatrix(t)}}();this.mapWindowToViewport=function(n,t,i){var r=this.getContainerDimensions(),u=i||new THREE.Vector2;return u.x=(n-r.left)/r.width*2-1,u.y=-((t-r.top)/r.height)*2+1,u};this.getCameraInfo=function(){var n=new CLOUD.CameraInfo(this.camera.position,this.camera.target,this.camera.up);return JSON.stringify(n)};this.isKeepZoom=function(n,t,i){var r;t===undefined&&(t=this.minDistance);i===undefined&&(i=this.maxDistance);var f=this.camera.position,e=this.camera.target,u=new THREE.Vector3;return(u.copy(f).sub(e),r=u.length()*(2-n),r<t||r>i)?!1:!0};this.computeRotation=function(){var i=new THREE.Matrix4,n,t;return i.lookAt(this.camera.position,this.camera.target,this.camera.up),n=new THREE.Quaternion,n.setFromRotationMatrix(i),t=new THREE.Euler,t.setFromQuaternion(n,undefined,!1),t};this.adjustCameraUp=function(){this.camera.realUp.y>0?this.camera.up=new THREE.Vector3(0,1,0):this.camera.realUp.y<0?this.camera.up=new THREE.Vector3(0,-1,0):this.camera.realUp.x>0?this.camera.up=new THREE.Vector3(1,0,0):this.camera.realUp.x<0?this.camera.up=new THREE.Vector3(-1,0,0):this.camera.realUp.z>0?this.camera.up=new THREE.Vector3(0,0,1):this.camera.realUp.z<0&&(this.camera.up=new THREE.Vector3(0,0,-1))};this.getWorldEye=function(){return this.camera.target.clone().sub(this.camera.position)};this.getWorldRight=function(){var n=new THREE.Vector3,t=this.camera.up,i=this.getWorldEye();return n.crossVectors(i,t),n.lengthSq()===0&&(t.z>t.y?i.y-=.0001:i.z+=.0001,n.crossVectors(i,t)),n.normalize()};this.getWorldUp=function(){var n=this.getWorldRight(),t=this.getWorldEye();return n.cross(t).normalize()};this.getWorldDimension=function(n,t){var u=this.camera.position,f=this.getWorldEye().normalize(),e=this.getTrackingPoint(n,t),o=e.clone().sub(u),s=Math.abs(f.dot(o)),i=this.getContainerDimensions(),h=i.width/i.height,r=2*s*Math.tan(THREE.Math.degToRad(this.camera.fov*.5)),c=r*h;return new THREE.Vector2(c,r)};this.getHitPoint=function(n,t){var r=this.viewer.getScene(),u=this.camera,i=r.getHitPoint(n,t,u);return i?i.clone():null};this.pointToWorld=function(n,i){var r=new THREE.Vector3(n,i,0);return r.unproject(t),r};this.getTrackingPoint=function(n,t){var u=this.getContainerDimensions(),v=n-u.left,y=t-u.top,s=v/u.width*2-1,h=(u.height-y)/u.height*2-1,i=this.getHitPoint(s,h),o,a;if(!i){var e=this.camera.position,f=this.getWorldEye().normalize(),l=this.pointToWorld(s,h),r=new THREE.Ray;r.origin.copy(e);r.direction.copy(l.clone().sub(e).normalize());ht?(o=new THREE.Plane,o.setFromNormalAndCoplanarPoint(f,ht),i=r.intersectPlane(o),i?(a=i.distanceTo(e),a<c&&(i=this.getTrackingPointFromBoundingBox(f,r))):i=this.getTrackingPointFromBoundingBox(f,r)):i=this.getTrackingPointFromBoundingBox(f,r);i||(CLOUD.Logger.log("tracking point is default!"),i=l)}return ht=i.clone(),i};this.getTrackingPointFromBoundingBox=function(n,t){var i=this.viewer.getScene();return i.getTrackingPointFromBoundingBox(n,t)};this.flyToPointWithParallelEye=function(n){var r=this.getWorldEye(),u=r.length(),t=r.clone(),i;t.y=0;t.normalize();t.setLength(u);i=new THREE.Vector3(0,1,0);this.camera.up=i;this.camera.realUp=i.clone();this.camera.position.copy(n);this.camera.target.addVectors(this.camera.position,t);this.update(!0)};this.flyToPoint=function(n){var r=this.camera.position,t=this.getWorldEye(),i=t.clone().normalize(),u=n.clone().sub(r),f=Math.abs(i.dot(u)),e=i.clone().multiplyScalar(f);this.camera.position.subVectors(n,e);this.camera.target.addVectors(this.camera.position,t);this.update(!0)};this.moveBackward=function(n,t){var i=this.camera.position,r=this.camera.target,o;if(t){var u=new THREE.Vector3(r.x-i.x,0,r.z-i.z),s=u.length(),f=n/s,e=new THREE.Vector3(-u.x*f,0,-u.z*f);i.add(e);r.add(e)}else o=r.clone().sub(i),this.camera.translateZ(n),r.addVectors(i,o)};this.moveForward=function(n,t){var i=this.camera.position,r=this.camera.target,o;if(t){var u=new THREE.Vector3(r.x-i.x,0,r.z-i.z),s=u.length(),f=n/s,e=new THREE.Vector3(u.x*f,0,u.z*f);i.add(e);r.add(e)}else o=r.clone().sub(i),this.camera.translateZ(-n),r.addVectors(i,o)};this.updatePivot=function(n,t){if(n){var i=this.viewer.renderer.computeSelectionBBox();if(i==null||i.empty()){t();return}this.pivot=i.center(this.pivot);return}t()};this.touchStartHandler=function(n){switch(n.touches.length){case 1:if(this.noRotate===!0)return;yt(n);f=e.ROTATE;break;case 2:this.noZoom!==!0&&pt(n);this.noPan!==!0&&wt(n);break;default:f=e.NONE}};this.touchMoveHandler=function(n){this.viewer.editorManager.cameraChange=!0;switch(n.touches.length){case 1:this.noRotate!==!0&&bt(n);break;case 2:this.viewer.getScene().remove(this.pivotBall);this.viewer.getScene().remove(this.pivotCenter);this.noZoom!==!0&&(kt(n),f=e.DOLLY);this.noPan!==!0&&(dt(n),f=e.PAN);break;default:f=e.NONE}this.touchUpdate()};this.touchEndHandler=function(n){this.viewer.editorManager.cameraChange=!1;switch(n.touches.length){default:f=e.NONE}this.viewer.getScene().remove(this.pivotBall);this.viewer.getScene().remove(this.pivotCenter);this.touchUpdate()}};CLOUD.PickHelper=function(n,t,i){"use strict";this.cameraEditor=t;this.scene=n;this.filter=n.filter;this.onObjectSelected=i;this.timerId=null;this.debugInfoDiv=null;this.lastDebugInfoDivShow=!1};CLOUD.PickHelper.prototype={constructor:CLOUD.PickHelper,destroy:function(){this.cameraEditor=null;this.scene=null;this.filter=null;this.onObjectSelected=null},click:function(n){function i(){t.handleMousePick(n,!1)}var t=this;t.timerId&&clearTimeout(t.timerId);t.timerId=setTimeout(i,300)},doubleClick:function(n){n.preventDefault();this.timerId&&clearTimeout(this.timerId);this.handleMousePick(n,!0)},handleMousePick:function(n,t){var r=this.cameraEditor;if(r.enabled===!1)return!1;var i=this,u=n.clientX,f=n.clientY,e=r.mapWindowToViewport(u,f);i.scene.pick(e,r.camera,function(u){if(!u){i.filter.setSelectedIds()&&r.updateView(!0);i.onObjectSelected(null,!1);return}CLOUD.Utils.isMobileDevice()&&(i.cameraEditor.pivot=u.point);var f=u.userId;if(i.intersectToWorld(u),t){CLOUD.GlobalData.EnableDemolishByDClick&&(i.filter.addDemolishId(f,!1),r.updateView(!0));i.onObjectSelected(u,!0)}else{if(n.ctrlKey||i.filter.setSelectedIds(),i.filter.addSelectedId(f,u.object.userData,!0))i.onObjectSelected(u,!1);else i.onObjectSelected(null,!1);r.updateView(!0)}})},intersectToWorld:function(n){var t=this.scene.getMatrixGlobal();n.worldPosition=CLOUD.GeomUtil.toMeshWorldPosition(n.point,t);n.worldBoundingBox=CLOUD.GeomUtil.getBoundingBoxWorldOfMesh(n.object,t)}};CLOUD.OrbitEditor=function(n,t,i){"use strict";this.scene=t;this.domElement=i!==undefined?i:document;this.mouseButtons={ORBIT:THREE.MOUSE.RIGHT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT};this.cameraEditor=n;this.isMouseClick=!1;this.oldMouseX=-1;this.oldMouseY=-1;this.timeoutId=null;this.orbitBySelection=!1};CLOUD.OrbitEditor.prototype=Object.create(THREE.EventDispatcher.prototype);CLOUD.OrbitEditor.prototype.constructor=CLOUD.OrbitEditor;CLOUD.OrbitEditor.prototype.destroy=function(){};CLOUD.OrbitEditor.prototype.onExistEditor=function(){};CLOUD.OrbitEditor.prototype.resize=function(){};CLOUD.OrbitEditor.prototype.getDomElement=function(){return this.domElement};CLOUD.OrbitEditor.prototype.delayHandle=function(){function t(){n.update(!0,!0)}var n=this.cameraEditor;this.timeoutId&&clearTimeout(this.timeoutId);this.timeoutId=setTimeout(t,200);n.viewer.editorManager.isUpdateRenderList=!1};CLOUD.OrbitEditor.prototype.fireEvent=function(n){this.cameraEditor.viewer.modelManager.dispatchEvent(n)};CLOUD.OrbitEditor.prototype.processMouseDown=function(n){var i,t,r;if(this.isMouseClick=!1,this.oldMouseX=n.clientX,this.oldMouseY=n.clientY,i=this,t=this.cameraEditor,t.enabled===!1)return!1;if(n.preventDefault(),n.button===i.mouseButtons.ORBIT){if(t.noRotate===!0)return;r=t.mapWindowToViewport(n.clientX,n.clientY);t.updatePivot(this.orbitBySelection,function(){i.scene.hitTestPosition(r,t.camera,function(n){t.pivot=n})});t.beginRotate(n.clientX,n.clientY)}else if(n.button===i.mouseButtons.ZOOM){if(t.noZoom===!0)return;t.beginZoom(n.clientX,n.clientY)}else if(n.button===i.mouseButtons.PAN||n.button===i.mouseButtons.PAN2){if(t.noPan===!0)return;t.beginPan(n.clientX,n.clientY)}return t.IsIdle()===!1?!0:!1};CLOUD.OrbitEditor.prototype.onMouseDown=function(n){return this.processMouseDown(n)};CLOUD.OrbitEditor.prototype.processMouseMove=function(n){var t=this.cameraEditor;t.enabled!==!1&&(n.preventDefault(),t.process(n.clientX,n.clientY,!0))};CLOUD.OrbitEditor.prototype.onMouseMove=function(n){this.processMouseMove(n)};CLOUD.OrbitEditor.prototype.processMouseUp=function(n){this.oldMouseX==n.clientX&&this.oldMouseY==n.clientY&&(this.isMouseClick=!0);var t=this.cameraEditor;return t.enabled===!1?!1:t.IsIdle()===!0?!1:(this.isMouseClick||t.update(!0),t.endOperation(),!0)};CLOUD.OrbitEditor.prototype.onMouseUp=function(n){return this.processMouseUp(n)};CLOUD.OrbitEditor.prototype.onMouseWheel=function(n){var i=this.cameraEditor,t;i.enabled!==!1&&i.noZoom!==!0&&(n.preventDefault(),n.stopPropagation(),t=0||n.wheelDelta||n.detail,t=Math.abs(t)>10?t:-t*40,t*=.0001,this.delayHandle(),i.zoom(t,n.clientX,n.clientY))};CLOUD.OrbitEditor.prototype.onMouseDoubleClick=function(){};CLOUD.OrbitEditor.prototype.onKeyDown=function(n){var t=this.cameraEditor;if(t.enabled!==!1&&t.noKeys!==!0&&t.noPan!==!0){this.delayHandle();switch(n.keyCode){case t.keys.ZERO:t.keyPanSpeed=t.defaultKeyPanSpeed;t.movementSpeed=t.defaultMovementSpeed;break;case t.keys.PLUS:t.keyPanSpeed*=1.1;t.movementSpeed*=1.1;break;case t.keys.SUB:t.keyPanSpeed*=.9;t.keyPanSpeed<t.minKeyPanSpeed&&(t.keyPanSpeed=this.minKeyPanSpeed);t.movementSpeed*=.9;t.movementSpeed<t.minMovementSpeed&&(t.movementSpeed=this.minMovementSpeed);break;case t.keys.Q:t.beginPan();t.pan(0,t.keyPanSpeed);t.update(!0);break;case t.keys.E:t.beginPan();t.pan(0,-t.keyPanSpeed);t.update(!0);break;case t.keys.LEFT:case t.keys.A:t.beginPan();t.pan(t.keyPanSpeed,0);t.update(!0);break;case t.keys.RIGHT:case t.keys.D:t.beginPan();t.pan(-t.keyPanSpeed,0);t.update(!0);break;case t.keys.UP:case t.keys.W:t.moveForward(t.movementSpeed,!n.shiftKey);t.update(!0);break;case t.keys.BOTTOM:case t.keys.S:t.moveBackward(t.movementSpeed,!n.shiftKey);t.update(!0)}}};CLOUD.OrbitEditor.prototype.onKeyUp=function(n){var t=this.cameraEditor;if(t.enabled!==!1&&t.noKeys!==!0&&t.noPan!==!0)switch(n.keyCode){case t.keys.ESC:this.scene.filter.clearSelectionSet();this.fireEvent({type:CLOUD.EVENTS.ON_SELECTION_CHANGED,intersect:null,click:1})}};CLOUD.OrbitEditor.prototype.touchstart=function(n){var t=this.cameraEditor;t.enabled!==!1&&t.touchStartHandler(n)};CLOUD.OrbitEditor.prototype.touchmove=function(n){var i=this,t=this.cameraEditor;t.enabled!==!1&&(n.preventDefault(),t.touchMoveHandler(n))};CLOUD.OrbitEditor.prototype.touchend=function(){var n=this.cameraEditor;n.enabled!==!1&&n.touchEndHandler(event)};CLOUD.PickEditor=function(n,t,i){"use strict";CLOUD.OrbitEditor.call(this,n,t,i);var r=this;this.pickHelper=new CLOUD.PickHelper(t,this.cameraEditor,function(n,t){r.onObjectSelected(n,t)})};CLOUD.PickEditor.prototype=Object.create(CLOUD.OrbitEditor.prototype);CLOUD.PickEditor.prototype.constructor=CLOUD.PickEditor;CLOUD.PickEditor.prototype.pickByClick=function(n){this.pickHelper.click(n)};CLOUD.PickEditor.prototype.processMouseUp=function(n){var t=this;t.oldMouseX==n.clientX&&t.oldMouseY==n.clientY?this.pickByClick(n):t.cameraEditor.update(!0)};CLOUD.PickEditor.prototype.onMouseUp=function(n){n.preventDefault();this.processMouseUp(n)};CLOUD.PickEditor.prototype.onMouseDoubleClick=function(n){this.pickHelper.doubleClick(n)};CLOUD.RectPickEditor=function(n,t){var i;this.onObjectSelected=t;this.startPt=new THREE.Vector2;this.endPt=new THREE.Vector2;this.frustum=new THREE.Frustum;this.slaveEditor=n;i=this;this.pickHelper=new CLOUD.PickHelper(n.scene,n.cameraEditor,function(n,t){i.onObjectSelected(n,t)});this.timeId=null;this.longTapFlag=!1;this.selectPad=CLOUD.Utils.isMobileDevice()?new CLOUD.SelectPad(this):null;i=this;this.longTap=function(){i.longTapFlag=!0;CLOUD.Logger.log("long tap");i.selectPad&&i.selectPad.showOverlay(i.startPt)}};CLOUD.RectPickEditor.prototype={onstructor:CLOUD.RectPickEditor,destroy:function(){this.onObjectSelected=null;this.slaveEditor=null;this.pickHelper.destroy();this.pickHelper=null;this.selectPad&&(this.selectPad=null)},resize:function(){},getDomElement:function(){return this.slaveEditor.domElement},udpateFrustum:function(n){var t=this.startPt.x,r=this.endPt.x,i=this.startPt.y,u=this.endPt.y,o,s,e,f;if(t>r&&(o=t,t=r,r=o),i>u&&(s=i,i=u,u=s),r-t==0||u-i==0)return!1;if(e=this.slaveEditor.cameraEditor,f=e.getContainerDimensions(),e.computeFrustum(t,r,i,u,this.frustum,f),n)this.onUpdateUI({visible:!0,dir:this.startPt.x<this.endPt.x,left:t-f.left,top:i-f.top,width:r-t,height:u-i});return!0},onExistEditor:function(){this.slaveEditor.onExistEditor()},onKeyDown:function(n){this.slaveEditor.onKeyDown(n)},onKeyUp:function(n){this.slaveEditor.onKeyUp(n)},onMouseDoubleClick:function(n){this.pickHelper.doubleClick(n)},onMouseDown:function(n){return n.preventDefault(),n.button===THREE.MOUSE.LEFT&&this.startPt.set(n.clientX,n.clientY),this.slaveEditor.processMouseDown(n)},onMouseMove:function(n){n.preventDefault();var t=n.shiftKey||n.ctrlKey||n.altKey;if(t&&n.button===THREE.MOUSE.LEFT)return this.endPt.set(n.clientX,n.clientY),this.udpateFrustum(!0),!0;this.slaveEditor.processMouseMove(n)},onMouseUp:function(n){var t,r,i,u;n.preventDefault();t=this.slaveEditor;this.onUpdateUI({visible:!1});if(n.button===THREE.MOUSE.LEFT){if(this.startPt.x==n.clientX&&this.startPt.y==n.clientY)return this.pickHelper.click(n),!0;if(r=n.shiftKey||n.ctrlKey||n.altKey,r)return(this.endPt.set(n.clientX,n.clientY),!this.udpateFrustum())?(this.pickHelper.click(n),!1):(i=CLOUD.OPSELECTIONTYPE.Clear,n.ctrlKey?i=CLOUD.OPSELECTIONTYPE.Add:n.altKey&&(i=CLOUD.OPSELECTIONTYPE.Remove),u=this,t.scene.pickByRect(this.frustum,i,function(){u.onObjectSelected(null,!1)}),t.cameraEditor.updateView(!0),!0)}return t.processMouseUp(n)},onMouseWheel:function(n){this.slaveEditor.onMouseWheel(n)}};CLOUD.RectPickEditor.prototype.touchstart=function(n){var i=this.slaveEditor,t;i.enabled!==!1&&(this.startPt.set(n.touches[0].clientX,n.touches[0].clientY),i.touchstart(n),this.timeId&&clearTimeout(this.timeId),t=this,t.timeId=setTimeout(t.longTap,400),this.selectPad&&this.selectPad.hideOverlay())};CLOUD.RectPickEditor.prototype.touchmove=function(n){var i=this,t=this.slaveEditor;t.enabled!==!1&&(this.timeId&&clearTimeout(this.timeId),n.preventDefault(),n.stopPropagation(),t.touchmove(n))};CLOUD.RectPickEditor.prototype.touchend=function(n){var t=this.slaveEditor;t.enabled!==!1&&(t.touchend(n),this.timeId&&clearTimeout(this.timeId),this.longTapFlag&&(this.longTapFlag=!1,n.preventDefault()))};CLOUD.ZoomEditor=function(n,t,i){CLOUD.OrbitEditor.call(this,n,t,i);this.mouseButtons={ZOOM:THREE.MOUSE.LEFT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT}};CLOUD.ZoomEditor.prototype=Object.create(CLOUD.OrbitEditor.prototype);CLOUD.ZoomEditor.prototype.constructor=CLOUD.ZoomEditor;CLOUD.RectZoomEditor=function(n,t,i){CLOUD.OrbitEditor.call(this,n,t,i);this.startPt=new THREE.Vector2;this.endPt=new THREE.Vector2;this.frustum=new THREE.Frustum};CLOUD.RectZoomEditor.prototype=Object.create(CLOUD.OrbitEditor.prototype);CLOUD.RectZoomEditor.prototype.constructor=CLOUD.RectZoomEditor;CLOUD.RectZoomEditor.prototype.updateFrustum=function(n){var t=this.startPt.x,r=this.endPt.x,i=this.startPt.y,u=this.endPt.y,e,o,f;if(t>r&&(e=t,t=r,r=e),i>u&&(o=i,i=u,u=o),r-t==0||u-i==0)return!1;if(f=this.cameraEditor.getContainerDimensions(),this.cameraEditor.computeFrustum(t,r,i,u,this.frustum,f),n)this.onUpdateUI({visible:!0,dir:this.startPt.x<this.endPt.x,left:t-f.left,top:i-f.top,width:r-t,height:u-i});return!0};CLOUD.RectZoomEditor.prototype.onMouseDown=function(n){return n.preventDefault(),n.stopPropagation(),n.button===THREE.MOUSE.LEFT&&this.startPt.set(n.clientX,n.clientY),this.processMouseDown(n)};CLOUD.RectZoomEditor.prototype.onMouseMove=function(n){if(n.preventDefault(),n.button===THREE.MOUSE.LEFT)return this.endPt.set(n.clientX,n.clientY),this.updateFrustum(!0),!0;this.processMouseMove(n)};CLOUD.RectZoomEditor.prototype.onMouseUp=function(n){n.preventDefault();n.stopPropagation();this.onUpdateUI({visible:!1});return n.button===THREE.MOUSE.LEFT?this.startPt.x==n.clientX&&this.startPt.y==n.clientY?!0:(this.endPt.set(n.clientX,n.clientY),!this.updateFrustum())?!1:(this.zoomToRectangle(),!0):this.processMouseUp(n)};CLOUD.RectZoomEditor.prototype.zoomToRectangle=function(){var i=this.cameraEditor.camera,b=this.cameraEditor.camera.target,ut=i.near,n=this.cameraEditor.getContainerDimensions(),e=this.startPt.x-n.left,o=this.startPt.y-n.top,s=this.endPt.x-n.left,h=this.endPt.y-n.top,c=Math.abs(s-e),l=Math.abs(o-h),u,y,rt;if(c!==0&&l!==0){var v=new THREE.Vector2((e+s)/2,(o+h)/2),ft=v.x/n.width*2-1,et=-v.y/n.height*2+1,ot=new THREE.Vector2(ft,et),r=i.position.clone(),t=b.clone().sub(r),st=t.length(),a,f=this.scene.hitTest(ot,i);if(f){var k=c/l>n.width/n.height?c/n.width:l/n.height,d=f.distanceTo(r),p=d*k;t.normalize();a=t.clone().negate().multiplyScalar(p)}else if(u={},u.left=Math.min(e,s),u.top=Math.min(o,h),u.right=Math.max(e,s),u.bottom=Math.max(o,h),y=this.scene.getNearDepthByRect(this.frustum,i),y!==Infinity){var ht=new THREE.Vector3((e+s)/2,(o+h)/2,y),ct=new THREE.Vector3(u.left,u.top,y),g=this.clientToWorld(ht),lt=this.clientToWorld(ct),p=g.clone().sub(lt).length();f=g.clone();t.normalize();a=t.clone().negate().multiplyScalar(p)}else{var w=ut*Math.tan(THREE.Math.degToRad(i.fov*.5)),nt=w*i.aspect,at=v.x*2*nt/n.width,vt=at-nt,yt=v.y*2*w/n.height,pt=yt-w,tt=this.cameraEditor.getWorldRight(),it=this.cameraEditor.getWorldUp();tt.normalize().multiplyScalar(vt);it.multiplyScalar(pt);rt=t.clone().add(it).add(tt);f=r.clone().add(rt);var k=c/l>n.width/n.height?c/n.width:l/n.height,d=f.distanceTo(r),p=d*k;t.normalize();a=t.clone().negate().multiplyScalar(p)}r=f.clone().add(a);i.position.copy(r);b.copy(r).sub(a.clone().normalize().multiplyScalar(st));this.cameraEditor.updateView(!0)}};CLOUD.RectZoomEditor.prototype.worldToClient=function(n){var i=this.cameraEditor.camera,t=new THREE.Vector3(n.x,n.y,n.z);return t.project(i),t};CLOUD.RectZoomEditor.prototype.clientToWorld=function(n){var i=this.cameraEditor.getContainerDimensions(),r=this.cameraEditor.camera,t=new THREE.Vector3;return t.x=n.x/i.width*2-1,t.y=-n.y/i.height*2+1,t.z=n.z,t.unproject(r),t};CLOUD.PanEditor=function(n,t,i){"use strict";CLOUD.OrbitEditor.call(this,n,t,i)};CLOUD.PanEditor.prototype=Object.create(CLOUD.OrbitEditor.prototype);CLOUD.PanEditor.prototype.constructor=CLOUD.PanEditor;CLOUD.FlyEditorUI=function(n,t){"use strict";this.domElement=n!==undefined?n:document;n&&this.domElement.setAttribute("tabindex",-1);this.enableControlPanel=!1;this.crossContainer=null;this.crossBoxWidth=30;this.crossBoxHeight=30;this.elementIds={imgKeyQ:"imgKeyQ",imgKeyW:"imgKeyW",imgKeyE:"imgKeyE",imgKeyA:"imgKeyA",imgKeyS:"imgKeyS",imgKeyD:"imgKeyD",imgKeyQ2:"imgKeyQ2",imgKeyW2:"imgKeyW2",imgKeyE2:"imgKeyE2",imgKeyA2:"imgKeyA2",imgKeyS2:"imgKeyS2",imgKeyD2:"imgKeyD2",imgTipQ:"imgTipQ",imgTipW:"imgTipW",imgTipE:"imgTipE",imgTipA:"imgTipA",imgTipS:"imgTipS",imgTipD:"imgTipD",tipRemarkQ:"tipRemarkQ",tipRemarkW:"tipRemarkW",tipRemarkE:"tipRemarkE",tipRemarkA:"tipRemarkA",tipRemarkS:"tipRemarkS",tipRemarkD:"tipRemarkD",keyControlPanel:"keyControlPanel",velocitySliderPanel:"velocitySliderPanel",velocitySlider:"velocitySlider",keySelectedCss:"key-selected"};this.sliderMax=100;this.sliderMin=1;this.sliderMiddle=50;this.sliderSection=10;this.sliderStep=this.sliderMax/this.sliderSection;this.onChangeSpeed=t};CLOUD.FlyEditorUI.prototype={initCross:function(){var t,u,n;if(!this.crossContainer){var e=this.domElement,o="http://www.w3.org/2000/svg",i=this.crossBoxWidth,r=this.crossBoxHeight,s=CLOUD.DomUtil.getContainerOffsetToClient(e),h=s.width/2-i/2,c=s.height/2-r/2,f=document.createElementNS(o,"svg");f.setAttributeNS(null,"viewBox","0 0 "+i+" "+r);f.setAttributeNS(null,"width",i);f.setAttributeNS(null,"height",r);t="M "+i/2+", "+r/2+"";t+=" l "+i/2+", 0";t+=" l -"+i+", 0";t+=" l "+i/2+", 0";t+=" l 0, "+r/2+"";t+=" l 0, -"+r+"";t+=" l 0, "+r/2+"";u=document.createElementNS(o,"path");u.setAttributeNS(null,"stroke","red");u.setAttributeNS(null,"stroke-width",1);u.setAttributeNS(null,"d",t);u.setAttributeNS(null,"opacity",.8);f.appendChild(u);n=document.createElement("div");n.style.position="absolute";n.style.display="block";n.style.outline="0";n.style.left=h+"px";n.style.top=c+"px";n.style.opacity="1.0";n.style.webkitTransition="opacity .2s ease";n.style.mozTransition="opacity .2s ease";n.style.msTransform="opacity .2s ease";n.style.oTransform="opacity .2s ease";n.style.transition="opacity .2s ease";n.appendChild(f);e.appendChild(n);this.crossContainer=n}},resize:function(){var i=this.domElement,r=this.crossBoxWidth,u=this.crossBoxHeight,n=this.crossContainer,t=CLOUD.DomUtil.getContainerOffsetToClient(i),f=t.width/2-r/2,e=t.height/2-u/2;n.style.left=f+"px";n.style.top=e+"px"},onKeyDown:function(n,t){this.enableControlPanel&&(n&t.FORWARD&&(CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyW,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyW2,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgTipW,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.tipRemarkW,!0)),n&t.BACK&&(CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyS,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyS2,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgTipS,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.tipRemarkS,!0)),n&t.LEFT&&(CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyA,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyA2,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgTipA,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.tipRemarkA,!0)),n&t.RIGHT&&(CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyD,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyD2,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgTipD,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.tipRemarkD,!0)),n&t.UP&&(CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyQ,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyQ2,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgTipQ,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.tipRemarkQ,!0)),n&t.DOWN&&(CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyE,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyE2,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgTipE,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.tipRemarkE,!0)))},onKeyUp:function(n,t){this.enableControlPanel&&(n&t.FORWARD&&(CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyW,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyW2,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgTipW,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.tipRemarkW,!1)),n&t.BACK&&(CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyS,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyS2,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgTipS,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.tipRemarkS,!1)),n&t.LEFT&&(CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyA,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyA2,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgTipA,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.tipRemarkA,!1)),n&t.RIGHT&&(CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyD,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyD2,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgTipD,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.tipRemarkD,!1)),n&t.UP&&(CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyQ,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyQ2,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgTipQ,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.tipRemarkQ,!1)),n&t.DOWN&&(CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyE,!0),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgKeyE2,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.imgTipE,!1),CLOUD.DomUtil.showOrHideElement(this.elementIds.tipRemarkE,!1)))},changeMoveSpeed:function(n,t){return n>0?(t+=this.sliderStep,t>this.sliderMax&&(t=this.sliderMax)):(t-=this.sliderStep,t<this.sliderMin&&(t=this.sliderMin)),this.velocitySlider&&(this.velocitySlider.value=t),t},enableFlyControlPanel:function(n){this.enableControlPanel=n},showControlPanel:function(n){n===undefined&&(n=!1);this.enableControlPanel=n;n&&(this.createKeyControlPanel(this.domElement.parentNode),this.createVelocitySliderPanel(this.domElement.parentNode));CLOUD.DomUtil.showOrHideElement(this.elementIds.keyControlPanel,n);CLOUD.DomUtil.showOrHideElement(this.elementIds.velocitySliderPanel,n);this.setCrossVisible(n)},setCrossVisible:function(n){this.crossContainer&&(this.crossContainer.style.display=n?"":"none")},createVelocitySliderPanel:function(n){var t,i;if(n!==undefined&&(t=this,this.velocitySliderPanel===undefined&&(i='<span class="span-align">Min<\/span><span  class="span-align"><input type="range" name="slider" id="velocitySlider" /><\/span><span class="span-align">Max<\/span>',this.velocitySliderPanel=document.createElement("div"),this.velocitySliderPanel.id="velocitySliderPanel",this.velocitySliderPanel.style.display="none",this.velocitySliderPanel.align="center",this.velocitySliderPanel.innerHTML=i,n.appendChild(this.velocitySliderPanel),this.velocitySlider=document.getElementById(t.elementIds.velocitySlider),this.velocitySlider))){this.velocitySlider.max=this.sliderMax;this.velocitySlider.min=this.sliderMin;this.velocitySlider.value=this.sliderMiddle;this.onChangeSpeed(this.sliderMiddle);this.velocitySlider.addEventListener("change",function(){t.onChangeSpeed(t.velocitySlider.value)})}},createKeyControlPanel:function(n){var u,i,r,t;if(n!==undefined&&this.keyControlPanel===undefined){for(u=[{id:"key00",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"key01",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"key02",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"tipRemarkW",tipText:"前进",tipCss:"tip-bottom"},{id:"key03",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"key04",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"key10",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"tipRemarkQ",tipText:"上升",tipCss:"tip-bottom"},{id:"key11",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"key12",imgId:"imgTipW",imgUrl:CLOUD.GlobalData.TextureResRoot+"cloud-tip-forward.png",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"key13",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"key14",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"tipRemarkE",tipText:"下降",tipCss:"tip-bottom"},{id:"key20",imgId:"imgTipQ",imgUrl:CLOUD.GlobalData.TextureResRoot+"cloud-tip-up.png",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"keyQ",imgId:"imgKeyQ",imgUrl:CLOUD.GlobalData.TextureResRoot+"cloud-key-Q.png",imgId2:"imgKeyQ2",imgUrl2:CLOUD.GlobalData.TextureResRoot+"cloud-press-Q.png",tipId:"",tipText:"",tipCss:""},{id:"keyW",imgId:"imgKeyW",imgUrl:CLOUD.GlobalData.TextureResRoot+'cloud-key-W.png"',imgId2:"imgKeyW2",imgUrl2:CLOUD.GlobalData.TextureResRoot+"cloud-press-W.png",tipId:"",tipText:"",tipCss:""},{id:"keyE",imgId:"imgKeyE",imgUrl:CLOUD.GlobalData.TextureResRoot+"cloud-key-E.png",imgId2:"imgKeyE2",imgUrl2:CLOUD.GlobalData.TextureResRoot+"cloud-press-E.png",tipId:"",tipText:"",tipCss:""},{id:"key24",imgId:"imgTipE",imgUrl:CLOUD.GlobalData.TextureResRoot+"cloud-tip-down.png",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"key30",imgId:'imgTipA"',imgUrl:CLOUD.GlobalData.TextureResRoot+"cloud-tip-left.png",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"keyA",imgId:"imgKeyA",imgUrl:CLOUD.GlobalData.TextureResRoot+"cloud-key-A.png",imgId2:"imgKeyA2",imgUrl2:CLOUD.GlobalData.TextureResRoot+"cloud-press-A.png",tipId:"",tipText:"",tipCss:""},{id:"keyS",imgId:"imgKeyS",imgUrl:CLOUD.GlobalData.TextureResRoot+"cloud-key-S.png",imgId2:"imgKeyS2",imgUrl2:CLOUD.GlobalData.TextureResRoot+"cloud-press-S.png",tipId:"",tipText:"",tipCss:""},{id:"keyD",imgId:"imgKeyD",imgUrl:CLOUD.GlobalData.TextureResRoot+"cloud-key-D.png",imgId2:"imgKeyD2",imgUrl2:CLOUD.GlobalData.TextureResRoot+"cloud-press-D.png",tipId:"",tipText:"",tipCss:""},{id:"key34",imgId:"imgTipD",imgUrl:CLOUD.GlobalData.TextureResRoot+"cloud-tip-right.png",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"key40",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"tipRemarkA",tipText:"左移",tipCss:"tip-right"},{id:"key41",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"key42",imgId:"imgTipS",imgUrl:CLOUD.GlobalData.TextureResRoot+"cloud-tip-back.png",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"key43",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"key44",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"tipRemarkD",tipText:"右移",tipCss:"tip-left"},{id:"key50",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"key51",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"key52",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"tipRemarkS",tipText:"后退",tipCss:"tip-top"},{id:"key53",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""},{id:"key54",imgId:"",imgUrl:"",imgId2:"",imgUrl2:"",tipId:"",tipText:"",tipCss:""}],i='<ul class="guide-list">',r=0;r<u.length;r++)t=u[r],i+='<li id="'+t.id+'">',i+='<div class="key-panel">',t.tipId!==""&&(i+='<p id="'+t.tipId+'" class="'+t.tipCss+'" style="display: none">'+t.tipText+"<\/p>"),t.imgId!==""&&(t.imgId2!==""?(i+='<images id="'+t.imgId+'" class="icon-medium" src="'+t.imgUrl+'" />',i+='<images id="'+t.imgId2+'" class="icon-medium" src="'+t.imgUrl2+'" style="display: none" />'):i+='<images id="'+t.imgId+'" class="icon-medium" src="'+t.imgUrl+'" style="display: none" />'),i+="<\/div>",i+="<\/li>";i+="<\/ul>";this.keyControlPanel=document.createElement("div");this.keyControlPanel.id="keyControlPanel";this.keyControlPanel.style.display="none";this.keyControlPanel.innerHTML=i;n.appendChild(this.keyControlPanel)}}};CLOUD.FlyEditor=function(n,t,i){"use strict";this.cameraEditor=n;this.scene=t;this.domElement=i!==undefined?i:document;this.movementSpeed=.005*CLOUD.GlobalData.SceneSize;this.defaultMovementSpeed=this.movementSpeed;this.minMovementSpeed=.001;this.movementSpeedMultiplier=1;this.lookSpeed=.001;this.constrainPitch=!0;this.pitchMin=THREE.Math.degToRad(5)-.5*Math.PI;this.pitchMax=.5*Math.PI-this.pitchMin;this.pitchDeltaTotal=0;this.mouseButtons={ORBIT:THREE.MOUSE.RIGHT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT};this.MoveDirection={NONE:0,UP:1,DOWN:2,LEFT:4,RIGHT:8,FORWARD:16,BACK:32};this.moveState=this.MoveDirection.NONE;this.isFirstPerson=!0;this.deltaYaw=0;this.deltaPitch=0;this.deltaWheel=0;this.rotateStart=new THREE.Vector2;this.rotateEnd=new THREE.Vector2;this.rotateDelta=new THREE.Vector2;this.timeoutId=null;this.isLockCameraHeight=!0;this.lockCameraHeight=0;this.ui=new CLOUD.FlyEditorUI(this.domElement,function(){});this.ui.initCross()};CLOUD.FlyEditor.prototype={constructor:CLOUD.FlyEditor,destroy:function(){this.ui=null;this.cameraEditor=null;this.scene=null;this.domElement=null},resize:function(){this.ui.resize()},getDomElement:function(){return this.domElement},handleEvent:function(n){typeof this[n.type]=="function"&&this[n.type](n)},delayHandle:function(){function t(){n.cameraEditor.viewer.editorManager.isUpdateRenderList=!0;n.cameraEditor.flyOnWorld()}var n=this;this.timeoutId&&clearTimeout(this.timeoutId);this.timeoutId=setTimeout(t,200);this.cameraEditor.viewer.editorManager.isUpdateRenderList=!1},activate:function(){},deactivate:function(){},onExistEditor:function(){this.deactivate();this.ui.showControlPanel(!1)},onKeyDown:function(n){if(!n.altKey){var t=this.MoveDirection.NONE;switch(n.keyCode){case 48:this.movementSpeed=this.defaultMovementSpeed;break;case 187:this.movementSpeed*=1.1;break;case 189:this.movementSpeed*=.9;this.movementSpeed<this.minMovementSpeed&&(this.movementSpeed=this.minMovementSpeed);break;case 38:case 87:t=this.MoveDirection.FORWARD;break;case 40:case 83:t=this.MoveDirection.BACK;break;case 37:case 65:t=this.MoveDirection.LEFT;break;case 39:case 68:t=this.MoveDirection.RIGHT;break;case 81:t=this.MoveDirection.UP;break;case 69:t=this.MoveDirection.DOWN;break;default:needUpdateUI=!0}if(t!==this.MoveDirection.NONE){this.moveState|=t;this.ui.onKeyDown(t,this.MoveDirection)}this.delayHandle();this.isFirstPerson=!n.shiftKey;this.update()}},onKeyUp:function(n){var t=this.MoveDirection.NONE;switch(n.keyCode){case 38:case 87:t=this.MoveDirection.FORWARD;break;case 40:case 83:t=this.MoveDirection.BACK;break;case 37:case 65:t=this.MoveDirection.LEFT;break;case 39:case 68:t=this.MoveDirection.RIGHT;break;case 81:t=this.MoveDirection.UP;break;case 69:t=this.MoveDirection.DOWN}if(t!==this.MoveDirection.NONE){this.ui.onKeyUp(t,this.MoveDirection);this.moveState&=~t}},processMouseDown:function(n){return this.domElement!==document&&this.domElement.focus(),n.preventDefault(),n.stopPropagation(),n.button===this.mouseButtons.ORBIT?this.rotateStart.set(n.clientX,n.clientY):n.button===this.mouseButtons.PAN&&(this.cameraEditor.beginPan(n.clientX,n.clientY),this.isLockCameraHeight&&(this.lockCameraHeight=n.clientY)),!0},onMouseDown:function(n){return this.processMouseDown(n)},processMouseMove:function(n){n.button===this.mouseButtons.ORBIT?(this.rotateEnd.set(n.clientX,n.clientY),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateStart.copy(this.rotateEnd),(this.rotateDelta.x!=0||this.rotateDelta.y!=0)&&(this.deltaYaw+=this.rotateDelta.x*this.lookSpeed,this.deltaPitch+=this.rotateDelta.y*this.lookSpeed,this.isFirstPerson=!n.shiftKey,this.update())):n.button===this.mouseButtons.PAN&&(this.isLockCameraHeight?this.cameraEditor.process(n.clientX,this.lockCameraHeight,!0):this.cameraEditor.process(n.clientX,n.clientY,!0))},onMouseMove:function(n){this.processMouseMove(n)},processMouseUp:function(n){return n.preventDefault(),n.stopPropagation(),n.button===this.mouseButtons.ORBIT?(this.rotateDelta.set(0,0),this.deltaYaw=0,this.deltaPitch=0,this.isFirstPerson=!n.shiftKey,this.update()):n.button===this.mouseButtons.PAN&&(this.isLockCameraHeight?this.cameraEditor.process(n.clientX,this.lockCameraHeight,!0):this.cameraEditor.process(n.clientX,n.clientY,!0),this.cameraEditor.endOperation()),!0},onMouseUp:function(n){return this.processMouseUp(n)},onMouseWheel:function(n){var i=this.cameraEditor,t;if(i.enabled!==!1&&i.noZoom!==!0){t=0||n.wheelDelta||n.detail;t=Math.abs(t)>10?t:-t*40;t*=.0005;this.delayHandle();var r=i.getContainerDimensions(),u=r.left+.5*r.width,f=r.top+.5*r.height;i.zoom(t,u,f)}},update:function(){var n=this.movementSpeed,r=this.cameraEditor.camera,e=r.position,o=this.cameraEditor.camera.target,t=o.clone().sub(e),u,f,i,h;if(this.cameraEditor.dirtyCamera(!0),this.moveState&this.MoveDirection.FORWARD&&this.goForward(n),this.moveState&this.MoveDirection.BACK&&this.goBack(n),this.moveState&this.MoveDirection.LEFT&&this.goLeft(n),this.moveState&this.MoveDirection.RIGHT&&this.goRight(n),this.moveState&this.MoveDirection.UP&&this.goUp(n),this.moveState&this.MoveDirection.DOWN&&this.goDown(n),this.isFirstPerson){var s=new THREE.Vector3(0,1,0),c=r.realUp||r.up,l=t.clone().cross(c).normalize();this.deltaPitch!=0&&(u=(new THREE.Quaternion).setFromAxisAngle(l,-this.deltaPitch),f=t.clone(),f.applyQuaternion(u),i=f.angleTo(s),i=i-.5*Math.PI,i>=this.pitchMin&&i<=this.pitchMax&&t.applyQuaternion(u),this.deltaPitch=0);this.deltaYaw!=0&&(h=(new THREE.Quaternion).setFromAxisAngle(s,-this.deltaYaw),t.applyQuaternion(h),this.deltaYaw=0);o.addVectors(e,t)}else this.pitchDeltaTotal+=this.deltaPitch,this.goTurn(this.deltaYaw),this.deltaYaw=0,this.constrainPitch?this.pitchDeltaTotal<this.pitchMax&&this.pitchDeltaTotal>this.pitchMin&&(this.goPitch(-this.deltaPitch),this.deltaPitch=0):(this.goPitch(-this.deltaPitch),this.deltaPitch=0),this.pitchDeltaTotal=THREE.Math.clamp(this.pitchDeltaTotal,this.pitchMin,this.pitchMax);this.cameraEditor.flyOnWorld();this.cameraEditor.dirtyCamera(!1)},goForward:function(n){if(this.isFirstPerson)this.cameraEditor.camera.translateZ(-n);else{var t=this.cameraEditor.camera.position,i=this.cameraEditor.camera.target,r=new THREE.Vector3(i.x-t.x,0,i.z-t.z),e=r.length(),u=n/e,f=new THREE.Vector3(r.x*u,0,r.z*u);t.add(f);i.add(f)}},goBack:function(n){if(this.isFirstPerson)this.cameraEditor.camera.translateZ(n);else{var t=this.cameraEditor.camera.position,i=this.cameraEditor.camera.target,r=new THREE.Vector3(i.x-t.x,0,i.z-t.z),e=r.length(),u=n/e,f=new THREE.Vector3(-r.x*u,0,-r.z*u);t.add(f);i.add(f)}},goLeft:function(n){if(this.isFirstPerson)this.cameraEditor.camera.translateX(-n);else{var t=this.cameraEditor.camera.position,i=this.cameraEditor.camera.target,r=new THREE.Vector3(i.x-t.x,0,i.z-t.z),e=r.length(),u=n/e,f=new THREE.Vector3(r.z*u,0,-r.x*u);t.add(f);i.add(f)}},goRight:function(n){if(this.isFirstPerson)this.cameraEditor.camera.translateX(n);else{var t=this.cameraEditor.camera.position,i=this.cameraEditor.camera.target,r=new THREE.Vector3(i.x-t.x,0,i.z-t.z),e=r.length(),u=n/e,f=new THREE.Vector3(-r.z*u,0,r.x*u);t.add(f);i.add(f)}},goUp:function(n){if(this.isFirstPerson)this.cameraEditor.camera.translateY(n);else{var t=this.cameraEditor.camera.position,i=this.cameraEditor.camera.target;t.y+=n;i.y+=n}},goDown:function(n){if(this.isFirstPerson)this.cameraEditor.camera.translateY(-n);else{var t=this.cameraEditor.camera.position,i=this.cameraEditor.camera.target;t.y-=n;i.y-=n}},goTurn:function(n){var t=this.cameraEditor.camera.position,i=this.cameraEditor.camera.target,r=new THREE.Vector3(i.x-t.x,0,i.z-t.z),u=Math.cos(n),f=Math.sin(n),e=new THREE.Vector3(r.x*u-r.z*f,0,r.x*f+r.z*u);i.x=t.x+e.x;i.z=t.z+e.z},goPitch:function(n){var t=this.cameraEditor.camera.position,i=this.cameraEditor.camera.target,u=i.x-t.x,f=i.z-t.z,e=Math.sqrt(u*u+f*f),r=new THREE.Vector3(e,i.y-t.y,0),o=Math.cos(n),s=Math.sin(n),h=new THREE.Vector3(r.x*o-r.y*s,r.x*s+r.y*o,0),c=h.x/e;i.x=t.x+c*u;i.y=t.y+h.y;i.z=t.z+c*f},setCrossVisible:function(n){this.ui.setCrossVisible(n)},enableFlyControlPanel:function(n){this.ui.enableFlyControlPanel(n)},showControlPanel:function(n){this.ui.showControlPanel(n)}};CLOUD.EditorManager=function(){function r(t){n.editor.touchmove(t)}function u(t){n.editor.touchstart(t)}function f(t){n.editor.touchend(t)}function e(t){n.editor.onKeyDown(t)}function o(t){n.editor.onKeyUp(t)}function i(t){n.cameraChange=!0;n.editor.onMouseWheel(t)}function s(i){a();t=!0;n.isUpdateRenderList=!1;var r=n.isAnimating();if(r){n.cameraChange=!1;return}n.editor.onMouseDown(i)}function h(i){var r=n.isAnimating();if(r){n.cameraChange=!1;return}if(t){n.isUpdateRenderList=!1;n.cameraChange=!0;n.editor.onMouseMove(i)}}function c(i){var u=n.isAnimating(),r;if(n.isUpdateRenderList=!0,r=t,t=!1,u){n.cameraChange=!1;return}if(r)n.editor.onMouseUp(i)}function l(t){n.editor.onMouseDoubleClick(t)}function a(){var i=n.editor.getDomElement(),t;i&&(t=i.querySelector("#cloud-main-canvas"),t&&t.focus&&t.focus())}this.editor=null;this.editors={};this.animationDuration=500;this.animationFrameTime=13;this.enableAnimation=!0;this.isUpdateRenderList=!0;this.cameraChange=!1;this.movePad=null;var n=this,t=!1;this.isMouseMoving=function(){return t};this.registerDomEventListeners=function(n){n.addEventListener("contextmenu",function(n){n.preventDefault()},!1);n.addEventListener("mousedown",s,!1);n.addEventListener("mousewheel",i,!1);n.addEventListener("DOMMouseScroll",i,!1);n.addEventListener("dblclick",l,!1);window.addEventListener("mousemove",h,!1);window.addEventListener("mouseup",c,!1);n.addEventListener("touchstart",u,!1);n.addEventListener("touchend",f,!1);n.addEventListener("touchmove",r,!1);n.addEventListener("keydown",e,!1);n.addEventListener("keyup",o,!1);a()};this.unregisterDomEventListeners=function(n){n.removeEventListener("contextmenu",function(n){n.preventDefault()},!1);n.removeEventListener("mousedown",s,!1);n.removeEventListener("mousewheel",i,!1);n.removeEventListener("DOMMouseScroll",i,!1);n.removeEventListener("dblclick",l,!1);window.removeEventListener("mousemove",h,!1);window.removeEventListener("mouseup",c,!1);n.removeEventListener("touchstart",u,!1);n.removeEventListener("touchend",f,!1);n.removeEventListener("touchmove",r,!1);n.removeEventListener("keydown",e,!1);n.removeEventListener("keyup",o,!1)}};CLOUD.EditorManager.prototype={constructor:CLOUD.EditorManager,destroy:function(){var n,t;this.editor=null;for(n in this.editors)t=this.editors[n],t.destroy();this.editors={};this.movePad=null},setEditor:function(n,t){this.editor!==null&&(this.editor==this.editors.orbitEditor,this.editor.onExistEditor());t&&(n.slaveEditor=t);n==this.editors.orbitEditor;this.editor=n},setPickMode:function(n){var i=this,t=this.editors.pickEditor;t===undefined&&(t=new CLOUD.PickEditor(n.cameraEditor,n.getScene(),n.domElement),t.onObjectSelected=function(t,i){n.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_SELECTION_CHANGED,intersect:t,click:i?2:1})},this.editors.pickEditor=t);i.setEditor(t)},getOrbitEditor:function(n){var t=this.editors.orbitEditor;return t===undefined&&(t=new CLOUD.OrbitEditor(n.cameraEditor,n.getScene(),n.domElement),this.editors.orbitEditor=t,this.movePad==null),t},getRectPickEditor:function(n){var t=this.editors.rectPickEditor;return t===undefined&&(t=new CLOUD.RectPickEditor(this.getOrbitEditor(n),function(t,i){n.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_SELECTION_CHANGED,intersect:t,click:i?2:1})}),t.onUpdateUI=function(t){n.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_UPDATE_SELECTION_UI,data:t})},this.editors.rectPickEditor=t),t},setRectPickMode:function(n,t){var r=this,i=this.getOrbitEditor(n),u=this.getRectPickEditor(n);i.orbitBySelection=t||!1;r.setEditor(u,i)},setRectZoomMode:function(n){var i=this,t=this.editors.rectZoomEditor;t===undefined&&(t=new CLOUD.RectZoomEditor(n.cameraEditor,n.getScene(),n.domElement),t.onUpdateUI=function(t){n.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_UPDATE_SELECTION_UI,data:t})},this.editors.rectZoomEditor=t);i.setEditor(t)},setOrbitMode:function(n){var t=this,i=this.getOrbitEditor(n);t.setEditor(i)},setZoomMode:function(n){var i=this,t=this.editors.zoomEditor;t===undefined&&(t=new CLOUD.ZoomEditor(n.cameraEditor,n.getScene(),n.domElement),this.editors.zoomEditor=t);i.setEditor(t)},setPanMode:function(n){var i=this,t=this.editors.panEditor;t===undefined&&(t=new CLOUD.PanEditor(n.cameraEditor,n.getScene(),n.domElement),this.editors.panEditor=t);i.setEditor(t)},setClipPlanesMode:function(n){var i=this,t=this.editors.clipPlanesEditor;t===undefined&&(t=new CLOUD.ClipPlanesEditor(n.cameraEditor,n.getScene(),n.domElement,function(t,i){n.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_SELECTION_CHANGED,intersect:t,click:i?2:1})}),t.onUpdateUI=function(t){n.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_UPDATE_SELECTION_UI,data:t})},this.editors.clipPlanesEditor=t,t.update(n.camera));i.setEditor(t)},setFlyMode:function(n,t){var u=this,i=this.editors.flyEditor,r;i===undefined&&(i=new CLOUD.FlyEditor(t.cameraEditor,t.getScene(),t.domElement),this.editors.flyEditor=i);r=this.getRectPickEditor(t);u.setEditor(i,r);i.showControlPanel(n);i.activate()},isFlyMode:function(){return this.editor===this.editors.flyEditor?!0:!1},zoomIn:function(n,t){n===undefined&&(n=.1);n<0&&(n=0);t.cameraEditor.zoom(n)},zoomOut:function(n,t){n===undefined&&(n=.1);n>0?n*=-1:n=0;t.cameraEditor.zoom(n)},zoomToBBox:function(n,t,i,r,u){i=i||-.05;var f=n.camera.zoomToBBox(t,i,r,u);n.cameraEditor.updateCamera(f,!0);n.render()},isAnimating:function(){return this.enableAnimation&&this.animator&&this.animator.isPlaying()},setStandardView:function(n,t,i,r){var f=t.camera,u,e;this.enableAnimation?(this.animator||(this.animator=new CLOUD.CameraAnimator),this.animator.setDuration(this.animationDuration),this.animator.setFrameTime(this.animationFrameTime),this.animator.setStandardView(n,t,i,r)):(u=t.getScene().getBoundingBox(),f.setStandardView(n,u),e=t.camera.zoomToBBox(u,i),t.cameraEditor.updateCamera(e,!0),t.render(),r&&r(),f.up.copy(THREE.Object3D.DefaultUp))},setStandardViewWithBox:function(n,t,i,r,u){var f=n.camera,e;f.setStandardView(t,i);e=f.zoomToBBox(i,r,u);n.cameraEditor.updateCamera(e);n.render();f.up.copy(THREE.Object3D.DefaultUp)},resize:function(){this.editor&&this.editor.resize()}};CLOUD.SelectPad=function(n){this.editor=n;this.dim=n.slaveEditor.cameraEditor.getContainerDimensions();this.pad=null;this.padSize=96;this.startPt=new THREE.Vector2;this.position=new THREE.Vector2;this.click=!1;this.clickCallback=null;this.intersect=null;var t=this;this.init=function(){window.addEventListener("resize",this.padInitBind,!1);this.pad=document.createElement("div");this.padInit();var n=this.editor.slaveEditor.domElement;n.appendChild(this.pad);this.addEventListener()};this.addEventListener=function(){this.pad.addEventListener("touchstart",this.padOnTouchStartBind,!1);this.pad.addEventListener("touchmove",this.padOnTouchMoveBind,!1);this.pad.addEventListener("touchend",this.padOnTouchEndBind,!1)};this.padInit=function(){this.pad!=null&&(this.pad.style.backgroundImage="url(images/selectPad.png)",this.pad.style.backgroundSize="100%",this.pad.style.position="absolute",this.pad.style.width=this.padSize.toString()+"px",this.pad.style.height=this.padSize.toString()+"px",this.pad.style.display="none")};this.showOverlay=function(n){this.position=n;this.pad.style.left=this.position.x.toString()+"px";this.pad.style.top=(this.position.y-this.dim.top).toString()+"px";this.pad.style.display="";this.pick()};this.hideOverlay=function(){this.pad.style.display="none"};this.pick=function(){var r=this.position.x,u=this.position.y,t=this.editor.slaveEditor.cameraEditor,n=this.editor.pickHelper,i=this,f=t.mapWindowToViewport(r,u);this.editor.slaveEditor.scene.pick(f,t.camera,function(r){if(!r){n.filter.setSelectedIds()&&t.updateView(!0);n.onObjectSelected(null,!1);i.intersect=null;return}var u=r.userId;if(n.intersectToWorld(r),n.filter.setSelectedIds(),n.filter.addSelectedId(u,r.object.userData,!0)){n.onObjectSelected(r,!1);i.intersect=r}else{n.onObjectSelected(null,!1);i.intersect=null}t.updateView(!0)})};this.onTouchStart=function(n){n.touches.length==1&&(n.stopPropagation(),n.preventDefault(),this.startPt.set(n.touches[0].clientX,n.touches[0].clientY),this.click=!0)};this.onTouchMove=function(n){if(n.touches.length==1){n.stopPropagation();n.preventDefault();var t=n.touches[0].clientX-this.startPt.x,i=n.touches[0].clientY-this.startPt.y;this.position.x+=t;this.position.y+=i;this.pad.style.left=this.position.x.toString()+"px";this.pad.style.top=(this.position.y-this.dim.top).toString()+"px";this.startPt.set(n.touches[0].clientX,n.touches[0].clientY);this.pick();this.click=!1}};this.onTouchEnd=function(){event.stopPropagation();this.click&&(this.clickCallback!=null?this.clickCallback(this.intersect):console.log("selectPad click",this.intersect))};this.padInitBind=this.padInit.bind(this);this.padOnTouchStartBind=this.onTouchStart.bind(this);this.padOnTouchEndBind=this.onTouchEnd.bind(this);this.padOnTouchMoveBind=this.onTouchMove.bind(this);this.init()};CLOUD=CLOUD||{};CLOUD.Loader=CLOUD.Loader||{};CLOUD.Loader.Url=function(n,t){this.serverUrl=n;this.databagId=t};CLOUD.Loader.Url.prototype.projectUrl=function(){return this.serverUrl+this.databagId+"/config.json"};CLOUD.Loader.Url.prototype.sceneUrl=function(n){return n=n||0,this.serverUrl+this.databagId+"/scene/scene_"+n};CLOUD.Loader.Url.prototype.sceneIdUrl=function(){return this.serverUrl+this.databagId+"/scene/scene_id"};CLOUD.Loader.Url.prototype.userIdUrl=function(){return this.serverUrl+this.databagId+"/scene/user_id"};CLOUD.Loader.Url.prototype.octreeUrl=function(n){return n=n||"o",this.serverUrl+this.databagId+"/scene/index_"+n};CLOUD.Loader.Url.prototype.symbolUrl=function(){return this.serverUrl+this.databagId+"/symbol/symbol"};CLOUD.Loader.Url.prototype.mpkUrl=function(n){return n=n||0,this.serverUrl+this.databagId+"/mpk/mpk_"+n};CLOUD.Loader.Url.prototype.meshIdUrl=function(){return this.serverUrl+this.databagId+"/mpk/mesh_id"};CLOUD.Loader.Url.prototype.materialUrl=function(){return this.serverUrl+this.databagId+"/material/material"};CLOUD.Loader.Url.prototype.materialIdUrl=function(){return this.serverUrl+this.databagId+"/material/material_id"};CLOUD.Loader.Url.prototype.userDataUrl=function(){return this.serverUrl+this.databagId+"/userdata/userdata"};CLOUD.Loader.IdReader=function(n){var t=new Uint32Array(n,0,2);this.size=t[0];this.count=t[1];this.cache={};this.idBuffer=n.slice(8);this.getSize=function(){return this.size};this.getCount=function(){return this.count};this.getString=function(n){if(this.cache[n]!==undefined)return this.cache[n];if(n>=0&&n<this.count){var t=new Uint8Array(this.idBuffer,this.size*n,this.size);return this.cache[n]=String.fromCharCode.apply(null,t),this.cache[n]}return undefined};this.getIndex=function(n){if(n==undefined)return-1;for(var i=0,r=this.count-1,f=n.length;i<=r;){var t=Math.floor((i+r)/2),e=new Uint8Array(this.idBuffer,this.size*t,f),o=String.fromCharCode.apply(null,e),u=n.localeCompare(o);if(u==0)return t;u<0?r=t-1:u>0&&(i=t+1)}return-1}};CLOUD.Loader.UserDataReader=function(n){this.userData=JSON.parse(n);this.count=0;for(var t in this.userData)this.userData.hasOwnProperty(t)&&this.count++;this.getCount=function(){return this.count};this.getData=function(){return this.userData};this.getUserData=function(n){return n>=0&&n<this.count?this.userData[n+""]:undefined}};CLOUD.Loader.Stack=function(){this.size=0;this.storage={}};CLOUD.Loader.Stack.prototype.push=function(n){var t=++this.size;this.storage[t]=n};CLOUD.Loader.Stack.prototype.pop=function(){var n=this.size,t;if(n)return t=this.storage[n],delete this.storage[n],this.size--,t};CLOUD.Loader.Stack.prototype.top=function(){var n=this.size;if(n)return this.storage[n]};CLOUD.Loader.Stack.prototype.empty=function(){return this.size>0?!1:!0};CLOUD.Loader.OctreeNode=function(n){n===undefined&&alert("Invalid Octant Id");this.octantId=n;this.childOctants=[];this.min=null;this.max=null;this.depth=0;this.center=null;this.size=-1;this.priority=-1};CLOUD.Loader.OctreeNode.prototype.add=function(n){n.depth=this.depth+1;this.childOctants.push(n)};CLOUD.Loader.OctreeNode.prototype.setBounds=function(n){var f,t;this.octantId==undefined&&alert("Invalid Octant Id");this.min=n[this.octantId].min;this.max=n[this.octantId].max;this.center=new THREE.Vector3(.5*(this.max.x+this.min.x),.5*(this.max.y+this.min.y),.5*(this.max.z+this.min.z));var i=this.max.x-this.min.x,r=this.max.y-this.min.y,u=this.max.z-this.min.z;for(this.size=i*i+r*r+u*u,f=this.childOctants.length,t=0;t<f;++t)this.childOctants[t].setBounds(n)};CLOUD.Loader.OctreeNode.prototype.intersectFrustum=function(n,t,i){var u,f,r,e;if(n&&this.depth<i&&(u=n.intersectsBox(new THREE.Box3(this.min,this.max))),u===!0)for(t.push(this),r=0,e=this.childOctants.length;r<e;++r)f=this.childOctants[r],f.intersectFrustum(n,t,i)};CLOUD.Loader.OctreeNode.prototype.intersectFrustumWithPriority=function(n,t,i,r,u,f,e){var h,c,o,l,a,s,v;if(n&&this.depth<t&&(h=n.intersectsBox(new THREE.Box3(this.min,this.max))),h===!0)for(o=new THREE.Vector3(this.center.x-i.x,this.center.y-i.y,this.center.z-i.z),l=o.lengthSq(),o.normalize(),a=o.dot(r),this.priority=1/(l*a),u?this.priority*=this.size:this.depth<f&&(this.priority*=this.size),e.push(this),s=0,v=this.childOctants.length;s<v;++s)c=this.childOctants[s],c.intersectFrustumWithPriority(n,t,i,r,u,f,e)};CLOUD.Loader.OctreeNode.prototype.findRadiusNeighborOctants=function(n,t,i,r,u){var e,o=!1,s,h,f,c;if(n&&this.depth<r&&(o=!(n.x+t<this.min.x||n.x-t>this.max.x||n.y+t<this.min.y||n.y-t>this.max.y||n.z+t<this.min.z||n.z-t>this.max.z)),o===!0)for(s=new THREE.Vector3(.5*(this.max.x+this.min.x)-n.x,.5*(this.max.y+this.min.y)-n.y,.5*(this.max.z+this.min.z)-n.z),h=s.lengthSq(),h<i&&u.push(this),f=0,c=this.childOctants.length;f<c;++f)e=this.childOctants[f],e.findRadiusNeighborOctants(n,t,i,r,u)};CLOUD.Loader.OctreeNode.prototype.intersectRayDistance=function(n,t){var i,r,u,f,h=1/t.x,e,o,c,s;return(t.x>=0?(i=(this.min.x-n.x)*h,r=(this.max.x-n.x)*h):(i=(this.max.x-n.x)*h,r=(this.min.x-n.x)*h),e=1/t.y,t.y>=0?(u=(this.min.y-n.y)*e,f=(this.max.y-n.y)*e):(u=(this.max.y-n.y)*e,f=(this.min.y-n.y)*e),i>f||u>r)?Infinity:(u>i&&(i=u),f<r&&(r=f),s=1/t.z,t.z>=0?(o=(this.min.z-n.z)*s,c=(this.max.z-n.z)*s):(o=(this.max.z-n.z)*s,TZmaz=(this.min.z-n.z)*s),i>c||o>r)?Infinity:(o>i&&(i=o),c<r&&(r=c),i)};CLOUD.Loader.OctreeNode.prototype.getDepthDescending=function(){var t,n;for(this.depth>CLOUD.GlobalData.MaximumDepth&&(CLOUD.GlobalData.MaximumDepth=this.depth),t=this.childOctants.length,n=0;n<t;++n)this.childOctants[n].getDepthDescending()};CLOUD.Loader.OctreeLoader=function(n){this.manager=n;this.loader=new THREE.XHRLoader(n)};CLOUD.Loader.OctreeLoader.prototype={constructor:CLOUD.Loader.OctreeLoader,load:function(n,t){function e(n){for(var w=n.length,t=0,b=null,o=null,s=new CLOUD.Loader.Stack,k=0,d=[],f,e,h,r,c,l,a,v,y,p;t<w&&n[t]!="D";){if(n[t]=="{"){for(f="",++t;n[t]!="}"&&n[t]!="{";)f+=n[t],++t;--t;f===undefined&&alert("bad id");e=new CLOUD.Loader.OctreeNode(f,0);d.push(f);++k;o==null?b=e:o.add(e);s.push(e);o=e}else n[t]=="}"&&(s.pop(),s.empty()||(o=s.top()));++t}for(i=b,++t,h=0,r=1e3;t<w&&h<=k;){for(c="";n[t]!=",";)c+=n[t],++t;for(++t,l="";n[t]!=",";)l+=n[t],++t;for(++t,a="";n[t]!=",";)a+=n[t],++t;for(++t,v="";n[t]!=",";)v+=n[t],++t;for(++t,y="";n[t]!=",";)y+=n[t],++t;for(++t,p="";n[t]!=",";)p+=n[t],++t;++t;u[d[h]]=new THREE.Box3(new THREE.Vector3(c*r,l*r,a*r),new THREE.Vector3(v*r,y*r,p*r));++h}i.setBounds(u);i.getDepthDescending();CLOUD.Logger.log("Maximum Depth:",CLOUD.GlobalData.MaximumDepth)}var f=this,r=this.loader,i,u=[];r.setCrossOrigin(f.manager.crossOrigin);r.load(n,function(n){e(n);t(i)})}};CLOUD.Loader.Material=function(n,t){var i=new Uint32Array(n,t,5),r;this.id=i[0];this.color=i[1];this.emissive=i[2];this.specular=i[3];this.side=i[4];r=new Float32Array(n,t+20,2);this.shininess=r[0];this.opacity=r[1];i=null;r=null};CLOUD.Loader.MaterialReader=function(n){var t=new Uint32Array(n,0,2),i;this.count=t[0];this.offset=t[1];this.dataSize=28;this.dataBuffer=n.slice(this.offset);this.material_id=-1;i=new ArrayBuffer(this.dataSize);this.material_cur=new CLOUD.Loader.Material(i,0);t=null};CLOUD.Loader.MaterialReader.prototype={constructor:CLOUD.Loader.MaterialReader,getData:function(n){if(n>=0&&n<this.count)return new CLOUD.Loader.Material(this.dataBuffer,n*this.dataSize)},getDataInfo:function(n){var t,i;return n==this.material_id?this.material_cur:n>=0&&n<this.count?(t=new Uint32Array(this.dataBuffer,n*this.dataSize,5),this.material_cur.id=t[0],this.material_cur.color=t[1],this.material_cur.emissive=t[2],this.material_cur.specular=t[3],this.material_cur.side=t[4],i=new Float32Array(this.dataBuffer,n*this.dataSize+20,2),this.material_cur.shininess=i[0],this.material_cur.opacity=i[1],this.material_id=n,this.material_cur):void 0}};CLOUD.Loader.SymbolHeader=function(n){var t=new Uint32Array(n,0,11),i;this.blockId=t[0];this.symbolCount=t[1];this.itemCount=t[2];this.matrixCount=t[3];this.meshCount=t[4];this.geomCount=t[5];this.symbolOffset=t[6];this.itemOffset=t[7];this.matrixOffset=t[8];this.meshOffset=t[9];this.geomOffset=t[10];i=new Float32Array(n,44,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5]));t=null;i=null};CLOUD.Loader.Symbol=function(n,t){var r=new Int32Array(n,t,3),i;this.symbolId=r[0];this.itemIndex=r[1];this.itemCount=r[2];i=new Float32Array(n,t+12,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5]));r=null;i=null};CLOUD.Loader.SymbolReader=function(n){this.header=new CLOUD.Loader.SymbolHeader(n);this.symbolSize=36;this.itemSize=52;this.matrixSize=64;this.meshSize=8;this.geomSize=32;this.maxSize=256;this.symbolBuffer=n.slice(this.header.symbolOffset,this.header.symbolOffset+this.header.symbolCount*this.symbolSize);this.itemBuffer=n.slice(this.header.itemOffset,this.header.itemOffset+this.header.itemCount*this.itemSize);this.matrixBuffer=n.slice(this.header.matrixOffset,this.header.matrixOffset+this.header.matrixCount*this.matrixSize);this.meshBuffer=n.slice(this.header.meshOffset,this.header.meshOffset+this.header.meshCount*this.meshSize);this.geomBuffer=n.slice(this.header.geomOffset,this.header.geomOffset+this.header.geomOffset*this.geomSize);this.matr_cur_id=-1;this.pt_symb_min=new THREE.Vector3(0,0,0);this.pt_symb_max=new THREE.Vector3(0,0,0);this.pt_item_min=new THREE.Vector3(0,0,0);this.pt_item_max=new THREE.Vector3(0,0,0);var t=new ArrayBuffer(this.maxSize);this.symb_cur=new CLOUD.Loader.Symbol(t,0);this.item_cur=new CLOUD.Loader.Item(t,0);this.matr_cur=new CLOUD.Loader.Matrix(t,0);this.mesh_cur=new CLOUD.Loader.MeshAttr(t,0);this.geom_cur=new CLOUD.Loader.GeomAttr(t,0);this.symb_cur.boundingBox.set(this.pt_symb_min,this.pt_symb_max);this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max)};CLOUD.Loader.SymbolReader.prototype={constructor:CLOUD.Loader.SymbolReader,getSymbol:function(n){if(n>=0&&n<this.header.symbolCount)return new CLOUD.Loader.Symbol(this.symbolBuffer,n*this.symbolSize)},getItem:function(n){if(n>=0&&n<this.header.itemCount)return new CLOUD.Loader.Item(this.itemBuffer,n*this.itemSize)},getMatrix:function(n){if(n>=0&&n<this.header.matrixCount)return new CLOUD.Loader.Matrix(this.matrixBuffer,n*this.matrixSize)},getMeshAttr:function(n){if(n>=0&&n<this.header.meshCount)return new CLOUD.Loader.MeshAttr(this.meshBuffer,n*this.meshSize)},getGeomAttr:function(n){if(n>=0&&n<this.header.geomCount)return new CLOUD.Loader.GeomAttr(this.geomBuffer,n*this.geomSize)},getSymbolInfo:function(n){var i,t;if(n>=0&&n<this.header.symbolCount)return i=new Int32Array(this.symbolBuffer,n*this.symbolSize,3),this.symb_cur.symbolId=i[0],this.symb_cur.itemIndex=i[1],this.symb_cur.itemCount=i[2],t=new Float32Array(this.symbolBuffer,n*this.symbolSize+12,6),this.pt_symb_min.set(t[0],t[1],t[2]),this.pt_symb_max.set(t[3],t[4],t[5]),this.symb_cur.boundingBox.set(this.pt_symb_min,this.pt_symb_max),this.symb_cur},getItemInfo:function(n){var t,i;if(n>=0&&n<this.header.itemCount)return t=new Int32Array(this.itemBuffer,n*this.itemSize,7),this.item_cur.ItemId=t[0],this.item_cur.originalId=t[1],this.item_cur.materialId=t[2],this.item_cur.userDataId=t[3],this.item_cur.matrixId=t[4],this.item_cur.type=t[5],this.item_cur.attrIndex=t[6],i=new Float32Array(this.itemBuffer,n*this.itemSize+28,6),this.pt_item_min.set(i[0],i[1],i[2]),this.pt_item_max.set(i[3],i[4],i[5]),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max),this.item_cur},getMatrixInfo:function(n){if(n==this.matr_cur_id)return this.matr_cur;if(n>=0&&n<this.header.matrixCount){var t=new Float32Array(this.matrixBuffer,n*this.matrixSize,16);return this.matr_cur.matrix.fromArray(t),this.matr_cur_id=n,this.matr_cur}},getMeshAttrInfo:function(n){if(n>=0&&n<this.header.meshCount){var t=new Int32Array(this.meshBuffer,n*this.meshSize,2);return this.mesh_cur.blockId=t[0],this.mesh_cur.meshId=t[1],this.mesh_cur}},getGeomInfo:function(n){if(n>=0&&n<this.header.geomCount){var t=new Float32Array(this.geomBuffer,n*this.geomSize,8);return this.geom_cur.startPt.set(t[0],t[1],t[2]),this.geom_cur.endPt.set(t[3],t[4],t[5]),this.geom_cur.radius=t[6],this.geom_cur.thickness=t[7],this.geom_cur}}};CLOUD.Loader.MPKHeader=function(n){var t=new Uint32Array(n,0,7);this.blockId=t[0];this.startId=t[1];this.vtFormat=t[2];this.meshCount=t[3];this.meshOffset=t[4];this.bufferSize=t[5];this.bufferOffset=t[6];t=null};CLOUD.Loader.MeshData=function(n,t){var r=new Uint32Array(n,t,4),i;this.mesh_id=r[0];this.ptCount=r[1];this.idxCount=r[2];this.dataOffset=r[3];i=new Float32Array(n,t+16,4);this.baseScale=i[0];this.baseVector=new THREE.Vector3(i[1],i[2],i[3]);r=null;i=null};CLOUD.Loader.MPKReader=function(n){this.header=new CLOUD.Loader.MPKHeader(n);this.meshSize=32;this.maxSize=256;this.meshBuffer=n.slice(this.header.meshOffset,this.header.meshOffset+this.header.meshCount*this.meshSize);this.geomBuffer=n.slice(this.header.bufferOffset,this.header.bufferOffset+this.header.bufferSize);this.mesh_cur_id=-1;this.pt_pos=new THREE.Vector3(0,0,0);var t=new ArrayBuffer(this.maxSize);this.mesh_cur=new CLOUD.Loader.MeshData(t,0);this.mesh_cur.baseVector=this.pt_pos};CLOUD.Loader.MPKReader.prototype={constructor:CLOUD.Loader.MPKReader,getMeshData:function(n){var t=n-this.header.startId;if(t>=0&&t<this.header.meshCount)return new CLOUD.Loader.MeshData(this.meshBuffer,t*this.meshSize)},getMeshInfo:function(n){var t,i,r;return n==this.mesh_cur_id?this.mesh_cur:(t=n-this.header.startId,t>=0&&t<this.header.meshCount?(i=new Uint32Array(this.meshBuffer,t*this.meshSize,4),this.mesh_cur.mesh_id=i[0],this.mesh_cur.ptCount=i[1],this.mesh_cur.idxCount=i[2],this.mesh_cur.dataOffset=i[3],r=new Float32Array(this.meshBuffer,t*this.meshSize+16,4),this.mesh_cur.baseScale=r[0],this.mesh_cur.baseVector.set(r[1],r[2],r[3]),this.mesh_cur_id=n,this.mesh_cur):void 0)},getPtBuffer:function(n){var i=n-this.header.startId,t;if(i>=0&&i<this.header.meshCount)return(t=this.getMeshInfo(n),t===undefined)?undefined:t.baseScale==0?new Float32Array(this.geomBuffer,t.dataOffset,t.ptCount*3):new Uint16Array(this.geomBuffer,t.dataOffset,t.ptCount*3)},getIdxBuffer:function(n){var r=n-this.header.startId,t,i;if(r>=0&&r<this.header.meshCount)return(t=this.getMeshInfo(n),t===undefined)?undefined:(i=t.dataOffset,t.baseScale==0?i+=t.ptCount*12:(i+=t.ptCount*6,t.ptCount%2==1&&(i+=2)),t.ptCount>65535?new Uint32Array(this.geomBuffer,i,t.idxCount):new Uint16Array(this.geomBuffer,i,t.idxCount))},getNormalBuffer:function(n){var r=n-this.header.startId,t,i;if((this.header.vtFormat&2)==2&&r>=0&&r<this.header.meshCount)return(t=this.getMeshInfo(n),t===undefined)?undefined:(i=t.dataOffset,t.baseScale==0?i+=t.ptCount*12:(i+=t.ptCount*6,t.ptCount%2==1&&(i+=2)),t.ptCount>65535?i+=t.idxCount*4:(i+=t.idxCount*2,t.idxCount%2==1&&(i+=2)),new Float32Array(this.geomBuffer,i,t.ptCount*3))}};CLOUD.Loader.SceneHeader=function(n){var t=new Uint32Array(n,0,13),i;this.blockId=t[0];this.cellCount=t[1];this.itemCount=t[2];this.userDataCount=t[3];this.matrixCount=t[4];this.meshCount=t[5];this.geomCount=t[6];this.cellOffset=t[7];this.itemOffset=t[8];this.userDataOffset=t[9];this.matrixOffset=t[10];this.meshOffset=t[11];this.geomOffset=t[12];i=new Float32Array(n,52,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5]));t=null;i=null};CLOUD.Loader.Cell=function(n,t){var r=new Int32Array(n,t,5),i;this.cellId=r[0];this.depth=r[1];this.itemIndex=r[2];this.itemCount=r[3];this.layerCount=r[4];this.layerIdxBuffer=new Int32Array(n,t+20,64);this.categoryBuffer=new Int32Array(n,t+276,64);i=new Float32Array(n,t+532,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5]));r=null;i=null};CLOUD.Loader.Item=function(n,t){var i=new Int32Array(n,t,7),r;this.ItemId=i[0];this.originalId=i[1];this.materialId=i[2];this.userDataId=i[3];this.matrixId=i[4];this.type=i[5];this.attrIndex=i[6];r=new Float32Array(n,t+28,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(r[0],r[1],r[2]),new THREE.Vector3(r[3],r[4],r[5]));i=null;r=null};CLOUD.Loader.Matrix=function(n,t){var i=new Float32Array(n,t,16);this.matrix=(new THREE.Matrix4).fromArray(i);i=null};CLOUD.Loader.UserData=function(n,t){var i=new Int32Array(n,t,3);this.category=i[0];this.scene_id=i[1];this.plan=i[2];this.classCode=new Uint8Array(n,t+12,20);i=null};CLOUD.Loader.MeshAttr=function(n,t){var i=new Int32Array(n,t,2);this.blockId=i[0];this.meshId=i[1];i=null};CLOUD.Loader.GeomAttr=function(n,t){var i=new Float32Array(n,t,8);this.startPt=new THREE.Vector3(i[0],i[1],i[2]);this.endPt=new THREE.Vector3(i[3],i[4],i[5]);this.radius=i[6];this.thickness=i[7];i=null};CLOUD.Loader.SceneReader=function(n){this.header=new CLOUD.Loader.SceneHeader(n);this.cellSize=556;this.itemSize=52;this.matrixSize=64;this.userDataSize=32;this.meshSize=8;this.geomSize=32;this.maxSize=1024;this.cellBuffer=n.slice(this.header.cellOffset,this.header.cellOffset+this.header.cellCount*this.cellSize);this.itemBuffer=n.slice(this.header.itemOffset,this.header.itemOffset+this.header.itemCount*this.itemSize);this.matrixBuffer=n.slice(this.header.matrixOffset,this.header.matrixOffset+this.header.matrixCount*this.matrixSize);this.userDataBuffer=n.slice(this.header.userDataOffset,this.header.userDataOffset+this.header.userDataCount*this.userDataSize);this.meshBuffer=n.slice(this.header.meshOffset,this.header.meshOffset+this.header.meshCount*this.meshSize);this.geomBuffer=n.slice(this.header.geomOffset,this.header.geomOffset+this.header.geomOffset*this.geomSize);this.matr_cur_id=-1;this.user_cur_id=-1;this.pt_cell_min=new THREE.Vector3(0,0,0);this.pt_cell_max=new THREE.Vector3(0,0,0);this.pt_item_min=new THREE.Vector3(0,0,0);this.pt_item_max=new THREE.Vector3(0,0,0);var t=new ArrayBuffer(this.maxSize);this.cell_cur=new CLOUD.Loader.Cell(t,0);this.item_cur=new CLOUD.Loader.Item(t,0);this.matr_cur=new CLOUD.Loader.Matrix(t,0);this.user_cur=new CLOUD.Loader.UserData(t,0);this.mesh_cur=new CLOUD.Loader.MeshAttr(t,0);this.geom_cur=new CLOUD.Loader.GeomAttr(t,0);this.cell_cur.boundingBox.set(this.pt_cell_min,this.pt_cell_max);this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max)};CLOUD.Loader.SceneReader.prototype={constructor:CLOUD.Loader.SceneReader,getCellMpks:function(n){var t,u,r,f,s,e,o,i;if(n>=0&&n<this.header.cellCount){for(t=[],u=this.getCellInfo(n),r=u.itemIndex;r<u.itemCount;++r)f=this.getItemInfo(r),f.type==1&&(s=this.getMeshAttrInfo(f.attrIndex),t.push(s.blockId));for(e={},o=[],i=0;i<t.length;++i)e[t[i]]||(e[t[i]]=!0,o.push(t[i]));return o}},getCell:function(n){if(n>=0&&n<this.header.cellCount)return new CLOUD.Loader.Cell(this.cellBuffer,n*this.cellSize)},getItem:function(n){if(n>=0&&n<this.header.itemCount)return new CLOUD.Loader.Item(this.itemBuffer,n*this.itemSize)},getMatrix:function(n){if(n>=0&&n<this.header.matrixCount)return new CLOUD.Loader.Matrix(this.matrixBuffer,n*this.matrixSize)},getUserData:function(n){if(n>=0&&n<this.header.userDataCount)return new CLOUD.Loader.UserData(this.userDataBuffer,n*this.userDataSize)},getMeshAttr:function(n){if(n>=0&&n<this.header.meshCount)return new CLOUD.Loader.MeshAttr(this.meshBuffer,n*this.meshSize)},getGeomAttr:function(n){if(n>=0&&n<this.header.geomCount)return new CLOUD.Loader.GeomAttr(this.geomBuffer,n*this.geomSize)},getCellInfo:function(n){var i,t;if(n>=0&&n<this.header.cellCount)return i=new Int32Array(this.cellBuffer,n*this.cellSize,5),this.cell_cur.cellId=i[0],this.cell_cur.depth=i[1],this.cell_cur.itemIndex=i[2],this.cell_cur.itemCount=i[3],this.cell_cur.layerCount=i[4],this.cell_cur.layerIdxBuffer=new Int32Array(this.cellBuffer,n*this.cellSize+20,64),this.cell_cur.categoryBuffer=new Int32Array(this.cellBuffer,n*this.cellSize+276,64),t=new Float32Array(this.cellBuffer,n*this.cellSize+532,6),this.pt_cell_min.set(t[0],t[1],t[2]),this.pt_cell_max.set(t[3],t[4],t[5]),this.cell_cur.boundingBox.set(this.pt_cell_min,this.pt_cell_max),this.cell_cur},getItemInfo:function(n){var t,i;if(n>=0&&n<this.header.itemCount)return t=new Int32Array(this.itemBuffer,n*this.itemSize,7),this.item_cur.ItemId=t[0],this.item_cur.originalId=t[1],this.item_cur.materialId=t[2],this.item_cur.userDataId=t[3],this.item_cur.matrixId=t[4],this.item_cur.type=t[5],this.item_cur.attrIndex=t[6],i=new Float32Array(this.itemBuffer,n*this.itemSize+28,6),this.pt_item_min.set(i[0],i[1],i[2]),this.pt_item_max.set(i[3],i[4],i[5]),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max),this.item_cur},getMatrixInfo:function(n){if(n==this.matr_cur_id)return this.matr_cur;if(n>=0&&n<this.header.matrixCount){var t=new Float32Array(this.matrixBuffer,n*this.matrixSize,16);return this.matr_cur.matrix.fromArray(t),this.matr_cur_id=n,this.matr_cur}},getUserInfo:function(n){if(n==this.user_cur_id)return this.user_cur;if(n>=0&&n<this.header.userDataCount){var t=new Int32Array(this.userDataBuffer,n*this.userDataSize,3);return this.user_cur.category=t[0],this.user_cur.scene_id=t[1],this.user_cur.plan=t[2],this.user_cur.classCode=new Uint8Array(this.userDataBuffer,n*this.userDataSize+12,20),this.user_cur_id=n,this.user_cur}},getMeshAttrInfo:function(n){if(n>=0&&n<this.header.meshCount){var t=new Int32Array(this.meshBuffer,n*this.meshSize,2);return this.mesh_cur.blockId=t[0],this.mesh_cur.meshId=t[1],this.mesh_cur}},getGeomInfo:function(n){if(n>=0&&n<this.header.geomCount){var t=new Float32Array(this.geomBuffer,n*this.geomSize,8);return this.geom_cur.startPt.set(t[0],t[1],t[2]),this.geom_cur.endPt.set(t[3],t[4],t[5]),this.geom_cur.radius=t[6],this.geom_cur.thickness=t[7],this.geom_cur}}};CLOUD.Model=function(n,t,i,r){THREE.LoadingManager.call(this);this.manager=n;this.serverUrl=t;this.databagId=i;this.texturePath=r;this.crossOrigin=!0;this.modelUrl=new CLOUD.Loader.Url(t,i);this.filter=this.manager.scene.filter;this.pool=this.manager.scene.meshPool;this.cache={cells:{},geometries:{},materials:{},instancedMaterials:{}};this.loader=new THREE.XHRLoader(this);this.octreeLoader=new CLOUD.Loader.OctreeLoader(this);this.octreeRootNode=null;this.octreeRootNodeI=null;this.visibleOctant=[];this.materialReader=null;this.symbolReader=null;this.userIdReader=null;this.userDataReader=null;this.sceneArray=null;this.sceneCount=0;this.mpkArray=null;this.mpkCount=0;this.symbolCount=0;this.octree_o=1;this.octree_i=1;this.taskCount=0;this.maxTaskCount=5;this.containsCamera=!1;this.load_complete=!1;this.referencedMeshCache={};this.taskManager=new CLOUD.TaskManager(this);this.userWorker=!1;this.notifyProgress=!0;this.highPriorityNodes=[];this.lowPriorityNodes=[]};CLOUD.Model.prototype=Object.create(THREE.LoadingManager.prototype);CLOUD.Model.prototype.constructor=CLOUD.Model;CLOUD.Model.prototype.load=function(n){var t=this,i=this.modelUrl;this.notifyProgress=n;this.loader.setResponseType("");this.loader.setCrossOrigin(this.crossOrigin);this.loader.load(i.projectUrl(),function(n){var r=JSON.parse(n),f,o,u,e;for(t.sceneCount=r.metadata.scenes,t.mpkCount=r.metadata.mpks,t.symbolCount=r.metadata.symbol,t.octree_o=r.metadata.octree_o,t.octree_i=r.metadata.octree_i,t.sceneArray=new Array(t.sceneCount),t.manager.scene.parseRootNode(r),t.load_complete=!1,t.mpkCount>0&&(t.maxTaskCount+=t.mpkCount-1),f=0,t.loader.setResponseType("arraybuffer"),t.loader.load(i.sceneUrl(f),function(n){var i=new CLOUD.Loader.SceneReader(n);i.header.blockId<t.sceneCount&&(t.sceneArray[i.header.blockId]=i);i=null;t.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_START,sceneId:f})}),o=t.mpkCount,u=0;u<o;++u)t.taskManager.addMpkTask(u);t.taskManager.processMpkTasks(t.onTaskFinished);t.loader.setResponseType("arraybuffer");t.loader.load(i.materialUrl(),function(n){t.parseMaterial(n);t.onTaskFinished()});t.symbolCount>0?(t.loader.setResponseType("arraybuffer"),t.loader.load(i.symbolUrl(),function(n){t.parseSymbol(n);t.onTaskFinished()})):t.maxTaskCount-=1;e=t.octreeLoader;t.octree_o>0&&e.load(i.octreeUrl("o"),function(n){t.octreeRootNode=n});t.octree_i>0&&e.load(i.octreeUrl("i"),function(n){t.octreeRootNodeI=n});t.loader.setResponseType("arraybuffer");t.loader.load(i.userIdUrl(),function(n){t.parseUserId(n);t.onTaskFinished()});t.loader.setResponseType("");t.loader.load(i.userDataUrl(),function(n){t.parseUserData(n);t.onTaskFinished()})})};CLOUD.Model.prototype.loadMpk=function(n,t){var i=this,r=this.modelUrl;this.loader.setResponseType("arraybuffer");this.loader.load(r.mpkUrl(n),function(n){if(i.userWorker){var r=new Worker(CLOUD.GlobalData.MpkWorkerUrl);r.onmessage=function(n){var r=n.data;for(var u in r)r.hasOwnProperty(u)&&(i.referencedMeshCache[u]=r[u]);t();i.onTaskFinished()};r.postMessage({msg:n})}else i.parseMpk(n),t(),i.onTaskFinished()})};CLOUD.Model.prototype.onTaskFinished=function(){if(this.taskCount++,this.notifyProgress){var n={total:this.maxTaskCount,loaded:this.taskCount};this.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:n})}this.taskCount>=this.maxTaskCount&&(this.load_complete=!0,this.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_COMPLETE}))};CLOUD.Model.prototype.destroy=function(){var t,i;for(var n in this.cache.geometries)t=this.cache.geometries[n],t.dispose();for(n in this.cache.materials)i=this.cache.materials[n],i.dispose();this.cache={cells:{},geometries:{},materials:{},instancedMaterials:{}};this.cache=null;this.loader=null;this.userIdReader=null;this.userDataReader=null;this.octreeLoader=null;this.octreeRootNode=null;this.octreeRootNodeI=null;this.visibleOctant=null;this.materialReader=null;this.symbolReader=null;this.sceneArray=null;this.mpkArray=null};CLOUD.Model.prototype.setCrossOrigin=function(n){this.crossOrigin=n};CLOUD.Model.prototype.parseMaterial=function(n){var f,e,u,i,t,r;if(this.materialReader=new CLOUD.Loader.MaterialReader(n),f=this.materialReader,e=f.count,!(e<0))for(u=0;u<e;++u)i={},t=f.getData(u),t.color!==undefined&&(i.color=t.color),t.opacity!==undefined&&(i.opacity=t.opacity,t.opacity<1&&(i.transparent=!0)),t.side!==undefined&&t.side&&(i.side=THREE.DoubleSide),CLOUD.ShaderMaterial.ShaderLib===undefined?r=new THREE.MeshBasicMaterial(i):(t.emissive!==undefined&&(i.emissive=t.emissive),t.specular!==undefined&&(i.specular=t.specular),t.shininess!==undefined&&(i.shininess=t.shininess),r=new THREE.MeshPhongMaterial(i),r.type="phong_cust_clip",r.uniforms=CLOUD.ShaderMaterial.ShaderLib.phong_cust_clip.uniforms,r.vertexShader=CLOUD.ShaderMaterial.ShaderLib.phong_cust_clip.vertexShader,r.fragmentShader=CLOUD.ShaderMaterial.ShaderLib.phong_cust_clip.fragmentShader),r.name=u,this.cache.materials[u]=r,i=null};CLOUD.Model.prototype.parseSymbol=function(n){this.symbolReader=new CLOUD.Loader.SymbolReader(n)};CLOUD.Model.prototype.parseMpk=function(n){for(var i=new MPK.MPKReader(n),t=i.header.startId,e=t+i.header.meshCount;t<e;++t){var r=i.getPtBuffer(t),u=i.getIdxBuffer(t),f=i.getNormalBuffer(t),o=i.getMeshData(t);if(r==undefined||u==undefined||f==undefined){CLOUD.Logger.log("Error Geometry!");continue}this.referencedMeshCache[t]={P:r,I:u,N:f,M:o}}i=null};CLOUD.Model.prototype.parseUserId=function(n){this.userIdReader=new CLOUD.Loader.IdReader(n)};CLOUD.Model.prototype.parseUserData=function(n){this.userDataReader=new CLOUD.Loader.UserDataReader(n)};CLOUD.Model.prototype.readMesh=function(n,t,i,r,u){var s=this.cache.cells[t],e=this.cache.geometries,h=r?r.userDataId:i.userDataId,c=r?r.originalId:i.originalId,l=this.userIdReader.getString(c),f;if(i.type==1?f=this.getMeshNodeAttribute(n,i,r):i.type==2?f=CLOUD.GeomUtil.getMeshNodeAttrOfTube(e,n,i,r):i.type==3?f=CLOUD.GeomUtil.getMeshNodeAttrOfPipe(e,n,i,r):i.type==4&&(f=CLOUD.GeomUtil.getMeshNodeAttrOfBox(e,n,i,r)),f){var a=f.nodeId,v=this.userDataReader.getUserData(h),y=f.matrix.clone(),o={nodeId:a,userId:l,userData:v,meshId:f.meshId,matrix:y,materialId:i.materialId,customPriority:u};s.push(o);this.pushMeshNode(o);f=null}};CLOUD.Model.prototype.readSymbol=function(n,t,i,r){var o,f,u,e;if(this.symbolReader!=null&&(o=this.symbolReader.header.symbolCount,n>=0&&n<o))for(f=this.symbolReader.getSymbolInfo(n),u=f.itemIndex;u<f.itemCount;++u)(e=this.symbolReader.getItemInfo(u),e.type!=0)&&this.readMesh(this.symbolReader,t,e,i,r)};CLOUD.Model.prototype.getMeshNodeAttribute=function(n,t,i){var o=n.getMatrixInfo(t.matrixId).matrix.clone(),c=n.getMeshAttrInfo(t.attrIndex),y=i?i.ItemId+"_"+t.ItemId:t.ItemId,u=c.meshId,s=this.referencedMeshCache,r=s[u].M,h,f,e;if(r==undefined)return CLOUD.Logger.log("No mesh information."),null;if(h=this.cache.geometries,f=h[u],!f){var l=s[u].P,a=s[u].I,v=s[u].N;if(l==undefined||a==undefined||v==undefined)return CLOUD.Logger.log("empty mesh data"),null;f=new THREE.BufferGeometry;f.setIndex(new THREE.BufferAttribute(a,1));f.addAttribute("position",new THREE.BufferAttribute(l,3));f.addAttribute("normal",new THREE.BufferAttribute(v,3));h[u]=f}return e=new THREE.Matrix4,e.setPosition(new THREE.Vector3(r.baseVector[0],r.baseVector[1],r.baseVector[2])),e.scale(new THREE.Vector3(r.baseScale,r.baseScale,r.baseScale)),r.baseScale!=0&&o.multiply(e),i&&o.multiplyMatrices(i.matrix,o),c=null,e=null,{nodeId:y,meshId:u,matrix:o}};CLOUD.Model.prototype.calcVisibleOctant=function(n){var s,o;if(!this.octreeRootNode)return CLOUD.Logger.log("octree load is not finish!"),0;this.visibleOctant.length=0;var r=this.manager.getWorldFrustum(n,!0),t=n.position,u=CLOUD.GlobalData.OctantDepth;this.manager.updateOctreeBox(this.octreeRootNode);var f=CLOUD.GlobalData.MaximumDepth*.7,e=n.target,i=new THREE.Vector3(e.x-t.x,e.y-t.y,e.z-t.z);return i.normalize(),s=new THREE.Vector3,this.containsCamera&&this.octreeRootNodeI!=null?(this.octreeRootNodeI.intersectFrustumWithPriority(r,u,t,i,!0,f,this.visibleOctant),CLOUD.Logger.log("Inner: ",this.visibleOctant.length),this.octreeRootNode.intersectFrustumWithPriority(r,u,t,i,!0,f,this.visibleOctant)):(this.octreeRootNode.intersectFrustumWithPriority(r,u,t,i,!1,f,this.visibleOctant),CLOUD.Logger.log("Outer: ",this.visibleOctant.length)),o=this.visibleOctant.length,CLOUD.Logger.log("Total Octant Count: ",this.visibleOctant.length),o};CLOUD.Model.prototype.sortVisibleOctant=function(n){var t=n.position;this.visibleOctant.sort(function(n,i){var r,u;if(this.containsCamera){if(r=t.x<n.min.x||t.x>n.max.x||t.y<n.min.y||t.y>n.max.y||t.z<n.min.z||t.z>n.max.z,!r)return-1;if(u=t.x<i.min.x||t.x>i.max.x||t.y<i.min.y||t.y>i.max.y||t.z<i.min.z||t.z>i.max.z,!u)return 1}return n.priority>i.priority?-1:n.priority<i.priority?1:0})};CLOUD.Model.prototype.readItemData=function(n,t,i,r){var u=n.getItemInfo(t),e,f;u!==undefined&&(u.type===0?(e=n.getMatrixInfo(u.matrixId).matrix.clone(),f={matrix:e,ItemId:u.ItemId,originalId:u.originalId,userDataId:u.userDataId},this.readSymbol(u.attrIndex,i,f,r),f=null):this.readMesh(n,i,u,null,r))};CLOUD.Model.prototype.prepare=function(n,t){var tt=this.sceneArray?this.sceneArray.length:0,r,c,h,u,l,d,f,e,b,a,i;if(!(tt<1)&&this.load_complete){if(r=this.sceneArray[0],!r){CLOUD.Logger.log("Empty scene");return}if(CLOUD.Logger.time("prepareScene"),c=0,c=CLOUD.GlobalData.DisableOctant?r.header.cellCount:this.calcVisibleOctant(n),c!==0){CLOUD.GlobalData.DisableOctant||this.sortVisibleOctant(n);var o=this.pool,v=this.filter,y=this.databagId,s=this.cache.cells,p=this.cache.geometries,w=this.cache.materials,k=this.manager.highPriorityCategories;t&&o.clear();this.customPriorityNodes=[];this.highPriorityNodes=[];this.lowPriorityNodes=[];var it=this.highPriorityNodes,rt=this.lowPriorityNodes,ut=this.customPriorityNodes;for(h=0;h<c;++h)if(u=CLOUD.GlobalData.DisableOctant?h:this.visibleOctant[h].octantId,l=s[u],l)for(i=0,d=l.length;i<d;++i)this.pushMeshNode(l[i]);else if(s[u]=[],f=r.getCellInfo(u),k){var g=f.layerCount,nt=f.layerIdxBuffer,ft=f.categoryBuffer;for(e=0;e<g;++e)if(b=nt[e],a=f.itemCount,e<g-1&&(a=nt[e+1]),k[ft[e]])for(i=b;i<a;++i)this.readItemData(r,i,u,!0);else for(i=b;i<a;++i)this.readItemData(r,i,u)}else for(i=f.itemIndex;i<f.itemCount;++i)this.readItemData(r,i,u);this.updateMeshNodes(it,o,v,s,p,w,y);this.updateMeshNodes(ut,o,v,s,p,w,y);this.updateMeshNodes(rt,o,v,s,p,w,y);CLOUD.Logger.log("mesh count:",o.counter);CLOUD.Logger.timeEnd("prepareScene")}}};CLOUD.Model.prototype.clearCells=function(){this.cache.cells={}};CLOUD.Model.prototype.pushMeshNode=function(n){var i=this.filter,r=n.userId,t=n.userData,f=n.customPriority,e=this.highPriorityNodes,o=this.lowPriorityNodes,s=this.customPriorityNodes,u;t&&i.hasFileFilter(t.sceneId)||i.isVisibleById(r,t)!==!1&&(u=i.hasHighlightMaterial(r,t),u?e.push(n):f?s.push(n):o.push(n))};CLOUD.Model.prototype.updateMeshNodes=function(n,t,i,r,u,f,e){var c=n.length,s,h;if(!(c<1))for(s=0;s<c;++s){var o=n[s],p=o.nodeId,l=o.userId,a=o.userData,w=o.meshId,b=o.matrix,k=u[w],d=o.materialId,v=i.getOverridedMaterialById(l,a),y;y=v?v:f[d];h={databagId:e,nodeId:p,userId:l,userData:a,geometry:k,matrix:b,material:y};t.get(h);h=null}};CLOUD.ModelManager=function(){this.scene=new CLOUD.Scene;this.crossOrigin=!0;this.models={};this.containsCamera=!1};CLOUD.ModelManager.prototype.calculateCameraModelRelation=function(n){var i=!1,r=this.models,u,t;for(u in r){if(r.hasOwnProperty(u)){if(t=r[u],t.octreeRootNodeI===null)continue;t.containsCamera=n.x<t.octreeRootNodeI.min.x||n.x>t.octreeRootNodeI.max.x||n.y<t.octreeRootNodeI.min.y||n.y>t.octreeRootNodeI.max.y||n.z<t.octreeRootNodeI.min.z||n.z>t.octreeRootNodeI.max.z?!1:!0}i=i||t.containsCamera}this.containsCamera=i};CLOUD.ModelManager.prototype.destroy=function(){this.scene.destroy();for(var n in this.models)this.models[n].destroy();this.models={}};CLOUD.ModelManager.prototype.prepareScene=function(n,t){var u=!0,f=0,i=this.models,r,e;for(r in i)i.hasOwnProperty(r)&&(f>1&&(u=!1),f++,e=i[r],e.prepare(n,u,t))};CLOUD.ModelManager.prototype.clearScene=function(){var n=this.models,t,i;for(t in n)n.hasOwnProperty(t)&&(i=n[t],i.clearCells())};CLOUD.ModelManager.prototype.getGlobalTransform=function(){return this.scene.rootNode.matrix};CLOUD.ModelManager.prototype.load=function(n){var t=this.models[n.databagId];if(t===undefined)t=new CLOUD.Model(this,n.serverUrl,n.databagId),this.models[n.databagId]=t;else return t;return t.load(n.notifyProgress),t};CLOUD.ModelManager.prototype.setCrossOrigin=function(n){this.crossOrigin=n};CLOUD.ModelManager.prototype.getMatrixWorldGlobal=function(){return this.scene.getMatrixWorldGlobal()};CLOUD.ModelManager.prototype.getWorldFrustum=function(n,t){var u=new THREE.Matrix4,f=new THREE.Frustum,o,r,s,h,a,v;if(t)u.getInverse(n.matrixWorld),f.setFromMatrix((new THREE.Matrix4).multiplyMatrices(n.projectionMatrix,u));else{var i=n.clone(),c=n.target,y=c.clone().sub(n.position).length(),l=this.getMatrixWorldGlobal(),e=new THREE.Matrix4;e.getInverse(l);o=new THREE.Matrix4;o.extractRotation(l);r=new THREE.Quaternion;r.setFromRotationMatrix(o);r.inverse();i.position.applyMatrix4(e);s=c.clone();s.applyMatrix4(e);h=s.clone().sub(i.position);a=h.length();h.normalize();v=a/y;i.far=n.far*v;i.up.applyQuaternion(r).normalize();i.realUp.applyQuaternion(r).normalize();i.updateProjectionMatrix();i.updateMatrixWorld();u.getInverse(i.matrixWorld);f.setFromMatrix((new THREE.Matrix4).multiplyMatrices(i.projectionMatrix,u));i=null}return f};CLOUD.ModelManager.prototype.updateOctreeBox=function(n){this.scene.updateOctreeBox(n)};CLOUD.ModelManager.prototype.hasModel=function(){var n=this.models,t,i;for(t in n)if(n.hasOwnProperty(t)&&(i=n[t],i.load_complete))return!0;return!1};CLOUD.ModelManager.prototype.setHighPriorityCategories=function(n){var i=n.length,t;if(!(i<1))for(this.highPriorityCategories={},t=0;t<i;++t)this.highPriorityCategories[n[t]]=!0};THREE.EventDispatcher.prototype.apply(CLOUD.ModelManager.prototype);CLOUD.TaskWorker=function(n,t){this.MaxThreadCount=n||8;var i=this;i.todoList={};i.todoCount=0;i.doingCount=0;this.hasTask=function(){return i.todoCount>0};this.addItem=function(n,t){i.todoList[n]=t;i.todoCount++};this.clearTasks=function(){i.todoList={};i.todoCount=0};this.run=function(n,i,r){function l(n){if(n>=u){f.doingCount<1&&t();return}var r=e[n];i(r,n+c,l)}var f=this,e,s,h,u,c,o;if(!(f.doingCount>0)){e=[];s=f.todoList;for(h in s)s.hasOwnProperty(h)&&e.push(h);if(f.todoList={},f.todoCount=0,u=e.length,u!=0)for(r&&e.sort(r),u=Math.min(u,CLOUD.GlobalData.ConcurrencyRequestCount),c=Math.min(this.MaxThreadCount,u),f.doingCount=u,o=0;o<c;++o)l(o)}}};CLOUD.MpkTaskWorker=function(n){this.MaxThreadCount=n||8;var t=this;this.todoList=[];this.doingCount=0;this.listners=[];this.addItem=function(n){if(n===undefined){console.log("undefined mpkId");return}this.todoList.push(n)};this.run=function(n,t){function c(o){var s,h,l;if(o>=i){if(r.doingCount<1){for(t(0,i),s=0,h=f.length;s<h;++s)f[s](0,i);f=[];r.run(n,function(){})}else t(r.doingCount,i);return}o>=e&&t(r.doingCount,i);l=u[o];n(l,o+e,c)}var s,u,h,r,i,f,e,o;if(this.doingCount>0){this.listners.push(t);return}s=this.todoList;this.todoList=[];u=[];for(h in s)s.hasOwnProperty(h)&&u.push(h);if(r=this,i=u.length,i==0){t();return}for(f=this.listners,this.listners=[],r.doingCount=i,e=Math.min(this.MaxThreadCount,i),o=0;o<e;++o)c(o)}};CLOUD.TaskManager=function(n){this.manager=n;var t=this;this.mpkWorker=new CLOUD.MpkTaskWorker(8)};CLOUD.TaskManager.prototype={constructor:CLOUD.TaskManager,addMpkTask:function(n){this.mpkWorker.addItem(n)},processMpkTasks:function(n){function i(n,i,r){t.manager.loadMpk(n,function(){--t.mpkWorker.doingCount;r(i)})}var t=this;this.mpkWorker.run(i,n||function(){})}};MPK=MPK||{};MPK.MPKHeader=function(n){var t=new Uint32Array(n,0,7);this.blockId=t[0];this.startId=t[1];this.vtFormat=t[2];this.meshCount=t[3];this.meshOffset=t[4];this.bufferSize=t[5];this.bufferOffset=t[6];t=null};MPK.MeshData=function(n,t){var r=new Uint32Array(n,t,4),i;this.mesh_id=r[0];this.ptCount=r[1];this.idxCount=r[2];this.dataOffset=r[3];i=new Float32Array(n,t+16,4);this.baseScale=i[0];this.baseVector=new Float32Array(3);this.baseVector[0]=i[1];this.baseVector[1]=i[2];this.baseVector[2]=i[3];r=null;i=null};MPK.MPKReader=function(n){this.header=new MPK.MPKHeader(n);this.meshSize=32;this.maxSize=256;this.meshBuffer=n.slice(this.header.meshOffset,this.header.meshOffset+this.header.meshCount*this.meshSize);this.geomBuffer=n.slice(this.header.bufferOffset,this.header.bufferOffset+this.header.bufferSize);this.mesh_cur_id=-1;this.pt_pos=new Float32Array(3);var t=new ArrayBuffer(this.maxSize);this.mesh_cur=new MPK.MeshData(t,0);this.mesh_cur.baseVector=this.pt_pos};MPK.MPKReader.prototype={constructor:MPK.MPKReader,getMeshData:function(n){var t=n-this.header.startId;if(t>=0&&t<this.header.meshCount)return new MPK.MeshData(this.meshBuffer,t*this.meshSize)},getMeshInfo:function(n){var t,i,r;return n==this.mesh_cur_id?this.mesh_cur:(t=n-this.header.startId,t>=0&&t<this.header.meshCount?(i=new Uint32Array(this.meshBuffer,t*this.meshSize,4),this.mesh_cur.mesh_id=i[0],this.mesh_cur.ptCount=i[1],this.mesh_cur.idxCount=i[2],this.mesh_cur.dataOffset=i[3],r=new Float32Array(this.meshBuffer,t*this.meshSize+16,4),this.mesh_cur.baseScale=r[0],this.mesh_cur.baseVector[0]=r[1],this.mesh_cur.baseVector[1]=r[2],this.mesh_cur.baseVector[2]=r[3],this.mesh_cur_id=n,this.mesh_cur):void 0)},getPtBuffer:function(n){var i=n-this.header.startId,t;if(i>=0&&i<this.header.meshCount)return(t=this.getMeshInfo(n),t===undefined)?undefined:t.baseScale==0?new Float32Array(this.geomBuffer,t.dataOffset,t.ptCount*3):new Uint16Array(this.geomBuffer,t.dataOffset,t.ptCount*3)},getIdxBuffer:function(n){var r=n-this.header.startId,t,i;if(r>=0&&r<this.header.meshCount)return(t=this.getMeshInfo(n),t===undefined)?undefined:(i=t.dataOffset,t.baseScale==0?i+=t.ptCount*12:(i+=t.ptCount*6,t.ptCount%2==1&&(i+=2)),t.ptCount>65535?new Uint32Array(this.geomBuffer,i,t.idxCount):new Uint16Array(this.geomBuffer,i,t.idxCount))},getNormalBuffer:function(n){var r=n-this.header.startId,t,i;if((this.header.vtFormat&2)==2&&r>=0&&r<this.header.meshCount)return(t=this.getMeshInfo(n),t===undefined)?undefined:(i=t.dataOffset,t.baseScale==0?i+=t.ptCount*12:(i+=t.ptCount*6,t.ptCount%2==1&&(i+=2)),t.ptCount>65535?i+=t.idxCount*4:(i+=t.idxCount*2,t.idxCount%2==1&&(i+=2)),new Float32Array(this.geomBuffer,i,t.ptCount*3))}};CLOUD.ClipWidget=function(n,t){var p,e,o,u,s,h,c;THREE.Object3D.call(this);this.uniforms=CLOUD.ShaderMaterial.ShaderLib.phong_cust_clip.uniforms;this.uniforms.vClipPlane.value[0]=n.clone();this.clipplane=n.clone();this.center=t.clone();this.size=.4;this.raycaster=new CLOUD.Raycaster;p=new THREE.PlaneBufferGeometry(16,16,1,1);p.dynamic=!0;var n=new THREE.Mesh(p,new THREE.MeshPhongMaterial({opacity:.3,transparent:!0,side:THREE.DoubleSide,color:6724044})),l=new THREE.BufferGeometry,nt=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}),b=6,i=new Float32Array(b*3),r=new Float32Array(b*3);i[0]=0;i[1]=0;i[2]=0;i[3]=this.size;i[4]=0;i[5]=0;i[6]=0;i[7]=0;i[8]=0;i[9]=0;i[10]=this.size;i[11]=0;i[12]=0;i[13]=0;i[14]=0;i[15]=0;i[16]=0;i[17]=this.size;r[0]=1;r[1]=0;r[2]=0;r[3]=1;r[4]=0;r[5]=0;r[6]=0;r[7]=1;r[8]=0;r[9]=0;r[10]=1;r[11]=0;r[12]=0;r[13]=0;r[14]=1;r[15]=0;r[16]=0;r[17]=1;l.addAttribute("position",new THREE.BufferAttribute(i,3));l.addAttribute("color",new THREE.BufferAttribute(r,3));l.computeBoundingSphere();var a=1.57,f=new THREE.Line(l,nt,THREE.LineSegments),v=new THREE.Mesh(new THREE.CylinderGeometry(0,.03,.1,6,1,!1),new THREE.MeshBasicMaterial({color:255}));v.rotation.x=a;v.position.z=this.size;e=new THREE.Mesh(new THREE.TorusGeometry(.06,.01,4,8),new THREE.MeshBasicMaterial({color:16711680}));e.rotation.y=a;e.position.x=this.size*.85;o=new THREE.Mesh(new THREE.TorusGeometry(.06,.01,4,8),new THREE.MeshBasicMaterial({color:65280}));o.rotation.x=a;o.position.y=this.size*.85;u=new THREE.Object3D;u.add(f);u.add(e);u.add(o);u.add(v);this.visible=!1;this.add(n);this.coord=u;this.add(u);this.XYZ=[e,o,v];this.axis=null;var k=new THREE.Vector3,tt=new THREE.Euler,d=new THREE.Matrix4,g=new THREE.Vector3,it=new THREE.Euler,y=new THREE.Quaternion,w=new THREE.Vector3(1,0,0),rt=new THREE.Vector3(0,1,0);this.onUpdateClipPlane=function(n,t,i){CLOUD.ShaderMaterial.ShaderLib.base_cust_clip.uniforms.iClipPlane.value=n;t!==undefined&&(CLOUD.ShaderMaterial.ShaderLib.base_cust_clip.uniforms.vClipPlane.value[0]=t.clone());i!==undefined&&CLOUD.ShaderMaterial.ShaderLib.base_cust_clip.uniforms.vClipPlane.value[0].applyMatrix4(i)};this.enable=function(n,t){this.visible=t;this.uniforms.iClipPlane.value=n?1:0;this.onUpdateClipPlane(this.isEnabled())};this.isEnabled=function(){return this.uniforms.iClipPlane.value==1};this.horizon=function(n){n?(this.quaternion.setFromAxisAngle(w,-a),this.position.copy(this.center)):(this.quaternion.setFromAxisAngle(w,0),this.position.copy(this.center));this.recaculateClipplane()};this.update=function(n){u=this.coord;this.updateMatrixWorld();k.setFromMatrixPosition(this.matrixWorld);tt.setFromRotationMatrix(d.extractRotation(this.matrixWorld));n.updateMatrixWorld();g.setFromMatrixPosition(n.matrixWorld);it.setFromRotationMatrix(d.extractRotation(n.matrixWorld));scale=k.distanceTo(g)/6*this.size;u.scale.set(scale,scale,scale)};this.recaculateClipplane=function(){this.updateMatrix();var n=new THREE.Matrix4;n.getInverse(this.matrix);n.transpose();this.uniforms.vClipPlane.value[0]=this.clipplane.clone();this.uniforms.vClipPlane.value[0].applyMatrix4(n);this.onUpdateClipPlane(this.isEnabled(),this.clipplane,n)};this.position.copy(this.center);this.recaculateClipplane();s=0;this.offset=function(n){if(n!=s){dist=n-s;s=n;tmpClipplane=this.uniforms.vClipPlane.value[0];offsetVector=new THREE.Vector3(tmpClipplane.x*dist,tmpClipplane.y*dist,tmpClipplane.z*dist);this.position.add(offsetVector);tmpClipplane.w-=dist;this.onUpdateClipPlane(this.isEnabled(),tmpClipplane)}};h=0;this.rotX=function(n){n!=h&&(angle=n-h,h=n,y.setFromAxisAngle(w,angle),this.quaternion.multiply(y),this.recaculateClipplane())};c=0;this.rotY=function(n){n!=c&&(angle=n-c,c=n,y.setFromAxisAngle(rt,angle),this.quaternion.multiply(y),this.recaculateClipplane())};this.snap=function(n,t){this.raycaster.setFromCamera(n,t);var i=this.raycaster.intersectObjects(this.XYZ);i.length>0?(f=i[0].object,f.color=f.material.color,f.material.color.set(16777215),this.axis=f):this.axis!=null&&(this.axis.material.color.set(this.axis.color),this.axis=null)};this.backup=function(){var n={};return n.quaternion=this.quaternion.clone(),n.position=this.position.clone(),n};this.restore=function(n,t,i,r){s=t;h=i;c=r;this.quaternion.copy(n.quaternion);this.position.copy(n.position);this.recaculateClipplane()};this.onMouseUp=function(){return this.axis!=null&&(this.axis.material.color.set(this.axis.color),this.axis=null),!0};this.onMouseDown=function(){return this.axis!==null,!0};this.onMouseMove=function(n,t){this.snap(n,t)};this.hitTest=function(n){var i=new THREE.Plane,t=this.uniforms.vClipPlane.value[0];return i.setComponents(t.x,t.y,t.z,t.w),{sign:n.direction.dot(i.normal)<0,distance:n.distanceToPlane(i)}}};CLOUD.ClipWidget.prototype=Object.create(THREE.Object3D.prototype);CLOUD.ClipWidget.prototype.constructor=CLOUD.ClipWidget;CLOUD.ClipEditor=function(n,t,i){CLOUD.OrbitEditor.call(this,n,t,i);var r=t.getClipWidget();this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,PAN:THREE.MOUSE.MIDDLE,ZOOM:THREE.MOUSE.RIGHT};this.toggle=function(n,t){CLOUD.ShaderMaterial.ShaderLib!==undefined&&r.enable(n,t)};this.visible=function(n){CLOUD.ShaderMaterial.ShaderLib!==undefined&&(r.visible=n)};this.horizon=function(n){CLOUD.ShaderMaterial.ShaderLib!==undefined&&r.horizon(n)};this.set=function(n){CLOUD.ShaderMaterial.ShaderLib!==undefined&&r.offset(n)};this.rotX=function(n){CLOUD.ShaderMaterial.ShaderLib!==undefined&&r.rotX(n)};this.rotY=function(n){CLOUD.ShaderMaterial.ShaderLib!==undefined&&r.rotY(n)};this.update=function(n){r!==undefined&&r.update(n)};this.backup=function(){return CLOUD.ShaderMaterial.ShaderLib===undefined?null:r.backup()};this.restore=function(n,t,i,u){if(CLOUD.ShaderMaterial.ShaderLib!==undefined)return r.restore(n,t,i,u)}};CLOUD.ClipEditor.prototype=Object.create(CLOUD.OrbitEditor.prototype);CLOUD.ClipEditor.prototype.constructor=CLOUD.ClipEditor;CLOUD.ClipPlanes=function(n,t){var i,r,u,f;THREE.Object3D.call(this);i=[];i.push("clipPlane_right");i.push("clipPlane_left");i.push("clipPlane_top");i.push("clipPlane_bottom");i.push("clipPlane_front");i.push("clipPlane_back");this.cubeSize=n.clone();this.center=t.clone();this.visible=!1;this.rotatable=!1;this.selectIndex=null;this.planeOffset=new Array(6);this.uniforms=CLOUD.ShaderMaterial.ShaderLib.phong_cust_clip.uniforms;this.clipplanes=null;this.calculation=!0;this.getPlaneNormal=function(n){var t=new THREE.Vector4,i=Math.floor(n/2),r=n%2;return t.setComponent(i,Math.pow(-1,r)),t.w=-this.cubeSize.getComponent(i)*.5,this.planeOffset[n]=0,t};this.planeMaterial=new THREE.MeshPhongMaterial({opacity:.3,transparent:!0,side:THREE.DoubleSide,color:6724044});this.planeHighLightMatrial=new THREE.MeshPhongMaterial({opacity:.3,transparent:!0,side:THREE.DoubleSide,color:65408});this.initPlaneModel=function(n){var t=Math.floor(n/2),u=n%2,f=t==0?this.cubeSize.z:this.cubeSize.x,e=t==1?this.cubeSize.z:this.cubeSize.y,o=new THREE.PlaneGeometry(f,e),r=new THREE.Mesh(o,this.planeMaterial.clone());r.name=i[n];r.customTag=!0;r.position.setComponent(t,Math.pow(-1,u)*this.cubeSize.getComponent(t)*.5);t==0?r.rotation.y=Math.pow(-1,u)*Math.PI*.5:t==1&&(r.rotation.x=Math.pow(-1,u)*Math.PI*.5);this.add(r)};this.enable=function(n,t){this.visible=t;this.uniforms.iClipPlane.value=n?6:0};this.isEnabled=function(){return this.uniforms.iClipPlane.value==0?!1:!0};ClipPlanesInfo=function(n,t,i,r,u,f,e,o,s,h){this.enable=n;this.visible=t;this.rotatable=i;this.calculation=r;this.planeOffset=u.slice(0);this.position=f;this.scale=e;this.quaternion=o;this.cubeSize=s;this.center=h};this.store=function(){return new ClipPlanesInfo(this.uniforms.iClipPlane.value?!0:!1,this.visible,this.rotatable,this.calculation,this.planeOffset,this.position.clone(),this.scale.clone(),this.quaternion.clone(),this.cubeSize.clone(),this.center.clone())};this.restore=function(n){this.calculation=!0;this.calculationPlanes(n.cubeSize,n.center);this.enable(n.enable,n.visible);this.rotatable=n.rotatable;this.calculation=n.calculation;for(var t=0;t<6;++t)this.planeOffset[t]=n.planeOffset[t];this.position.copy(n.position);this.scale.copy(n.scale);this.quaternion._w=n.quaternion._w;this.quaternion._x=n.quaternion._x;this.quaternion._y=n.quaternion._y;this.quaternion._z=n.quaternion._z;this.update()};this.reset=function(){this.calculation=!0;for(var n=0;n<6;++n)this.planeOffset[n]=0;this.position.copy(this.center);this.scale.copy(new THREE.Vector3(1,1,1));this.quaternion.copy(new THREE.Quaternion);this.update()};this.calculationPlanes=function(n,t){var n,i;if(this.calculation){for(this.cubeSize.copy(n),this.center.copy(t),n=this.children.length,i=n-1;i>=0;--i)this.remove(this.children[i]);for(i=0;i<6;++i)this.uniforms.vClipPlane.value[i]=this.getPlaneNormal(i),this.initPlaneModel(i);this.clipplanes=this.uniforms.vClipPlane.value.slice(0);this.reset()}};this.update=function(){var t,n;for(this.updateMatrixWorld(),t=new THREE.Matrix4,t.getInverse(this.matrix),t.transpose(),n=0;n<6;++n)this.uniforms.vClipPlane.value[n]=this.clipplanes[n].clone().applyMatrix4(t)};this.offset=function(n,t){var r,h,i,c,u,o,s,e,f,v;for(this.calculation=!1,r=Math.floor(n/2),h=n%2,this.planeOffset[n]+=t,i=this.cubeSize.getComponent(r)*.5,h==0&&this.planeOffset[n]>i?(this.planeOffset[n]-=t,t=i-this.planeOffset[n],this.planeOffset[n]=i):h==1&&this.planeOffset[n]<-i&&(this.planeOffset[n]-=t,t=-i-this.planeOffset[n],this.planeOffset[n]=-i),c=new THREE.Vector3,u=0;u<6;++u){var l=this.clipplanes[u].clone(),a=this.planeOffset[u],f=new THREE.Vector3(l.x*a,l.y*a,l.z*a);c.add(f)}o=1+c.getComponent(r)/this.cubeSize.getComponent(r);o>0&&o<2?(this.scale.setComponent(r,o),s=this.uniforms.vClipPlane.value[n].clone(),e=new THREE.Vector3(s.x,s.y,s.z),e.normalize(),f=t,v=new THREE.Vector3(e.x*f,e.y*f,e.z*f),n%2==1?this.position.sub(v.multiplyScalar(.5)):this.position.add(v.multiplyScalar(.5)),this.update()):this.planeOffset[n]-=t};r=new THREE.Quaternion;u=new THREE.Vector3(1,0,0);this.rotX=function(n){this.calculation=!1;r.setFromAxisAngle(u,n);this.quaternion.multiply(r);this.update()};f=new THREE.Vector3(0,1,0);this.rotY=function(n){this.calculation=!1;r.setFromAxisAngle(f,n);this.quaternion.multiply(r);this.update()};this.highLight=function(){this.selectIndex!=null&&(this.children[this.selectIndex].material=this.planeHighLightMatrial.clone())};this.cancelHighLight=function(){this.selectIndex!=null&&(this.children[this.selectIndex].material=this.planeMaterial.clone(),this.selectIndex=null)};this.calculationPlanes(n,t)};CLOUD.ClipPlanes.prototype=Object.create(THREE.Object3D.prototype);CLOUD.ClipPlanes.prototype.constructor=CLOUD.ClipPlanes;CLOUD.ClipPlanes.prototype.hitTest=function(n){var r=null,u=null;if(this.raycast(n),this.selectIndex!=null){var f=n.ray,i=new THREE.Plane,t=this.uniforms.vClipPlane.value[this.selectIndex];i.setComponents(t.x,t.y,t.z,t.w);r=f.distanceToPlane(i);u=f.direction.dot(i.normal)<0}return{sign:u,distance:r}};CLOUD.ClipPlanes.prototype.raycast=function(){return function(n){for(var u,r=[],t,i=0,f=this.children.length;i<f;i++)intersectObject(this.children[i],n,r,!0),r.length>0&&(t?(u=r.pop(),u.distance<t.distance&&(t=u,this.selectIndex=i)):(t=r.pop(),this.selectIndex=i));return t||(this.selectIndex=null),!1}}();CLOUD.ClipPlanesEditor=function(n,t,i,r){var u,f;CLOUD.OrbitEditor.call(this,n,t,i);this.cameraEditor=n;this.scene=t;this.onObjectSelected=r;this.enablePick=!1;u=t.getClipPlanes();this.startPt=new THREE.Vector2;this.endPt=new THREE.Vector2;this.frustum=new THREE.Frustum;this.selectIndex=null;this.planeDistance=0;this.offsetSpeed=.02;f=this;this.pickHelper=new CLOUD.PickHelper(this.scene,this.cameraEditor,function(n,t){f.onObjectSelected(n,t)});this.toggle=function(n,t){CLOUD.ShaderMaterial.ShaderLib!==undefined&&u.enable(n,t)};this.visible=function(n){CLOUD.ShaderMaterial.ShaderLib!==undefined&&(u.visible=n)};this.rotatable=function(n){CLOUD.ShaderMaterial.ShaderLib!==undefined&&(u.rotatable=n)};this.store=function(){if(CLOUD.ShaderMaterial.ShaderLib!==undefined)return u.store()};this.restore=function(n){CLOUD.ShaderMaterial.ShaderLib!==undefined&&u.restore(n)};this.reset=function(){CLOUD.ShaderMaterial.ShaderLib!==undefined&&u.reset()};this.pointToScreen=function(n){var u=this.cameraEditor.camera,f=new THREE.Matrix4,i,t,r;return f.multiplyMatrices(u.projectionMatrix,u.matrixWorldInverse),i=new THREE.Vector4(n.x,n.y,n.z,1),i.applyMatrix4(f),t=new THREE.Vector2,t.x=(i.x/i.w+1)/2,t.y=1-(i.y/i.w+1)/2,r=this.cameraEditor.getContainerDimensions(),t.x=t.x*r.width+r.left,t.y=t.y*r.height+r.top,t};this.getPlaneDistanceInScreen=function(){var n,t,f,e,i,r,o,s;return this.selectIndex==null?null:this.selectIndex<2?(n=u.center.clone(),t=u.center.clone(),n.x-=u.cubeSize.x,t.x+=u.cubeSize.x,f=this.pointToScreen(n),e=this.pointToScreen(t),f.x-e.x):(i=u.center.clone(),r=u.center.clone(),r.y-=u.cubeSize.y,i.y+=u.cubeSize.y,o=this.pointToScreen(r),s=this.pointToScreen(i),o.y-s.y)};this.getPickPoint=function(n,t){var i=this.cameraEditor.getContainerDimensions(),u=n-i.left,f=t-i.top,e=u/i.width*2-1,o=(i.height-f)/i.height*2-1,r=new CLOUD.Raycaster;return r.setFromCamera(new THREE.Vector2(e,o),this.cameraEditor.object),r.ray.intersectPlane(this.plane)};this.getSelectIndex=function(){return u.selectIndex};this.isVisible=function(){return u.visible};this.isRotate=function(){return u.rotatable};this.offset=function(n){var t=Math.floor(this.selectIndex/2);this.selectIndex<=3?u.offset(this.selectIndex,-n*u.cubeSize.getComponent(t)*2):this.selectIndex%2==1?u.offset(this.selectIndex,-n*u.cubeSize.getComponent(t)*2):u.offset(this.selectIndex,n*u.cubeSize.getComponent(t)*2)};this.rotate=function(n,t){this.selectIndex==2||this.selectIndex==3?u.rotX(t/180*Math.PI*.1):u.rotY(n/180*Math.PI*.1)};this.update=function(n){u!==undefined&&u.update(n)};this.cancelHighLight=function(){u!==undefined&&u.cancelHighLight()};this.highLight=function(){u!==undefined&&u.highLight()}};CLOUD.ClipPlanesEditor.prototype=Object.create(CLOUD.OrbitEditor.prototype);CLOUD.ClipPlanesEditor.prototype.constructor=CLOUD.ClipPlanesEditor;CLOUD.ClipPlanesEditor.prototype.updateFrustum=function(n){var t=this.startPt.x,r=this.endPt.x,i=this.startPt.y,u=this.endPt.y,o,s,e,f;if(t>r&&(o=t,t=r,r=o),i>u&&(s=i,i=u,u=s),r-t==0||u-i==0)return!1;if(e=this.cameraEditor,f=e.getContainerDimensions(),e.computeFrustum(t,r,i,u,this.frustum,f),n)this.onUpdateUI({visible:!0,dir:this.startPt.x<this.endPt.x,left:t-f.left,top:i-f.top,width:r-t,height:u-i});return!0};CLOUD.ClipPlanesEditor.prototype.processMouseDown=function(n){this.startPt.set(n.clientX,n.clientY);this.enablePick||n.button!==THREE.MOUSE.LEFT||(this.cameraEditor.getTrackingPoint(n.clientX,n.clientY),this.selectIndex=this.getSelectIndex(),this.planeDistance=this.getPlaneDistanceInScreen());this.selectIndex!=null?(this.highLight(),this.cameraEditor.viewer.editorManager.isUpdateRenderList=!0,this.cameraEditor.update(!0)):CLOUD.OrbitEditor.prototype.processMouseDown.call(this,n)};CLOUD.ClipPlanesEditor.prototype.processMouseUp=function(n){var i,t,r;if(this.selectIndex=null,this.planeDistance=0,this.enablePick&&n.button===THREE.MOUSE.LEFT){this.onUpdateUI({visible:!1});if(this.startPt.x==n.clientX&&this.startPt.y==n.clientY)this.pickHelper.click(n);else if(i=n.shiftKey||n.ctrlKey||n.altKey,i)return(this.endPt.set(n.clientX,n.clientY),!this.updateFrustum())?(this.pickHelper.click(n),!1):(t=CLOUD.OPSELECTIONTYPE.Clear,n.ctrlKey?t=CLOUD.OPSELECTIONTYPE.Add:n.altKey&&(t=CLOUD.OPSELECTIONTYPE.Remove),r=this,this.scene.pickByReck(this.frustum,t,function(){r.onObjectSelected(null,!1)}),this.cameraEditor.updateView(!0),!0)}return CLOUD.OrbitEditor.prototype.processMouseUp.call(this,n),this.cameraEditor.viewer.editorManager.isUpdateRenderList=!0,this.cancelHighLight(),this.cameraEditor.update(!0),!0};CLOUD.ClipPlanesEditor.prototype.processMouseMove=function(n){var i=n.shiftKey||n.ctrlKey||n.altKey,t;if(i&&n.button===THREE.MOUSE.LEFT)return this.endPt.set(n.clientX,n.clientY),this.updateFrustum(!0),!0;this.selectIndex!=null?(this.isRotate()?(this.rotate(n.clientX-this.startPt.x,n.clientY-this.startPt.y),this.startPt.set(n.clientX,n.clientY)):(t=0,t=this.selectIndex<2?n.clientX-this.startPt.x:n.clientY-this.startPt.y,this.offset(t/this.planeDistance),this.startPt.set(n.clientX,n.clientY)),this.cameraEditor.update(!0)):CLOUD.OrbitEditor.prototype.processMouseMove.call(this,n)};CLOUD.ClipPlanesEditor.prototype.touchstart=function(n){n.preventDefault();this.startPt.set(n.touches[0].clientX,n.touches[0].clientY);this.enablePick||(this.cameraEditor.getTrackingPoint(n.touches[0].clientX,n.touches[0].clientY),this.selectIndex=this.getSelectIndex(),this.planeDistance=this.getPlaneDistanceInScreen());this.selectIndex!=null?(this.highLight(),this.cameraEditor.viewer.editorManager.isUpdateRenderList=!0,this.cameraEditor.update(!0)):this.cameraEditor.touchStartHandler(n)};CLOUD.ClipPlanesEditor.prototype.touchmove=function(n){if(n.preventDefault(),this.selectIndex!=null){if(this.isRotate())this.rotate(n.touches[0].clientX-this.startPt.x,n.touches[0].clientY-this.startPt.y),this.startPt.set(n.touches[0].clientX,n.touches[0].clientY);else{var t=0;t=this.selectIndex<2?n.touches[0].clientX-this.startPt.x:n.touches[0].clientY-this.startPt.y;this.offset(t/this.planeDistance);this.startPt.set(n.touches[0].clientX,n.touches[0].clientY)}this.cameraEditor.update(!0)}else this.cameraEditor.touchMoveHandler(n)};CLOUD.ClipPlanesEditor.prototype.touchend=function(n){if(n.preventDefault(),this.selectIndex=null,this.planeDistance=0,this.enablePick){this.onUpdateUI({visible:!1});this.startPt.x==n.touches[0].clientX&&this.startPt.y==n.touches[0].clientY&&this.pickHelper.click(n)}return this.cameraEditor.touchEndHandler(n),this.cameraEditor.viewer.editorManager.isUpdateRenderList=!0,this.cancelHighLight(),this.cameraEditor.update(!0),!0};CLOUD.ClipPlaneService=function(n){this.viewer=n};CLOUD.ClipPlaneService.prototype={construtor:CLOUD.ClipPlaneService,destroy:function(){this.viewer=null},update:function(n){var t=this.viewer,r=t.editorManager.editors.clipEditor,i;r!==undefined&&(r.update(n),t.render());i=t.editorManager.editors.clipPlanesEditor;i!==undefined&&(i.update(n),t.render())},getClipEditor:function(){var n=this.viewer,t=n.editorManager.editors.clipEditor;return t===undefined&&(t=new CLOUD.ClipEditor(n.cameraEditor,n.getScene(),n.domElement),n.editorManager.editors.clipEditor=t),this.update(n.camera),t},getClipPlanesEditor:function(){var n=this.viewer,t=n.editorManager.editors.clipPlanesEditor;return t===undefined&&(t=new CLOUD.ClipPlanesEditor(n.cameraEditor,n.getScene(),n.domElement),n.editorManager.editors.clipPlanesEditor=t),this.update(n.camera),t},clipToggle:function(n,t){var r=this.viewer,i=this.getClipEditor();i.toggle(n,t)},clipVisible:function(n){var t=this.getClipEditor();t.visible(n)},clipHorizon:function(n){var t=this.getClipEditor();t.horizon(n)},clipSetPlane:function(n){var t=this.getClipEditor();t.set(n)},clipRotPlaneX:function(n){var t=this.getClipEditor();t.rotX(n)},clipRotPlaneY:function(n){var t=this.getClipEditor();t.rotY(n)},backupClipplane:function(){var n=this.getClipEditor();return n.backup()},restoreClipplane:function(n,t,i,r){var u=this.getClipEditor();u.restore(n,t,i,r)},clipPlanesToggle:function(n,t){var r=this.viewer,i=this.getClipPlanesEditor();i.toggle(n,t)},clipPlanesVisible:function(n){var t=this.getClipPlanesEditor();t.visible(n)},clipPlanesRotatable:function(n){var t=this.getClipPlanesEditor();t.rotatable(n)},clipPlanesEnablePick:function(n){var t=this.getClipPlanesEditor();t.enablePick=n},saveState:function(){var n=this.getClipPlanesEditor();return n.store()},loadState:function(n){var t=this.getClipPlanesEditor();t.restore(n)},clipPlanesReset:function(){var n=this.getClipPlanesEditor();n.reset()}};CLOUD.Viewer=function(){"use strict";this.domElement=null;this.camera=null;this.renderer=null;this.requestRenderCount=0;this.requestRenderMaxCount=1e4;this.rendering=!1;this.incrementRenderHandle=0;this.callbacks={};this.services={};this.tmpBox=new THREE.Box3;this.enableCameraNearFar=!0;this.currentHomeView=CLOUD.EnumStandardView.ISO;this.modelManager=new CLOUD.ModelManager;this.editorManager=new CLOUD.EditorManager;this.isRecalculationPlanes=!1;this.calculationPlanesBind=this.calculationPlanes.bind(this);this.addRenderFinishedCallback(this.calculationPlanesBind)};CLOUD.Viewer.prototype={constructor:CLOUD.Viewer,addCallbacks:function(n,t){var i=this.callbacks[n];i||(i=[],this.callbacks[n]=i);i.indexOf(t)===-1&&i.push(t)},removeCallbacks:function(n,t){var i=this.callbacks[n],r;i&&(r=i.indexOf(t),r!==-1&&i.splice(r,1))},removeAllCallbacks:function(){var t,i,r;for(var n in this.callbacks)for(t=this.callbacks[n],i=0,r=t.length;i<r;i++)t.splice(0,1);for(n in this.callbacks)delete this.callbacks[n];this.callbacks={}},onCallbacks:function(n){var i=this.callbacks[n],t,r;if(i)for(t=0,r=i.length;t<r;t++)i[t]()},addRenderCallback:function(n){this.addCallbacks("render",n)},removeRenderCallback:function(n){this.removeCallbacks("render",n)},onRenderCallback:function(){this.onCallbacks("render")},addRenderFinishedCallback:function(n){this.addCallbacks("renderFinished",n)},removeRenderFinishedCallback:function(n){this.removeCallbacks("renderFinished",n)},onRenderFinishedCallback:function(){this.onCallbacks("renderFinished")},destroy:function(){var n,t;this.removeAllCallbacks();this.editorManager.unregisterDomEventListeners(this.domElement);this.domElement.removeChild(this.domElement.childNodes[0]);this.domElement=null;for(n in this.services)t=this.services[n],t.destroy();this.services={};this.editorManager.destroy();this.modelManager.destroy();this.renderer.destroy&&this.renderer.destroy();this.renderer=null;this.modelManager=null;this.editorManager=null},init:function(n){var i,t,e,r,o,u,f,s;console.log("Web3D: "+CLOUD.Version);i=this;this.domElement=n;t={alpha:!0,preserveDrawingBuffer:!0,antialias:!0};e=CLOUD.GlobalData.IncrementRender;try{r=document.createElement("canvas");o=r.getContext("webgl",t)||r.getContext("experimental-webgl",t);o||(t.antialias=!1)}catch(h){return!1}return CLOUD.GeomUtil.initializeUnitInstances(),t.canvas=r,e?(this.renderer=new THREE.WebGLIncrementRenderer(t),this.renderer.setRenderTicket(0)):this.renderer=new THREE.WebGLRenderer(t),this.renderer.domElement.addEventListener("webglcontextlost",function(n){n.preventDefault();i.incrementRenderHandle>0&&(cancelAnimationFrame(i.incrementRenderHandle),console.log("---------------- webglcontextlost --------------"))},!1),u=n.offsetWidth,f=n.offsetHeight,this.renderer.setClearColor(0,0),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(u,f),this.renderer.domElement.setAttribute("tabindex","0"),this.renderer.domElement.setAttribute("id","cloud-main-canvas"),this.domElement.appendChild(this.renderer.domElement),this.camera=new CLOUD.Camera(u,f,45,.1,CLOUD.GlobalData.SceneSize*20),s=this.camera,this.cameraEditor=new CLOUD.CameraEditor(this,s,n,function(){i.render()}),this.setPickMode(),this.editorManager.registerDomEventListeners(this.domElement),this.modelManager.onUpdateViewer=function(){i.render(!0)},this.goToInitialView(),!0},render:function(){var n=this,i=this.camera,u=this.modelManager,t=this.renderer,r=this.getScene(),s=CLOUD.GlobalData.IncrementRender,e,o,f;if(s&&n.renderer.IncrementRender){if(++this.requestRenderCount,this.requestRenderCount>this.requestRenderMaxCount&&(this.requestRenderCount=0),this.rendering)return;this.rendering=!0;u.calculateCameraModelRelation(i.position);this.calculateNearFar();for(e in this.services)o=this.services[e],o.update(i);r.updateLights(i);f=this.editorManager.isUpdateRenderList;t.resetIncrementRender();t.setObjectListUpdateState(f);t.setFilterObject(r.filter);function s(u,f){var e=u;return function(){t.autoClear=f;n.editorManager.cameraChange?(t.resetIncrementRender(),t.autoClear=!0,n.editorManager.cameraChange=!1):t.autoClear=f;var u=t.IncrementRender(r,i);u||e!==n.requestRenderCount?(n.rendering=!1,e!==n.requestRenderCount?n.render():n.onRenderFinishedCallback()):n.incrementRenderHandle=requestAnimationFrame(s(e,!1))}}this.incrementRenderHandle=requestAnimationFrame(s(n.requestRenderCount,!0));f&&u.prepareScene(i);this.onRenderCallback()}else this.calculateNearFar(),r.updateLights(i),u.prepareScene(i),t.render(r,i),this.onRenderCallback(),this.onRenderFinishedCallback()},resize:function(n,t){var i=this.camera;i.setSize(n,t);i.updateProjectionMatrix();this.renderer.setSize(n,t);this.editorManager.resize();this.onCallbacks("resize");this.render()},calculateNearFar:function(){var u=this.getScene(),f=u.getBoundingBoxWorld(),i=this.camera,n,r,e;if(f!=null){n=this.tmpBox;n.copy(f);n.applyMatrix4(u.getMatrixGlobal());var o=n.center(),s=i.position,h=s.clone().sub(o),t=h.length();this.modelManager.containsCamera||!this.enableCameraNearFar?i.setNearFar(.1,2e4):(r=.001,e=(t*t+t*r)/(16777216*r),i.setNearFar(e,t+1e4))}},registerDomEventListeners:function(){this.domElement&&this.editorManager.registerDomEventListeners(this.domElement)},unregisterDomEventListeners:function(){this.domElement&&this.editorManager.unregisterDomEventListeners(this.domElement)},registerEventListener:function(n,t){this.modelManager.addEventListener(n,t)},load:function(n,t,i,r){return i=i||!0,this.modelManager.load({databagId:n,serverUrl:t,notifyProgress:i,debug:r})},unloadAll:function(){this.renderer.destroy();this.modelManager.destroy()},clearAll:function(){this.getScene().clearAll()},getScene:function(){return this.modelManager.scene},getFilters:function(){return this.getScene().filter},showScene:function(n,t){this.getScene().showSceneNodes(n,t)},setEditorDefault:function(){this.setPickMode()},setPickMode:function(n){this.editorManager.setRectPickMode(this,n)},setRectPickMode:function(n){this.editorManager.setRectPickMode(this,n)},setRectZoomMode:function(){this.editorManager.setRectZoomMode(this)},setOrbitMode:function(){this.editorManager.setOrbitMode(this)},setZoomMode:function(){this.editorManager.setZoomMode(this)},setPanMode:function(){this.editorManager.setPanMode(this)},setFlyMode:function(n){this.editorManager.setFlyMode(n,this)},setClipPlanesMode:function(){this.editorManager.setClipPlanesMode(this)},zoomIn:function(n){this.editorManager.zoomIn(n,this)},zoomOut:function(n){this.editorManager.zoomOut(n,this)},zoomAll:function(n,t){var i=this.getScene().getBoundingBox();this.editorManager.zoomToBBox(this,i,n,t)},zoomToBuilding:function(n,t){var i=this.getScene().boundingBoxInner;i.empty()?this.zoomAll():this.editorManager.zoomToBBox(this,i,n,t)},zoomToSelection:function(n,t){var i=this.renderer.computeSelectionBBox();(i==null||i.empty())&&(i=this.getScene().getBoundingBox());this.editorManager.zoomToBBox(this,i,n,t)},zoomToBBox:function(n,t,i){n?n.applyMatrix4(this.getScene().getMatrixGlobal()):n=this.getScene().getBoundingBox();this.editorManager.zoomToBBox(this,n,t,i)},zoomToBBoxByDirection:function(n,t,i,r){var u,e,f;if(!t){this.zoomToBBox(n,i,r);return}t&&n&&(u=n.clone(),e=u.center().clone().add(t),u.applyMatrix4(this.getScene().getMatrixGlobal()),e.applyMatrix4(this.getScene().getMatrixGlobal()),f=e.clone().sub(u.center()),f.length()>.0001?(f.normalize(),viewer.camera.realUp.copy(THREE.Object3D.DefaultUp),this.editorManager.zoomToBBox(this,u,i,r,f)):this.editorManager.zoomToBBox(this,u,i,r))},zoomToBBoxWithOuterBox:function(n,t,i,r){var u,e,f;if(!t){this.zoomToBBox(n,i,r);return}t&&n&&(u=n.clone(),e=t.center(),u.applyMatrix4(this.getScene().getMatrixGlobal()),e.applyMatrix4(this.getScene().getMatrixGlobal()),f=e.clone().sub(u.center()),f.length()>.0001?(f.normalize(),this.camera.realUp.copy(THREE.Object3D.DefaultUp),this.editorManager.zoomToBBox(this,u,i,r,f)):this.editorManager.zoomToBBox(this,u,i,r))},setStandardView:function(n,t,i){t=t||-.05;this.editorManager.setStandardView(n,this,t,i)},setStandardViewWithBox:function(n,t,i,r){i=i||.05;r=r||1;t?t.applyMatrix4(this.getScene().getMatrixGlobal()):t=this.getScene().getBoundingBox();this.editorManager.setStandardViewWithBox(this,n,t,i,r)},setTopView:function(n,t,i){this.setStandardViewWithBox(CLOUD.EnumStandardView.ISO,n,t,i)},setInitialViewType:function(n){this.initialView=n},goToInitialView:function(){var n;if(this.initialView)n=this.camera.setStandardView(this.initialView);else{n=new THREE.Vector3(0,0,0);var i=new THREE.Vector3(-CLOUD.GlobalData.SceneSize*.5,CLOUD.GlobalData.SceneSize*.3,CLOUD.GlobalData.SceneSize),r=new THREE.Vector3(0,1,0),t=new THREE.Vector3;t.subVectors(n,i);this.camera.LookAt(n,t,r)}this.cameraEditor.updateCamera(n);this.render()},setHomeViewType:function(n){this.currentHomeView=n},goToHomeView:function(n){this.setStandardView(this.currentHomeView,n)},lookAt:function(n,t,i){var r=new THREE.Vector3;r.subVectors(t,n);this.camera.LookAt(t,r,i);this.cameraEditor.updateCamera(t);this.render()},setImageResPath:function(n){CLOUD.GlobalData.TextureResRoot=n},setLimitFrameTime:function(n){CLOUD.GlobalData.IncrementRender&&(n<=0&&(n=30),CLOUD.GlobalData.LimitFrameTime=n)},limitFrameRate:function(n){CLOUD.GlobalData.IncrementRender&&(n<=0&&(n=4),CLOUD.GlobalData.LimitFrameTime=1e3/n)},transformCamera:function(n){return CLOUD.CameraUtil.transformCamera(n,this.modelManager.scene)},getCamera:function(){return this.cameraEditor.getCameraInfo()},setCamera:function(n){var t=CLOUD.CameraUtil.parseCameraInfo(n);this.lookAt(t.position,t.target,t.up)},getRenderBufferScreenShot:function(n,t){var y=this.renderer.domElement,s=y.toDataURL("image/png"),h=y.width,c=y.height,p=window.devicePixelRatio||1,i=h/p,r=c/p,f,e,l,a,u,o,v;return!i||!r?t?(t(s),null):s:(l=0,a=0,i>r||h/c<i/r?(f=i,e=c/h*i,a=r/2-e/2):(e=r,f=h/c*r,l=i/2-f/2),t)?(u=new Image,u.onload=function(){var o=document.createElement("canvas"),s=o.getContext("2d"),h;o.width=i;o.height=r;n&&(s.fillStyle=n,s.fillRect(0,0,i,r));s.drawImage(u,l,a,f,e);h=o.toDataURL("image/png");t(h)},u.src=s,null):(u=new Image,u.src=s,o=document.createElement("canvas"),v=o.getContext("2d"),o.width=i,o.height=r,n&&(v.fillStyle=n,v.fillRect(0,0,i,r)),v.drawImage(u,l,a,f,e),o.toDataURL("image/png"))},screenShot:function(n,t,i){function u(n,t,i){var h=r.renderer.domElement,c=h.toDataURL("image/png"),l=h.width,a=h.height,p=window.devicePixelRatio||1,u=n,f=t,e,o,v,y,s;return!u||!f?i?(i(c),null):c:(v=0,y=0,u>f||l/a<u/f?(e=u,o=a/l*u,y=f/2-o/2):(o=f,e=l/a*f,v=u/2-e/2),i?(s=new Image,s.onload=function(){var n=document.createElement("canvas"),r=n.getContext("2d"),t;n.width=u;n.height=f;r.drawImage(s,v,y,e,o);t=n.toDataURL("image/png");i(t)},s.src=c,null):void 0)}var r=this,f=u(n,t,i);return this.render(),f},canvas2image:function(n){var t=this.getRenderBufferScreenShot(n);return this.render(),t},lockAxisZ:function(n){this.cameraEditor&&this.cameraEditor.lockAxisZ(n)},enableTranslucentByDClick:function(n){CLOUD.GlobalData.EnableDemolishByDClick=n},disableRotate:function(n){this.cameraEditor&&this.cameraEditor.disableRotate(n)},calculationPlanes:function(){if(this.isRecalculationPlanes){this.isRecalculationPlanes=!1;var t=this.getScene(),n=this.renderer.computeRenderObjectsBox();t.getClipPlanes().calculationPlanes(n.size(),n.center());this.render()}},recalculationPlanes:function(){this.isRecalculationPlanes=!0},setOctantDepth:function(n){CLOUD.GlobalData.OctantDepth=n},resizePool:function(n){CLOUD.GlobalData.maxObjectNumInPool=n;this.getScene().resizePool()},setHighPriorityCategories:function(n){this.modelManager.setHighPriorityCategories(n)}};