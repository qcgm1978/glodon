var CLOUD=CLOUD||{};CLOUD.Version2D="20161009";CLOUD.DomUtil=CLOUD.DomUtil||{splitStr:function(n){return n.trim().split(/\s+/g)},getContainerOffsetToClient:function(n){var t,r=function(n){for(var t=0,i=0;n;)t+=n.offsetTop,i+=n.offsetLeft,n=n.offsetParent;var r=document.body,u=document.documentElement,f=window.pageYOffset||u.scrollTop||r.scrollTop,e=window.pageXOffset||u.scrollLeft||r.scrollLeft;return t-=f,i-=e,{top:t,left:i}},u=function(n){var t=n.getBoundingClientRect(),i=document.body,r=document.documentElement,u=r.clientTop||i.clientTop,f=r.clientLeft||i.clientLeft,e=t.top-u,o=t.left-f;return{top:Math.round(e),left:Math.round(o)}},f=function(n){return n.getBoundingClientRect?u(n):r(n)},i;return n!=document?(i=f(n),t={width:n.offsetWidth,height:n.offsetHeight,left:i.left,top:i.top}):t={width:window.innerWidth,height:window.innerHeight,left:0,top:0},t},setClassName:function(n,t){var i=document.getElementById(n);i&&(i.className=t)},addClassName:function(n,t){var r,i,u,f,e,o=document.getElementById(n);if(o&&(i=o,t&&typeof t=="string"&&(r=t.split(/\s+/),i.nodeType===1)))if(i.className||r.length!==1){for(u=" "+i.className+" ",f=0,e=r.length;f<e;++f)u.indexOf(" "+r[f]+" ")<0&&(u+=r[0]+" ");i.className=String.trim(u)}else i.className=t},removeClassName:function(n,t){var f,i,r,u,e,o=document.getElementById(n);if(o&&(r=o,t&&typeof t=="string"&&(f=(t||"").split(/\s+/),r.nodeType===1&&r.className))){for(i=(" "+r.className+" ").replace(O," "),u=0,e=f.length;u<e;u++)while(i.indexOf(" "+f[u]+" ")>=0)i=i.replace(" "+f[u]+" "," ");r.className=t?String.trim(i):""}},showOrHideElement:function(n,t){var i=document.getElementById(n);i&&(i.style.display=t?"":"none")},getStyleString:function(n){var t=[],i,r;for(i in n)r=n[i],t.push(i),t.push(":"),t.push(r),t.push("; ");return t.join("")},cloneStyle:function(n){var t={};for(var i in n)t[i]=n[i];return t},removeStyleAttribute:function(n,t){Array.isArray(t)||(t=[t]);t.forEach(function(t){t in n&&delete n[t]})},trimRight:function(n){var i,t;if(n.length===0)return"";for(i=n.length-1,t=i;t>=0;--t)if(n.charAt(t)!==" "){i=t;break}return n.substr(0,i+1)},trimLeft:function(n){var i,t;if(n.length===0)return"";for(i=0,t=0;t<n.length;++t)if(n.charAt(t)!==" "){i=t;break}return n.substr(i)},matchesSelector:function(n,t){if(n.matches)return n.matches(t);if(n.matchesSelector)return n.matchesSelector(t);if(n.webkitMatchesSelector)return n.webkitMatchesSelector(t);if(n.msMatchesSelector)return n.msMatchesSelector(t);if(n.mozMatchesSelector)return n.mozMatchesSelector(t);if(n.oMatchesSelector)return n.oMatchesSelector(t);if(n.querySelectorAll){for(var r=(n.document||n.ownerDocument).querySelectorAll(t),i=0;r[i]&&r[i]!==element;)i++;return r[i]?!0:!1}return!1},toTranslate3d:function(n,t){return"translate3d("+n+"px,"+t+"px,0)"},setCursorStyle:function(n,t){var i;switch(t){case"n":case"s":i="ns-resize";break;case"w":case"e":i="ew-resize";break;case"ne":case"sw":i="nesw-resize";break;case"nw":case"se":i="nwse-resize"}n.style.cursor=i}};!function(n){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=n();else if("function"==typeof define&&define.amd)define([],n);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self);t.html2canvas=n()}}(function(){var n;return function t(n,i,r){function u(f,o){var h,c,s;if(!i[f]){if(!n[f]){if(h=typeof require=="function"&&require,!o&&h)return h(f,!0);if(e)return e(f,!0);c=new Error("Cannot find module '"+f+"'");throw c.code="MODULE_NOT_FOUND",c;}s=i[f]={exports:{}};n[f][0].call(s.exports,function(t){var i=n[f][1][t];return u(i?i:t)},s,s.exports,t,n,i,r)}return i[f].exports}for(var e=typeof require=="function"&&require,f=0;f<r.length;f++)u(r[f]);return u}({1:[function(t,i,r){(function(t){
/*! http://mths.be/punycode v1.2.4 by @mathias */
(function(u){function s(n){throw RangeError(vt[n]);}function nt(n,t){for(var i=n.length;i--;)n[i]=t(n[i]);return n}function tt(n,t){return nt(n.split(at),t).join(".")}function it(n){for(var r=[],i=0,f=n.length,t,u;i<f;)t=n.charCodeAt(i++),t>=55296&&t<=56319&&i<f?(u=n.charCodeAt(i++),(u&64512)==56320?r.push(((t&1023)<<10)+(u&1023)+65536):(r.push(t),i--)):r.push(t);return r}function rt(n){return nt(n,function(n){var t="";return n>65535&&(n-=65536,t+=a(n>>>10&1023|55296),n=56320|n&1023),t+a(n)}).join("")}function yt(n){return n-48<10?n-22:n-65<26?n-65:n-97<26?n-97:f}function ut(n,t){return n+22+75*(n<26)-((t!=0)<<5)}function ft(n,t,i){var r=0;for(n=i?e(n/ht):n>>1,n+=e(n/t);n>w*l>>1;r+=f)n=e(n/w);return e(r+(w+1)*n/(n+st))}function et(n){var v=[],ut=n.length,r,t=0,b=d,y=k,i,u,w,nt,o,c,a,tt,it;for(i=n.lastIndexOf(g),i<0&&(i=0),u=0;u<i;++u)n.charCodeAt(u)>=128&&s("not-basic"),v.push(n.charCodeAt(u));for(w=i>0?i+1:0;w<ut;){for(nt=t,o=1,c=f;;c+=f){if(w>=ut&&s("invalid-input"),a=yt(n.charCodeAt(w++)),(a>=f||a>e((h-t)/o))&&s("overflow"),t+=a*o,tt=c<=y?p:c>=y+l?l:c-y,a<tt)break;it=f-tt;o>e(h/it)&&s("overflow");o*=it}r=v.length+1;y=ft(t-nt,r,nt==0);e(t/r)>h-b&&s("overflow");b+=e(t/r);t%=r;v.splice(t++,0,b)}return rt(v)}function ot(n){var r,u,v,et,y,t,o,w,b,nt,i,c=[],tt,rt,ot,st;for(n=it(n),tt=n.length,r=d,u=0,y=k,t=0;t<tt;++t)i=n[t],i<128&&c.push(a(i));for(v=et=c.length,et&&c.push(g);v<tt;){for(o=h,t=0;t<tt;++t)i=n[t],i>=r&&i<o&&(o=i);for(rt=v+1,o-r>e((h-u)/rt)&&s("overflow"),u+=(o-r)*rt,r=o,t=0;t<tt;++t)if(i=n[t],i<r&&++u>h&&s("overflow"),i==r){for(w=u,b=f;;b+=f){if(nt=b<=y?p:b>=y+l?l:b-y,w<nt)break;st=w-nt;ot=f-nt;c.push(a(ut(nt+st%ot,0)));w=e(st/ot)}c.push(a(ut(w,0)));y=ft(u,rt,v==et);u=0;++v}++u;++r}return c.join("")}function pt(n){return tt(n,function(n){return ct.test(n)?et(n.slice(4).toLowerCase()):n})}function wt(n){return tt(n,function(n){return lt.test(n)?"xn--"+ot(n):n})}var v=typeof r=="object"&&r,b=typeof i=="object"&&i&&i.exports==v&&i,c=typeof t=="object"&&t;(c.global===c||c.window===c)&&(u=c);var o,h=2147483647,f=36,p=1,l=26,st=38,ht=700,k=72,d=128,g="-",ct=/^xn--/,lt=/[^ -~]/,at=/\x2E|\u3002|\uFF0E|\uFF61/g,vt={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},w=f-p,e=Math.floor,a=String.fromCharCode,y;if(o={version:"1.2.4",ucs2:{decode:it,encode:rt},decode:et,encode:ot,toASCII:wt,toUnicode:pt},typeof n=="function"&&typeof n.amd=="object"&&n.amd)n("punycode",function(){return o});else if(v&&!v.nodeType)if(b)b.exports=o;else for(y in o)o.hasOwnProperty(y)&&(v[y]=o[y]);else u.punycode=o})(this)}).call(this,typeof global!="undefined"?global:typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{}],2:[function(n,t){function f(n,t,i){n.defaultView&&(t!==n.defaultView.pageXOffset||i!==n.defaultView.pageYOffset)&&n.defaultView.scrollTo(t,i)}function e(n,t){try{t&&(t.width=n.width,t.height=n.height,t.getContext("2d").putImageData(n.getContext("2d").getImageData(0,0,n.width,n.height),0,0))}catch(i){u("Unable to copy canvas content from",n,i)}}function i(n,t){for(var r=n.nodeType===3?document.createTextNode(n.nodeValue):n.cloneNode(!1),u=n.firstChild;u;)(t===!0||u.nodeType!==1||u.nodeName!=="SCRIPT")&&r.appendChild(i(u,t)),u=u.nextSibling;return n.nodeType===1&&(r._scrollTop=n.scrollTop,r._scrollLeft=n.scrollLeft,n.nodeName==="CANVAS"?e(n,r):(n.nodeName==="TEXTAREA"||n.nodeName==="SELECT")&&(r.value=n.value)),r}function r(n){if(n.nodeType===1){n.scrollTop=n._scrollTop;n.scrollLeft=n._scrollLeft;for(var t=n.firstChild;t;)r(t),t=t.nextSibling}}var u=n("./log");t.exports=function(n,t,u,e,o,s,h){var l=i(n.documentElement,o.javascriptEnabled),c=t.createElement("iframe");return c.className="html2canvas-container",c.style.visibility="hidden",c.style.position="fixed",c.style.left="-10000px",c.style.top="0px",c.style.border="0",c.width=u,c.height=e,c.scrolling="no",t.body.appendChild(c),new Promise(function(t){var i=c.contentWindow.document;c.contentWindow.onload=c.onload=function(){var n=setInterval(function(){i.body.childNodes.length>0&&(r(i.documentElement),clearInterval(n),o.type==="view"&&(c.contentWindow.scrollTo(s,h),/(iPad|iPhone|iPod)/g.test(navigator.userAgent)&&(c.contentWindow.scrollY!==h||c.contentWindow.scrollX!==s)&&(i.documentElement.style.top=-h+"px",i.documentElement.style.left=-s+"px",i.documentElement.style.position="absolute")),t(c))},50)};i.open();i.write("<!DOCTYPE html><html><\/html>");f(n,s,h);i.replaceChild(i.adoptNode(l),i.documentElement);i.close()})}},{"./log":13}],3:[function(n,t){function i(n){this.r=0;this.g=0;this.b=0;this.a=null;var t=this.fromArray(n)||this.namedColor(n)||this.rgb(n)||this.rgba(n)||this.hex6(n)||this.hex3(n)}var r,u,f,e,o;i.prototype.darken=function(n){var t=1-n;return new i([Math.round(this.r*t),Math.round(this.g*t),Math.round(this.b*t),this.a])};i.prototype.isTransparent=function(){return this.a===0};i.prototype.isBlack=function(){return this.r===0&&this.g===0&&this.b===0};i.prototype.fromArray=function(n){return Array.isArray(n)&&(this.r=Math.min(n[0],255),this.g=Math.min(n[1],255),this.b=Math.min(n[2],255),n.length>3&&(this.a=n[3])),Array.isArray(n)};r=/^#([a-f0-9]{3})$/i;i.prototype.hex3=function(n){var t=null;return(t=n.match(r))!==null&&(this.r=parseInt(t[1][0]+t[1][0],16),this.g=parseInt(t[1][1]+t[1][1],16),this.b=parseInt(t[1][2]+t[1][2],16)),t!==null};u=/^#([a-f0-9]{6})$/i;i.prototype.hex6=function(n){var t=null;return(t=n.match(u))!==null&&(this.r=parseInt(t[1].substring(0,2),16),this.g=parseInt(t[1].substring(2,4),16),this.b=parseInt(t[1].substring(4,6),16)),t!==null};f=/^rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)$/;i.prototype.rgb=function(n){var t=null;return(t=n.match(f))!==null&&(this.r=Number(t[1]),this.g=Number(t[2]),this.b=Number(t[3])),t!==null};e=/^rgba\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d?\.?\d+)\s*\)$/;i.prototype.rgba=function(n){var t=null;return(t=n.match(e))!==null&&(this.r=Number(t[1]),this.g=Number(t[2]),this.b=Number(t[3]),this.a=Number(t[4])),t!==null};i.prototype.toString=function(){return this.a!==null&&this.a!==1?"rgba("+[this.r,this.g,this.b,this.a].join(",")+")":"rgb("+[this.r,this.g,this.b].join(",")+")"};i.prototype.namedColor=function(n){n=n.toLowerCase();var t=o[n];if(t)this.r=t[0],this.g=t[1],this.b=t[2];else if(n==="transparent")return this.r=this.g=this.b=this.a=0,!0;return!!t};i.prototype.isColor=!0;o={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};t.exports=i},{}],4:[function(t,i){function u(n,t){var u=k++,f,o,i;return(t=t||{},t.logging&&(r.options.logging=!0,r.options.start=Date.now()),t.async=typeof t.async=="undefined"?!0:t.async,t.allowTaint=typeof t.allowTaint=="undefined"?!1:t.allowTaint,t.removeContainer=typeof t.removeContainer=="undefined"?!0:t.removeContainer,t.javascriptEnabled=typeof t.javascriptEnabled=="undefined"?!1:t.javascriptEnabled,t.imageTimeout=typeof t.imageTimeout=="undefined"?1e4:t.imageTimeout,t.renderer=typeof t.renderer=="function"?t.renderer:e,t.strict=!!t.strict,typeof n=="string")?typeof t.proxy!="string"?Promise.reject("Proxy must be used when rendering url"):(f=t.width!=null?t.width:window.innerWidth,o=t.height!=null?t.height:window.innerHeight,w(it(n),t.proxy,document,f,o,t).then(function(n){return h(n.contentWindow.document.documentElement,n,t,f,o)})):(i=(n===undefined?[document.documentElement]:n.length?n:[n])[0],i.setAttribute(s+u,u),d(i.ownerDocument,t,i.ownerDocument.defaultView.innerWidth,i.ownerDocument.defaultView.innerHeight,u).then(function(n){if(typeof t.onrendered=="function"){r("options.onrendered is deprecated, html2canvas returns a Promise containing the canvas");t.onrendered(n)}return n}))}function d(n,t,i,u,f){return p(n,n,i,u,t,n.defaultView.pageXOffset,n.defaultView.pageYOffset).then(function(e){var o,c;r("Document cloned");o=s+f;c="["+o+"='"+f+"']";n.querySelector(c).removeAttribute(o);var l=e.contentWindow,a=l.document.querySelector(c),v=typeof t.onclone=="function"?Promise.resolve(t.onclone(l.document)):Promise.resolve(!0);return v.then(function(){return h(a,e,t,i,u)})})}function h(n,t,i,u,f){var o=t.contentWindow,h=new l(o.document),y=new a(i,h),s=b(n),p=i.type==="view"?u:nt(o.document),w=i.type==="view"?f:tt(o.document),e=new i.renderer(p,w,y,i,document),k=new v(n,e,h,y,i);return k.ready.then(function(){r("Finished rendering");var u;return u=i.type==="view"?c(e.canvas,{width:e.canvas.width,height:e.canvas.height,top:0,left:0,x:0,y:0}):n===o.document.body||n===o.document.documentElement||i.canvas!=null?e.canvas:c(e.canvas,{width:i.width!=null?i.width:s.width,height:i.height!=null?i.height:s.height,top:s.top,left:s.left,x:0,y:0}),g(t,i),u})}function g(n,t){t.removeContainer&&(n.parentNode.removeChild(n),r("Cleaned up container"))}function c(n,t){var i=document.createElement("canvas"),e=Math.min(n.width-1,Math.max(0,t.left)),s=Math.min(n.width,Math.max(1,t.left+t.width)),o=Math.min(n.height-1,Math.max(0,t.top)),h=Math.min(n.height,Math.max(1,t.top+t.height)),u,f;return i.width=t.width,i.height=t.height,u=s-e,f=h-o,r("Cropping canvas at:","left:",t.left,"top:",t.top,"width:",u,"height:",f),r("Resulting crop with width",t.width,"and height",t.height,"with x",e,"and y",o),i.getContext("2d").drawImage(n,e,o,u,f,t.x,t.y,u,f),i}function nt(n){return Math.max(Math.max(n.body.scrollWidth,n.documentElement.scrollWidth),Math.max(n.body.offsetWidth,n.documentElement.offsetWidth),Math.max(n.body.clientWidth,n.documentElement.clientWidth))}function tt(n){return Math.max(Math.max(n.body.scrollHeight,n.documentElement.scrollHeight),Math.max(n.body.offsetHeight,n.documentElement.offsetHeight),Math.max(n.body.clientHeight,n.documentElement.clientHeight))}function it(n){var t=document.createElement("a");return t.href=n,t.href=t.href,t}var l=t("./support"),e=t("./renderers/canvas"),a=t("./imageloader"),v=t("./nodeparser"),y=t("./nodecontainer"),r=t("./log"),o=t("./utils"),p=t("./clone"),w=t("./proxy").loadUrlDocument,b=o.getBounds,s="data-html2canvas-node",k=0,f;u.CanvasRenderer=e;u.NodeContainer=y;u.log=r;u.utils=o;f=typeof document=="undefined"||typeof Object.create!="function"||typeof document.createElement("canvas").getContext!="function"?function(){return Promise.reject("No canvas support")}:u;i.exports=f;typeof n=="function"&&n.amd&&n("html2canvas",[],function(){return f})},{"./clone":2,"./imageloader":11,"./log":13,"./nodecontainer":14,"./nodeparser":15,"./proxy":16,"./renderers/canvas":20,"./support":22,"./utils":26}],5:[function(n,t){function i(n){if(this.src=n,r("DummyImageContainer for",n),!this.promise||!this.image){r("Initiating DummyImageContainer");i.prototype.image=new Image;var t=this.image;i.prototype.promise=new Promise(function(n,i){t.onload=n;t.onerror=i;t.src=u();t.complete===!0&&n(t)})}}var r=n("./log"),u=n("./utils").smallImage;t.exports=i},{"./log":13,"./utils":26}],6:[function(n,t){function r(n,t){var r=document.createElement("div"),u=document.createElement("img"),f=document.createElement("span"),e="Hidden Text",o,s;r.style.visibility="hidden";r.style.fontFamily=n;r.style.fontSize=t;r.style.margin=0;r.style.padding=0;document.body.appendChild(r);u.src=i();u.width=1;u.height=1;u.style.margin=0;u.style.padding=0;u.style.verticalAlign="baseline";f.style.fontFamily=n;f.style.fontSize=t;f.style.margin=0;f.style.padding=0;f.appendChild(document.createTextNode(e));r.appendChild(f);r.appendChild(u);o=u.offsetTop-f.offsetTop+1;r.removeChild(f);r.appendChild(document.createTextNode(e));r.style.lineHeight="normal";u.style.verticalAlign="super";s=u.offsetTop-r.offsetTop+1;document.body.removeChild(r);this.baseline=o;this.lineWidth=1;this.middle=s}var i=n("./utils").smallImage;t.exports=r},{"./utils":26}],7:[function(n,t){function i(){this.data={}}var r=n("./font");i.prototype.getMetrics=function(n,t){return this.data[n+"-"+t]===undefined&&(this.data[n+"-"+t]=new r(n,t)),this.data[n+"-"+t]};t.exports=i},{"./font":6}],8:[function(n,t){function i(t,i,r){this.image=null;this.src=t;var f=this,e=u(t);this.promise=(i?new Promise(function(n){t.contentWindow.document.URL==="about:blank"||t.contentWindow.document.documentElement==null?t.contentWindow.onload=t.onload=function(){n(t)}:n(t)}):this.proxyLoad(r.proxy,e,r)).then(function(t){var i=n("./core");return i(t.contentWindow.document.documentElement,{type:"view",width:t.width,height:t.height,proxy:r.proxy,javascriptEnabled:r.javascriptEnabled,removeContainer:r.removeContainer,allowTaint:r.allowTaint,imageTimeout:r.imageTimeout/2})}).then(function(n){return f.image=n})}var r=n("./utils"),u=r.getBounds,f=n("./proxy").loadUrlDocument;i.prototype.proxyLoad=function(n,t,i){var r=this.src;return f(r.src,n,r.ownerDocument,t.width,t.height,i)};t.exports=i},{"./core":4,"./proxy":16,"./utils":26}],9:[function(n,t){function i(n){this.src=n.value;this.colorStops=[];this.type=null;this.x0=.5;this.y0=.5;this.x1=.5;this.y1=.5;this.promise=Promise.resolve(!0)}i.TYPES={LINEAR:1,RADIAL:2};i.REGEXP_COLORSTOP=/^\s*(rgba?\(\s*\d{1,3},\s*\d{1,3},\s*\d{1,3}(?:,\s*[0-9\.]+)?\s*\)|[a-z]{3,20}|#[a-f0-9]{3,6})(?:\s+(\d{1,3}(?:\.\d+)?)(%|px)?)?(?:\s|$)/i;t.exports=i},{}],10:[function(n,t){function i(n,t){this.src=n;this.image=new Image;var i=this;this.tainted=null;this.promise=new Promise(function(r,u){i.image.onload=r;i.image.onerror=u;t&&(i.image.crossOrigin="anonymous");i.image.src=n;i.image.complete===!0&&r(i.image)})}t.exports=i},{}],11:[function(n,t){function i(n,t){this.link=null;this.options=n;this.support=t;this.origin=this.getOrigin(window.location.href)}var r=n("./log"),u=n("./imagecontainer"),f=n("./dummyimagecontainer"),o=n("./proxyimagecontainer"),s=n("./framecontainer"),e=n("./svgcontainer"),h=n("./svgnodecontainer"),c=n("./lineargradientcontainer"),l=n("./webkitgradientcontainer"),a=n("./utils").bind;i.prototype.findImages=function(n){var t=[];return n.reduce(function(n,t){switch(t.node.nodeName){case"IMG":return n.concat([{args:[t.node.src],method:"url"}]);case"svg":case"IFRAME":return n.concat([{args:[t.node],method:t.node.nodeName}])}return n},[]).forEach(this.addImage(t,this.loadImage),this),t};i.prototype.findBackgroundImage=function(n,t){return t.parseBackgroundImages().filter(this.hasImageBackground).forEach(this.addImage(n,this.loadImage),this),n};i.prototype.addImage=function(n,t){return function(i){i.args.forEach(function(u){this.imageExists(n,u)||(n.splice(0,0,t.call(this,i)),r("Added image #"+n.length,typeof u=="string"?u.substring(0,100):u))},this)}};i.prototype.hasImageBackground=function(n){return n.method!=="none"};i.prototype.loadImage=function(n){if(n.method==="url"){var t=n.args[0];return!this.isSVG(t)||this.support.svg||this.options.allowTaint?t.match(/data:image\/.*;base64,/i)?new u(t.replace(/url\(['"]{0,}|['"]{0,}\)$/ig,""),!1):this.isSameOrigin(t)||this.options.allowTaint===!0||this.isSVG(t)?new u(t,!1):this.support.cors&&!this.options.allowTaint&&this.options.useCORS?new u(t,!0):this.options.proxy?new o(t,this.options.proxy):new f(t):new e(t)}return n.method==="linear-gradient"?new c(n):n.method==="gradient"?new l(n):n.method==="svg"?new h(n.args[0],this.support.svg):n.method==="IFRAME"?new s(n.args[0],this.isSameOrigin(n.args[0].src),this.options):new f(n)};i.prototype.isSVG=function(n){return n.substring(n.length-3).toLowerCase()==="svg"||e.prototype.isInline(n)};i.prototype.imageExists=function(n,t){return n.some(function(n){return n.src===t})};i.prototype.isSameOrigin=function(n){return this.getOrigin(n)===this.origin};i.prototype.getOrigin=function(n){var t=this.link||(this.link=document.createElement("a"));return t.href=n,t.href=t.href,t.protocol+t.hostname+t.port};i.prototype.getPromise=function(n){return this.timeout(n,this.options.imageTimeout)["catch"](function(){var t=new f(n.src);return t.promise.then(function(t){n.image=t})})};i.prototype.get=function(n){var t=null;return this.images.some(function(i){return(t=i).src===n})?t:null};i.prototype.fetch=function(n){return this.images=n.reduce(a(this.findBackgroundImage,this),this.findImages(n)),this.images.forEach(function(n,t){n.promise.then(function(){r("Succesfully loaded image #"+(t+1),n)},function(i){r("Failed loading image #"+(t+1),n,i)})}),this.ready=Promise.all(this.images.map(this.getPromise,this)),r("Finished searching images"),this};i.prototype.timeout=function(n,t){var i,u=Promise.race([n.promise,new Promise(function(u,f){i=setTimeout(function(){r("Timed out loading image",n);f(n)},t)})]).then(function(n){return clearTimeout(i),n});return u["catch"](function(){clearTimeout(i)}),u};t.exports=i},{"./dummyimagecontainer":5,"./framecontainer":8,"./imagecontainer":10,"./lineargradientcontainer":12,"./log":13,"./proxyimagecontainer":17,"./svgcontainer":23,"./svgnodecontainer":24,"./utils":26,"./webkitgradientcontainer":27}],12:[function(n,t){function r(n){i.apply(this,arguments);this.type=i.TYPES.LINEAR;var t=r.REGEXP_DIRECTION.test(n.args[0])||!i.REGEXP_COLORSTOP.test(n.args[0]);t?n.args[0].split(/\s+/).reverse().forEach(function(n,t){var r,u,i;switch(n){case"left":this.x0=0;this.x1=1;break;case"top":this.y0=0;this.y1=1;break;case"right":this.x0=1;this.x1=0;break;case"bottom":this.y0=1;this.y1=0;break;case"to":r=this.y0;u=this.x0;this.y0=this.y1;this.x0=this.x1;this.x1=u;this.y1=r;break;case"center":break;default:if(i=parseFloat(n,10)*.01,isNaN(i))break;t===0?(this.y0=i,this.y1=1-this.y0):(this.x0=i,this.x1=1-this.x0)}},this):(this.y0=0,this.y1=1);this.colorStops=n.args.slice(t?1:0).map(function(n){var t=n.match(i.REGEXP_COLORSTOP),r=+t[2],f=r===0?"%":t[3];return{color:new u(t[1]),stop:f==="%"?r/100:null}});this.colorStops[0].stop===null&&(this.colorStops[0].stop=0);this.colorStops[this.colorStops.length-1].stop===null&&(this.colorStops[this.colorStops.length-1].stop=1);this.colorStops.forEach(function(n,t){n.stop===null&&this.colorStops.slice(t).some(function(i,r){return i.stop!==null?(n.stop=(i.stop-this.colorStops[t-1].stop)/(r+1)+this.colorStops[t-1].stop,!0):!1},this)},this)}var i=n("./gradientcontainer"),u=n("./color");r.prototype=Object.create(i.prototype);r.REGEXP_DIRECTION=/^\s*(?:to|left|right|top|bottom|center|\d{1,3}(?:\.\d+)?%?)(?:\s|$)/i;t.exports=r},{"./color":3,"./gradientcontainer":9}],13:[function(n,t){var i=function(){i.options.logging&&window.console&&window.console.log&&Function.prototype.bind.call(window.console.log,window.console).apply(window.console,[Date.now()-i.options.start+"ms","html2canvas:"].concat([].slice.call(arguments,0)))};i.options={logging:!1};t.exports=i},{}],14:[function(n,t){function i(n,t){this.node=n;this.parent=t;this.stack=null;this.bounds=null;this.borders=null;this.clip=[];this.backgroundClip=[];this.offsetBounds=null;this.visible=null;this.computedStyles=null;this.colors={};this.styles={};this.backgroundImages=null;this.transformData=null;this.transformMatrix=null;this.isPseudoElement=!1;this.opacity=null}function h(n){var t=n.options[n.selectedIndex||0];return t?t.text||"":""}function c(n){if(n&&n[1]==="matrix")return n[2].split(",").map(function(n){return parseFloat(n.trim())});if(n&&n[1]==="matrix3d"){var t=n[2].split(",").map(function(n){return parseFloat(n.trim())});return[t[0],t[1],t[4],t[5],t[12],t[13]]}}function r(n){return n.toString().indexOf("%")!==-1}function l(n){return n.replace("px","")}function a(n){return parseFloat(n)}var f=n("./color"),u=n("./utils"),e=u.getBounds,o=u.parseBackgrounds,s=u.offsetBounds;i.prototype.cloneTo=function(n){n.visible=this.visible;n.borders=this.borders;n.bounds=this.bounds;n.clip=this.clip;n.backgroundClip=this.backgroundClip;n.computedStyles=this.computedStyles;n.styles=this.styles;n.backgroundImages=this.backgroundImages;n.opacity=this.opacity};i.prototype.getOpacity=function(){return this.opacity===null?this.opacity=this.cssFloat("opacity"):this.opacity};i.prototype.assignStack=function(n){this.stack=n;n.children.push(this)};i.prototype.isElementVisible=function(){return this.node.nodeType===Node.TEXT_NODE?this.parent.visible:this.css("display")!=="none"&&this.css("visibility")!=="hidden"&&!this.node.hasAttribute("data-html2canvas-ignore")&&(this.node.nodeName!=="INPUT"||this.node.getAttribute("type")!=="hidden")};i.prototype.css=function(n){return this.computedStyles||(this.computedStyles=this.isPseudoElement?this.parent.computedStyle(this.before?":before":":after"):this.computedStyle(null)),this.styles[n]||(this.styles[n]=this.computedStyles[n])};i.prototype.prefixedCss=function(n){var t=this.css(n);return t===undefined&&["webkit","moz","ms","o"].some(function(i){return t=this.css(i+n.substr(0,1).toUpperCase()+n.substr(1)),t!==undefined},this),t===undefined?null:t};i.prototype.computedStyle=function(n){return this.node.ownerDocument.defaultView.getComputedStyle(this.node,n)};i.prototype.cssInt=function(n){var t=parseInt(this.css(n),10);return isNaN(t)?0:t};i.prototype.color=function(n){return this.colors[n]||(this.colors[n]=new f(this.css(n)))};i.prototype.cssFloat=function(n){var t=parseFloat(this.css(n));return isNaN(t)?0:t};i.prototype.fontWeight=function(){var n=this.css("fontWeight");switch(parseInt(n,10)){case 401:n="bold";break;case 400:n="normal"}return n};i.prototype.parseClip=function(){var n=this.css("clip").match(this.CLIP);return n?{top:parseInt(n[1],10),right:parseInt(n[2],10),bottom:parseInt(n[3],10),left:parseInt(n[4],10)}:null};i.prototype.parseBackgroundImages=function(){return this.backgroundImages||(this.backgroundImages=o(this.css("backgroundImage")))};i.prototype.cssList=function(n,t){var i=(this.css(n)||"").split(",");return i=i[t||0]||i[0]||"auto",i=i.trim().split(" "),i.length===1&&(i=[i[0],r(i[0])?"auto":i[0]]),i};i.prototype.parseBackgroundSize=function(n,t,i){var u=this.cssList("backgroundSize",i),f,o,s,e;if(r(u[0]))f=n.width*parseFloat(u[0])/100;else{if(/contain|cover/.test(u[0]))return s=n.width/n.height,e=t.width/t.height,s<e^u[0]==="contain"?{width:n.height*e,height:n.height}:{width:n.width,height:n.width/e};f=parseInt(u[0],10)}return o=u[0]==="auto"&&u[1]==="auto"?t.height:u[1]==="auto"?f/t.width*t.height:r(u[1])?n.height*parseFloat(u[1])/100:parseInt(u[1],10),u[0]==="auto"&&(f=o/t.height*t.width),{width:f,height:o}};i.prototype.parseBackgroundPosition=function(n,t,i,u){var f=this.cssList("backgroundPosition",i),e,o;return e=r(f[0])?(n.width-(u||t).width)*(parseFloat(f[0])/100):parseInt(f[0],10),o=f[1]==="auto"?e/t.width*t.height:r(f[1])?(n.height-(u||t).height)*parseFloat(f[1])/100:parseInt(f[1],10),f[0]==="auto"&&(e=o/t.height*t.width),{left:e,top:o}};i.prototype.parseBackgroundRepeat=function(n){return this.cssList("backgroundRepeat",n)[0]};i.prototype.parseTextShadows=function(){var r=this.css("textShadow"),u=[],t,i,n;if(r&&r!=="none")for(t=r.match(this.TEXT_SHADOW_PROPERTY),i=0;t&&i<t.length;i++)n=t[i].match(this.TEXT_SHADOW_VALUES),u.push({color:new f(n[0]),offsetX:n[1]?parseFloat(n[1].replace("px","")):0,offsetY:n[2]?parseFloat(n[2].replace("px","")):0,blur:n[3]?n[3].replace("px",""):0});return u};i.prototype.parseTransform=function(){if(!this.transformData)if(this.hasTransform()){var t=this.parseBounds(),n=this.prefixedCss("transformOrigin").split(" ").map(l).map(a);n[0]+=t.left;n[1]+=t.top;this.transformData={origin:n,matrix:this.parseTransformMatrix()}}else this.transformData={origin:[0,0],matrix:[1,0,0,1,0,0]};return this.transformData};i.prototype.parseTransformMatrix=function(){if(!this.transformMatrix){var n=this.prefixedCss("transform"),t=n?c(n.match(this.MATRIX_PROPERTY)):null;this.transformMatrix=t?t:[1,0,0,1,0,0]}return this.transformMatrix};i.prototype.parseBounds=function(){return this.bounds||(this.bounds=this.hasTransform()?s(this.node):e(this.node))};i.prototype.hasTransform=function(){return this.parseTransformMatrix().join(",")!=="1,0,0,1,0,0"||this.parent&&this.parent.hasTransform()};i.prototype.getValue=function(){var n=this.node.value||"";return this.node.tagName==="SELECT"?n=h(this.node):this.node.type==="password"&&(n=Array(n.length+1).join("•")),n.length===0?this.node.placeholder||"":n};i.prototype.MATRIX_PROPERTY=/(matrix|matrix3d)\((.+)\)/;i.prototype.TEXT_SHADOW_PROPERTY=/((rgba|rgb)\([^\)]+\)(\s-?\d+px){0,})/g;i.prototype.TEXT_SHADOW_VALUES=/(-?\d+px)|(#.+)|(rgb\(.+\))|(rgba\(.+\))/g;i.prototype.CLIP=/^rect\((\d+)px,? (\d+)px,? (\d+)px,? (\d+)px\)$/;t.exports=i},{"./color":3,"./utils":26}],15:[function(n,t){function i(n,t,i,f,e){var o,s;r("Starting NodeParser");this.renderer=t;this.options=e;this.range=null;this.support=i;this.renderQueue=[];this.stack=new k(!0,1,n.ownerDocument,null);o=new w(n,null);e.background&&t.rectangle(0,0,t.width,t.height,new u(e.background));n===n.ownerDocument.documentElement&&(s=new w(o.color("backgroundColor").isTransparent()?n.ownerDocument.body:n.ownerDocument.documentElement,null),t.rectangle(0,0,t.width,t.height,s.color("backgroundColor")));o.visibile=o.isElementVisible();this.createPseudoHideStyles(n.ownerDocument);this.disableAnimations(n.ownerDocument);this.nodes=it([o].concat(this.getChildren(o)).filter(function(n){return n.visible=n.isElementVisible()}).map(this.getPseudoElements,this));this.fontMetrics=new ct;r("Fetched nodes, total:",this.nodes.length);r("Calculate overflow clips");this.calculateOverflowClips();r("Start fetching images");this.images=f.fetch(this.nodes.filter(l));this.ready=this.images.ready.then(d(function(){return r("Images loaded, starting parsing"),r("Creating stacking contexts"),this.createStackingContexts(),r("Sorting stacking contexts"),this.sortStackingContexts(this.stack),this.parse(this.stack),r("Render queue created with "+this.renderQueue.length+" items"),new Promise(d(function(n){e.async?typeof e.async=="function"?e.async.call(this,this.renderQueue,n):this.renderQueue.length>0?(this.renderIndex=0,this.asyncRenderer(this.renderQueue,n)):n():(this.renderQueue.forEach(this.paint,this),n())},this))},this))}function rt(n){return n.parent&&n.parent.clip.length}function yt(n){return n.replace(/(\-[a-z])/g,function(n){return n.toUpperCase().replace("-","")})}function ut(){}function ft(n,t,i,r){return n.map(function(u,f){if(u.width>0){var o=t.left,e=t.top,s=t.width,h=t.height-n[2].width;switch(f){case 0:h=n[0].width;u.args=p({c1:[o,e],c2:[o+s,e],c3:[o+s-n[1].width,e+h],c4:[o+n[3].width,e+h]},r[0],r[1],i.topLeftOuter,i.topLeftInner,i.topRightOuter,i.topRightInner);break;case 1:o=t.left+t.width-n[1].width;s=n[1].width;u.args=p({c1:[o+s,e],c2:[o+s,e+h+n[2].width],c3:[o,e+h],c4:[o,e+n[0].width]},r[1],r[2],i.topRightOuter,i.topRightInner,i.bottomRightOuter,i.bottomRightInner);break;case 2:e=e+t.height-n[2].width;h=n[2].width;u.args=p({c1:[o+s,e+h],c2:[o,e+h],c3:[o+n[3].width,e],c4:[o+s-n[3].width,e]},r[2],r[3],i.bottomRightOuter,i.bottomRightInner,i.bottomLeftOuter,i.bottomLeftInner);break;case 3:s=n[3].width;u.args=p({c1:[o,e+h+n[2].width],c2:[o,e],c3:[o+s,e+n[0].width],c4:[o+s,e+h]},r[3],r[0],i.bottomLeftOuter,i.bottomLeftInner,i.topLeftOuter,i.topLeftInner)}}return u})}function f(n,t,i,r){var h=4*((Math.sqrt(2)-1)/3),e=i*h,s=r*h,u=n+i,f=t+r;return{topLeft:o({x:n,y:f},{x:n,y:f-s},{x:u-e,y:t},{x:u,y:t}),topRight:o({x:n,y:t},{x:n+e,y:t},{x:u,y:f-s},{x:u,y:f}),bottomRight:o({x:u,y:t},{x:u,y:t+s},{x:n+e,y:f},{x:n,y:f}),bottomLeft:o({x:u,y:f},{x:u-e,y:f},{x:n,y:t+s},{x:n,y:t})}}function et(n,t,i){var e=n.left,o=n.top,r=n.width,u=n.height,v=t[0][0]<r/2?t[0][0]:r/2,y=t[0][1]<u/2?t[0][1]:u/2,s=t[1][0]<r/2?t[1][0]:r/2,p=t[1][1]<u/2?t[1][1]:u/2,h=t[2][0]<r/2?t[2][0]:r/2,c=t[2][1]<u/2?t[2][1]:u/2,w=t[3][0]<r/2?t[3][0]:r/2,l=t[3][1]<u/2?t[3][1]:u/2,a=r-s,b=u-c,k=r-h,d=u-l;return{topLeftOuter:f(e,o,v,y).topLeft.subdivide(.5),topLeftInner:f(e+i[3].width,o+i[0].width,Math.max(0,v-i[3].width),Math.max(0,y-i[0].width)).topLeft.subdivide(.5),topRightOuter:f(e+a,o,s,p).topRight.subdivide(.5),topRightInner:f(e+Math.min(a,r+i[3].width),o+i[0].width,a>r+i[3].width?0:s-i[3].width,p-i[0].width).topRight.subdivide(.5),bottomRightOuter:f(e+k,o+b,h,c).bottomRight.subdivide(.5),bottomRightInner:f(e+Math.min(k,r-i[3].width),o+Math.min(b,u+i[0].width),Math.max(0,h-i[1].width),c-i[2].width).bottomRight.subdivide(.5),bottomLeftOuter:f(e,o+d,w,l).bottomLeft.subdivide(.5),bottomLeftInner:f(e+i[3].width,o+d,Math.max(0,w-i[3].width),l-i[2].width).bottomLeft.subdivide(.5)}}function o(n,t,i,r){var u=function(n,t,i){return{x:n.x+(t.x-n.x)*i,y:n.y+(t.y-n.y)*i}};return{start:n,startControl:t,endControl:i,end:r,subdivide:function(f){var e=u(n,t,f),s=u(t,i,f),h=u(i,r,f),c=u(e,s,f),l=u(s,h,f),a=u(c,l,f);return[o(n,e,c,a),o(a,l,h,r)]},curveTo:function(n){n.push(["bezierCurve",t.x,t.y,i.x,i.y,r.x,r.y])},curveToReversed:function(r){r.push(["bezierCurve",i.x,i.y,t.x,t.y,n.x,n.y])}}}function p(n,t,i,r,u,f,e){var o=[];return t[0]>0||t[1]>0?(o.push(["line",r[1].start.x,r[1].start.y]),r[1].curveTo(o)):o.push(["line",n.c1[0],n.c1[1]]),i[0]>0||i[1]>0?(o.push(["line",f[0].start.x,f[0].start.y]),f[0].curveTo(o),o.push(["line",e[0].end.x,e[0].end.y]),e[0].curveToReversed(o)):(o.push(["line",n.c2[0],n.c2[1]]),o.push(["line",n.c3[0],n.c3[1]])),t[0]>0||t[1]>0?(o.push(["line",u[1].end.x,u[1].end.y]),u[1].curveToReversed(o)):o.push(["line",n.c4[0],n.c4[1]]),o}function e(n,t,i,r,u,f,e){t[0]>0||t[1]>0?(n.push(["line",r[0].start.x,r[0].start.y]),r[0].curveTo(n),r[1].curveTo(n)):n.push(["line",f,e]);(i[0]>0||i[1]>0)&&n.push(["line",u[0].start.x,u[0].start.y])}function pt(n){return n.cssInt("zIndex")<0}function wt(n){return n.cssInt("zIndex")>0}function ot(n){return n.cssInt("zIndex")===0}function st(n){return["inline","inline-block","inline-table"].indexOf(n.css("display"))!==-1}function ht(n){return n instanceof k}function bt(n){return n.node.data.trim().length>0}function kt(n){return/^(normal|none|0px)$/.test(n.parent.css("letterSpacing"))}function dt(n){return["TopLeft","TopRight","BottomRight","BottomLeft"].map(function(t){var r=n.css("border"+t+"Radius"),i=r.split(" ");return i.length<=1&&(i[1]=i[0]),i.map(ui)})}function gt(n){return n.nodeType===Node.TEXT_NODE||n.nodeType===Node.ELEMENT_NODE}function ni(n){var t=n.css("position"),i=["absolute","relative","fixed"].indexOf(t)!==-1?n.css("zIndex"):"auto";return i!=="auto"}function h(n){return n.css("position")!=="static"}function nt(n){return n.css("float")!=="none"}function ti(n){return["inline-block","inline-table"].indexOf(n.css("display"))!==-1}function c(n){var t=this;return function(){return!n.apply(t,arguments)}}function l(n){return n.node.nodeType===Node.ELEMENT_NODE}function a(n){return n.isPseudoElement===!0}function tt(n){return n.node.nodeType===Node.TEXT_NODE}function ii(n){return function(t,i){return t.cssInt("zIndex")+n.indexOf(t)/n.length-(i.cssInt("zIndex")+n.indexOf(i)/n.length)}}function ri(n){return n.getOpacity()<1}function ui(n){return parseInt(n,10)}function fi(n){return n.width}function ei(n){return n.node.nodeType!==Node.ELEMENT_NODE||["SCRIPT","HEAD","TITLE","OBJECT","BR","OPTION"].indexOf(n.node.nodeName)===-1}function it(n){return[].concat.apply([],n)}function oi(n){var t=n.substr(0,1);return t===n.substr(n.length-1)&&t.match(/'|"/)?n.substr(1,n.length-2):n}function si(n){for(var r=[],t=0,u=!1,i;n.length;)hi(n[t])===u?(i=n.splice(0,t),i.length&&r.push(v.ucs2.encode(i)),u=!u,t=0):t++,t>=n.length&&(i=n.splice(0,t),i.length&&r.push(v.ucs2.encode(i)));return r}function hi(n){return[32,13,10,9,45].indexOf(n)!==-1}function ci(n){return/[^\u0000-\u00ff]/.test(n)}var r=n("./log"),v=n("punycode"),w=n("./nodecontainer"),b=n("./textcontainer"),s=n("./pseudoelementcontainer"),ct=n("./fontmetrics"),u=n("./color"),k=n("./stackingcontext"),y=n("./utils"),d=y.bind,lt=y.getBounds,at=y.parseBackgrounds,vt=y.offsetBounds,g;i.prototype.calculateOverflowClips=function(){this.nodes.forEach(function(n){if(l(n)){a(n)&&n.appendToDOM();n.borders=this.parseBorders(n);var i=n.css("overflow")==="hidden"?[n.borders.clip]:[],t=n.parseClip();t&&["absolute","fixed"].indexOf(n.css("position"))!==-1&&i.push([["rect",n.bounds.left+t.left,n.bounds.top+t.top,t.right-t.left,t.bottom-t.top]]);n.clip=rt(n)?n.parent.clip.concat(i):i;n.backgroundClip=n.css("overflow")!=="hidden"?n.clip.concat([n.borders.clip]):n.clip;a(n)&&n.cleanDOM()}else tt(n)&&(n.clip=rt(n)?n.parent.clip:[]);a(n)||(n.bounds=null)},this)};i.prototype.asyncRenderer=function(n,t,i){i=i||Date.now();this.paint(n[this.renderIndex++]);n.length===this.renderIndex?t():i+20>Date.now()?this.asyncRenderer(n,t,i):setTimeout(d(function(){this.asyncRenderer(n,t)},this),0)};i.prototype.createPseudoHideStyles=function(n){this.createStyles(n,"."+s.prototype.PSEUDO_HIDE_ELEMENT_CLASS_BEFORE+':before { content: "" !important; display: none !important; }.'+s.prototype.PSEUDO_HIDE_ELEMENT_CLASS_AFTER+':after { content: "" !important; display: none !important; }')};i.prototype.disableAnimations=function(n){this.createStyles(n,"* { -webkit-animation: none !important; -moz-animation: none !important; -o-animation: none !important; animation: none !important; -webkit-transition: none !important; -moz-transition: none !important; -o-transition: none !important; transition: none !important;}")};i.prototype.createStyles=function(n,t){var i=n.createElement("style");i.innerHTML=t;n.body.appendChild(i)};i.prototype.getPseudoElements=function(n){var t=[[n]],i,r;return n.node.nodeType===Node.ELEMENT_NODE&&(i=this.getPseudoElement(n,":before"),r=this.getPseudoElement(n,":after"),i&&t.push(i),r&&t.push(r)),it(t)};i.prototype.getPseudoElement=function(n,t){var i=n.computedStyle(t),u,o,h;if(!i||!i.content||i.content==="none"||i.content==="-moz-alt-content"||i.display==="none")return null;var f=oi(i.content),c=f.substr(0,3)==="url",r=document.createElement(c?"img":"html2canvaspseudoelement"),e=new s(r,n,t);for(u=i.length-1;u>=0;u--)o=yt(i.item(u)),r.style[o]=i[o];return r.className=s.prototype.PSEUDO_HIDE_ELEMENT_CLASS_BEFORE+" "+s.prototype.PSEUDO_HIDE_ELEMENT_CLASS_AFTER,c?(r.src=at(f)[0].args[0],[e]):(h=document.createTextNode(f),r.appendChild(h),[e,new b(h,e)])};i.prototype.getChildren=function(n){return it([].filter.call(n.node.childNodes,gt).map(function(t){var i=[t.nodeType===Node.TEXT_NODE?new b(t,n):new w(t,n)].filter(ei);return t.nodeType===Node.ELEMENT_NODE&&i.length&&t.tagName!=="TEXTAREA"?i[0].isElementVisible()?i.concat(this.getChildren(i[0])):[]:i},this))};i.prototype.newStackingContext=function(n,t){var i=new k(t,n.getOpacity(),n.node,n.parent),r;n.cloneTo(i);r=t?i.getParentStack(this):i.parent.stack;r.contexts.push(i);n.stack=i};i.prototype.createStackingContexts=function(){this.nodes.forEach(function(n){l(n)&&(this.isRootElement(n)||ri(n)||ni(n)||this.isBodyWithTransparentRoot(n)||n.hasTransform())?this.newStackingContext(n,!0):l(n)&&(h(n)&&ot(n)||ti(n)||nt(n))?this.newStackingContext(n,!1):n.assignStack(n.parent.stack)},this)};i.prototype.isBodyWithTransparentRoot=function(n){return n.node.nodeName==="BODY"&&n.parent.color("backgroundColor").isTransparent()};i.prototype.isRootElement=function(n){return n.parent===null};i.prototype.sortStackingContexts=function(n){n.contexts.sort(ii(n.contexts.slice(0)));n.contexts.forEach(this.sortStackingContexts,this)};i.prototype.parseTextBounds=function(n){return function(t,i,r){var u,f,e;if(n.parent.css("textDecoration").substr(0,4)!=="none"||t.trim().length!==0){if(this.support.rangeBounds&&!n.parent.hasTransform())return u=r.slice(0,i).join("").length,this.getRangeBounds(n.node,u,t.length);if(n.node&&typeof n.node.data=="string")return f=n.node.splitText(t.length),e=this.getWrapperBounds(n.node,n.parent.hasTransform()),n.node=f,e}else(!this.support.rangeBounds||n.parent.hasTransform())&&(n.node=n.node.splitText(t.length));return{}}};i.prototype.getWrapperBounds=function(n,t){var i=n.ownerDocument.createElement("html2canvaswrapper"),r=n.parentNode,f=n.cloneNode(!0),u;return i.appendChild(n.cloneNode(!0)),r.replaceChild(i,n),u=t?vt(i):lt(i),r.replaceChild(f,i),u};i.prototype.getRangeBounds=function(n,t,i){var r=this.range||(this.range=n.ownerDocument.createRange());return r.setStart(n,t),r.setEnd(n,t+i),r.getBoundingClientRect()};i.prototype.parse=function(n){var r=n.contexts.filter(pt),i=n.children.filter(l),t=i.filter(c(nt)),u=t.filter(c(h)).filter(c(st)),f=i.filter(c(h)).filter(nt),e=t.filter(c(h)).filter(st),o=n.contexts.concat(t.filter(h)).filter(ot),s=n.children.filter(tt).filter(bt),a=n.contexts.filter(wt);r.concat(u).concat(f).concat(e).concat(o).concat(s).concat(a).forEach(function(n){this.renderQueue.push(n);ht(n)&&(this.parse(n),this.renderQueue.push(new ut))},this)};i.prototype.paint=function(n){try{n instanceof ut?this.renderer.ctx.restore():tt(n)?(a(n.parent)&&n.parent.appendToDOM(),this.paintText(n),a(n.parent)&&n.parent.cleanDOM()):this.paintNode(n)}catch(t){if(r(t),this.options.strict)throw t;}};i.prototype.paintNode=function(n){ht(n)&&(this.renderer.setOpacity(n.opacity),this.renderer.ctx.save(),n.hasTransform()&&this.renderer.setTransform(n.parseTransform()));n.node.nodeName==="INPUT"&&n.node.type==="checkbox"?this.paintCheckbox(n):n.node.nodeName==="INPUT"&&n.node.type==="radio"?this.paintRadio(n):this.paintElement(n)};i.prototype.paintElement=function(n){var t=n.parseBounds();this.renderer.clip(n.backgroundClip,function(){this.renderer.renderBackground(n,t,n.borders.borders.map(fi))},this);this.renderer.clip(n.clip,function(){this.renderer.renderBorders(n.borders.borders)},this);this.renderer.clip(n.backgroundClip,function(){var i,u;switch(n.node.nodeName){case"svg":case"IFRAME":i=this.images.get(n.node);i?this.renderer.renderImage(n,t,n.borders,i):r("Error loading <"+n.node.nodeName+">",n.node);break;case"IMG":u=this.images.get(n.node.src);u?this.renderer.renderImage(n,t,n.borders,u):r("Error loading <img>",n.node.src);break;case"CANVAS":this.renderer.renderImage(n,t,n.borders,{image:n.node});break;case"SELECT":case"INPUT":case"TEXTAREA":this.paintFormValue(n)}},this)};i.prototype.paintCheckbox=function(n){var r=n.parseBounds(),i=Math.min(r.width,r.height),t={width:i-1,height:i-1,top:r.top,left:r.left},f=[3,3],e=[f,f,f,f],o=[1,1,1,1].map(function(n){return{color:new u("#A5A5A5"),width:n}}),s=et(t,e,o);this.renderer.clip(n.backgroundClip,function(){this.renderer.rectangle(t.left+1,t.top+1,t.width-2,t.height-2,new u("#DEDEDE"));this.renderer.renderBorders(ft(o,t,s,e));n.node.checked&&(this.renderer.font(new u("#424242"),"normal","normal","bold",i-3+"px","arial"),this.renderer.text("✔",t.left+i/6,t.top+i-1))},this)};i.prototype.paintRadio=function(n){var t=n.parseBounds(),i=Math.min(t.width,t.height)-2;this.renderer.clip(n.backgroundClip,function(){this.renderer.circleStroke(t.left+1,t.top+1,i,new u("#DEDEDE"),1,new u("#A5A5A5"));n.node.checked&&this.renderer.circle(Math.ceil(t.left+i/4)+1,Math.ceil(t.top+i/4)+1,Math.floor(i/2),new u("#424242"))},this)};i.prototype.paintFormValue=function(n){var f=n.getValue(),u;if(f.length>0){var i=n.node.ownerDocument,t=i.createElement("html2canvaswrapper");["lineHeight","textAlign","fontFamily","fontWeight","fontSize","color","paddingLeft","paddingTop","paddingRight","paddingBottom","width","height","borderLeftStyle","borderTopStyle","borderLeftWidth","borderTopWidth","boxSizing","whiteSpace","wordWrap"].forEach(function(i){try{t.style[i]=n.css(i)}catch(u){r("html2canvas: Parse: Exception caught in renderFormValue: "+u.message)}});u=n.parseBounds();t.style.position="fixed";t.style.left=u.left+"px";t.style.top=u.top+"px";t.textContent=f;i.body.appendChild(t);this.paintText(new b(t.firstChild,n));i.body.removeChild(t)}};i.prototype.paintText=function(n){n.applyTextTransform();var i=v.ucs2.decode(n.node.data),r=(!this.options.letterRendering||kt(n))&&!ci(n.node.data)?si(i):i.map(function(n){return v.ucs2.encode([n])}),e=n.parent.fontWeight(),u=n.parent.css("fontSize"),f=n.parent.css("fontFamily"),t=n.parent.parseTextShadows();this.renderer.font(n.parent.color("color"),n.parent.css("fontStyle"),n.parent.css("fontVariant"),e,u,f);t.length?this.renderer.fontShadow(t[0].color,t[0].offsetX,t[0].offsetY,t[0].blur):this.renderer.clearShadow();this.renderer.clip(n.parent.clip,function(){r.map(this.parseTextBounds(n),this).forEach(function(t,i){t&&(this.renderer.text(r[i],t.left,t.bottom),this.renderTextDecoration(n.parent,t,this.fontMetrics.getMetrics(f,u)))},this)},this)};i.prototype.renderTextDecoration=function(n,t,i){switch(n.css("textDecoration").split(" ")[0]){case"underline":this.renderer.rectangle(t.left,Math.round(t.top+i.baseline+i.lineWidth),t.width,1,n.color("color"));break;case"overline":this.renderer.rectangle(t.left,Math.round(t.top),t.width,1,n.color("color"));break;case"line-through":this.renderer.rectangle(t.left,Math.ceil(t.top+i.middle+i.lineWidth),t.width,1,n.color("color"))}};g={inset:[["darken",.6],["darken",.1],["darken",.1],["darken",.6]]};i.prototype.parseBorders=function(n){var t=n.parseBounds(),i=dt(n),r=["Top","Right","Bottom","Left"].map(function(t,i){var e=n.css("border"+t+"Style"),r=n.color("border"+t+"Color"),f;return e==="inset"&&r.isBlack()&&(r=new u([255,255,255,r.a])),f=g[e]?g[e][i]:null,{width:n.cssInt("border"+t+"Width"),color:f?r[f[0]](f[1]):r,args:null}}),f=et(t,i,r);return{clip:this.parseBackgroundClip(n,f,r,i,t),borders:ft(r,t,f,i)}};i.prototype.parseBackgroundClip=function(n,t,i,r,u){var o=n.css("backgroundClip"),f=[];switch(o){case"content-box":case"padding-box":e(f,r[0],r[1],t.topLeftInner,t.topRightInner,u.left+i[3].width,u.top+i[0].width);e(f,r[1],r[2],t.topRightInner,t.bottomRightInner,u.left+u.width-i[1].width,u.top+i[0].width);e(f,r[2],r[3],t.bottomRightInner,t.bottomLeftInner,u.left+u.width-i[1].width,u.top+u.height-i[2].width);e(f,r[3],r[0],t.bottomLeftInner,t.topLeftInner,u.left+i[3].width,u.top+u.height-i[2].width);break;default:e(f,r[0],r[1],t.topLeftOuter,t.topRightOuter,u.left,u.top);e(f,r[1],r[2],t.topRightOuter,t.bottomRightOuter,u.left+u.width,u.top);e(f,r[2],r[3],t.bottomRightOuter,t.bottomLeftOuter,u.left+u.width,u.top+u.height);e(f,r[3],r[0],t.bottomLeftOuter,t.topLeftOuter,u.left,u.top+u.height)}return f};t.exports=i},{"./color":3,"./fontmetrics":7,"./log":13,"./nodecontainer":14,"./pseudoelementcontainer":18,"./stackingcontext":21,"./textcontainer":25,"./utils":26,punycode:1}],16:[function(n,t,i){function u(n,t,i){var h="withCredentials"in new XMLHttpRequest,r,u;return t?(r=e(h),u=o(t,n,r),h?s(u):f(i,u,r).then(function(n){return l(n.content)})):Promise.reject("No proxy configured")}function v(n,t,i){var r="crossOrigin"in new Image,u=e(r),s=o(t,n,u);return r?Promise.resolve(s):f(i,s,u).then(function(n){return"data:"+n.type+";base64,"+n.content})}function f(n,t,i){return new Promise(function(r,u){var f=n.createElement("script"),e=function(){delete window.html2canvas.proxy[i];n.body.removeChild(f)};window.html2canvas.proxy[i]=function(n){e();r(n)};f.src=t;f.onerror=function(n){e();u(n)};n.body.appendChild(f)})}function e(n){return n?"":"html2canvas_"+Date.now()+"_"+ ++a+"_"+Math.round(Math.random()*1e5)}function o(n,t,i){return n+"?url="+encodeURIComponent(t)+(i.length?"&callback=html2canvas.proxy."+i:"")}function y(n){return function(t){var e=new DOMParser,i,u,f;try{i=e.parseFromString(t,"text/html")}catch(o){r("DOMParser not supported, falling back to createHTMLDocument");i=document.implementation.createHTMLDocument("");try{i.open();i.write(t);i.close()}catch(s){r("createHTMLDocument write not supported, falling back to document.body.innerHTML");i.body.innerHTML=t}}return u=i.querySelector("base"),u&&u.href.host||(f=i.createElement("base"),f.href=n,i.head.insertBefore(f,i.head.firstChild)),i}}function p(n,t,i,r,f,e){return new u(n,t,window.document).then(y(n)).then(function(n){return c(n,i,r,f,e,0,0)})}var s=n("./xhr"),h=n("./utils"),r=n("./log"),c=n("./clone"),l=h.decode64,a=0;i.Proxy=u;i.ProxyURL=v;i.loadUrlDocument=p},{"./clone":2,"./log":13,"./utils":26,"./xhr":28}],17:[function(n,t){function r(n,t){var u=document.createElement("a"),r;u.href=n;n=u.href;this.src=n;this.image=new Image;r=this;this.promise=new Promise(function(u,f){r.image.crossOrigin="Anonymous";r.image.onload=u;r.image.onerror=f;new i(n,t,document).then(function(n){r.image.src=n})["catch"](f)})}var i=n("./proxy").ProxyURL;t.exports=r},{"./proxy":16}],18:[function(n,t){function i(n,t,i){r.call(this,n,t);this.isPseudoElement=!0;this.before=i===":before"}var r=n("./nodecontainer");i.prototype.cloneTo=function(n){i.prototype.cloneTo.call(this,n);n.isPseudoElement=!0;n.before=this.before};i.prototype=Object.create(r.prototype);i.prototype.appendToDOM=function(){this.before?this.parent.node.insertBefore(this.node,this.parent.node.firstChild):this.parent.node.appendChild(this.node);this.parent.node.className+=" "+this.getHideClass()};i.prototype.cleanDOM=function(){this.node.parentNode.removeChild(this.node);this.parent.node.className=this.parent.node.className.replace(this.getHideClass(),"")};i.prototype.getHideClass=function(){return this["PSEUDO_HIDE_ELEMENT_CLASS_"+(this.before?"BEFORE":"AFTER")]};i.prototype.PSEUDO_HIDE_ELEMENT_CLASS_BEFORE="___html2canvas___pseudoelement_before";i.prototype.PSEUDO_HIDE_ELEMENT_CLASS_AFTER="___html2canvas___pseudoelement_after";t.exports=i},{"./nodecontainer":14}],19:[function(n,t){function i(n,t,i,r,u){this.width=n;this.height=t;this.images=i;this.options=r;this.document=u}var r=n("./log");i.prototype.renderImage=function(n,t,i,r){var f=n.cssInt("paddingLeft"),e=n.cssInt("paddingTop"),h=n.cssInt("paddingRight"),c=n.cssInt("paddingBottom"),u=i.borders,o=t.width-(u[1].width+u[3].width+f+h),s=t.height-(u[0].width+u[2].width+e+c);this.drawImage(r,0,0,r.image.width||o,r.image.height||s,t.left+f+u[3].width,t.top+e+u[0].width,o,s)};i.prototype.renderBackground=function(n,t,i){t.height>0&&t.width>0&&(this.renderBackgroundColor(n,t),this.renderBackgroundImage(n,t,i))};i.prototype.renderBackgroundColor=function(n,t){var i=n.color("backgroundColor");i.isTransparent()||this.rectangle(t.left,t.top,t.width,t.height,i)};i.prototype.renderBorders=function(n){n.forEach(this.renderBorder,this)};i.prototype.renderBorder=function(n){n.color.isTransparent()||n.args===null||this.drawShape(n.args,n.color)};i.prototype.renderBackgroundImage=function(n,t,i){var u=n.parseBackgroundImages();u.reverse().forEach(function(u,f,e){var o,s;switch(u.method){case"url":o=this.images.get(u.args[0]);o?this.renderBackgroundRepeating(n,t,o,e.length-(f+1),i):r("Error loading background-image",u.args[0]);break;case"linear-gradient":case"gradient":s=this.images.get(u.value);s?this.renderBackgroundGradient(s,t,i):r("Error loading background-image",u.args[0]);break;case"none":break;default:r("Unknown background-image type",u.args[0])}},this)};i.prototype.renderBackgroundRepeating=function(n,t,i,r,u){var f=n.parseBackgroundSize(t,i.image,r),e=n.parseBackgroundPosition(t,i.image,r,f),o=n.parseBackgroundRepeat(r);switch(o){case"repeat-x":case"repeat no-repeat":this.backgroundRepeatShape(i,e,f,t,t.left+u[3],t.top+e.top+u[0],99999,f.height,u);break;case"repeat-y":case"no-repeat repeat":this.backgroundRepeatShape(i,e,f,t,t.left+e.left+u[3],t.top+u[0],f.width,99999,u);break;case"no-repeat":this.backgroundRepeatShape(i,e,f,t,t.left+e.left+u[3],t.top+e.top+u[0],f.width,f.height,u);break;default:this.renderBackgroundRepeat(i,e,f,{top:t.top,left:t.left},u[3],u[0])}};t.exports=i},{"./log":13}],20:[function(n,t){function i(n,t){r.apply(this,arguments);this.canvas=this.options.canvas||this.document.createElement("canvas");this.options.canvas||(this.canvas.width=n,this.canvas.height=t);this.ctx=this.canvas.getContext("2d");this.taintCtx=this.document.createElement("canvas").getContext("2d");this.ctx.textBaseline="bottom";this.variables={};f("Initialized CanvasRenderer with size",n,"x",t)}function e(n){return n.length>0}var r=n("../renderer"),u=n("../lineargradientcontainer"),f=n("../log");i.prototype=Object.create(r.prototype);i.prototype.setFillStyle=function(n){return this.ctx.fillStyle=typeof n=="object"&&!!n.isColor?n.toString():n,this.ctx};i.prototype.rectangle=function(n,t,i,r,u){this.setFillStyle(u).fillRect(n,t,i,r)};i.prototype.circle=function(n,t,i,r){this.setFillStyle(r);this.ctx.beginPath();this.ctx.arc(n+i/2,t+i/2,i/2,0,Math.PI*2,!0);this.ctx.closePath();this.ctx.fill()};i.prototype.circleStroke=function(n,t,i,r,u,f){this.circle(n,t,i,r);this.ctx.strokeStyle=f.toString();this.ctx.stroke()};i.prototype.drawShape=function(n,t){this.shape(n);this.setFillStyle(t).fill()};i.prototype.taints=function(n){if(n.tainted===null){this.taintCtx.drawImage(n.image,0,0);try{this.taintCtx.getImageData(0,0,1,1);n.tainted=!1}catch(t){this.taintCtx=document.createElement("canvas").getContext("2d");n.tainted=!0}}return n.tainted};i.prototype.drawImage=function(n,t,i,r,u,f,e,o,s){(!this.taints(n)||this.options.allowTaint)&&this.ctx.drawImage(n.image,t,i,r,u,f,e,o,s)};i.prototype.clip=function(n,t,i){this.ctx.save();n.filter(e).forEach(function(n){this.shape(n).clip()},this);t.call(i);this.ctx.restore()};i.prototype.shape=function(n){return this.ctx.beginPath(),n.forEach(function(n,t){n[0]==="rect"?this.ctx.rect.apply(this.ctx,n.slice(1)):this.ctx[t===0?"moveTo":n[0]+"To"].apply(this.ctx,n.slice(1))},this),this.ctx.closePath(),this.ctx};i.prototype.font=function(n,t,i,r,u,f){this.setFillStyle(n).font=[t,i,r,u,f].join(" ").split(",")[0]};i.prototype.fontShadow=function(n,t,i,r){this.setVariable("shadowColor",n.toString()).setVariable("shadowOffsetY",t).setVariable("shadowOffsetX",i).setVariable("shadowBlur",r)};i.prototype.clearShadow=function(){this.setVariable("shadowColor","rgba(0,0,0,0)")};i.prototype.setOpacity=function(n){this.ctx.globalAlpha=n};i.prototype.setTransform=function(n){this.ctx.translate(n.origin[0],n.origin[1]);this.ctx.transform.apply(this.ctx,n.matrix);this.ctx.translate(-n.origin[0],-n.origin[1])};i.prototype.setVariable=function(n,t){return this.variables[n]!==t&&(this.variables[n]=this.ctx[n]=t),this};i.prototype.text=function(n,t,i){this.ctx.fillText(n,t,i)};i.prototype.backgroundRepeatShape=function(n,t,i,r,u,f,e,o,s){var h=[["line",Math.round(u),Math.round(f)],["line",Math.round(u+e),Math.round(f)],["line",Math.round(u+e),Math.round(o+f)],["line",Math.round(u),Math.round(o+f)]];this.clip([h],function(){this.renderBackgroundRepeat(n,t,i,r,s[3],s[0])},this)};i.prototype.renderBackgroundRepeat=function(n,t,i,r,u,f){var e=Math.round(r.left+t.left+u),o=Math.round(r.top+t.top+f);this.setFillStyle(this.ctx.createPattern(this.resizeImage(n,i),"repeat"));this.ctx.translate(e,o);this.ctx.fill();this.ctx.translate(-e,-o)};i.prototype.renderBackgroundGradient=function(n,t){if(n instanceof u){var i=this.ctx.createLinearGradient(t.left+t.width*n.x0,t.top+t.height*n.y0,t.left+t.width*n.x1,t.top+t.height*n.y1);n.colorStops.forEach(function(n){i.addColorStop(n.stop,n.color.toString())});this.rectangle(t.left,t.top,t.width,t.height,i)}};i.prototype.resizeImage=function(n,t){var i=n.image,u,r;return i.width===t.width&&i.height===t.height?i:(r=document.createElement("canvas"),r.width=t.width,r.height=t.height,u=r.getContext("2d"),u.drawImage(i,0,0,i.width,i.height,0,0,t.width,t.height),r)};t.exports=i},{"../lineargradientcontainer":12,"../log":13,"../renderer":19}],21:[function(n,t){function i(n,t,i,u){r.call(this,i,u);this.ownStacking=n;this.contexts=[];this.children=[];this.opacity=(this.parent?this.parent.stack.opacity:1)*t}var r=n("./nodecontainer");i.prototype=Object.create(r.prototype);i.prototype.getParentStack=function(n){var t=this.parent?this.parent.stack:null;return t?t.ownStacking?t:t.getParentStack(n):n.stack};t.exports=i},{"./nodecontainer":14}],22:[function(n,t){function i(n){this.rangeBounds=this.testRangeBounds(n);this.cors=this.testCORS();this.svg=this.testSVG()}i.prototype.testRangeBounds=function(n){var i,t,r,u,f=!1;return n.createRange&&(i=n.createRange(),i.getBoundingClientRect&&(t=n.createElement("boundtest"),t.style.height="123px",t.style.display="block",n.body.appendChild(t),i.selectNode(t),r=i.getBoundingClientRect(),u=r.height,u===123&&(f=!0),n.body.removeChild(t))),f};i.prototype.testCORS=function(){return typeof(new Image).crossOrigin!="undefined"};i.prototype.testSVG=function(){var n=new Image,t=document.createElement("canvas"),i=t.getContext("2d");n.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><\/svg>";try{i.drawImage(n,0,0);t.toDataURL()}catch(r){return!1}return!0};t.exports=i},{}],23:[function(n,t){function i(n){this.src=n;this.image=null;var t=this;this.promise=this.hasFabric().then(function(){return t.isInline(n)?Promise.resolve(t.inlineFormatting(n)):r(n)}).then(function(n){return new Promise(function(i){window.html2canvas.svg.fabric.loadSVGFromString(n,t.createCanvas.call(t,i))})})}var r=n("./xhr"),u=n("./utils").decode64;i.prototype.hasFabric=function(){return!window.html2canvas.svg||!window.html2canvas.svg.fabric?Promise.reject(new Error("html2canvas.svg.js is not loaded, cannot render svg")):Promise.resolve()};i.prototype.inlineFormatting=function(n){return/^data:image\/svg\+xml;base64,/.test(n)?this.decode64(this.removeContentType(n)):this.removeContentType(n)};i.prototype.removeContentType=function(n){return n.replace(/^data:image\/svg\+xml(;base64)?,/,"")};i.prototype.isInline=function(n){return/^data:image\/svg\+xml/i.test(n)};i.prototype.createCanvas=function(n){var t=this;return function(i,r){var u=new window.html2canvas.svg.fabric.StaticCanvas("c");t.image=u.lowerCanvasEl;u.setWidth(r.width).setHeight(r.height).add(window.html2canvas.svg.fabric.util.groupSVGElements(i,r)).renderAll();n(u.lowerCanvasEl)}};i.prototype.decode64=function(n){return typeof atob=="function"?window.atob(n):u(n)};t.exports=i},{"./utils":26,"./xhr":28}],24:[function(n,t){function i(n,t){this.src=n;this.image=null;var i=this;this.promise=t?new Promise(function(t,r){i.image=new Image;i.image.onload=t;i.image.onerror=r;i.image.src="data:image/svg+xml,"+(new XMLSerializer).serializeToString(n);i.image.complete===!0&&t(i.image)}):this.hasFabric().then(function(){return new Promise(function(t){window.html2canvas.svg.fabric.parseSVGDocument(n,i.createCanvas.call(i,t))})})}var r=n("./svgcontainer");i.prototype=Object.create(r.prototype);t.exports=i},{"./svgcontainer":23}],25:[function(n,t){function i(n,t){r.call(this,n,t)}function u(n,t,i){if(n.length>0)return t+i.toUpperCase()}var r=n("./nodecontainer");i.prototype=Object.create(r.prototype);i.prototype.applyTextTransform=function(){this.node.data=this.transform(this.parent.css("textTransform"))};i.prototype.transform=function(n){var t=this.node.data;switch(n){case"lowercase":return t.toLowerCase();case"capitalize":return t.replace(/(^|\s|:|-|\(|\))([a-z])/g,u);case"uppercase":return t.toUpperCase();default:return t}};t.exports=i},{"./nodecontainer":14}],26:[function(n,t,i){i.smallImage=function(){return"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"};i.bind=function(n,t){return function(){return n.apply(t,arguments)}};i.decode64=function(n){for(var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l=n.length,s,e,r,u,f,o,h,c="",t=0;t<l;t+=4)s=i.indexOf(n[t]),e=i.indexOf(n[t+1]),r=i.indexOf(n[t+2]),u=i.indexOf(n[t+3]),f=s<<2|e>>4,o=(e&15)<<4|r>>2,h=(r&3)<<6|u,c+=r===64?String.fromCharCode(f):u===64||u===-1?String.fromCharCode(f,o):String.fromCharCode(f,o,h);return c};i.getBounds=function(n){if(n.getBoundingClientRect){var t=n.getBoundingClientRect(),i=n.offsetWidth==null?t.width:n.offsetWidth;return{top:t.top,bottom:t.bottom||t.top+t.height,right:t.left+i,left:t.left,width:i,height:n.offsetHeight==null?t.height:n.offsetHeight}}return{}};i.offsetBounds=function(n){var t=n.offsetParent?i.offsetBounds(n.offsetParent):{top:0,left:0};return{top:n.offsetTop+t.top,bottom:n.offsetTop+n.offsetHeight+t.top,right:n.offsetLeft+t.left+n.offsetWidth,left:n.offsetLeft+t.left,width:n.offsetWidth,height:n.offsetHeight}};i.parseBackgrounds=function(n){var a=" \r\n\t",t,i,o,h,u,l=[],r=0,s=0,f,e,c=function(){t&&(i.substr(0,1)==='"'&&(i=i.substr(1,i.length-2)),i&&e.push(i),t.substr(0,1)==="-"&&(h=t.indexOf("-",1)+1)>0&&(o=t.substr(0,h),t=t.substr(h)),l.push({prefix:o,method:t.toLowerCase(),value:u,args:e,image:null}));e=[];t=o=i=u=""};return e=[],t=o=i=u="",n.split("").forEach(function(n){if(r!==0||!(a.indexOf(n)>-1)){switch(n){case'"':f?f===n&&(f=null):f=n;break;case"(":if(f)break;else{if(r===0){r=1;u+=n;return}s++}break;case")":if(f)break;else if(r===1){if(s===0){r=0;u+=n;c();return}s--}break;case",":if(f)break;else{if(r===0){c();return}if(r===1&&s===0&&!t.match(/^url$/i)){e.push(i);i="";u+=n;return}}}u+=n;r===0?t+=n:i+=n}}),c(),l}},{}],27:[function(n,t){function r(n){i.apply(this,arguments);this.type=n.args[0]==="linear"?i.TYPES.LINEAR:i.TYPES.RADIAL}var i=n("./gradientcontainer");r.prototype=Object.create(i.prototype);t.exports=r},{"./gradientcontainer":9}],28:[function(n,t){function i(n){return new Promise(function(t,i){var r=new XMLHttpRequest;r.open("GET",n);r.onload=function(){r.status===200?t(r.responseText):i(new Error(r.statusText))};r.onerror=function(){i(new Error("Network Error"))};r.send()})}t.exports=i},{}]},{},[4])(4)});CLOUD=CLOUD||{};CLOUD.Extensions=CLOUD.Extensions||{};CLOUD.Extensions.Utils=CLOUD.Extensions.Utils||{};CLOUD.Extensions.Utils.Geometric={isInsideBounds:function(n,t,i){return n>=i.x&&n<=i.x+i.width&&t>=i.y&&t<=i.y+i.height},getAngleBetweenPoints:function(n,t){return Math.atan2(t.y-n.y,t.x-n.x)},isEqualBetweenPoints:function(n,t,i){i=i||.0001;var r=n.x-t.x,u=n.y-t.y,f=Math.sqrt(r*r+u*u);return f>i?!1:!0}};CLOUD=CLOUD||{};CLOUD.Extensions=CLOUD.Extensions||{};CLOUD.Extensions.Utils=CLOUD.Extensions.Utils||{};CLOUD.Extensions.Utils.Shape2D={createSvgElement:function(n){var t=document.createElementNS("http://www.w3.org/2000/svg",n);return t.setAttribute("pointer-events","inherit"),t},getRGBAString:function(n,t){if(t<=0)return"none";return["rgba("+parseInt("0x"+n.substr(1,2)),",",parseInt("0x"+n.substr(3,2)),",",parseInt("0x"+n.substr(5,2)),",",t,")"].join("")},makeFlag:function(){var n=this.createSvgElement("path");return n.setAttribute("d","M0 0 L0 -20 L15 -13 L4 -6.87 L4 0Z"),n},makeBubble:function(){var n=this.createSvgElement("path");return n.setAttribute("d","m0.0035,-19.88544c-3.838253,0 -6.95,2.581968 -6.95,5.766754c0,3.185555 6.95,13.933247 6.95,13.933247s6.95,-10.747692 6.95,-13.933247c0,-3.184786 -3.11082,-5.766754 -6.95,-5.766754z"),n},makeCommon:function(n){var t=this.createSvgElement("image");return t.href.baseVal=n,t.setAttribute("height","50px"),t.setAttribute("width","50px"),t}};CLOUD.MiniMap=function(n){function hr(n,t,i,r){return(t.x-n.x)*(r.y-i.y)-(t.y-n.y)*(r.x-i.x)}function cr(n,t,i){return hr(n,t,n,i)}function bi(n,t,i){return Math.abs(cr(n,t,i))}function ki(n,t,i,r){var u=bi(n,t,i),f=bi(n,t,r);return new THREE.Vector2((r.x*u+i.x*f)/(u+f),(r.y*u+i.y*f)/(u+f))}function lr(n,t,i){var r=new THREE.Vector3,u;return(r.crossVectors(n,t),u=r.dot(i),u>=0)?!1:!0}function v(n){n.x=n.x*d;n.y=-n.y*g}function ct(n){n.x=n.x/d;n.y=-n.y/g}function it(n){var t=f.size();n.x=.5*(n.x+1)*t.x+f.min.x;n.y=.5*(n.y+1)*t.y+f.min.y}function lt(n){var t=f.size();n.x=(n.x-f.min.x)/t.x*2-1;n.y=(n.y-f.min.y)/t.y*2-1}function ar(n){var t=document.createElement("style"),i;t.type="text/css";try{t.appendChild(document.createTextNode(n))}catch(r){t.styleSheet.cssText=n}i=document.getElementsByTagName("head")[0];i.appendChild(t)}function di(n){return vt[n]==null?(vt[n]=document.createElementNS(h,"image"),vt[n]):vt[n]}function vr(n){return et[n]==null?(et[n]=document.createElementNS(h,"line"),yt==0&&et[n].setAttribute("shape-rendering","crispEdges"),et[n]):et[n]}function yr(n){return st[n]==null?(st[n]=document.createElementNS(h,"circle"),yt==0&&st[n].setAttribute("shape-rendering","crispEdges"),st[n]):st[n]}function pr(n){return ot[n]==null?(ot[n]=document.createElementNS(h,"text"),yt==0&&ot[n].setAttribute("shape-rendering","crispEdges"),ot[n]):ot[n]}function wr(n,i,r){t=vr(oi++);t.setAttribute("x1",n.x);t.setAttribute("y1",n.y);t.setAttribute("x2",i.x);t.setAttribute("y2",i.y);r instanceof THREE.LineBasicMaterial&&(t.setAttribute("style","fill: none; stroke: "+r.color.getStyle()+"; stroke-width: "+r.linewidth+"; stroke-opacity: "+r.opacity+"; stroke-linecap: "+r.linecap+"; stroke-linejoin: "+r.linejoin),y.appendChild(t))}function gi(n,i,r){t=yr(ci++);t.setAttribute("r",pt+"");t.setAttribute("transform","translate("+n+","+i+")");r instanceof THREE.LineBasicMaterial&&(t.setAttribute("style","fill: none; stroke: "+r.color.getStyle()+"; stroke-width: 1"),y.appendChild(t))}function nr(n,i,r,u){t=pr(si++);u instanceof THREE.LineBasicMaterial&&(t.setAttribute("style","font-size:"+fr+"px; fill: none; stroke: "+u.color.getStyle()+"; stroke-width: 1"),y.appendChild(t));t.innerHTML=r;var f=t.getBoundingClientRect(),e=n-.5*f.width,o=i+.25*f.height;t.setAttribute("transform","translate("+e+","+o+")")}function br(){w&&(t=di(0),r.appendChild(t))}function kr(){r.appendChild(c);r.appendChild(l);r.appendChild(a)}function dr(){var e,l,c,n,a,h,u,f;for(r.appendChild(y),e=0,l=rt.length;e<l;e++)for(c=rt[e],n=0,a=c.length;n<a;n++){var t=c[n],o=t.v1.clone(),s=t.v2.clone(),i=t.material;gt.makeEmpty();gt.setFromPoints([o,s]);dt.isIntersectionBox(gt)===!0&&(wr(o,s,i),n%er==0&&(h=new THREE.Vector2,h.subVectors(s,o).normalize().multiplyScalar(pt),u=o.clone().sub(h),f=s.clone().add(h),gi(u.x,u.y,i),gi(f.x,f.y,i),nr(u.x,u.y,t.name,i),nr(f.x,f.y,t.name,i)))}}function gr(n,t){var i;t=t||{position:"absolute",display:"block",left:"20px",bottom:"20px",outline:"#0000FF dotted thin"};for(i in t)n.style[i]=t[i]}function fi(n){var t=tr.getMainSceneMatrix();n.applyMatrix4(t)}function nu(n,t){for(var e=new THREE.Box2,l=[],ut=new THREE.Box2(new THREE.Vector2(t[0],t[1]),new THREE.Vector2(t[2],t[3])),a=[],v=[],i=0,o=0,w=n.length,b,k,y,p,d,g,nt,tt,it,i=0;i<w;i++){var r=n[i],s=r.start||r.Start,h=r.end||r.End,u=new THREE.Vector2(s.X,s.Y),f=new THREE.Vector2(h.X,h.Y),c=f.clone().sub(u).normalize();Math.abs(c.x)>=Math.abs(c.y)?a.push({v1:u,v2:f}):v.push({v1:u,v2:f})}for(b=a.length,k=v.length,i=0;i<b;i++)for(y=a[i],d=y.v1.clone(),g=y.v2.clone(),o=0;o<k;o++)p=v[o],nt=p.v1.clone(),tt=p.v2.clone(),it=ki(d,g,nt,tt),e.expandByPoint(it);for(e.union(ut),e.expandByScalar(sr),i=0;i<w;i++){var r=n[i],rt=r.name||r.Name,s=r.start||r.Start,h=r.end||r.End,u=new THREE.Vector2(s.X,s.Y),f=new THREE.Vector2(h.X,h.Y),c=f.clone().sub(u).normalize();Math.abs(c.x)>=Math.abs(c.y)?(u.x=e.max.x,f.x=e.min.x,l.push({name:rt,start:{X:u.x,Y:u.y},end:{X:f.x,Y:f.y}})):(u.y=e.min.y,f.y=e.max.y,l.push({name:rt,start:{X:u.x,Y:u.y},end:{X:f.x,Y:f.y}}))}return l}function tu(n){var i,s;for(f.makeEmpty(),i=0,s=n.length;i<s;i++){var r=n[i],h=r.start||r.Start,c=r.end||r.End,y=new THREE.Vector2(h.X,h.Y),w=new THREE.Vector2(c.X,c.Y);f.expandByPoint(y);f.expandByPoint(w)}var b=f.center(),t=f.size(),l=new THREE.Vector2,a=4,u=p/k,v=t.x/t.y,e=t.x,o=t.y;v>u?(nt&&(e=t.x*p/(p-4*(pt+a))),o=e/u):v<u&&(nt&&(o=t.y*k/(k-4*(pt+a))),e=o*u);l.set(e,o);f.setFromCenterAndSize(b,l)}function iu(n,t){var a,nt,tt,c,l,it,ut,y,p,w,b,ft;rt.length>0&&(rt=[]);o.length>0&&(o=[]);for(var e=[],s=[],i=0,h=0,et=n.length,i=0;i<et;i++){var r=n[i],k=r.name||r.Name,d=r.start||r.Start,g=r.end||r.End,u=new THREE.Vector2(d.X,d.Y),f=new THREE.Vector2(g.X,g.Y);lt(u);v(u);lt(f);v(f);a=f.clone().sub(u).normalize();Math.abs(a.x)>=Math.abs(a.y)?e.push({name:k,v1:u,v2:f,material:t}):s.push({name:k,v1:u,v2:f,material:t})}for(rt.push(e),rt.push(s),nt=e.length,tt=s.length,i=0;i<nt;i++)for(c=e[i],ut=c.name,y=c.v1.clone(),p=c.v2.clone(),h=0;h<tt;h++)l=s[h],it=l.name,w=l.v1.clone(),b=l.v2.clone(),ft=ki(y,p,w,b),o.push({intersectionPoint:ft,horizLine:[y.clone(),p.clone()],verticalLine:[w.clone(),b.clone()],abcName:ut,numeralName:it})}this.viewer=n;this.visible=!0;this.width=0;this.height=0;this.domContainer=null;this.autoClear=!0;this.mouseButtons={LEFT:THREE.MOUSE.LEFT,RIGHT:THREE.MOUSE.RIGHT};this.callbackCameraChanged=null;this.callbackClickOnAxisGrid=null;this.initialized=!1;this.axisGirds=null;var tr=this,i,b=new THREE.Vector2,at=new THREE.Color,ei=1,ir=3355443,rr=new THREE.LineBasicMaterial({color:10066329,linewidth:.5}),h="http://www.w3.org/2000/svg",r,y,ft=[],et=[],ot=[],vt=[],st=[],ur=0,oi=0,si=0,hi=0,ci=0,yt=1,t,p,k,d,g,dt=new THREE.Box2,gt=new THREE.Box2,f=new THREE.Box2,rt=[],o=[],pt=10,fr=8,er=3,nt=!1,ut=!1,w=!1,wt=!0,u,a,c,l,s,bt,ni,ti="#258ae3",or="#000",li="#fff",ai=1,ht=3,kt=!1,vi=0,tt=0,e,yi,pi=!0,ii,ri=1e-5,wi=!1,ui=!1,sr=100;this.enableMouseEvent=function(n){wt=n};this.isEnableMouseEvent=function(){return wt};this.isMouseOverCanvas=function(n){var u=i,r,t;if(wi=!1,u){if(r=CLOUD.DomUtil.getContainerOffsetToClient(u),t=new THREE.Vector2,t.x=n.x-r.left,t.y=n.y-r.top,r.width===0||r.height===0)return!1;if(t.x>0&&t.x<this.width&&t.y>0&&t.y<this.height)return b.x=t.x/this.width*2-1,b.y=-t.y/this.height*2+1,wi=!0,!0}return!1};this.isMouseMoving=function(){return this.viewer.editorManager.isMouseMoving()};this.onMouseDown=function(){this.isMouseMoving()||(this.isMouseDown=!0)};this.onMouseMove=function(n){if(!this.isMouseMoving()&&wt){var t=new THREE.Vector2(n.clientX,n.clientY),i=this.isMouseOverCanvas(t);this.highlightedNode(i,nt,!1)}};this.onMouseUp=function(n){var t,i,u,f,e,s,r;if(this.isMouseDown){this.isMouseDown=!1;var h=new THREE.Vector2(n.clientX,n.clientY),o=this.isMouseOverCanvas(h),c=ut||w;if(!wt){this.highlightedNode(o,nt,!0);return}o&&c&&(t=new THREE.Vector3,i=b.clone(),it(i),u=b.clone(),v(u),f=this.getIntersectionToMinDistance(u),f?(e=new THREE.Vector2(f.intersectionPoint.x,f.intersectionPoint.y),s=u.sub(e),s.lengthSq()<ht*ht?(r=e.clone(),ct(r),it(r),t.set(r.x,r.y,tt)):t.set(i.x,i.y,tt)):t.set(i.x,i.y,tt),fi(t),this.flyToPointWithParallelEye(t))}};this.onContextMenu=function(n){n.preventDefault()};this.onMouseDownBinded=this.onMouseDown.bind(this);this.onMouseMoveBinded=this.onMouseMove.bind(this);this.onMouseUpBinded=this.onMouseUp.bind(this);this.onContextMenuBinded=this.onContextMenu.bind(this);this.addDomEventListeners=function(){i&&(i.addEventListener("contextmenu",this.onContextMenuBinded,!1),i.addEventListener("mousedown",this.onMouseDownBinded,!1),i.addEventListener("mousemove",this.onMouseMoveBinded,!1),i.addEventListener("mouseup",this.onMouseUpBinded,!1))};this.removeDomEventListeners=function(){i&&(i.removeEventListener("contextmenu",this.onContextMenuBinded,!1),i.removeEventListener("mousedown",this.onMouseDownBinded,!1),i.removeEventListener("mousemove",this.onMouseMoveBinded,!1),i.removeEventListener("mouseup",this.onMouseUpBinded,!1))};this.init=function(n,t,i,u,f){if(t=t||320,i=i||240,f=f||0,r||(r=document.createElementNS(h,"svg"),y=document.createElementNS(h,"g")),this.initCanvasContainer(n,u),this.initTipNode(),this.initCameraNode(),this.setSize(t,i),this.setClearColor(ir,f),this.clear(),this.addDomEventListeners(),kt=!1,this.callbackClickOnAxisGrid)this.callbackClickOnAxisGrid({position:"",abcName:"",numeralName:"",offsetX:"",offsetY:""});this.initialized=!0};this.uninit=function(){this.initialized&&(this.initialized=!1,this.removeDomEventListeners(),this.clear(),r.parentNode&&r.parentNode.removeChild(r),this.remove(),i=null,r=null,y=null,this.domContainer=null,this.callbackCameraChanged=null,this.callbackClickOnAxisGrid=null,this.axisGirds=null)};this.setSize=function(n,t){i&&(this.width=n,this.height=t,i.style.width=n+"px",i.style.height=t+"px",p=n,k=t,d=p/2,g=k/2,r.setAttribute("viewBox",-d+" "+-g+" "+p+" "+k),r.setAttribute("width",p),r.setAttribute("height",k),dt.min.set(-d,-g),dt.max.set(d,g))};this.setClearColor=function(n,t){at.set(n);ei=t!==undefined?t:1};this.clear=function(){for(ur=0,oi=0,si=0,hi=0,ci=0;r.childNodes.length>0;){while(r.childNodes[0]>0)r.childNodes[0].removeChild(r.childNodes[0].childNodes[0]);r.removeChild(r.childNodes[0])}r.style.backgroundColor="rgba("+(at.r*255|0)+","+(at.g*255|0)+","+(at.b*255|0)+","+ei+")"};this.render=function(){ut&&(this.autoClear&&this.clear(),this.visible)&&(br(),nt&&(dr(),kr()),this.calculateCameraPosition(),pi&&r.appendChild(s))};this.initCanvasContainer=function(n,t){this.domContainer=n;i||(i=document.createElement("div"),gr(i,t),n.appendChild(i),i.appendChild(r))};this.initCameraNode=function(){var n,t;s||(s=document.createElementNS(h,"g"),s.setAttribute("fill","#1b8cef"),s.setAttribute("stroke","#cbd7e1"),s.setAttribute("stroke-width","1"),s.setAttribute("stroke-linejoin","round"),n=document.createElementNS(h,"circle"),n.setAttribute("r","6"),ni=n,t=document.createElementNS(h,"path"),t.setAttribute("d","M 7 6 Q 10 0, 7 -6 L 19 0 Z"),bt=t,s.appendChild(n),s.appendChild(t));s.setAttribute("opacity","0.0")};this.initTipNode=function(){if(!u){var n=".cloud-tip:after { box-sizing: border-box;display: inline;font-size: 10px;width: 100%;line-height: 1;color: "+li+";content: '\\25BC';position: absolute;text-align: center;margin: -4px 0 0 0;top: 100%;left: 0;}";ar(n);u=document.createElement("div");u.className="";u.style.position="absolute";u.style.display="block";u.style.background=li;u.style.color=or;u.style.padding="0 8px 0 8px";u.style.borderRadius="2px";u.style.fontSize="8px";i.appendChild(u)}u.style.opacity=0;a||(a=document.createElementNS(h,"circle"),a.setAttribute("r",ht+""),a.setAttribute("fill",ti));a.style.opacity=0;c||(c=document.createElementNS(h,"line"),c.setAttribute("style","stroke:"+ti+";stroke-width:"+ai+""));c.style.opacity=0;l||(l=document.createElementNS(h,"line"),l.setAttribute("style","stroke:"+ti+";stroke-width:"+ai+""));l.style.opacity=0};this.generateAxisGrid=function(n){var t,u,i,r;if(n==undefined&&(n=!0),t=CLOUD.MiniMap.axisGridData,t){if(u=t.Grids.length,u<1){console.error("axis grid data error!!!");return}ut=!0;r=t.mapMaxBox;i=n&&r?nu(t.Grids,r):t.Grids;this.axisGirds=i;this.initAxisGird(i);w?(console.log("re-initialize floor plane!!!"),this.initFloorPlane(),ui?this.fly():this.render()):this.render()}};this.initAxisGird=function(n){tu(n);iu(n,rr)};this.generateFloorPlane=function(n){var t;if(n===undefined&&(n=!1),ui=n,t=CLOUD.MiniMap.floorPlaneData,t){var r=t.Path||t.path,i=t.BoundingBox||t.boundingBox,u=t.Elevation||t.elevation;if(!r||!i){console.warn("floor-plan data is error!");return}if(yi=r,e=new THREE.Box3(new THREE.Vector3(i.Min.X,i.Min.Y,i.Min.Z),new THREE.Vector3(i.Max.X,i.Max.Y,i.Max.Z)),tt=.5*(e.min.z+e.max.z),vi=u||e.min.z,w=!0,!ut){console.warn("axis-grid is not initialized!");return}this.initFloorPlane();ui?this.fly():this.render()}};this.initFloorPlane=function(){var h=yi,r=new THREE.Box2(new THREE.Vector2(e.min.x,e.min.y),new THREE.Vector2(e.max.x,e.max.y)),c=f.size(),l=f.center(),u=r.size(),a=r.center(),n=p/c.x,o=u.x*n,s=u.y*n,i=a.clone().sub(l);i.x*=n;i.y*=-n;f.containsBox(r)||console.warn("the bounding-box of axis-grid is not contains the bounding-box of floor-plane!");t=di(0);t.href.baseVal=h;t.setAttribute("id","Floor-"+hi);t.setAttribute("preserveAspectRatio","none");t.setAttribute("width",o+"");t.setAttribute("height",s+"");t.setAttribute("x",-.5*o+"");t.setAttribute("y",-.5*s+"");t.setAttribute("transform","translate("+i.x+","+i.y+")")};this.resizeClientAxisGrid=function(){var n=this.axisGirds||CLOUD.MiniMap.axisGridData.Grids;this.initAxisGird(n);w&&this.initFloorPlane()};this.showAxisGird=function(){ut&&(nt=!0,this.resizeClientAxisGrid(),y.style.display="",kt&&this.showTip(),this.render())};this.hideAxisGird=function(){ut&&(nt=!1,this.resizeClientAxisGrid(),y.style.display="none",this.hideTip(),this.render())};this.showTip=function(){u&&(u.className="cloud-tip",u.style.opacity=1);a&&(a.style.opacity=1);c&&(c.style.opacity=1);l&&(l.style.opacity=1)};this.hideTip=function(){u&&(u.className="",u.style.opacity=0);a&&(a.style.opacity=0);c&&(c.style.opacity=0);l&&(l.style.opacity=0)};this.highlightNodeByAxisGridNumber=function(n,t){var i=this.getIntersectionByAxisGridNumber(n,t);i?(this.setHighlightNode(i),this.showTip()):this.hideTip();this.render()};this.highlightedNode=function(n,t,i){var r,u,f;kt=!1;n&&t?(i?(u=b.clone(),v(u),r=this.getIntersectionToMinDistance(u)):r=this.getIntersectionByNormalizedPoint(b),r?(kt=!0,this.setHighlightNode(r),this.showTip()):this.hideTip(),this.render(),this.callbackClickOnAxisGrid&&(f=this.getAxisGridInfoByNormalizedPoint(b),this.callbackClickOnAxisGrid(f))):(this.hideTip(),this.render())};this.setHighlightNode=function(n){a.setAttribute("transform","translate("+n.intersectionPoint.x+","+n.intersectionPoint.y+")");u.innerHTML=n.numeralName+"-"+n.abcName;var t=u.getBoundingClientRect();u.style.left=d+n.intersectionPoint.x-.5*t.width+"px";u.style.top=g+n.intersectionPoint.y-t.height-12+"px";c.setAttribute("x1",n.horizLine[0].x);c.setAttribute("y1",n.horizLine[0].y);c.setAttribute("x2",n.horizLine[1].x);c.setAttribute("y2",n.horizLine[1].y);l.setAttribute("x1",n.verticalLine[0].x);l.setAttribute("y1",n.verticalLine[0].y);l.setAttribute("x2",n.verticalLine[1].x);l.setAttribute("y2",n.verticalLine[1].y)};this.getMainSceneMatrix=function(){return this.viewer.getScene().getMatrixGlobal()};this.containsPointInMainScene=function(n){var t=this.viewer.getScene().getBoundingBoxWorld();return t?t.containsPoint(n):!1};this.getAxisGridInfoByPoint=function(n){var e,f,t,u,i,r,o,s;return w&&(e=this.getMainSceneMatrix(),f=new THREE.Matrix4,f.getInverse(e),t=n.clone(),t.applyMatrix4(f),u=t.clone(),lt(u),v(u),i=this.getIntersectionToMinDistance(u),i)?(r=new THREE.Vector2(i.intersectionPoint.x,i.intersectionPoint.y),ct(r),it(r),o=Math.round(t.x-r.x),s=Math.round(t.y-r.y),{position:t,abcName:i.abcName,numeralName:i.numeralName,offsetX:o,offsetY:s}):{position:new THREE.Vector3,abcName:"",numeralName:"",offsetX:"",offsetY:""}};this.getAxisGridInfoByNormalizedPoint=function(n){var i,u,t,r,f,e;return w&&(i=n.clone(),it(i),u=n.clone(),v(u),t=this.getIntersectionToMinDistance(u),t)?(r=new THREE.Vector2(t.intersectionPoint.x,t.intersectionPoint.y),ct(r),it(r),f=Math.round(i.x-r.x),e=Math.round(i.y-r.y),{position:i,abcName:t.abcName,numeralName:t.numeralName,offsetX:f,offsetY:e}):{position:new THREE.Vector3,abcName:"",numeralName:"",offsetX:"",offsetY:""}};this.getIntersectionByNormalizedPoint=function(n){for(var u,i,f,r=null,e=ht*ht,t=0,s=o.length;t<s;t++)if(u=o[t].intersectionPoint,i=new THREE.Vector2(n.x,n.y),v(i),f=u.distanceToSquared(i),f<e){r=o[t];break}return r};this.getIntersectionByAxisGridNumber=function(n,t){for(var u,f,r=null,i=0,e=o.length;i<e;i++)if(u=o[i].abcName.toLowerCase(),f=o[i].numeralName,u===n.toLowerCase()&&f===t){r=o[i];break}return r};this.getIntersectionToMinDistance=function(n){var i,r,t,f;if(o.length<1)return null;for(i=0,r=0,t=0,f=o.length;t<f;t++){var e=o[t],s=new THREE.Vector2(e.intersectionPoint.x,e.intersectionPoint.y),u=s.distanceToSquared(n);t==0?i=u:i>u&&(i=u,r=t)}return o[r]};this.calculateCameraPosition=function(){var o,k,i,p,t,r,n,l,u,nt;if(w&&(o=this.viewer.camera,k=this.viewer.cameraEditor,o&&k)){var d=o.position,it=o.target,h=this.getMainSceneMatrix(),c=new THREE.Matrix4;c.getInverse(h);var a=e.center(),rt=new THREE.Vector3(e.min.x,e.min.y,a.z).applyMatrix4(h),ut=new THREE.Vector3(e.min.x,e.max.y,a.z).applyMatrix4(h),ft=new THREE.Vector3(e.max.x,e.min.y,a.z).applyMatrix4(h),y=new THREE.Plane;if(y.setFromCoplanarPoints(rt,ut,ft),i=y.projectPoint(d),i.applyMatrix4(c),p=y.projectPoint(it),p.applyMatrix4(c),t=p.clone().sub(i),t.z=0,t.normalize(),r=d.clone(),r.applyMatrix4(c),n=r.clone(),lt(n),v(n),s.setAttribute("opacity","1.0"),t.length()<ri)bt.setAttribute("opacity","0.0"),s.setAttribute("transform","translate("+n.x+","+n.y+")");else{var et=new THREE.Vector3(0,0,1),g=new THREE.Vector3(1,0,0),ot=lr(g,t,et),b=THREE.Math.radToDeg(g.angleTo(t));ot||(b*=-1);l=this.calculateEdgePositionCameraOutBounds(f,i,t);l?(u=new THREE.Vector2(l.x,l.y),lt(u),v(u),bt.setAttribute("opacity","1.0"),ni.setAttribute("opacity","0.0"),s.setAttribute("transform","translate("+u.x+","+u.y+") rotate("+b+")")):(bt.setAttribute("opacity","1.0"),ni.setAttribute("opacity","1.0"),s.setAttribute("transform","translate("+n.x+","+n.y+") rotate("+b+")"))}return this.setCallbackCameraInfo(r,n),ii=r.clone(),nt=new THREE.Vector3(i.x,i.y,tt),{worldPosition:r,projectedWorldPosition:nt,screenPosition:n}}};this.calculateEdgePositionCameraOutBounds=function(n,t,i){var c=function(n,t){for(var r=!1,i=0,u=n.length;i<u;i++)if(CLOUD.Extensions.Utils.Geometric.isEqualBetweenPoints(t,n[i],ri)){r=!0;break}return r},f=n.clone(),r;if(f.min.x-=.5,f.min.y-=.5,f.max.x+=.5,f.max.y+=.5,!f.containsPoint(t)){var u=[],l=new THREE.Vector3(t.x,t.y,0),h=new THREE.Ray(l,i),o=new THREE.Vector3(n.min.x,n.min.y,0),s=new THREE.Vector3(-1,0,0),e=new THREE.Plane;if(e.setFromNormalAndCoplanarPoint(s,o),r=h.intersectPlane(e),r&&f.containsPoint(r)&&u.push(r),o.set(n.max.x,n.max.y,0),s.set(-1,0,0),e.setFromNormalAndCoplanarPoint(s,o),r=h.intersectPlane(e),r&&f.containsPoint(r)&&u.push(r),o.set(n.min.x,n.min.y,0),s.set(0,1,0),e.setFromNormalAndCoplanarPoint(s,o),r=h.intersectPlane(e),r&&f.containsPoint(r)&&(c(r,u)||u.push(r)),o.set(n.max.x,n.max.y,0),s.set(0,1,0),e.setFromNormalAndCoplanarPoint(s,o),r=h.intersectPlane(e),r&&f.containsPoint(r)&&(c(r,u)||u.push(r)),u.length!=2)return null;var a=u[0],v=u[1],y=v.clone().sub(a).normalize();return CLOUD.Extensions.Utils.Geometric.isEqualBetweenPoints(y,i,ri)?u[0]:u[1]}return null};this.fly=function(){var t=this.calculateCameraPosition(),n=t.projectedWorldPosition.clone();fi(n);this.flyToPointWithParallelEye(n)};this.flyToPointWithParallelEye=function(n){this.viewer.cameraEditor.flyToPointWithParallelEye(n)};this.flyByAxisGridNumber=function(n,t){var r=this.getIntersectionByAxisGridNumber(n,t),i;r&&(i=new THREE.Vector3(r.intersectionPoint.x,r.intersectionPoint.y,tt),ct(i),it(i),fi(i),this.viewer.cameraEditor.flyToPointWithParallelEye(i))};this.setCallbackCameraInfo=function(n,t){var e=!0,f,i,r,u;if(ii&&(e=n.distanceToSquared(ii)!==0),this.callbackCameraChanged&&e)if(f=n.clone(),i=this.getIntersectionToMinDistance(t),i){r=new THREE.Vector2(i.intersectionPoint.x,i.intersectionPoint.y);ct(r);it(r);var o=Math.round(n.x-r.x),s=Math.round(n.y-r.y),v=Math.round(n.z-vi),h="X("+i.numeralName+","+o+")",c="Y("+i.abcName+","+s+")",l=!0,a=n.clone();a.setZ(tt);this.containsPointInMainScene(a)||(l=!1,h="",c="");u={position:f,isInScene:l,axis:{abcName:i.abcName,numeralName:i.numeralName,offsetX:o,offsetY:s,offsetZ:v,infoX:h,infoY:c}};this.callbackCameraChanged(u)}else u={position:f,isInScene:!1,axis:{abcName:"",numeralName:"",offsetX:"",offsetY:"",offsetZ:"",infoX:"",infoY:""}},this.callbackCameraChanged(u)};this.enableCameraNode=function(n){pi=n};this.remove=function(){i&&i.parentNode&&i.parentNode.removeChild(i)};this.append=function(){i&&!i.parentNode&&(this.domContainer.appendChild(i),this.render())};this.setCameraChangedCallback=function(n){this.callbackCameraChanged=n};this.setClickOnAxisGridCallback=function(n){this.callbackClickOnAxisGrid=n}};CLOUD.MiniMap.axisGridData=null;CLOUD.MiniMap.floorPlaneData=null;CLOUD.MiniMap.setAxisGridData=function(n){CLOUD.MiniMap.axisGridData=n};CLOUD.MiniMap.setFloorPlaneData=function(n){CLOUD.MiniMap.floorPlaneData=n};CLOUD.Extensions.Marker=function(n,t){this.id=n;this.editor=t;this.position=new THREE.Vector3;this.boundingBox=new THREE.Box3;this.shape=null;this.style=CLOUD.Extensions.Marker.getDefaultStyle();this.selected=!1;this.highlighted=!1;this.highlightColor="#000088";this.isDisableInteractions=!1;this.keys={BACKSPACE:8,ALT:18,ESC:27,LEFT:37,UP:38,RIGHT:39,BOTTOM:40,DELETE:46,ZERO:48,A:65,D:68,E:69,Q:81,S:83,W:87,PLUS:187,SUB:189};this.onMouseDownBinded=this.onMouseDown.bind(this);this.onKeyUpBinded=this.onKeyUp.bind(this)};CLOUD.Extensions.Marker.prototype={constructor:CLOUD.Extensions.Marker,addDomEventListeners:function(){this.shape.addEventListener("mousedown",this.onMouseDownBinded,!0);window.addEventListener("keyup",this.onKeyUpBinded)},removeDomEventListeners:function(){this.shape.removeEventListener("mousedown",this.onMouseDownBinded,!0);window.removeEventListener("keyup",this.onKeyUpBinded)},onMouseDown:function(n){n.preventDefault();n.stopPropagation();this.select()},onKeyUp:function(n){switch(n.keyCode){case this.keys.DELETE:this.editor.deselectMarker();this.delete()}},createShape:function(){},destroy:function(){this.removeDomEventListeners();this.deselect();this.setParent(null)},set:function(n,t,i,r){this.userId=n;this.position.set(t.x,t.y,t.z);this.boundingBox=i.clone();r&&(this.style=CLOUD.DomUtil.cloneStyle(r));this.update()},setParent:function(n){var t=this.shape;t&&(t.parentNode&&t.parentNode.removeChild(t),n&&n.appendChild(t))},setStyle:function(n){this.style=CLOUD.DomUtil.cloneStyle(n);this.update()},select:function(){this.selected||(this.selected=!0,this.highlight(!0));this.editor.selectMarker(this)},deselect:function(){this.highlight(!1);this.selected=!1},highlight:function(n){this.isDisableInteractions||(this.highlighted=n,this.update())},disableInteractions:function(n){this.isDisableInteractions=n},"delete":function(){this.editor.deleteMarker(this)},getClientPosition:function(){return this.editor.worldToClient(this.position)},getBoundingBox:function(){return this.boundingBox},toNewObject:function(){return{id:this.id,userId:this.userId,shapeType:this.shapeType,position:this.position?this.position.clone():null,boundingBox:this.boundingBox?this.boundingBox.clone():null}},update:function(){var t=this.style["stroke-width"],i=this.highlighted?this.highlightColor:this.style["stroke-color"],r=this.style["stroke-opacity"],u=this.style["fill-color"],f=this.style["fill-opacity"],n=this.getClientPosition();if(!n){this.shape.style.display="none";return}this.shape.style.display!==""&&(this.shape.style.display="");var e=n.x,o=n.y,s=["translate(",e,",",o,") "].join("");this.shape.setAttribute("transform",s);this.shape.setAttribute("stroke-width",t);this.shape.setAttribute("stroke",i);this.shape.setAttribute("stroke-opacity",r);this.shape.setAttribute("fill",u);this.shape.setAttribute("fill-opacity",f)}};CLOUD.Extensions.Marker.shapeTypes={BUBBLE:0,FLAG:1,COMMON:2};CLOUD.Extensions.Marker.getDefaultStyle=function(){var n={};return n["stroke-width"]=2,n["stroke-color"]="#fffaff",n["stroke-opacity"]=1,n["fill-color"]="#ff2129",n["fill-opacity"]=1,n};CLOUD.Extensions.MarkerFlag=function(n,t){CLOUD.Extensions.Marker.call(this,n,t);this.shapeType=CLOUD.Extensions.Marker.shapeTypes.FLAG;this.createShape();this.addDomEventListeners()};CLOUD.Extensions.MarkerFlag.prototype=Object.create(CLOUD.Extensions.Marker.prototype);CLOUD.Extensions.MarkerFlag.prototype.constructor=CLOUD.Extensions.Marker;CLOUD.Extensions.MarkerFlag.prototype.createShape=function(){this.shape=CLOUD.Extensions.Utils.Shape2D.makeFlag()};CLOUD.Extensions.MarkerBubble=function(n,t){CLOUD.Extensions.Marker.call(this,n,t);this.shapeType=CLOUD.Extensions.Marker.shapeTypes.BUBBLE;this.createShape();this.addDomEventListeners()};CLOUD.Extensions.MarkerBubble.prototype=Object.create(CLOUD.Extensions.Marker.prototype);CLOUD.Extensions.MarkerBubble.prototype.constructor=CLOUD.Extensions.Marker;CLOUD.Extensions.MarkerBubble.prototype.createShape=function(){this.shape=CLOUD.Extensions.Utils.Shape2D.makeBubble()};CLOUD.Extensions.MarkerEditor=function(n){"use strict";this.cameraEditor=n.cameraEditor;this.scene=n.getScene();this.domElement=n.domElement;this.markers=[];this.selectedMarker=null;this.flagColors={red:"#ff2129",green:"#85af03",yellow:"#fe9829"};this.bubbleColors={red:"#f92a24",green:"#86b507",gray:"#ff9326"};this.nextMarkerId=0;this.initialized=!1;this.markerClickCallback=null};CLOUD.Extensions.MarkerEditor.prototype.onResize=function(){if(this.svg){var n=this.getDomContainerBounds();this.svg.setAttribute("width",n.width+"");this.svg.setAttribute("height",n.height+"");this.updateMarkers()}};CLOUD.Extensions.MarkerEditor.prototype.init=function(){if(!this.svg){var n=this.getDomContainerBounds(),t=n.width,i=n.height;this.svg=CLOUD.Extensions.Utils.Shape2D.createSvgElement("svg");this.svg.style.position="absolute";this.svg.style.display="block";this.svg.style.position="absolute";this.svg.style.display="block";this.svg.style.left="0";this.svg.style.top="0";this.svg.setAttribute("width",t+"");this.svg.setAttribute("height",i+"");this.domElement.appendChild(this.svg);this.svgGroup=CLOUD.Extensions.Utils.Shape2D.createSvgElement("g");this.svg.insertBefore(this.svgGroup,this.svg.firstChild)}this.initialized=!0};CLOUD.Extensions.MarkerEditor.prototype.uninit=function(){(this.initialized=!1,this.svg)&&(this.unloadMarkers(),this.svgGroup&&this.svgGroup.parentNode&&this.svgGroup.parentNode.removeChild(this.svgGroup),this.svg.parentNode&&this.svg.parentNode.removeChild(this.svg),this.svgGroup=null,this.svg=null,this.markerClickCallback=null)};CLOUD.Extensions.MarkerEditor.prototype.isInitialized=function(){return this.initialized};CLOUD.Extensions.MarkerEditor.prototype.generateMarkerId=function(){++this.nextMarkerId;return this.nextMarkerId.toString(10)};CLOUD.Extensions.MarkerEditor.prototype.clear=function(){for(var t=this.markers,i,n;t.length;)i=t[0],this.deleteMarker(i);if(n=this.svgGroup,n&&n.childNodes.length>0)while(n.childNodes.length)n.removeChild(n.childNodes[0])};CLOUD.Extensions.MarkerEditor.prototype.addMarker=function(n){n.setParent(this.svgGroup);this.markers.push(n)};CLOUD.Extensions.MarkerEditor.prototype.deleteMarker=function(n){if(n){var t=this.markers.indexOf(n);t!==-1&&this.markers.splice(t,1);n.destroy()}};CLOUD.Extensions.MarkerEditor.prototype.selectMarker=function(n){this.selectedMarker!==n?(this.deselectMarker(),this.selectedMarker=n):this.deselectMarker();this.markerClickCallback&&(this.selectedMarker?this.markerClickCallback(this.selectedMarker.toNewObject()):this.markerClickCallback(null))};CLOUD.Extensions.MarkerEditor.prototype.deselectMarker=function(){this.selectedMarker&&(this.selectedMarker.deselect(),this.selectedMarker=null)};CLOUD.Extensions.MarkerEditor.prototype.getSceneMatrix=function(){return this.scene.getMatrixGlobal()};CLOUD.Extensions.MarkerEditor.prototype.getInverseSceneMatrix=function(){var t=this.getSceneMatrix(),n=new THREE.Matrix4;return n.getInverse(t),n};CLOUD.Extensions.MarkerEditor.prototype.worldToClient=function(n){var i=this.getDomContainerBounds(),r=this.cameraEditor.camera,u=this.getSceneMatrix(),t=new THREE.Vector3(n.x,n.y,n.z);return(t.applyMatrix4(u),t.project(r),Math.abs(t.z)>1)?null:(t.x=Math.round(.5*(t.x+1)*i.width),t.y=Math.round(-.5*(t.y-1)*i.height),t.z=0,t)};CLOUD.Extensions.MarkerEditor.prototype.clientToWorld=function(n){var i=this.getDomContainerBounds(),u=this.cameraEditor.camera,t=new THREE.Vector3,r;return t.x=n.x/i.width*2-1,t.y=-n.y/i.height*2+1,t.z=0,t.unproject(u),r=this.getInverseSceneMatrix(),t.applyMatrix4(r),t};CLOUD.Extensions.MarkerEditor.prototype.clientToViewport=function(n){var i=this.getDomContainerBounds(),t=new THREE.Vector3;return t.x=n.x/i.width*2-1,t.y=-n.y/i.height*2+1,t.z=0,t};CLOUD.Extensions.MarkerEditor.prototype.enableSVGPaint=function(n){n?this.svg&&this.svg.setAttribute("pointer-events","painted"):this.svg&&this.svg.setAttribute("pointer-events","none")};CLOUD.Extensions.MarkerEditor.prototype.getDomContainerBounds=function(){return CLOUD.DomUtil.getContainerOffsetToClient(this.domElement)};CLOUD.Extensions.MarkerEditor.prototype.getMarkerColor=function(n,t){var i=this.bubbleColors.red;n<0&&n>1&&(n=0);t>2&&(t-=3);t<0&&t>2&&(t=0);switch(t){case 0:i=n===0?this.bubbleColors.red:this.flagColors.red;break;case 1:i=n===0?this.bubbleColors.green:this.flagColors.green;break;case 2:i=n===0?this.bubbleColors.gray:this.flagColors.yellow}return i};CLOUD.Extensions.MarkerEditor.prototype.createMarkerByIntersect=function(n,t,i){var r=this.generateMarkerId(),u=n.userId,f=n.worldPosition||n.object.point,e=n.worldBoundingBox||n.object.boundingBox,o={id:r,userId:u,position:f,boundingBox:e,shapeType:t,state:i};this.createMarker(o)};CLOUD.Extensions.MarkerEditor.prototype.createMarker=function(n){var i,t,r;n&&(i=CLOUD.Extensions.Marker.getDefaultStyle(),i["fill-color"]=this.getMarkerColor(n.shapeType,n.state),t=n.id,r=CLOUD.Extensions.Marker.shapeTypes.BUBBLE===n.shapeType?new CLOUD.Extensions.MarkerBubble(t,this):CLOUD.Extensions.Marker.shapeTypes.FLAG===n.shapeType?new CLOUD.Extensions.MarkerFlag(t,this):new CLOUD.Extensions.MarkerCommon(t,this,n.state),r.set(n.userId,n.position,n.boundingBox,i),this.addMarker(r))};CLOUD.Extensions.MarkerEditor.prototype.getMarkersBoundingBox=function(){var t,n,i,r;if(this.markers.length<1)return null;for(t=new THREE.Box3,n=0,i=this.markers.length;n<i;n++)r=this.markers[n],t.union(r.getBoundingBox());return t};CLOUD.Extensions.MarkerEditor.prototype.getMarkerInfoList=function(){for(var i=[],t=0,r=this.markers.length;t<r;t++){var n=this.markers[t],u=n.userId+"_"+t,f={id:n.id||u,userId:n.userId,shapeType:n.shapeType,position:n.position,boundingBox:n.boundingBox,state:n.state};i.push(f)}return i};CLOUD.Extensions.MarkerEditor.prototype.loadMarkers=function(n){var r,u,f;for(this.clear(),r=0,u=n.length;r<u;r++){var t=n[r],e=t.userId+"_"+r,o=t.id||e,s=t.userId,h=t.shapeType,c=t.state,l=t.position,i=new THREE.Box3;i.max.x=t.boundingBox.max.x;i.max.y=t.boundingBox.max.y;i.max.z=t.boundingBox.max.z;i.min.x=t.boundingBox.min.x;i.min.y=t.boundingBox.min.y;i.min.z=t.boundingBox.min.z;f={id:o,userId:s,position:l,boundingBox:i,shapeType:h,state:c};this.createMarker(f)}};CLOUD.Extensions.MarkerEditor.prototype.loadMarkersFromIntersect=function(n,t,i){this.clear();this.createMarkerByIntersect(n,t,i)};CLOUD.Extensions.MarkerEditor.prototype.unloadMarkers=function(){this.clear()};CLOUD.Extensions.MarkerEditor.prototype.updateMarkers=function(){for(var i,n=0,t=this.markers.length;n<t;n++)i=this.markers[n],i.update()};CLOUD.Extensions.MarkerEditor.prototype.getMarker=function(n){for(var i=this.markers,r=i.length,t=0;t<r;++t)if(i[t].id==n)return i[t];return null};CLOUD.Extensions.MarkerEditor.prototype.setMarkerClickCallback=function(n){this.markerClickCallback=n};CLOUD.Extensions.Annotation=function(n,t){this.editor=n;this.id=t;this.shapeType=0;this.position={x:0,y:0,z:0};this.size={width:0,height:0};this.rotation=0;this.style=n.annotationStyle?CLOUD.DomUtil.cloneStyle(n.annotationStyle):this.getDefaultStyle();this.shape=null;this.selected=!1;this.highlighted=!1;this.highlightColor="#FAFF3C";this.isDisableInteractions=!1;this.disableResizeWidth=!1;this.disableResizeHeight=!1;this.disableRotation=!1;this.onMouseDownBinded=this.onMouseDown.bind(this);this.onMouseOutBinded=this.onMouseOut.bind(this);this.onMouseOverBinded=this.onMouseOver.bind(this)};CLOUD.Extensions.Annotation.prototype={constructor:CLOUD.Extensions.Annotation,addDomEventListeners:function(){},removeDomEventListeners:function(){},onMouseDown:function(n){this.isDisableInteractions||(this.select(),this.editor.annotationFrame&&this.editor.annotationFrame.dragBegin(n))},onMouseOut:function(){this.highlight(!1)},onMouseOver:function(){this.highlight(!0)},created:function(){},destroy:function(){this.removeDomEventListeners();this.deselect();this.setParent(null)},set:function(n,t,i){this.position.x=n.x;this.position.y=n.y;this.position.z=n.z;this.size.width=t.width;this.size.height=t.height;this.rotation=i||0;this.update()},resetRotation:function(n){this.rotation=n;this.update()},getRotation:function(){return this.rotation},resetPosition:function(n){this.position.x=n.x;this.position.y=n.y;this.position.z=n.z;this.update()},getClientPosition:function(){return this.editor.getAnnotationClientPosition(this.position)},resetSize:function(n,t){this.size.width=n.width;this.size.height=n.height;this.position.x=t.x;this.position.y=t.y;this.position.z=t.z;this.update()},getClientSize:function(){return this.editor.getAnnotationClientSize(this.size,this.position)},setParent:function(n){var t=this.shape;t.parentNode&&t.parentNode.removeChild(t);n&&n.appendChild(t)},setStyle:function(n){this.style=CLOUD.DomUtil.cloneStyle(n);this.update(!0)},getStyle:function(){return CLOUD.DomUtil.cloneStyle(this.style)},updateStyle:function(n){this.style=CLOUD.DomUtil.cloneStyle(n);this.update(!0)},update:function(){},select:function(){this.selected||(this.selected=!0,this.highlighted=!1,this.update(),this.editor.selectAnnotation(this))},deselect:function(){this.selected=!1},highlight:function(n){this.isDisableInteractions||(this.highlighted=n,this.update())},disableInteractions:function(n){this.isDisableInteractions=n},"delete":function(){this.editor.deleteAnnotation(this)},getDefaultStyle:function(){var n={};return n["stroke-width"]=3,n["stroke-color"]="#ff0000",n["stroke-opacity"]=1,n["fill-color"]="#ff0000",n["fill-opacity"]=0,n["font-family"]="Arial",n["font-size"]=16,n["font-style"]="",n["font-weight"]="",n}};CLOUD.Extensions.Annotation.shapeTypes={ARROW:0,RECTANGLE:1,CIRCLE:2,CROSS:3,CLOUD:4,TEXT:5};CLOUD.Extensions.AnnotationArrow=function(n,t){CLOUD.Extensions.Annotation.call(this,n,t);this.shapeType=CLOUD.Extensions.Annotation.shapeTypes.ARROW;this.head=new THREE.Vector2;this.tail=new THREE.Vector2;this.disableResizeHeight=!0;this.size.height=this.style["stroke-width"]*4;this.createShape();this.addDomEventListeners()};CLOUD.Extensions.AnnotationArrow.prototype=Object.create(CLOUD.Extensions.Annotation.prototype);CLOUD.Extensions.AnnotationArrow.prototype.constructor=CLOUD.Extensions.AnnotationArrow;CLOUD.Extensions.AnnotationArrow.prototype.addDomEventListeners=function(){this.shape.addEventListener("mousedown",this.onMouseDownBinded,!0);this.shape.addEventListener("mouseout",this.onMouseOutBinded);this.shape.addEventListener("mouseover",this.onMouseOverBinded)};CLOUD.Extensions.AnnotationArrow.prototype.removeDomEventListeners=function(){this.shape.removeEventListener("mousedown",this.onMouseDownBinded,!0);this.shape.removeEventListener("mouseout",this.onMouseOutBinded);this.shape.removeEventListener("mouseover",this.onMouseOverBinded)};CLOUD.Extensions.AnnotationArrow.prototype.createShape=function(){this.shape=CLOUD.Extensions.Utils.Shape2D.createSvgElement("polygon")};CLOUD.Extensions.AnnotationArrow.prototype.setByTailHead=function(n,t){var i=new THREE.Vector2(n.x,n.y),r=new THREE.Vector2(t.x,t.y),f=r.clone().sub(i).normalize(),u;this.size.width=i.distanceTo(r);this.rotation=Math.acos(f.dot(new THREE.Vector2(1,0)));this.rotation=t.y>n.y?Math.PI*2-this.rotation:this.rotation;this.tail.set(n.x,n.y);this.head.set(t.x,t.y);u=n.z;this.position.x=.5*(this.head.x+this.tail.x);this.position.y=.5*(this.head.y+this.tail.y);this.position.z=u;this.update()};CLOUD.Extensions.AnnotationArrow.prototype.getClientSize=function(){var n=this.editor.getAnnotationClientSize(this.size,this.position);return n.height=this.style["stroke-width"]*4,n};CLOUD.Extensions.AnnotationArrow.prototype.resetSize=function(n,t){var i=new THREE.Vector2(Math.cos(this.rotation),Math.sin(this.rotation));i.multiplyScalar(n.width*.5);var r=new THREE.Vector2(t.x,t.y),u=r.clone().sub(i),f=r.clone().add(i);this.tail.set(u.x,u.y);this.head.set(f.x,f.y);this.position.x=t.x;this.position.y=t.y;this.position.z=t.z;this.size.width=n.width;this.update()};CLOUD.Extensions.AnnotationArrow.prototype.resetPosition=function(n){var t=this.head.x-this.tail.x,i=this.head.y-this.tail.y;this.tail.x=n.x-t*.5;this.tail.y=n.y-i*.5;this.head.x=this.tail.x+t;this.head.y=this.tail.y+i;this.position.x=n.x;this.position.y=n.y;this.position.z=n.z;this.update()};CLOUD.Extensions.AnnotationArrow.prototype.update=function(){var i=this.highlighted?this.highlightColor:this.style["stroke-color"],r=this.style["stroke-opacity"],u=this.getShapePoints(),f=u.map(function(n){return n[0]+","+n[1]}),e=f.join(" "),n=this.getClientPosition(),t=this.getClientSize(),o=.5*t.width,s=.5*t.height;this.transformShape=["translate(",n.x,",",n.y,") ","rotate(",THREE.Math.radToDeg(this.rotation),") ","translate(",-o,",",-s,") "].join("");this.shape.setAttribute("points",e);this.shape.setAttribute("transform",this.transformShape);this.shape.setAttribute("fill",i);this.shape.setAttribute("opacity",r)};CLOUD.Extensions.AnnotationArrow.prototype.getShapePoints=function(){var u=this.style["stroke-width"]*2,e=this.getClientSize(),n=e.width*.5,t=u,i=u*.5,r=n-2*t,o=[-n,-i],s=[r,-i],h=[r,-t],c=[n,0],l=[r,t],a=[r,i],v=[-n,i],f=[o,s,h,c,l,a,v];return f.forEach(function(i){i[0]+=n;i[1]+=t}),f};CLOUD.Extensions.AnnotationArrow.prototype.renderToCanvas=function(n){var i=this.style["stroke-width"]*2,r=this.style["stroke-color"],u=this.style["stroke-opacity"],t=this.getClientPosition(),f=this.getClientSize(),e=f.width*.5,o=i,s=(new THREE.Matrix4).makeTranslation(-e,-o,0),h=(new THREE.Matrix4).makeRotationZ(this.rotation),c=(new THREE.Matrix4).makeTranslation(t.x,t.y,0),l=c.multiply(h).multiply(s),a=this.getShapePoints();n.fillStyle=CLOUD.Extensions.Utils.Shape2D.getRGBAString(r,u);n.beginPath();a.forEach(function(t){var i=new THREE.Vector3(t[0],t[1],0);i.applyMatrix4(l);n.lineTo(i.x,i.y)});n.fill()};CLOUD.Extensions.AnnotationRectangle=function(n,t){CLOUD.Extensions.Annotation.call(this,n,t);this.shapeType=CLOUD.Extensions.Annotation.shapeTypes.RECTANGLE;this.createShape();this.addDomEventListeners()};CLOUD.Extensions.AnnotationRectangle.prototype=Object.create(CLOUD.Extensions.Annotation.prototype);CLOUD.Extensions.AnnotationRectangle.prototype.constructor=CLOUD.Extensions.AnnotationRectangle;CLOUD.Extensions.AnnotationRectangle.prototype.addDomEventListeners=function(){this.shape.addEventListener("mousedown",this.onMouseDownBinded,!0);this.shape.addEventListener("mouseout",this.onMouseOutBinded);this.shape.addEventListener("mouseover",this.onMouseOverBinded)};CLOUD.Extensions.AnnotationRectangle.prototype.removeDomEventListeners=function(){this.shape.removeEventListener("mousedown",this.onMouseDownBinded,!0);this.shape.removeEventListener("mouseout",this.onMouseOutBinded);this.shape.removeEventListener("mouseover",this.onMouseOverBinded)};CLOUD.Extensions.AnnotationRectangle.prototype.createShape=function(){this.shape=CLOUD.Extensions.Utils.Shape2D.createSvgElement("rect")};CLOUD.Extensions.AnnotationRectangle.prototype.update=function(){var n=this.style["stroke-width"],f=this.highlighted?this.highlightColor:this.style["stroke-color"],e=this.style["stroke-opacity"],o=this.style["fill-color"],s=this.style["fill-opacity"],t=this.getClientPosition(),i=this.getClientSize(),r=Math.max(i.width-n,0),u=Math.max(i.height-n,0),h=.5*r,c=.5*u;this.transformShape=["translate(",t.x,",",t.y,") ","rotate(",THREE.Math.radToDeg(this.rotation),") ","translate(",-h,",",-c,") "].join("");this.shape.setAttribute("transform",this.transformShape);this.shape.setAttribute("stroke-width",n);this.shape.setAttribute("stroke",CLOUD.Extensions.Utils.Shape2D.getRGBAString(f,e));this.shape.setAttribute("fill",CLOUD.Extensions.Utils.Shape2D.getRGBAString(o,s));this.shape.setAttribute("width",r+"");this.shape.setAttribute("height",u+"")};CLOUD.Extensions.AnnotationRectangle.prototype.renderToCanvas=function(n){var r=this.style["stroke-width"],o=this.highlighted?this.highlightColor:this.style["stroke-color"],s=this.style["stroke-opacity"],h=this.style["fill-color"],u=this.style["fill-opacity"],f=this.getClientSize(),e=this.getClientPosition(),t=Math.max(f.width-r,0),i=Math.max(f.height-r,0);n.strokeStyle=CLOUD.Extensions.Utils.Shape2D.getRGBAString(o,s);n.fillStyle=CLOUD.Extensions.Utils.Shape2D.getRGBAString(h,u);n.lineWidth=r;n.translate(e.x,e.y);n.rotate(this.rotation);n.beginPath();u!==0&&n.fillRect(t/-2,i/-2,t,i);n.strokeRect(t/-2,i/-2,t,i)};CLOUD.Extensions.AnnotationCircle=function(n,t){CLOUD.Extensions.Annotation.call(this,n,t);this.shapeType=CLOUD.Extensions.Annotation.shapeTypes.CIRCLE;this.createShape();this.addDomEventListeners()};CLOUD.Extensions.AnnotationCircle.prototype=Object.create(CLOUD.Extensions.Annotation.prototype);CLOUD.Extensions.AnnotationCircle.prototype.constructor=CLOUD.Extensions.AnnotationCircle;CLOUD.Extensions.AnnotationCircle.prototype.addDomEventListeners=function(){this.shape.addEventListener("mousedown",this.onMouseDownBinded,!0);this.shape.addEventListener("mouseout",this.onMouseOutBinded);this.shape.addEventListener("mouseover",this.onMouseOverBinded)};CLOUD.Extensions.AnnotationCircle.prototype.removeDomEventListeners=function(){this.shape.removeEventListener("mousedown",this.onMouseDownBinded,!0);this.shape.removeEventListener("mouseout",this.onMouseOutBinded);this.shape.removeEventListener("mouseover",this.onMouseOverBinded)};CLOUD.Extensions.AnnotationCircle.prototype.createShape=function(){this.shape=CLOUD.Extensions.Utils.Shape2D.createSvgElement("ellipse")};CLOUD.Extensions.AnnotationCircle.prototype.update=function(){var n=this.style["stroke-width"],f=this.highlighted?this.highlightColor:this.style["stroke-color"],e=this.style["stroke-opacity"],o=this.style["fill-color"],s=this.style["fill-opacity"],r=this.getClientPosition(),u=this.getClientSize(),t=Math.max(u.width-n,0)*.5,i=Math.max(u.height-n,0)*.5;this.transformShape=["translate(",r.x,",",r.y,") ","rotate(",THREE.Math.radToDeg(this.rotation),") ","translate(",-t,",",-i,") "].join("");this.shape.setAttribute("transform",this.transformShape);this.shape.setAttribute("stroke-width",n);this.shape.setAttribute("stroke",CLOUD.Extensions.Utils.Shape2D.getRGBAString(f,e));this.shape.setAttribute("fill",CLOUD.Extensions.Utils.Shape2D.getRGBAString(o,s));this.shape.setAttribute("cx",t);this.shape.setAttribute("cy",i);this.shape.setAttribute("rx",t);this.shape.setAttribute("ry",i)};CLOUD.Extensions.AnnotationCircle.prototype.renderToCanvas=function(n){function f(n,t,i,r,u){n.beginPath();var s=t-r/2,h=t+r/2,f=i-u/2,c=i+u/2,l=.551784,e=l*r/2,o=l*u/2;n.moveTo(t,f);n.bezierCurveTo(t+e,f,h,i-o,h,i);n.bezierCurveTo(h,i+o,t+e,c,t,c);n.bezierCurveTo(t-e,c,s,i+o,s,i);n.bezierCurveTo(s,i-o,t-e,f,t,f);n.stroke()}var t=this.style["stroke-width"],e=this.style["stroke-color"],o=this.style["stroke-opacity"],s=this.style["fill-color"],i=this.style["fill-opacity"],r=this.getClientPosition(),u=this.getClientSize(),h=Math.max(u.width-t,0),c=Math.max(u.height-t,0);n.strokeStyle=CLOUD.Extensions.Utils.Shape2D.getRGBAString(e,o);n.fillStyle=CLOUD.Extensions.Utils.Shape2D.getRGBAString(s,i);n.lineWidth=t;n.translate(r.x,r.y);n.rotate(this.rotation);f(n,0,0,h,c);i!==0&&n.fill()};CLOUD.Extensions.AnnotationCloud=function(n,t){CLOUD.Extensions.Annotation.call(this,n,t);this.shapeType=CLOUD.Extensions.Annotation.shapeTypes.CLOUD;this.shapePoints=[];this.trackingPoint={x:0,y:0};this.isSeal=!1;this.isTracking=!1;this.isEnableTrack=!1;this.originSize={width:1,height:1};this.viewBox={width:1e3,height:1e3};this.createShape();this.addDomEventListeners()};CLOUD.Extensions.AnnotationCloud.prototype=Object.create(CLOUD.Extensions.Annotation.prototype);CLOUD.Extensions.AnnotationCloud.prototype.constructor=CLOUD.Extensions.AnnotationCloud;CLOUD.Extensions.AnnotationCloud.prototype.addDomEventListeners=function(){this.shape.addEventListener("mousedown",this.onMouseDownBinded,!0);this.shape.addEventListener("mouseout",this.onMouseOutBinded);this.shape.addEventListener("mouseover",this.onMouseOverBinded)};CLOUD.Extensions.AnnotationCloud.prototype.removeDomEventListeners=function(){this.shape.removeEventListener("mousedown",this.onMouseDownBinded,!0);this.shape.removeEventListener("mouseout",this.onMouseOutBinded);this.shape.removeEventListener("mouseover",this.onMouseOverBinded)};CLOUD.Extensions.AnnotationCloud.prototype.createShape=function(){this.shape=CLOUD.Extensions.Utils.Shape2D.createSvgElement("path")};CLOUD.Extensions.AnnotationCloud.prototype.setByPositions=function(n,t){this.positions=n.concat();this.isSeal=t||!1;this.calculatePosition(!0);this.originSize.width=this.size.width===0?1:this.size.width;this.originSize.height=this.size.height===0?1:this.size.height;this.update()};CLOUD.Extensions.AnnotationCloud.prototype.set=function(n,t,i,r,u){this.position.x=n.x;this.position.y=n.y;this.position.z=n.z;this.size.width=t.width;this.size.height=t.height;this.rotation=i||0;u?(this.originSize.width=u.width===0?1:u.width,this.originSize.height=u.height===0?1:u.height):(this.originSize.width=this.size.width===0?1:this.size.width,this.originSize.height=this.size.height===0?1:this.size.height);this.setShapePoints(r);this.update()};CLOUD.Extensions.AnnotationCloud.prototype.setTrackingPoint=function(n){this.trackingPoint.x=n.x;this.trackingPoint.y=n.y;this.calculatePosition(!1);this.update()};CLOUD.Extensions.AnnotationCloud.prototype.update=function(){if(!(this.shapePoints.length<1)){var n=this.getPathString(),t=this.style["stroke-width"],i=this.highlighted?this.highlightColor:this.style["stroke-color"],r=this.style["stroke-opacity"],u=this.style["fill-color"],f=this.style["fill-opacity"];this.shape.setAttribute("stroke-width",t);this.shape.setAttribute("stroke",CLOUD.Extensions.Utils.Shape2D.getRGBAString(i,r));this.shape.setAttribute("fill",CLOUD.Extensions.Utils.Shape2D.getRGBAString(u,f));this.shape.setAttribute("d",n)}};CLOUD.Extensions.AnnotationCloud.prototype.worldToViewBox=function(n){var t=this.originSize.width,i=this.originSize.height,r=this.viewBox.width,u=this.viewBox.height,f=Math.floor(n.x/t*r+.5),e=Math.floor(n.y/i*u+.5);return{x:f,y:e}};CLOUD.Extensions.AnnotationCloud.prototype.viewBoxToWorld=function(n){var t=this.originSize.width,i=this.originSize.height,r=this.viewBox.width,u=this.viewBox.height,f=n.x/r*t,e=n.y/u*i;return{x:f,y:e}};CLOUD.Extensions.AnnotationCloud.prototype.getPathString=function(){var s=this.size.width/this.originSize.width,h=this.size.height/this.originSize.height,c=(new THREE.Matrix4).makeScale(s,h,1),l=(new THREE.Matrix4).makeRotationZ(-this.rotation),a=(new THREE.Matrix4).makeTranslation(this.position.x,this.position.y,this.position.z),r=a.multiply(l).multiply(c),u=this,n=new THREE.Vector3,t,i,f,e,o=this.shapePoints.map(function(o,s){return s===0?(n.x=o.x,n.y=o.y,n.z=0,n.applyMatrix4(r),n=u.editor.worldToClient(n),t=n.x,i=n.y,["M"].concat([t,i]).join(" ")):(n.x=o.cx,n.y=o.cy,n.z=0,n.applyMatrix4(r),n=u.editor.worldToClient(n),f=n.x,e=n.y,n.x=o.x,n.y=o.y,n.z=0,n.applyMatrix4(r),n=u.editor.worldToClient(n),t=n.x,i=n.y,["Q"].concat([f,e,t,i]).join(" "))}).join(" ");return this.isSeal&&(o+="Z"),o};CLOUD.Extensions.AnnotationCloud.prototype.getControlPoint=function(n,t){var r=new THREE.Vector2(n.x,n.y),u=new THREE.Vector2(t.x,t.y),i=u.clone().sub(r),e=.5*i.length(),o=.5*(r.x+u.x),s=.5*(r.y+u.y),f=new THREE.Vector2(o,s);return i.normalize(),i.rotateAround(new THREE.Vector2(0,0),.5*Math.PI),i.multiplyScalar(e),f.add(i),{x:f.x,y:f.y}};CLOUD.Extensions.AnnotationCloud.prototype.getBoundingBox=function(){for(var i=new THREE.Box2,t=new THREE.Vector2,n=0,r=this.shapePoints.length;n<r;n++)n===0?(t.set(this.shapePoints[n].x,this.shapePoints[n].y),i.expandByPoint(t)):(t.set(this.shapePoints[n].cx,this.shapePoints[n].cy),i.expandByPoint(t),t.set(this.shapePoints[n].x,this.shapePoints[n].y),i.expandByPoint(t));return i};CLOUD.Extensions.AnnotationCloud.prototype.calculateShapePath=function(){var u={},i={},r={},t,f=this.positions.length,n;if(this.shapePoints=[],!(f<1))if(this.depth=this.positions[0].z||0,f===1)i.x=this.positions[0].x,i.y=this.positions[0].y,this.shapePoints.push({x:this.positions[0].x,y:this.positions[0].y}),this.isTracking&&(t=this.getControlPoint(i,this.trackingPoint),this.shapePoints.push({cx:t.x,cy:t.y,x:this.trackingPoint.x,y:this.trackingPoint.y}));else for(n=0;n<f;n++)i.x=this.positions[n].x,i.y=this.positions[n].y,n===0?(this.shapePoints.push({x:this.positions[n].x,y:this.positions[n].y}),r.x=this.positions[n].x,r.y=this.positions[n].y,u.x=this.positions[n].x,u.y=this.positions[n].y):(t=this.getControlPoint(r,i),this.shapePoints.push({cx:t.x,cy:t.y,x:i.x,y:i.y}),r.x=i.x,r.y=i.y,n===f-1&&(this.isTracking?(t=this.getControlPoint(r,this.trackingPoint),this.shapePoints.push({cx:t.x,cy:t.y,x:this.trackingPoint.x,y:this.trackingPoint.y})):this.isSeal&&(t=this.getControlPoint(r,u),this.shapePoints.push({cx:t.x,cy:t.y,x:u.x,y:u.y}))))};CLOUD.Extensions.AnnotationCloud.prototype.calculateRelativePosition=function(n){for(var t=0,i=this.shapePoints.length;t<i;t++)t===0?(this.shapePoints[t].x-=n.x,this.shapePoints[t].y-=n.y):(this.shapePoints[t].x-=n.x,this.shapePoints[t].y-=n.y,this.shapePoints[t].cx-=n.x,this.shapePoints[t].cy-=n.y)};CLOUD.Extensions.AnnotationCloud.prototype.calculatePosition=function(n){var i,t,r;n=n||!1;this.calculateShapePath();n?(i=this.getBoundingBox(),t=i.center(),this.center={x:t.x,y:t.y},this.position.x=t.x,this.position.y=t.y,this.position.z=this.depth||0,this.calculateRelativePosition(t),i=this.getBoundingBox(),r=i.size(),this.size.width=r.x||16,this.size.height=r.y||16):this.center&&this.calculateRelativePosition(this.center)};CLOUD.Extensions.AnnotationCloud.prototype.startTrack=function(){this.isTracking=!0};CLOUD.Extensions.AnnotationCloud.prototype.finishTrack=function(){this.isTracking=!1};CLOUD.Extensions.AnnotationCloud.prototype.enableTrack=function(){this.isEnableTrack=!0};CLOUD.Extensions.AnnotationCloud.prototype.disableTrack=function(){this.isEnableTrack=!1};CLOUD.Extensions.AnnotationCloud.prototype.getTrackState=function(){return this.isEnableTrack};CLOUD.Extensions.AnnotationCloud.prototype.setSeal=function(n){this.isSeal=n;this.calculatePosition(!1);this.update()};CLOUD.Extensions.AnnotationCloud.prototype.setShapePoints=function(n){var u,f,e,o,t,i=n.split(","),s=parseInt(i[0]),h=parseInt(i[1]),r,c;for(t=this.viewBoxToWorld({x:s,y:h}),s=t.x,h=t.y,this.shapePoints=[],this.shapePoints.push({x:s,y:h}),r=2,c=i.length;r<c;r+=4)e=parseInt(i[r]),o=parseInt(i[r+1]),t=this.viewBoxToWorld({x:e,y:o}),e=t.x,o=t.y,u=parseInt(i[r+2]),f=parseInt(i[r+3]),t=this.viewBoxToWorld({x:u,y:f}),u=t.x,f=t.y,this.shapePoints.push({cx:e,cy:o,x:u,y:f})};CLOUD.Extensions.AnnotationCloud.prototype.getShapePoints=function(){for(var u=[],i,r,f,e,n,t=0,o=this.shapePoints.length;t<o;t++)t===0?(i=this.shapePoints[t].x,r=this.shapePoints[t].y,n=this.worldToViewBox({x:i,y:r}),i=n.x,r=n.y,u.push(i),u.push(r)):(f=this.shapePoints[t].cx,e=this.shapePoints[t].cy,n=this.worldToViewBox({x:f,y:e}),f=n.x,e=n.y,u.push(f),u.push(e),i=this.shapePoints[t].x,r=this.shapePoints[t].y,n=this.worldToViewBox({x:i,y:r}),i=n.x,r=n.y,u.push(i),u.push(r));return u.join(",")};CLOUD.Extensions.AnnotationCloud.prototype.renderToCanvas=function(n){var t,i,r,o,s;if(!(this.shapePoints.length<2)){var h=this.style["stroke-width"],c=this.highlighted?this.highlightColor:this.style["stroke-color"],l=this.style["stroke-opacity"],a=this.style["fill-color"],e=this.style["fill-opacity"];n.strokeStyle=CLOUD.Extensions.Utils.Shape2D.getRGBAString(c,l);n.fillStyle=CLOUD.Extensions.Utils.Shape2D.getRGBAString(a,e);n.lineWidth=h;var v=this.size.width/this.originSize.width,y=this.size.height/this.originSize.height,p=(new THREE.Matrix4).makeScale(v,y,1),w=(new THREE.Matrix4).makeRotationZ(-this.rotation),b=(new THREE.Matrix4).makeTranslation(this.position.x,this.position.y,this.position.z),u=b.multiply(w).multiply(p),f=this;n.beginPath();t=new THREE.Vector3;this.shapePoints.forEach(function(e,h){h===0?(t.x=e.x,t.y=e.y,t.z=0,t.applyMatrix4(u),t=f.editor.worldToClient(t),i=t.x,r=t.y,n.moveTo(i,r)):(t.x=e.cx,t.y=e.cy,t.z=0,t.applyMatrix4(u),t=f.editor.worldToClient(t),o=t.x,s=t.y,t.x=e.x,t.y=e.y,t.z=0,t.applyMatrix4(u),t=f.editor.worldToClient(t),i=t.x,r=t.y,n.quadraticCurveTo(o,s,i,r))});n.stroke();e!==0&&n.fill();n.stroke()}};CLOUD.Extensions.AnnotationCross=function(n,t){CLOUD.Extensions.Annotation.call(this,n,t);this.shapeType=CLOUD.Extensions.Annotation.shapeTypes.CROSS;this.createShape();this.addDomEventListeners()};CLOUD.Extensions.AnnotationCross.prototype=Object.create(CLOUD.Extensions.Annotation.prototype);CLOUD.Extensions.AnnotationCross.prototype.constructor=CLOUD.Extensions.AnnotationCross;CLOUD.Extensions.AnnotationCross.prototype.addDomEventListeners=function(){this.shape.addEventListener("mousedown",this.onMouseDownBinded,!0);this.shape.addEventListener("mouseout",this.onMouseOutBinded);this.shape.addEventListener("mouseover",this.onMouseOverBinded)};CLOUD.Extensions.AnnotationCross.prototype.removeDomEventListeners=function(){this.shape.removeEventListener("mousedown",this.onMouseDownBinded,!0);this.shape.removeEventListener("mouseout",this.onMouseOutBinded);this.shape.removeEventListener("mouseover",this.onMouseOverBinded)};CLOUD.Extensions.AnnotationCross.prototype.createShape=function(){this.shape=CLOUD.Extensions.Utils.Shape2D.createSvgElement("path")};CLOUD.Extensions.AnnotationCross.prototype.update=function(){var n=this.style["stroke-width"],r=this.highlighted?this.highlightColor:this.style["stroke-color"],u=this.style["stroke-opacity"],f=this.style["fill-color"],e=this.style["fill-opacity"],t=this.getClientPosition(),i=this.getClientSize(),o=Math.max(i.width-n,0)*.5,s=Math.max(i.height-n,0)*.5;this.transformShape=["translate(",t.x,",",t.y,") ","rotate(",THREE.Math.radToDeg(this.rotation),") ","translate(",-o,",",-s,") "].join("");this.shape.setAttribute("transform",this.transformShape);this.shape.setAttribute("stroke-width",n);this.shape.setAttribute("stroke",CLOUD.Extensions.Utils.Shape2D.getRGBAString(r,u));this.shape.setAttribute("fill",CLOUD.Extensions.Utils.Shape2D.getRGBAString(f,e));this.shape.setAttribute("d",this.getPath().join(" "))};CLOUD.Extensions.AnnotationCross.prototype.getPath=function(){var t=this.getClientSize(),i=0,r=0,u=t.width,f=t.height,n=[];return n.push("M"),n.push(i),n.push(r),n.push("L"),n.push(u),n.push(f),n.push("z"),n.push("M"),n.push(i),n.push(f),n.push("L"),n.push(u),n.push(r),n.push("z"),n};CLOUD.Extensions.AnnotationCross.prototype.renderToCanvas=function(n){var t=this.style["stroke-width"],o=this.highlighted?this.highlightColor:this.style["stroke-color"],s=this.style["stroke-opacity"],h=this.style["fill-color"],u=this.style["fill-opacity"],f=this.getClientPosition(),e=this.getClientSize(),i=Math.max(e.width-t,0),r=Math.max(e.height-t,0);n.strokeStyle=CLOUD.Extensions.Utils.Shape2D.getRGBAString(o,s);n.fillStyle=CLOUD.Extensions.Utils.Shape2D.getRGBAString(h,u);n.lineWidth=t;n.translate(f.x,f.y);n.rotate(this.rotation);n.translate(-.5*i,-.5*r);n.beginPath();n.moveTo(0,0);n.lineTo(i,r);n.moveTo(0,r);n.lineTo(i,0);n.stroke();u!==0&&n.fill();n.stroke()};CLOUD.Extensions.AnnotationText=function(n,t){CLOUD.Extensions.Annotation.call(this,n,t);this.shapeType=CLOUD.Extensions.Annotation.shapeTypes.TEXT;this.currText="";this.currTextLines=[""];this.textDirty=!0;this.lineHeight=100;this.textArea=document.createElement("textarea");this.textArea.setAttribute("maxlength","260");this.textAreaStyle={};this.textAreaStyle.position="absolute";this.textAreaStyle["overflow-y"]="hidden";this.measurePanel=document.createElement("div");this.isActive=!1;this.createShape();this.addDomEventListeners()};CLOUD.Extensions.AnnotationText.prototype=Object.create(CLOUD.Extensions.Annotation.prototype);CLOUD.Extensions.AnnotationText.prototype.constructor=CLOUD.Extensions.AnnotationText;CLOUD.Extensions.AnnotationText.prototype.addDomEventListeners=function(){this.shape.addEventListener("mousedown",this.onMouseDownBinded,!0);this.shape.addEventListener("mouseout",this.onMouseOutBinded);this.shape.addEventListener("mouseover",this.onMouseOverBinded)};CLOUD.Extensions.AnnotationText.prototype.removeDomEventListeners=function(){this.shape.removeEventListener("mousedown",this.onMouseDownBinded,!0);this.shape.removeEventListener("mouseout",this.onMouseOutBinded);this.shape.removeEventListener("mouseover",this.onMouseOverBinded)};CLOUD.Extensions.AnnotationText.prototype.createShape=function(){this.clipPath=CLOUD.Extensions.Utils.Shape2D.createSvgElement("clipPath");this.clipPathId="clip_"+this.id;this.clipPath.setAttribute("id",this.clipPathId);this.clipPath.removeAttribute("pointer-events");this.clipRect=CLOUD.Extensions.Utils.Shape2D.createSvgElement("rect");this.clipRect.removeAttribute("pointer-events");this.clipPath.appendChild(this.clipRect);this.shape=CLOUD.Extensions.Utils.Shape2D.createSvgElement("text");this.backgroundRect=CLOUD.Extensions.Utils.Shape2D.createSvgElement("rect")};CLOUD.Extensions.AnnotationText.prototype.set=function(n,t,i,r){this.position.x=n.x;this.position.y=n.y;this.position.z=n.z;this.size.width=t.width;this.size.height=t.height;this.rotation=i;this.setText(r)};CLOUD.Extensions.AnnotationText.prototype.resetSize=function(n,t){var r=this.getClientSize(),u=Math.floor(r.width)!==n.width,i;this.position.x=t.x;this.position.y=t.y;this.position.z=t.z;this.size.width=n.width;this.size.height=n.height;u&&(i=this.calcTextLines(),this.linesEqual(i)||(this.currTextLines=i,this.textDirty=!0,this.forceRedraw()));this.update()};CLOUD.Extensions.AnnotationText.prototype.setText=function(n){this.currText=n;this.currTextLines=this.calcTextLines();this.textDirty=!0;this.show();this.update()};CLOUD.Extensions.AnnotationText.prototype.getText=function(){return this.currText};CLOUD.Extensions.AnnotationText.prototype.setParent=function(n){var t=this.clipPath.parentNode;t&&t.removeChild(this.clipPath);n&&n.appendChild(this.clipPath);t=this.backgroundRect.parentNode;t&&t.removeChild(this.backgroundRect);n&&n.appendChild(this.backgroundRect);t=this.shape.parentNode;t&&t.removeChild(this.shape);n&&n.appendChild(this.shape)};CLOUD.Extensions.AnnotationText.prototype.update=function(n){var u=this.style["font-size"],e=this.highlighted?this.highlightColor:this.style["stroke-color"],o=this.style["stroke-opacity"],s=this.style["fill-color"],h=this.style["fill-opacity"],f=this.getClientPosition(),t=this.getClientSize(),c=t.width*.5,l=t.height*.5,i,r;this.transformShape=["translate(",f.x,",",f.y,") ","rotate(",THREE.Math.radToDeg(this.rotation),") ","translate(",-c,",",-l,") "].join("");this.shape.setAttribute("font-family",this.style["font-family"]);this.shape.setAttribute("font-size",u);this.shape.setAttribute("font-weight",this.style["font-weight"]);this.shape.setAttribute("font-style",this.style["font-style"]);this.shape.setAttribute("fill",CLOUD.Extensions.Utils.Shape2D.getRGBAString(e,o));i=["translate(0, ",u,")"].join("");this.shape.setAttribute("transform",this.transformShape+i);(this.textDirty||n)&&(n&&(this.currTextLines=this.calcTextLines()),this.rebuildTextSvg(),this.textDirty=!1);r=this.shape.getBBox();this.shapeBox=r;this.clipRect.setAttribute("x","0");this.clipRect.setAttribute("y",r.y+"");this.clipRect.setAttribute("width",t.width);this.clipRect.setAttribute("height",t.height);i=["translate(0, ",t.height,")"].join("");this.backgroundRect.setAttribute("transform",this.transformShape+i);this.backgroundRect.setAttribute("width",t.width);this.backgroundRect.setAttribute("height",t.height);this.backgroundRect.setAttribute("stroke-width","0");this.backgroundRect.setAttribute("fill",CLOUD.Extensions.Utils.Shape2D.getRGBAString(s,h))};CLOUD.Extensions.AnnotationText.prototype.show=function(){this.shape.style.display!==""&&(this.shape.style.display="")};CLOUD.Extensions.AnnotationText.prototype.hide=function(){this.shape.style.display!=="none"&&(this.shape.style.display="none")};CLOUD.Extensions.AnnotationText.prototype.forceRedraw=function(){window.requestAnimationFrame(function(){this.highlighted=!this.highlighted;this.update();this.highlighted=!this.highlighted;this.update()}.bind(this))};CLOUD.Extensions.AnnotationText.prototype.rebuildTextSvg=function(){while(this.shape.childNodes.length>0)this.shape.removeChild(this.shape.childNodes[0]);var t=0,n=0,i=this.getLineHeight();this.currTextLines.forEach(function(r){var u=CLOUD.Extensions.Utils.Shape2D.createSvgElement("tspan");u.setAttribute("x",t);u.setAttribute("y",n);u.textContent=r;this.shape.appendChild(u);n+=i}.bind(this))};CLOUD.Extensions.AnnotationText.prototype.getLineHeight=function(){return this.style["font-size"]*this.lineHeight*.01};CLOUD.Extensions.AnnotationText.prototype.calcTextLines=function(){var n=this.editor.annotationTextArea.getTextValuesByAnnotation(this);return n.lines};CLOUD.Extensions.AnnotationText.prototype.getTextLines=function(){return this.currTextLines.concat()};CLOUD.Extensions.AnnotationText.prototype.linesEqual=function(n){var i=this.currTextLines,r,t;if(n.length!==i.length)return!1;for(r=i.length,t=0;t<r;++t)if(n[t]!==i[t])return!1;return!0};CLOUD.Extensions.AnnotationText.prototype.renderToCanvas=function(n){function o(n,t,i,r){var u=0;t.forEach(function(t){u+i>r||(n.fillText(t,0,u),u+=i)})}var s=this.style["fill-color"],r=this.style["fill-opacity"],u=this.style["stroke-color"],h=this.style["stroke-opacity"],c=this.style["font-family"],l=this.style["font-style"],a=this.style["font-weight"],f=this.style["font-size"],v=f*this.lineHeight*.01,i=this.getClientPosition(),e=this.getClientSize(),t={width:this.shapeBox.width,height:this.shapeBox.height};n.save();n.fillStyle=CLOUD.Extensions.Utils.Shape2D.getRGBAString(s,r);n.translate(i.x,i.y);r!==0&&n.fillRect(-.5*t.width,-.5*t.height,t.width,t.height);n.restore();n.fillStyle=u;n.strokeStyle=u;n.textBaseline="top";n.translate(i.x,i.y);n.rotate(this.rotation);n.translate(-.5*e.width,-.5*e.height);n.font=l+" "+a+" "+f+"px "+c;n.globalAlpha=h;o(n,this.currTextLines,v,t.height)};CLOUD.Extensions.AnnotationTextArea=function(n,t){this.editor=n;this.container=t;this.textArea=document.createElement("textarea");this.textArea.setAttribute("maxlength","260");this.textAreaStyle={};this.textAreaStyle.position="absolute";this.textAreaStyle["overflow-y"]="hidden";this.measurePanel=document.createElement("div");this.textAnnotation=null;this.onKeyDownBinded=this.onKeyDown.bind(this);this.onResizeBinded=this.onResize.bind(this);this.addDomEventListeners()};CLOUD.Extensions.AnnotationTextArea.prototype.addDomEventListeners=function(){this.textArea.addEventListener("keydown",this.onKeyDownBinded,!1)};CLOUD.Extensions.AnnotationTextArea.prototype.removeDomEventListeners=function(){this.textArea.removeEventListener("keydown",this.onKeyDownBinded,!1)};CLOUD.Extensions.AnnotationTextArea.prototype.onKeyDown=function(){var n=event.keyCode,t=event.shiftKey;t||n!==13||(event.preventDefault(),this.accept(),this.editor.resetCurrentAnnotationText())};CLOUD.Extensions.AnnotationTextArea.prototype.onResize=function(){window.requestAnimationFrame(function(){if(this.textAnnotation){var n=this.textArea.value;this.style=null;this.init();this.textArea.value=n}}.bind(this))};CLOUD.Extensions.AnnotationTextArea.prototype.destroy=function(){this.removeDomEventListeners();this.inactive()};CLOUD.Extensions.AnnotationTextArea.prototype.init=function(){var t=this.textAnnotation.getClientPosition(),n=this.textAnnotation.getClientSize(),i=Math.floor(t.x-n.width*.5+.5),r=Math.floor(t.y-n.height*.5+.5),u=this.textAnnotation.lineHeight+"%";this.textAreaStyle["line-height"]=u;this.setBound(i,r,n.width,n.height);this.setStyle(this.textAnnotation.getStyle());this.textArea.value=this.textAnnotation.getText()};CLOUD.Extensions.AnnotationTextArea.prototype.setBound=function(n,t,i,r){n+i>=this.container.clientWidth&&(n=this.container.clientWidth-(i+10));t+r>=this.container.clientHeight&&(t=this.container.clientHeight-(r+10));this.textAreaStyle.left=n+"px";this.textAreaStyle.top=t+"px";this.textAreaStyle.width=i+"px";this.textAreaStyle.height=r+"px"};CLOUD.Extensions.AnnotationTextArea.prototype.setStyle=function(n){var u;if(this.style){var t=parseFloat(this.textArea.style.width),i=parseFloat(this.textArea.style.height),f=parseFloat(this.textArea.style.left),e=parseFloat(this.textArea.style.top),r={x:f+t*.5,y:e+i*.5};this.setBound(r.x-t*.5,r.y-i*.5,t,i)}this.textAreaStyle["font-family"]=n["font-family"];this.textAreaStyle["font-size"]=n["font-size"]+"px";this.textAreaStyle["font-weight"]=n["font-weight"];this.textAreaStyle["font-style"]=n["font-style"];this.textAreaStyle.color=n["stroke-color"];u=CLOUD.DomUtil.getStyleString(this.textAreaStyle);this.textArea.setAttribute("style",u);this.style=CLOUD.DomUtil.cloneStyle(n)};CLOUD.Extensions.AnnotationTextArea.prototype.isActive=function(){return!!this.textAnnotation};CLOUD.Extensions.AnnotationTextArea.prototype.active=function(n,t){if(this.textAnnotation!==n){this.inactive();this.container.appendChild(this.textArea);this.textAnnotation=n;this.firstEdit=t||!1;this.init();window.addEventListener("resize",this.onResizeBinded);var i=this.textArea;window.requestAnimationFrame(function(){i.focus()})}};CLOUD.Extensions.AnnotationTextArea.prototype.inactive=function(){window.removeEventListener("resize",this.onResizeBinded);this.textAnnotation&&(this.textAnnotation=null,this.container.removeChild(this.textArea));this.style=null};CLOUD.Extensions.AnnotationTextArea.prototype.accept=function(){var r=parseFloat(this.textArea.style.left),u=parseFloat(this.textArea.style.top),n=parseFloat(this.textArea.style.width),t=parseFloat(this.textArea.style.height),i=this.getTextValues(),f={x:r+n*.5,y:u+t*.5},e={annotation:this.textAnnotation,firstEdit:this.firstEdit,style:this.style,position:f,width:n,height:t,text:i.text,lines:i.lines};this.editor.handleTextChange(e);this.inactive()};CLOUD.Extensions.AnnotationTextArea.prototype.getTextValuesByAnnotation=function(n){this.active(n,!1);var t=this.getTextValues();return this.inactive(),t};CLOUD.Extensions.AnnotationTextArea.prototype.getTextValues=function(){var n=this.textArea.value;return{text:n,lines:this.calcTextLines()}};CLOUD.Extensions.AnnotationTextArea.prototype.calcTextLines=function(){var o=this.textArea.value,r=o.split(/\r*\n/),n=CLOUD.DomUtil.cloneStyle(this.textAreaStyle),u,i,t,f,e;for(CLOUD.DomUtil.removeStyleAttribute(n,["top","left","width","height","overflow-y"]),n.position="absolute",n["white-space"]="nowrap",n.float="left",n.visibility="hidden",this.measurePanel.setAttribute("style",CLOUD.DomUtil.getStyleString(n)),this.container.appendChild(this.measurePanel),u=parseFloat(this.textArea.style.width),i=[],t=0,f=r.length;t<f;++t)e=CLOUD.DomUtil.trimRight(r[t]),this.splitLine(e,u,i);return this.container.removeChild(this.measurePanel),i};CLOUD.Extensions.AnnotationTextArea.prototype.getShorterLine=function(n){var t=n.lastIndexOf(" "),i,r;if(t===-1)return[n];while(n.charAt(t-1)===" ")t--;return i=n.substr(t),r=n.substr(0,t),[r,i]};CLOUD.Extensions.AnnotationTextArea.prototype.splitWord=function(n,t,i,r){for(var u=1,f,e,o,s;;){if(f=n.substr(0,u),this.measurePanel.innerHTML=f,e=this.measurePanel.clientWidth,e>i){if(u===1){r.push(f);this.splitWord(n.substr(1),t,i,r);return}o=n.substr(0,u-1);r.push(o);s=n.substr(u-1);this.splitLine(s+t,i,r);return}if(u++,u>n.length){r.push(n);return}}};CLOUD.Extensions.AnnotationTextArea.prototype.splitLine=function(n,t,i){var r,u,e,f;if(n!=="")for(r="",u=!1;!u;)this.measurePanel.innerHTML=n,e=this.measurePanel.clientWidth,e<=t?(i.push(n),this.splitLine(CLOUD.DomUtil.trimLeft(r),t,i),u=!0):(f=this.getShorterLine(n),f.length===1?(this.splitWord(n,r,t,i),u=!0):(n=f[0],r=f[1]+r))};CLOUD.Extensions.AnnotationFrame=function(n,t){this.editor=n;this.container=t;this.selection={x:0,y:0,width:0,height:0,rotation:0,element:null,active:!1,dragging:!1,resizing:!1,handle:{}};this.annotation=null;this.onResizeDownBinded=this.onResizeDown.bind(this);this.onDoubleClickBinded=this.onDoubleClick.bind(this);this.onRepositionDownBinded=this.onRepositionDown.bind(this);this.onRotationDownBinded=this.onRotationDown.bind(this);this.createFramePanel();this.addDomEventListeners()};CLOUD.Extensions.AnnotationFrame.prototype.addDomEventListeners=function(){this.framePanel.addEventListener("mousedown",this.onResizeDownBinded);this.framePanel.addEventListener("dblclick",this.onDoubleClickBinded);this.selection.element.addEventListener("mousedown",this.onRepositionDownBinded);this.selection.element.addEventListener("mousedown",this.onRotationDownBinded)};CLOUD.Extensions.AnnotationFrame.prototype.removeDomEventListeners=function(){this.framePanel.removeEventListener("mousedown",this.onResizeDownBinded);this.framePanel.removeEventListener("dblclick",this.onDoubleClickBinded);this.selection.element.removeEventListener("mousedown",this.onRepositionDownBinded);this.selection.element.removeEventListener("mousedown",this.onRotationDownBinded)};CLOUD.Extensions.AnnotationFrame.prototype.onMouseMove=function(){};CLOUD.Extensions.AnnotationFrame.prototype.onMouseUp=function(){};CLOUD.Extensions.AnnotationFrame.prototype.onRepositionDown=function(n){this.annotation&&(this.isDragPoint(n.target)||this.isRotatePoint(n.target)||(this.selection.dragging=!0,this.originMouse=this.editor.getPointOnDomContainer(n.clientX,n.clientY),this.originPosition=this.annotation.getClientPosition(),this.onMouseMove=this.onRepositionMove.bind(this),this.onMouseUp=this.onRepositionUp.bind(this),this.editor.dragAnnotationFrameBegin()))};CLOUD.Extensions.AnnotationFrame.prototype.onRepositionMove=function(n){var f;if(this.annotation&&this.selection.dragging){var t=this.editor.getPointOnDomContainer(n.clientX,n.clientY),i={x:t.x-this.originMouse.x,y:t.y-this.originMouse.y},r=this.originPosition.x+i.x,u=this.originPosition.y+i.y;this.updatePosition(r,u,this.selection.rotation);f=this.editor.getAnnotationWorldPosition({x:r,y:u});this.annotation.resetPosition(f)}};CLOUD.Extensions.AnnotationFrame.prototype.onRepositionUp=function(){(this.onMouseMove=function(){},this.onMouseUp=function(){},this.selection.dragging)&&(this.selection.dragging=!1,this.editor.dragAnnotationFrameEnd())};CLOUD.Extensions.AnnotationFrame.prototype.onResizeDown=function(n){var t,i;if(this.annotation&&(t=n.target,this.isDragPoint(t))){this.selection.resizing=!0;this.selection.handle.resizingPanel=t;i=this.selection.handle.resizingPanel.getAttribute("data-drag-point");this.container.style.cursor=i+"-resize";var r=this.editor.getPointOnDomContainer(n.clientX,n.clientY),u=this.annotation.getClientPosition(),f=this.annotation.getClientSize();this.origin={x:u.x,y:u.y,width:f.width,height:f.height,mouseX:r.x,mouseY:r.y};this.onMouseMove=this.onResizeMove.bind(this);this.onMouseUp=this.onResizeUp.bind(this);this.editor.dragAnnotationFrameBegin()}};CLOUD.Extensions.AnnotationFrame.prototype.onResizeMove=function(n){if(this.annotation&&this.selection.resizing){var e=this.editor.getPointOnDomContainer(n.clientX,n.clientY),i=this.origin,t={x:e.x-i.mouseX,y:e.y-i.mouseY},h=new THREE.Vector3(t.x,t.y,0),c=(new THREE.Matrix4).makeRotationZ(-this.selection.rotation);t=h.applyMatrix4(c);var l=i.x,a=i.y,u=i.width,f=i.height,r=new THREE.Vector3,v=this.selection.handle.resizingPanel.getAttribute("data-drag-point"),y={n:function(){f-=t.y;r.y=t.y},s:function(){f+=t.y;r.y=t.y},w:function(){u-=t.x;r.x=t.x},e:function(){u+=t.x;r.x=t.x},nw:function(){this.n();this.w()},ne:function(){this.n();this.e()},sw:function(){this.s();this.w()},se:function(){this.s();this.e()}};y[v]();var p=(new THREE.Matrix4).makeRotationZ(this.selection.rotation),o=r.applyMatrix4(p),s={x:l+o.x*.5,y:a+o.y*.5},w={width:u,height:f},b=this.editor.getAnnotationWorldPosition(s),k=this.editor.getAnnotationWorldSize(w,s);this.annotation.resetSize(k,b)}};CLOUD.Extensions.AnnotationFrame.prototype.onResizeUp=function(){this.onMouseMove=function(){};this.onMouseUp=function(){};this.selection.resizing=!1;this.selection.handle.resizingPanel=null;this.container.style.cursor="";this.editor.dragAnnotationFrameEnd()};CLOUD.Extensions.AnnotationFrame.prototype.onRotationDown=function(n){this.annotation&&this.isRotatePoint(n.target)&&(this.selection.rotating=!0,this.originPosition=this.editor.getPointOnDomContainer(n.clientX,n.clientY),this.originRotation=this.selection.rotation||0,this.onMouseMove=this.onRotationMove.bind(this),this.onMouseUp=this.onRotationUp.bind(this),this.editor.dragAnnotationFrameBegin())};CLOUD.Extensions.AnnotationFrame.prototype.onRotationMove=function(n){if(this.annotation&&this.selection.rotating){var r=this.editor.getPointOnDomContainer(n.clientX,n.clientY),t=this.annotation.getClientPosition(),u=CLOUD.Extensions.Utils.Geometric.getAngleBetweenPoints(t,r),f=CLOUD.Extensions.Utils.Geometric.getAngleBetweenPoints(t,this.originPosition),i=u-f+this.originRotation;this.updatePosition(this.selection.x,this.selection.y,i);this.annotation.resetRotation(i)}};CLOUD.Extensions.AnnotationFrame.prototype.onRotationUp=function(){this.onMouseMove=function(){};this.onMouseUp=function(){};this.selection.rotating=!1;this.originRotation=null;this.originPosition=null;this.editor.dragAnnotationFrameEnd()};CLOUD.Extensions.AnnotationFrame.prototype.onDoubleClick=function(n){if(this.selection.dragging=!1,this.annotation)this.editor.onMouseDoubleClick(n,this.annotation)};CLOUD.Extensions.AnnotationFrame.prototype.destroy=function(){this.removeDomEventListeners()};CLOUD.Extensions.AnnotationFrame.prototype.createFramePanel=function(){var t=this,i=function(){var n=document.createElement("div");return n.style.position="absolute",n.style.top=0,n.style.bottom=0,n.style.left=0,n.style.right=0,n.style.overflow="hidden",n.style.visibility="hidden",n.style.pointerEvents="none",n},r=function(n){var i=2,r=n/2+i,t=document.createElement("div");return t.style.position="absolute",t.style.backgroundColor="aqua",t.style.border=i+"px solid rgb(95, 98, 100)",t.style.height=n+"px",t.style.width=n+"px",t.style.borderRadius=r+"px",t.style.boxSizing="border-box",t.classList.add("select-rotate-point"),t.style.top="-25px",t.style.left="50%",t.style.transform="translate3d(-50%, 0px, 0px)",t},u=function(){var n=document.createElement("div");return n.style.position="absolute",n.style.border="1px solid rgb(0, 0, 255)",n.style.zIndex=1,n.style.cursor="move",n.style.boxSizing="border-box",n.style.pointerEvents="auto",n.classList.add("drag-box"),n},f=function(n,t){var f=2,u=(n+f)/-2,r,i=document.createElement("div");i.style.position="absolute";i.style.backgroundColor="rgba(151, 151, 151, 1)";i.style.border=f+"px solid rgb(95, 98, 100)";i.style.height=n+"px";i.style.width=n+"px";i.style.borderRadius=n/2+f+"px";i.style.boxSizing="border-box";CLOUD.DomUtil.setCursorStyle(i,t);i.className="select-drag-point drag-point-"+t;i.setAttribute("data-drag-point",t);switch(t){case"n":r=document.createElement("div");r.style.position="absolute";r.style.width="100%";r.style.height=n+"px";r.style.top=u+"px";i.style.margin="0 auto";i.style.position="";r.appendChild(i);i=r;break;case"s":r=document.createElement("div");r.style.position="absolute";r.style.width="100%";r.style.height=n+"px";r.style.bottom=u+"px";i.style.margin="0 auto";i.style.position="";r.appendChild(i);i=r;break;case"w":i.style.left=u+"px";i.style.top="50%";i.style.transform="translate3d(0, -50%, 0)";break;case"e":i.style.right=u+"px";i.style.top="50%";i.style.transform="translate3d(0, -50%, 0)";break;case"nw":i.style.top=u+"px";i.style.left=u+"px";break;case"ne":i.style.top=u+"px";i.style.right=u+"px";break;case"sw":i.style.bottom=u+"px";i.style.left=u+"px";break;case"se":i.style.bottom=u+"px";i.style.right=u+"px"}return i},e=function(n){var i=12;["n","s","w","e","nw","ne","sw","se"].forEach(function(r){t.selection.handle[r]=f(i,r);n.appendChild(t.selection.handle[r])})},n;this.framePanel=i();this.container.appendChild(this.framePanel);n=u();e(n);this.selection.element=n;this.framePanel.appendChild(this.selection.element);this.selection.rotationPanel=r(12);n.appendChild(this.selection.rotationPanel);this.updateState(!1)};CLOUD.Extensions.AnnotationFrame.prototype.setSelection=function(n,t,i,r,u){this.updateDimensions(i,r);this.updatePosition(n,t,u);this.updateState(!0);this.framePanel.style.visibility="visible"};CLOUD.Extensions.AnnotationFrame.prototype.setAnnotation=function(n){if(!n){this.annotation&&(this.annotation=null,this.updateState(!1));return}var t=n.getClientSize(),i=n.getClientPosition(),r=n.rotation;this.annotation=n;this.setSelection(i.x-t.width/2,i.y-t.height/2,t.width,t.height,r);this.enableResize();this.enableRotation()};CLOUD.Extensions.AnnotationFrame.prototype.isActive=function(){return this.isDragging()||this.isResizing()||this.isRotating()};CLOUD.Extensions.AnnotationFrame.prototype.dragBegin=function(n){this.onRepositionDown(n)};CLOUD.Extensions.AnnotationFrame.prototype.isDragging=function(){return this.selection.dragging};CLOUD.Extensions.AnnotationFrame.prototype.isResizing=function(){return this.selection.resizing};CLOUD.Extensions.AnnotationFrame.prototype.isRotating=function(){return this.selection.rotating};CLOUD.Extensions.AnnotationFrame.prototype.enableResize=function(){var n,t;if(this.annotation.disableResizeHeight||this.annotation.disableResizeWidth){for(t in this.selection.handle)n=this.selection.handle[t],n&&(n.style.display="none");this.annotation.disableResizeHeight&&(this.selection.handle.w.style.display="block",this.selection.handle.e.style.display="block");this.annotation.disableResizeWidth&&(this.selection.handle.n.style.display="block",this.selection.handle.s.style.display="block")}else for(t in this.selection.handle)n=this.selection.handle[t],n&&(n.style.display="block")};CLOUD.Extensions.AnnotationFrame.prototype.enableRotation=function(){var n=this.annotation.disableRotation?"none":"block";this.selection.rotationPanel.style.display=n};CLOUD.Extensions.AnnotationFrame.prototype.updateDimensions=function(n,t){this.selection.width=n;this.selection.height=t;this.selection.element.style.width=n+"px";this.selection.element.style.height=t+"px"};CLOUD.Extensions.AnnotationFrame.prototype.updatePosition=function(n,t,i){var r=this.annotation.getClientSize();this.selection.x=n;this.selection.y=t;this.selection.rotation=i;this.selection.element.style.msTransform=CLOUD.DomUtil.toTranslate3d(n,t)+" rotate("+i+"rad)";this.selection.element.style.msTransformOrigin=r.width/2+"px "+r.height/2+"px";this.selection.element.style.webkitTransform=CLOUD.DomUtil.toTranslate3d(n,t)+" rotate("+i+"rad)";this.selection.element.style.webkitTransformOrigin=r.width/2+"px "+r.height/2+"px";this.selection.element.style.transform=CLOUD.DomUtil.toTranslate3d(n,t)+" rotate("+i+"rad)";this.selection.element.style.transformOrigin=r.width/2+"px "+r.height/2+"px"};CLOUD.Extensions.AnnotationFrame.prototype.updateState=function(n){this.selection.active=n;this.selection.element.style.display=n?"block":"none"};CLOUD.Extensions.AnnotationFrame.prototype.isDragPoint=function(n){return CLOUD.DomUtil.matchesSelector(n,".select-drag-point")};CLOUD.Extensions.AnnotationFrame.prototype.isRotatePoint=function(n){return CLOUD.DomUtil.matchesSelector(n,".select-rotate-point")};CLOUD=CLOUD||{};CLOUD.Extensions=CLOUD.Extensions||{};CLOUD.Extensions.AnnotationEditor=function(n){"use strict";this.domElement=n;this.annotations=[];this.selectedAnnotation=null;this.bounds={x:0,y:0,width:0,height:0};this.keys={BACKSPACE:8,ALT:18,ESC:27,LEFT:37,UP:38,RIGHT:39,BOTTOM:40,DELETE:46,ZERO:48,A:65,D:68,E:69,Q:81,S:83,W:87,PLUS:187,SUB:189};this.isEditing=!1;this.originX=0;this.originY=0;this.isCreating=!1;this.beginEditCallback=null;this.endEditCallback=null;this.changeEditorModeCallback=null;this.annotationType=CLOUD.Extensions.Annotation.shapeTypes.ARROW;this.nextAnnotationId=0;this.annotationMinLen=16;this.initialized=!1;this.epsilon=.0001;this.annotationStyle=null;this.isDblClickCloseCloud=!0;this.mouseButtons={LEFT:0,MIDDLE:1,RIGHT:2};this.onContextMenuBinded=this.onContextMenu.bind(this);this.onMouseDownBinded=this.onMouseDown.bind(this);this.onMouseDoubleClickBinded=this.onMouseDoubleClick.bind(this);this.onMouseMoveBinded=this.onMouseMove.bind(this);this.onMouseUpBinded=this.onMouseUp.bind(this);this.onKeyDownBinded=this.onKeyDown.bind(this);this.onKeyUpBinded=this.onKeyUp.bind(this);this.onTouchStartBinded=this.onTouchStart.bind(this);this.onTouchMoveBinded=this.onTouchMove.bind(this);this.onTouchEndBinded=this.onTouchEnd.bind(this)};CLOUD.Extensions.AnnotationEditor.prototype.addDomEventListeners=function(){this.svg&&(this.svg.addEventListener("mousedown",this.onMouseDownBinded,!1),this.svg.addEventListener("touchstart",this.onTouchStartBinded,!1),this.svg.addEventListener("dblclick",this.onMouseDoubleClickBinded,!1),this.svg.addEventListener("contextmenu",this.onContextMenuBinded,!1),window.addEventListener("mousemove",this.onMouseMoveBinded,!1),window.addEventListener("mouseup",this.onMouseUpBinded,!1),window.addEventListener("touchmove",this.onTouchMoveBinded,!1),window.addEventListener("touchend",this.onTouchEndBinded,!1),window.addEventListener("keydown",this.onKeyDownBinded,!1),window.addEventListener("keyup",this.onKeyUpBinded,!1),this.onFocus())};CLOUD.Extensions.AnnotationEditor.prototype.removeDomEventListeners=function(){this.svg&&(this.svg.removeEventListener("mousedown",this.onMouseDownBinded,!1),this.svg.removeEventListener("touchstart",this.onTouchStartBinded,!1),this.svg.removeEventListener("dblclick",this.onMouseDoubleClickBinded,!1),this.svg.removeEventListener("contextmenu",this.onContextMenuBinded,!1),window.removeEventListener("mousemove",this.onMouseMoveBinded,!1),window.removeEventListener("mouseup",this.onMouseUpBinded,!1),window.removeEventListener("touchmove",this.onTouchMoveBinded,!1),window.removeEventListener("touchend",this.onTouchEndBinded,!1),window.removeEventListener("keydown",this.onKeyDownBinded,!1),window.removeEventListener("keyup",this.onKeyUpBinded,!1))};CLOUD.Extensions.AnnotationEditor.prototype.onFocus=function(){this.svg&&this.svg.focus()};CLOUD.Extensions.AnnotationEditor.prototype.onContextMenu=function(n){n.preventDefault()};CLOUD.Extensions.AnnotationEditor.prototype.onMouseDown=function(n){if(n.preventDefault(),n.stopPropagation(),n.button===this.mouseButtons.LEFT){if(this.annotationFrame.isActive()){this.annotationFrame.setAnnotation(this.selectedAnnotation);return}this.handleEvent(n,"down");this.isCreating||n.target!==this.svg||this.selectAnnotation(null)}};CLOUD.Extensions.AnnotationEditor.prototype.onMouseMove=function(n){if(n.stopPropagation(),n.button===this.mouseButtons.LEFT){if(this.annotationFrame.isActive()){this.annotationFrame.onMouseMove(n);this.annotationFrame.setAnnotation(this.selectedAnnotation);return}this.handleEvent(n,"move")}};CLOUD.Extensions.AnnotationEditor.prototype.onMouseUp=function(n){if(n.stopPropagation(),this.annotationFrame.isActive()){this.annotationFrame.onMouseUp(n);return}this.selectedAnnotation&&this.isCreating&&this.handleEvent(n,"up")};CLOUD.Extensions.AnnotationEditor.prototype.onTouchStart=function(n){if(n.preventDefault(),n.stopPropagation(),n.touches.length==1){if(this.annotationFrame.isActive()){this.annotationFrame.setAnnotation(this.selectedAnnotation);return}this.handleEvent(n,"start");this.isCreating||n.target!==this.svg||this.selectAnnotation(null)}};CLOUD.Extensions.AnnotationEditor.prototype.onTouchMove=function(n){if(n.stopPropagation(),n.touches.length==1){if(this.annotationFrame.isActive()){this.annotationFrame.onTouchMove(n);this.annotationFrame.setAnnotation(this.selectedAnnotation);return}this.handleEvent(n,"touchmove")}};CLOUD.Extensions.AnnotationEditor.prototype.onTouchEnd=function(n){if(n.stopPropagation(),this.annotationFrame.isActive()){this.annotationFrame.onTouchEnd(n);return}this.selectedAnnotation&&this.isCreating&&this.handleEvent(n,"end")};CLOUD.Extensions.AnnotationEditor.prototype.onMouseDoubleClick=function(n,t){(n.preventDefault(),n.stopPropagation(),this.isEditing)&&(this.isDblClickCloseCloud&&this.mouseDoubleClickForCloud(n),this.mouseDoubleClickForText(n,t))};CLOUD.Extensions.AnnotationEditor.prototype.onKeyDown=function(){};CLOUD.Extensions.AnnotationEditor.prototype.onKeyUp=function(n){if(this.isEditing)switch(n.keyCode){case this.keys.DELETE:this.selectedAnnotation&&(this.selectedAnnotation.delete(),this.selectedAnnotation=null,this.deselectAnnotation());break;case this.keys.ESC:this.annotationType===CLOUD.Extensions.Annotation.shapeTypes.CLOUD&&(this.selectedAnnotation.finishTrack(),this.selectedAnnotation.setSeal(!1),this.createAnnotationEnd(),this.deselectAnnotation());this.forceAnnotationTextComplete()}};CLOUD.Extensions.AnnotationEditor.prototype.onResize=function(){var n=this.getDomContainerBounds();this.bounds.x=0;this.bounds.y=0;this.bounds.width=n.width;this.bounds.height=n.height;this.svg.setAttribute("width",this.bounds.width+"");this.svg.setAttribute("height",this.bounds.height+"");this.updateAnnotations()};CLOUD.Extensions.AnnotationEditor.prototype.handleEvent=function(n,t){var i=this.annotationType;if(t!=="down"&&t!=="start"||!this.forceAnnotationTextComplete())switch(i){case CLOUD.Extensions.Annotation.shapeTypes.RECTANGLE:t==="down"?this.startRectangle(n.clientX,n.clientY)&&this.createAnnotationBegin():t==="start"?this.startRectangle(n.touches[0].clientX,n.touches[0].clientY)&&this.createAnnotationBegin():t==="move"?this.moveRectangle(n.clientX,n.clientY):t==="touchmove"?this.moveRectangle(n.touches[0].clientX,n.touches[0].clientY):(t==="up"||t==="end")&&(this.createAnnotationEnd(),this.deselectAnnotation());break;case CLOUD.Extensions.Annotation.shapeTypes.CIRCLE:t==="down"?this.startCircle(n.clientX,n.clientY)&&this.createAnnotationBegin():t==="start"?this.startCircle(n.touches[0].clientX,n.touches[0].clientY)&&this.createAnnotationBegin():t==="move"?this.moveCircle(n.clientX,n.clientY):t==="touchmove"?this.moveCircle(n.touches[0].clientX,n.touches[0].clientY):(t==="up"||t==="end")&&(this.createAnnotationEnd(),this.deselectAnnotation());break;case CLOUD.Extensions.Annotation.shapeTypes.CROSS:t==="down"?this.startCross(n.clientX,n.clientY)&&this.createAnnotationBegin():t==="start"?this.startCross(n.touches[0].clientX,n.touches[0].clientY)&&this.createAnnotationBegin():t==="move"?this.moveCross(n.clientX,n.clientY):t==="touchmove"?this.moveCross(n.touches[0].clientX,n.touches[0].clientY):(t==="up"||t==="end")&&(this.createAnnotationEnd(),this.deselectAnnotation());break;case CLOUD.Extensions.Annotation.shapeTypes.CLOUD:t==="down"?this.startCloud(n.clientX,n.clientY)&&this.createAnnotationBegin():t==="start"?this.startCloud(n.touches[0].clientX,n.touches[0].clientY)&&this.createAnnotationBegin():t==="move"?this.moveCloud(n.clientX,n.clientY):t==="touchmove"?this.moveCloud(n.touches[0].clientX,n.touches[0].clientY):(t==="up"||t==="end")&&this.endCloud(n,t);break;case CLOUD.Extensions.Annotation.shapeTypes.TEXT:t==="down"?this.startText(n.clientX,n.clientY):t==="start"&&this.startText(n.touches[0].clientX,n.touches[0].clientY);break;case CLOUD.Extensions.Annotation.shapeTypes.ARROW:default:t==="down"?this.startArrow(n.clientX,n.clientY)&&this.createAnnotationBegin():t==="start"?this.startArrow(n.touches[0].clientX,n.touches[0].clientY)&&this.createAnnotationBegin():t==="move"?this.moveArrow(n.clientX,n.clientY):t==="touchmove"?this.moveArrow(n.touches[0].clientX,n.touches[0].clientY):(t==="up"||t==="end")&&(this.createAnnotationEnd(),this.deselectAnnotation())}};CLOUD.Extensions.AnnotationEditor.prototype.startArrow=function(n,t){var f,o,r;if(this.selectedAnnotation)return!1;f=this.getPointOnDomContainer(n,t);this.originX=f.x;this.originY=f.y;var e=this.annotationMinLen,i={x:this.originX,y:this.originY},u={x:Math.round(i.x+Math.cos(Math.PI*.25)*e),y:Math.round(i.y+Math.sin(-Math.PI*.25)*e)},s=function(n,t,i,r){CLOUD.Extensions.Utils.Geometric.isInsideBounds(t.x,t.y,r)||(t.y=Math.round(n.y+Math.sin(Math.PI*.25)*i),CLOUD.Extensions.Utils.Geometric.isInsideBounds(t.x,t.y,r))||(t.x=Math.round(n.y+Math.cos(-Math.PI*.25)*i),CLOUD.Extensions.Utils.Geometric.isInsideBounds(t.x,t.y,r))||(t.y=Math.round(n.y+Math.sin(-Math.PI*.25)*i))};return s(i,u,e,this.getBounds()),u=this.getAnnotationWorldPosition(u),i=this.getAnnotationWorldPosition(i),o=this.generateAnnotationId(),r=new CLOUD.Extensions.AnnotationArrow(this,o),r.setByTailHead(i,u),this.addAnnotation(r),r.created(),this.selectedAnnotation=r,!0};CLOUD.Extensions.AnnotationEditor.prototype.moveArrow=function(n,t){var s,h,r,u;if(this.selectedAnnotation&&this.isCreating){var f=this.selectedAnnotation,o=this.getPointOnDomContainer(n,t),i=this.getBounds(),e=this.originX,c=this.originY,l=o.x-e;Math.abs(l)<this.annotationMinLen&&(o.x=l>0?e+this.annotationMinLen:e-this.annotationMinLen);s=Math.min(Math.max(i.x,o.x),i.x+i.width);h=Math.min(Math.max(i.y,o.y),i.y+i.height);s===e&&h===c&&(s++,h++);r={x:e,y:c};u={x:s,y:h};r=this.getAnnotationWorldPosition(r);u=this.getAnnotationWorldPosition(u);(Math.abs(f.head.x-u.x)>=this.epsilon||Math.abs(f.head.y-u.y)>=this.epsilon||Math.abs(f.tail.x-r.x)>=this.epsilon||Math.abs(f.tail.y-r.y)>=this.epsilon)&&f.setByTailHead(r,u)}};CLOUD.Extensions.AnnotationEditor.prototype.startRectangle=function(n,t){var i,u;if(this.selectedAnnotation)return!1;i=this.getPointOnDomContainer(n,t);u=this.annotationMinLen;this.originX=i.x;this.originY=i.y;var f={x:i.x,y:i.y},e={width:u,height:u},o=this.getAnnotationWorldPosition(f),s=this.getAnnotationWorldSize(e,f),h=this.generateAnnotationId(),r=new CLOUD.Extensions.AnnotationRectangle(this,h);return r.set(o,s,0),this.addAnnotation(r),r.created(),this.selectedAnnotation=r,!0};CLOUD.Extensions.AnnotationEditor.prototype.moveRectangle=function(n,t){if(this.selectedAnnotation&&this.isCreating){var r=this.selectedAnnotation,c=this.getPointOnDomContainer(n,t),i=this.getBounds(),e=this.originX,o=this.originY,u=Math.min(Math.max(i.x,c.x),i.x+i.width),f=Math.min(Math.max(i.y,c.y),i.y+i.height);u===e&&f===o&&(u++,f++);var l={x:(e+u)/2,y:(o+f)/2},a={width:Math.abs(u-e),height:Math.abs(f-o)},s=this.getAnnotationWorldPosition(l),h=this.getAnnotationWorldSize(a,l);(Math.abs(r.position.x-s.x)>this.epsilon||Math.abs(r.size.y-h.y)>this.epsilon||Math.abs(r.position.y-s.y)>this.epsilon||Math.abs(r.size.y-h.y)>this.epsilon)&&r.set(s,h)}};CLOUD.Extensions.AnnotationEditor.prototype.startCircle=function(n,t){var i;if(this.selectedAnnotation)return!1;i=this.getPointOnDomContainer(n,t);this.originX=i.x;this.originY=i.y;var u=this.annotationMinLen,f={x:i.x,y:i.y},e={width:u,height:u},o=this.getAnnotationWorldPosition(f),s=this.getAnnotationWorldSize(e,f),h=this.generateAnnotationId(),r=new CLOUD.Extensions.AnnotationCircle(this,h);return r.set(o,s,0),this.addAnnotation(r),r.created(),this.selectedAnnotation=r,!0};CLOUD.Extensions.AnnotationEditor.prototype.moveCircle=function(n,t){if(this.selectedAnnotation&&this.isCreating){var r=this.selectedAnnotation,c=this.getPointOnDomContainer(n,t),i=this.getBounds(),e=this.originX,o=this.originY,u=Math.min(Math.max(i.x,c.x),i.x+i.width),f=Math.min(Math.max(i.y,c.y),i.y+i.height);u===e&&f===o&&(u++,f++);var l={x:(e+u)/2,y:(o+f)/2},a={width:Math.abs(u-e),height:Math.abs(f-o)},s=this.getAnnotationWorldPosition(l),h=this.getAnnotationWorldSize(a,l);(Math.abs(r.position.x-s.x)>this.epsilon||Math.abs(r.size.y-h.y)>this.epsilon||Math.abs(r.position.y-s.y)>this.epsilon||Math.abs(r.size.y-h.y)>this.epsilon)&&r.set(s,h)}};CLOUD.Extensions.AnnotationEditor.prototype.startCross=function(n,t){var i;if(this.selectedAnnotation)return!1;i=this.getPointOnDomContainer(n,t);this.originX=i.x;this.originY=i.y;var u=this.annotationMinLen,f={x:i.x,y:i.y},e={width:u,height:u},o=this.getAnnotationWorldPosition(f),s=this.getAnnotationWorldSize(e,f),h=this.generateAnnotationId(),r=new CLOUD.Extensions.AnnotationCross(this,h);return r.set(o,s,0),this.addAnnotation(r),r.created(),this.selectedAnnotation=r,!0};CLOUD.Extensions.AnnotationEditor.prototype.moveCross=function(n,t){if(this.selectedAnnotation&&this.isCreating){var r=this.selectedAnnotation,c=this.getPointOnDomContainer(n,t),i=this.getBounds(),e=this.originX,o=this.originY,u=Math.min(Math.max(i.x,c.x),i.x+i.width),f=Math.min(Math.max(i.y,c.y),i.y+i.height);u===e&&f===o&&(u++,f++);var l={x:(e+u)/2,y:(o+f)/2},a={width:Math.abs(u-e),height:Math.abs(f-o)},s=this.getAnnotationWorldPosition(l),h=this.getAnnotationWorldSize(a,l);(Math.abs(r.position.x-s.x)>this.epsilon||Math.abs(r.size.y-h.y)>this.epsilon||Math.abs(r.position.y-s.y)>this.epsilon||Math.abs(r.size.y-h.y)>this.epsilon)&&r.set(s,h)}};CLOUD.Extensions.AnnotationEditor.prototype.startCloud=function(n,t){var r,u,f,i;return this.selectedAnnotation?!1:(r=this.getPointOnDomContainer(n,t),this.originX=r.x,this.originY=r.y,u=this.getAnnotationWorldPosition({x:r.x,y:r.y}),this.cloudPoints=[u],f=this.generateAnnotationId(),i=new CLOUD.Extensions.AnnotationCloud(this,f),i.setByPositions(this.cloudPoints),i.created(),i.enableTrack(),this.addAnnotation(i),this.selectedAnnotation=i,!0)};CLOUD.Extensions.AnnotationEditor.prototype.moveCloud=function(n,t){var i,r,u;this.selectedAnnotation&&this.isCreating&&(i=this.selectedAnnotation,i.getTrackState()&&(r=this.getPointOnDomContainer(n,t),u=this.getAnnotationWorldPosition(r),i.startTrack(),i.setTrackingPoint(u)))};CLOUD.Extensions.AnnotationEditor.prototype.endCloud=function(n,t){var u,i,f;if(n.button===this.mouseButtons.LEFT||n.touches&&n.touches.length===0){if(!this.selectedAnnotation||!this.isCreating)return;var r=t==="up"?this.getPointOnDomContainer(n.clientX,n.clientY):this.getPointOnDomContainer(n.touches[0].clientX,n.touches[0].clientY),o={x:this.originX,y:this.originY},s=2;if(CLOUD.Extensions.Utils.Geometric.isEqualBetweenPoints(o,r,s))return;u=this.getAnnotationWorldPosition({x:r.x,y:r.y});this.cloudPoints.push(u);i=this.selectedAnnotation;i.disableTrack();f=this.cloudPoints;function e(){i.finishTrack();i.setByPositions(f);i.enableTrack()}this.isDblClickCloseCloud?(this.timerId&&clearTimeout(this.timerId),this.timerId=setTimeout(e,300)):e()}else n.button===this.mouseButtons.RIGHT&&this.mouseDoubleClickForCloud(n)};CLOUD.Extensions.AnnotationEditor.prototype.mouseDoubleClickForCloud=function(n){if(this.isCreating&&this.selectedAnnotation&&this.selectedAnnotation.shapeType===CLOUD.Extensions.Annotation.shapeTypes.CLOUD){this.isDblClickCloseCloud&&this.timerId&&clearTimeout(this.timerId);var i=this.getPointOnDomContainer(n.clientX,n.clientY),t=this.getAnnotationWorldPosition(i);this.cloudPoints.push({x:t.x,y:t.y});this.selectedAnnotation.finishTrack();this.selectedAnnotation.setByPositions(this.cloudPoints,!0);this.createAnnotationEnd();this.deselectAnnotation()}};CLOUD.Extensions.AnnotationEditor.prototype.startText=function(n,t){if(!this.selectedAnnotation){var r=this.getPointOnDomContainer(n,t),u=16,f=u*20,e=u*4,o={x:r.x+.5*f,y:r.y+.5*e},s={width:f,height:e},h=this.getAnnotationWorldPosition(o),c=this.getAnnotationWorldSize(s,o),l=this.generateAnnotationId(),i=this.currentAnnotationText=new CLOUD.Extensions.AnnotationText(this,l);return i.set(h,c,0,""),this.addAnnotation(i),i.created(),i.forceRedraw(),this.selectedAnnotation=i,this.annotationTextArea.active(this.selectedAnnotation,!0),!0}};CLOUD.Extensions.AnnotationEditor.prototype.mouseDoubleClickForText=function(n,t){t&&this.selectedAnnotation&&this.selectedAnnotation.shapeType===CLOUD.Extensions.Annotation.shapeTypes.TEXT&&(this.currentAnnotationText=t,this.selectedAnnotation.hide(),this.deselectAnnotation(),this.annotationTextArea.active(t,!1))};CLOUD.Extensions.AnnotationEditor.prototype.init=function(n){if(n&&(this.beginEditCallback=n.beginEditCallback,this.endEditCallback=n.endEditCallback,this.changeEditorModeCallback=n.changeEditorModeCallback),!this.svg){var t=this.getDomContainerBounds();this.bounds.width=t.width;this.bounds.height=t.height;this.svg=CLOUD.Extensions.Utils.Shape2D.createSvgElement("svg");this.svg.style.position="absolute";this.svg.style.display="block";this.svg.style.left="0";this.svg.style.top="0";this.svg.setAttribute("width",t.width+"");this.svg.setAttribute("height",t.height+"");this.domElement.appendChild(this.svg);this.enableSVGPaint(!1);this.annotationFrame=new CLOUD.Extensions.AnnotationFrame(this,this.domElement);this.annotationTextArea=new CLOUD.Extensions.AnnotationTextArea(this,this.domElement)}this.initialized=!0};CLOUD.Extensions.AnnotationEditor.prototype.uninit=function(){(this.initialized=!1,this.svg)&&(this.isEditing&&this.editEnd(),this.unloadAnnotations(),this.svg.parentNode&&this.svg.parentNode.removeChild(this.svg),this.svgGroup=null,this.svg=null,this.beginEditCallback=null,this.endEditCallback=null,this.changeEditorModeCallback=null)};CLOUD.Extensions.AnnotationEditor.prototype.isInitialized=function(){return this.initialized};CLOUD.Extensions.AnnotationEditor.prototype.destroy=function(){this.forceAnnotationTextComplete();this.deselectAnnotation();this.annotationFrame&&(this.annotationFrame.destroy(),this.annotationFrame=null);this.currentAnnotationText&&(this.currentAnnotationText=null)};CLOUD.Extensions.AnnotationEditor.prototype.generateAnnotationId=function(){return++this.nextAnnotationId,this.nextAnnotationId.toString(10)};CLOUD.Extensions.AnnotationEditor.prototype.onExistEditor=function(){this.uninit()};CLOUD.Extensions.AnnotationEditor.prototype.editBegin=function(){if(this.isEditing)return!0;this.svgGroup||(this.svgGroup=CLOUD.Extensions.Utils.Shape2D.createSvgElement("g"));this.svgGroup.parentNode||this.svg.insertBefore(this.svgGroup,this.svg.firstChild);this.handleCallbacks("beginEdit");this.addDomEventListeners();this.enableSVGPaint(!0);this.clear();this.isEditing=!0};CLOUD.Extensions.AnnotationEditor.prototype.editEnd=function(){this.isEditing=!1;this.forceAnnotationTextComplete();this.svgGroup&&this.svgGroup.parentNode&&this.svgGroup.parentNode.removeChild(this.svgGroup);this.removeDomEventListeners();this.handleCallbacks("endEdit");this.enableSVGPaint(!1);this.deselectAnnotation()};CLOUD.Extensions.AnnotationEditor.prototype.createAnnotationBegin=function(){this.isCreating||(this.isCreating=!0,this.disableAnnotationInteractions(!0))};CLOUD.Extensions.AnnotationEditor.prototype.createAnnotationEnd=function(){this.isCreating&&(this.isCreating=!1,this.disableAnnotationInteractions(!1))};CLOUD.Extensions.AnnotationEditor.prototype.dragAnnotationFrameBegin=function(){this.disableAnnotationInteractions(!0)};CLOUD.Extensions.AnnotationEditor.prototype.dragAnnotationFrameEnd=function(){this.disableAnnotationInteractions(!1)};CLOUD.Extensions.AnnotationEditor.prototype.clear=function(){for(var i=this.annotations,t,n;i.length;)t=i[0],this.removeAnnotation(t),t.destroy();if(n=this.svgGroup,n&&n.childNodes.length>0)while(n.childNodes.length)n.removeChild(n.childNodes[0])};CLOUD.Extensions.AnnotationEditor.prototype.setAnnotationType=function(n){this.forceAnnotationTextComplete();this.annotationType=n;this.createAnnotationEnd();this.deselectAnnotation();this.onFocus()};CLOUD.Extensions.AnnotationEditor.prototype.addAnnotation=function(n){n.setParent(this.svgGroup);this.annotations.push(n)};CLOUD.Extensions.AnnotationEditor.prototype.deleteAnnotation=function(n){n&&(this.removeAnnotation(n),n.destroy())};CLOUD.Extensions.AnnotationEditor.prototype.removeAnnotation=function(n){var t=this.annotations.indexOf(n);t!==-1&&this.annotations.splice(t,1)};CLOUD.Extensions.AnnotationEditor.prototype.setAnnotationSelection=function(n){this.selectedAnnotation!==n&&this.deselectAnnotation();this.selectedAnnotation=n;this.isCreating||this.annotationFrame.setAnnotation(n)};CLOUD.Extensions.AnnotationEditor.prototype.selectAnnotation=function(n){if(n)if(this.annotationType===n.shapeType)this.setAnnotationSelection(n);else{var t=n.shapeType;this.setAnnotationSelection(null);this.setAnnotationSelection(n)}else this.setAnnotationSelection(null)};CLOUD.Extensions.AnnotationEditor.prototype.deselectAnnotation=function(){this.selectedAnnotation&&(this.selectedAnnotation.deselect(),this.selectedAnnotation=null);this.annotationFrame.setAnnotation(null)};CLOUD.Extensions.AnnotationEditor.prototype.worldToClient=function(n){return new THREE.Vector3(n.x,n.y,n.z)};CLOUD.Extensions.AnnotationEditor.prototype.clientToWorld=function(n){return new THREE.Vector3(n.x,n.y,0)};CLOUD.Extensions.AnnotationEditor.prototype.getAnnotationWorldPosition=function(n){return this.clientToWorld(n)};CLOUD.Extensions.AnnotationEditor.prototype.getAnnotationClientPosition=function(n){return this.worldToClient(n)};CLOUD.Extensions.AnnotationEditor.prototype.getAnnotationWorldSize=function(n,t){var i=this.clientToWorld({x:t.x-.5*n.width,y:t.y-.5*n.height}),r=this.clientToWorld({x:t.x+.5*n.width,y:t.y+.5*n.height});return{width:Math.abs(r.x-i.x),height:Math.abs(r.y-i.y)}};CLOUD.Extensions.AnnotationEditor.prototype.getAnnotationClientSize=function(n,t){var i=this.worldToClient({x:t.x-.5*n.width,y:t.y-.5*n.height,z:t.z}),r=this.worldToClient({x:t.x+.5*n.width,y:t.y+.5*n.height,z:t.z});return{width:Math.abs(r.x-i.x),height:Math.abs(r.y-i.y)}};CLOUD.Extensions.AnnotationEditor.prototype.getBounds=function(){return this.bounds};CLOUD.Extensions.AnnotationEditor.prototype.getPointOnDomContainer=function(n,t){var i=this.getDomContainerBounds();return new THREE.Vector2(n-i.left,t-i.top)};CLOUD.Extensions.AnnotationEditor.prototype.getDomContainerBounds=function(){return CLOUD.DomUtil.getContainerOffsetToClient(this.domElement)};CLOUD.Extensions.AnnotationEditor.prototype.getViewBox=function(n,t){var i=this.clientToWorld({x:0,y:0}),r=this.clientToWorld({x:n,y:t}),u=Math.min(i.x,r.x),f=Math.min(i.y,r.y),e=Math.max(i.x,r.x),o=Math.max(i.y,r.y);return[u,f,e-u,o-f].join(" ")};CLOUD.Extensions.AnnotationEditor.prototype.handleTextChange=function(n){var t=n.annotation;if(n.text===""){this.selectAnnotation(null);n.annotation.delete();return}var i={x:n.position.x,y:n.position.y},r={width:n.width,height:n.height},u=this.getAnnotationWorldPosition(i),f=this.getAnnotationWorldSize(r,i);t.resetSize(f,u);t.setText(n.text);this.createAnnotationEnd();this.deselectAnnotation()};CLOUD.Extensions.AnnotationEditor.prototype.disableAnnotationInteractions=function(n){this.annotations.forEach(function(t){t.disableInteractions(n)})};CLOUD.Extensions.AnnotationEditor.prototype.handleCallbacks=function(n){switch(n){case"beginEdit":this.beginEditCallback&&this.beginEditCallback(this.domElement);break;case"endEdit":this.endEditCallback&&this.endEditCallback(this.domElement);break;case"changeEditor":this.changeEditorModeCallback&&this.changeEditorModeCallback(this.domElement)}};CLOUD.Extensions.AnnotationEditor.prototype.renderToCanvas=function(n){this.annotations.forEach(function(t){n.save();t.renderToCanvas(n);n.restore()})};CLOUD.Extensions.AnnotationEditor.prototype.enableSVGPaint=function(n){n?this.svg&&this.svg.setAttribute("pointer-events","painted"):this.svg&&this.svg.setAttribute("pointer-events","none")};CLOUD.Extensions.AnnotationEditor.prototype.forceAnnotationTextComplete=function(){return this.annotationTextArea&&this.annotationTextArea.isActive()?(this.annotationTextArea.accept(),this.currentAnnotationText&&(this.currentAnnotationText=null),!0):!1};CLOUD.Extensions.AnnotationEditor.prototype.resetCurrentAnnotationText=function(){this.currentAnnotationText&&(this.currentAnnotationText=null)};CLOUD.Extensions.AnnotationEditor.prototype.getScreenSnapshot=function(n,t){var i=document.createElement("canvas"),o=this.getDomContainerBounds(),f,u,h;i.width=o.width;i.height=o.height;var r=i.getContext("2d"),e=this.gradientStartColor,s=this.gradientStopColor,c=this;return(e&&(s?(f=r.createLinearGradient(0,0,0,i.height),f.addColorStop(0,e),f.addColorStop(1,s),r.fillStyle=f):r.fillStyle=e,r.fillRect(0,0,i.width,i.height)),t&&n)?(u=new Image,u.onload=function(){r.drawImage(u,0,0);c.renderToCanvas(r);var n=i.toDataURL("image/png");i=r=null;t(n)},u.src=n,null):(n&&(u=new Image,u.src=n,r.drawImage(u,0,0)),this.renderToCanvas(r),h=i.toDataURL("image/png"),i=r=null,h)};CLOUD.Extensions.AnnotationEditor.prototype.setBackgroundColor=function(n,t){this.gradientStartColor=n;this.gradientStopColor=t};CLOUD.Extensions.AnnotationEditor.prototype.getAnnotationInfoList=function(){var i,t,e,n,r,u,f,o;for(this.forceAnnotationTextComplete(),this.createAnnotationEnd(),this.deselectAnnotation(),i=[],t=0,e=this.annotations.length;t<e;t++)n=this.annotations[t],r="",n.shapeType===CLOUD.Extensions.Annotation.shapeTypes.TEXT&&(r=encodeURIComponent(n.currText)),u="",f=null,n.shapeType===CLOUD.Extensions.Annotation.shapeTypes.CLOUD&&(u=n.getShapePoints(),f=n.originSize),o={id:n.id,shapeType:n.shapeType,position:n.position,size:n.size,rotation:n.rotation,shapePoints:u,originSize:f,style:n.style,text:r},i.push(o);return i};CLOUD.Extensions.AnnotationEditor.prototype.loadAnnotations=function(n){var v,y,s,h,c,l,a,o;for(this.svgGroup||(this.svgGroup=CLOUD.Extensions.Utils.Shape2D.createSvgElement("g")),this.clear(),this.svgGroup.parentNode||this.svg.insertBefore(this.svgGroup,this.svg.firstChild),v=0,y=n.length;v<y;v++){var t=n[v],i=t.id,p=t.shapeType,r=t.position,u=t.size,f=t.rotation,w=t.shapePoints,b=t.originSize,k=decodeURIComponent(t.text),e=t.style?t.style:this.annotationStyle;switch(p){case CLOUD.Extensions.Annotation.shapeTypes.ARROW:s=new CLOUD.Extensions.AnnotationArrow(this,i);s.set(r,u,f);s.setStyle(e);this.addAnnotation(s);s.created();break;case CLOUD.Extensions.Annotation.shapeTypes.RECTANGLE:h=new CLOUD.Extensions.AnnotationRectangle(this,i);h.set(r,u,f);h.setStyle(e);this.addAnnotation(h);h.created();break;case CLOUD.Extensions.Annotation.shapeTypes.CIRCLE:c=new CLOUD.Extensions.AnnotationCircle(this,i);c.set(r,u,f);c.setStyle(e);this.addAnnotation(c);c.created();break;case CLOUD.Extensions.Annotation.shapeTypes.CROSS:l=new CLOUD.Extensions.AnnotationCross(this,i);l.set(r,u,f);l.setStyle(e);this.addAnnotation(l);l.created();break;case CLOUD.Extensions.Annotation.shapeTypes.CLOUD:a=new CLOUD.Extensions.AnnotationCloud(this,i);a.set(r,u,f,w,b);a.setStyle(e);this.addAnnotation(a);a.created();break;case CLOUD.Extensions.Annotation.shapeTypes.TEXT:o=new CLOUD.Extensions.AnnotationText(this,i);o.set(r,u,f,k);o.setStyle(e);this.addAnnotation(o);o.created();o.forceRedraw()}}};CLOUD.Extensions.AnnotationEditor.prototype.unloadAnnotations=function(){this.clear();this.svgGroup&&this.svgGroup.parentNode&&this.svgGroup.parentNode.removeChild(this.svgGroup)};CLOUD.Extensions.AnnotationEditor.prototype.showAnnotations=function(){this.svgGroup&&this.svgGroup.setAttribute("visibility","visible")};CLOUD.Extensions.AnnotationEditor.prototype.hideAnnotations=function(){this.svgGroup&&this.svgGroup.setAttribute("visibility","hidden")};CLOUD.Extensions.AnnotationEditor.prototype.setAnnotationStyle=function(n,t){this.annotationStyle=CLOUD.DomUtil.cloneStyle(n);t&&this.currentAnnotationText&&(this.currentAnnotationText.updateStyle(n),this.annotationTextArea&&this.annotationTextArea.setStyle(n))};CLOUD.Extensions.AnnotationEditor.prototype.updateAnnotations=function(){for(var i,n=0,t=this.annotations.length;n<t;n++)i=this.annotations[n],i.update();this.annotationFrame&&this.selectedAnnotation&&this.annotationFrame.setAnnotation(this.selectedAnnotation)};CLOUD.Extensions.AnnotationEditor.prototype.onCameraChange=function(){};CLOUD.Extensions.AnnotationEditor.prototype.enableDblClickCloseCloud=function(n){this.isDblClickCloseCloud=n};CLOUD=CLOUD||{};CLOUD.Extensions=CLOUD.Extensions||{};CLOUD.Extensions.AnnotationEditor2D=function(n){"use strict";CLOUD.Extensions.AnnotationEditor.call(this,n);this.absoluteBasePoint=null;this.screenBasePoint=null;this.zoomFactor={x:1,y:1}};CLOUD.Extensions.AnnotationEditor2D.prototype=Object.create(CLOUD.Extensions.AnnotationEditor.prototype);CLOUD.Extensions.AnnotationEditor2D.prototype.constructor=CLOUD.Extensions.AnnotationEditor2D;CLOUD.Extensions.AnnotationEditor2D.prototype.setDomContainer=function(n){n&&(this.domElement=n)};CLOUD.Extensions.AnnotationEditor2D.prototype.setAbsoluteBasePoint=function(n){n&&(this.absoluteBasePoint||(this.absoluteBasePoint={}),this.absoluteBasePoint.x=n.x,this.absoluteBasePoint.y=n.y)};CLOUD.Extensions.AnnotationEditor2D.prototype.setScreenBasePoint=function(n){n&&(this.screenBasePoint||(this.screenBasePoint={}),this.screenBasePoint.x=n.x,this.screenBasePoint.y=n.y)};CLOUD.Extensions.AnnotationEditor2D.prototype.setZoomFactor=function(n,t){n=n||1;t=t||1;this.zoomFactor.x=n;this.zoomFactor.y=t};CLOUD.Extensions.AnnotationEditor2D.prototype.worldToClient=function(n){var u=this.getDomContainerBounds(),t=new THREE.Vector3,i=this.absoluteBasePoint,r=this.screenBasePoint;return this.absoluteBasePoint||(i={x:0,y:0}),this.screenBasePoint||(r={x:u.width*.5,y:u.height*.5}),t.x=(n.x-i.x)*this.zoomFactor.x+r.x,t.y=(-n.y-i.y)*this.zoomFactor.y+r.y,t.z=0,t};CLOUD.Extensions.AnnotationEditor2D.prototype.clientToWorld=function(n){var u=this.getDomContainerBounds(),t=new THREE.Vector3,f=1/this.zoomFactor.x,e=1/this.zoomFactor.y,i=this.absoluteBasePoint,r=this.screenBasePoint;return this.absoluteBasePoint||(i={x:0,y:0}),this.screenBasePoint||(r={x:u.width*.5,y:u.height*.5}),t.x=(n.x-r.x)*f+i.x,t.y=-((n.y-r.y)*e+i.y),t.z=0,t};CLOUD.Extensions.AnnotationEditor2D.prototype.onCameraChange=function(){this.handleCallbacks("changeEditor")};CLOUD.Extensions.AnnotationEditor2D.prototype.setSvgZIndex=function(n){n=n||18;this.svg&&(this.svg.style.zIndex=n)};CLOUD=CLOUD||{};CLOUD.Extensions=CLOUD.Extensions||{};CLOUD.Extensions.AnnotationEditor3D=function(n,t){"use strict";CLOUD.Extensions.AnnotationEditor.call(this,n);this.camera=t};CLOUD.Extensions.AnnotationEditor3D.prototype=Object.create(CLOUD.Extensions.AnnotationEditor.prototype);CLOUD.Extensions.AnnotationEditor3D.prototype.constructor=CLOUD.Extensions.AnnotationEditor3D;CLOUD.Extensions.AnnotationEditor3D.prototype.setDomContainer=function(n){n&&(this.domElement=n)};CLOUD.Extensions.AnnotationEditor3D.prototype.worldToClient=function(n){var r=this.getDomContainerBounds(),i=this.camera,t=new THREE.Vector3(n.x,n.y,n.z);return t.applyMatrix4(i.matrixWorld),t.sub(i.position),t.project(i),t.x=Math.floor(.5*(t.x+1)*r.width+.5),t.y=Math.floor(-.5*(t.y-1)*r.height+.5),t.z=0,t};CLOUD.Extensions.AnnotationEditor3D.prototype.clientToWorld=function(n){var r=this.getDomContainerBounds(),i=this.camera,t=new THREE.Vector3;return t.x=n.x/r.width*2-1,t.y=-n.y/r.height*2+1,t.z=0,t.unproject(i),t.add(i.position).applyMatrix4(i.matrixWorldInverse),t};CLOUD.Extensions.AnnotationEditor3D.prototype.onCameraChange=function(){this.camera.dirty&&this.handleCallbacks("changeEditor")};CLOUD.Extensions.Marker=function(n,t){this.id=n;this.editor=t;this.position=new THREE.Vector3;this.boundingBox=new THREE.Box3;this.shape=null;this.style=CLOUD.Extensions.Marker.getDefaultStyle();this.selected=!1;this.highlighted=!1;this.highlightColor="#000088";this.isDisableInteractions=!1;this.keys={BACKSPACE:8,ALT:18,ESC:27,LEFT:37,UP:38,RIGHT:39,BOTTOM:40,DELETE:46,ZERO:48,A:65,D:68,E:69,Q:81,S:83,W:87,PLUS:187,SUB:189};this.onMouseDownBinded=this.onMouseDown.bind(this);this.onKeyUpBinded=this.onKeyUp.bind(this)};CLOUD.Extensions.Marker.prototype={constructor:CLOUD.Extensions.Marker,addDomEventListeners:function(){this.shape.addEventListener("mousedown",this.onMouseDownBinded,!0);window.addEventListener("keyup",this.onKeyUpBinded)},removeDomEventListeners:function(){this.shape.removeEventListener("mousedown",this.onMouseDownBinded,!0);window.removeEventListener("keyup",this.onKeyUpBinded)},onMouseDown:function(n){n.preventDefault();n.stopPropagation();this.select()},onKeyUp:function(n){switch(n.keyCode){case this.keys.DELETE:this.editor.deselectMarker();this.delete()}},createShape:function(){},destroy:function(){this.removeDomEventListeners();this.deselect();this.setParent(null)},set:function(n,t,i,r){this.userId=n;this.position.set(t.x,t.y,t.z);this.boundingBox=i.clone();r&&(this.style=CLOUD.DomUtil.cloneStyle(r));this.update()},setParent:function(n){var t=this.shape;t&&(t.parentNode&&t.parentNode.removeChild(t),n&&n.appendChild(t))},setStyle:function(n){this.style=CLOUD.DomUtil.cloneStyle(n);this.update()},select:function(){this.selected||(this.selected=!0,this.highlight(!0));this.editor.selectMarker(this)},deselect:function(){this.highlight(!1);this.selected=!1},highlight:function(n){this.isDisableInteractions||(this.highlighted=n,this.update())},disableInteractions:function(n){this.isDisableInteractions=n},"delete":function(){this.editor.deleteMarker(this)},getClientPosition:function(){return this.editor.worldToClient(this.position)},getBoundingBox:function(){return this.boundingBox},toNewObject:function(){return{id:this.id,userId:this.userId,shapeType:this.shapeType,position:this.position?this.position.clone():null,boundingBox:this.boundingBox?this.boundingBox.clone():null}},update:function(){var t=this.style["stroke-width"],i=this.highlighted?this.highlightColor:this.style["stroke-color"],r=this.style["stroke-opacity"],u=this.style["fill-color"],f=this.style["fill-opacity"],n=this.getClientPosition();if(!n){this.shape.style.display="none";return}this.shape.style.display!==""&&(this.shape.style.display="");var e=n.x,o=n.y,s=["translate(",e,",",o,") "].join("");this.shape.setAttribute("transform",s);this.shape.setAttribute("stroke-width",t);this.shape.setAttribute("stroke",i);this.shape.setAttribute("stroke-opacity",r);this.shape.setAttribute("fill",u);this.shape.setAttribute("fill-opacity",f)}};CLOUD.Extensions.Marker.shapeTypes={BUBBLE:0,FLAG:1,COMMON:2};CLOUD.Extensions.Marker.getDefaultStyle=function(){var n={};return n["stroke-width"]=2,n["stroke-color"]="#fffaff",n["stroke-opacity"]=1,n["fill-color"]="#ff2129",n["fill-opacity"]=1,n};CLOUD.Extensions.MarkerBubble=function(n,t){CLOUD.Extensions.Marker.call(this,n,t);this.shapeType=CLOUD.Extensions.Marker.shapeTypes.BUBBLE;this.createShape();this.addDomEventListeners()};CLOUD.Extensions.MarkerBubble.prototype=Object.create(CLOUD.Extensions.Marker.prototype);CLOUD.Extensions.MarkerBubble.prototype.constructor=CLOUD.Extensions.Marker;CLOUD.Extensions.MarkerBubble.prototype.createShape=function(){this.shape=CLOUD.Extensions.Utils.Shape2D.makeBubble()};CLOUD.Extensions.MarkerFlag=function(n,t){CLOUD.Extensions.Marker.call(this,n,t);this.shapeType=CLOUD.Extensions.Marker.shapeTypes.FLAG;this.createShape();this.addDomEventListeners()};CLOUD.Extensions.MarkerFlag.prototype=Object.create(CLOUD.Extensions.Marker.prototype);CLOUD.Extensions.MarkerFlag.prototype.constructor=CLOUD.Extensions.Marker;CLOUD.Extensions.MarkerFlag.prototype.createShape=function(){this.shape=CLOUD.Extensions.Utils.Shape2D.makeFlag()};CLOUD.Extensions.MarkerCommon=function(n,t,i){CLOUD.Extensions.Marker.call(this,n,t);this.shapeType=CLOUD.Extensions.Marker.shapeTypes.COMMON;this.createShape(i);this.addDomEventListeners()};CLOUD.Extensions.MarkerCommon.prototype=Object.create(CLOUD.Extensions.Marker.prototype);CLOUD.Extensions.MarkerCommon.prototype.constructor=CLOUD.Extensions.Marker;CLOUD.Extensions.MarkerCommon.prototype.createShape=function(n){this.shape=CLOUD.Extensions.Utils.Shape2D.makeCommon(n)};CLOUD.Extensions.MarkerEditor=function(n){"use strict";this.cameraEditor=n.cameraEditor;this.scene=n.getScene();this.domElement=n.domElement;this.markers=[];this.selectedMarker=null;this.flagColors={red:"#ff2129",green:"#85af03",yellow:"#fe9829"};this.bubbleColors={red:"#f92a24",green:"#86b507",gray:"#ff9326"};this.nextMarkerId=0;this.initialized=!1;this.markerClickCallback=null};CLOUD.Extensions.MarkerEditor.prototype.onResize=function(){if(this.svg){var n=this.getDomContainerBounds();this.svg.setAttribute("width",n.width+"");this.svg.setAttribute("height",n.height+"");this.updateMarkers()}};CLOUD.Extensions.MarkerEditor.prototype.init=function(){if(!this.svg){var n=this.getDomContainerBounds(),t=n.width,i=n.height;this.svg=CLOUD.Extensions.Utils.Shape2D.createSvgElement("svg");this.svg.style.position="absolute";this.svg.style.display="block";this.svg.style.position="absolute";this.svg.style.display="block";this.svg.style.left="0";this.svg.style.top="0";this.svg.setAttribute("width",t+"");this.svg.setAttribute("height",i+"");this.domElement.appendChild(this.svg);this.svgGroup=CLOUD.Extensions.Utils.Shape2D.createSvgElement("g");this.svg.insertBefore(this.svgGroup,this.svg.firstChild)}this.initialized=!0};CLOUD.Extensions.MarkerEditor.prototype.uninit=function(){(this.initialized=!1,this.svg)&&(this.unloadMarkers(),this.svgGroup&&this.svgGroup.parentNode&&this.svgGroup.parentNode.removeChild(this.svgGroup),this.svg.parentNode&&this.svg.parentNode.removeChild(this.svg),this.svgGroup=null,this.svg=null,this.markerClickCallback=null)};CLOUD.Extensions.MarkerEditor.prototype.isInitialized=function(){return this.initialized};CLOUD.Extensions.MarkerEditor.prototype.generateMarkerId=function(){++this.nextMarkerId;return this.nextMarkerId.toString(10)};CLOUD.Extensions.MarkerEditor.prototype.clear=function(){for(var t=this.markers,i,n;t.length;)i=t[0],this.deleteMarker(i);if(n=this.svgGroup,n&&n.childNodes.length>0)while(n.childNodes.length)n.removeChild(n.childNodes[0])};CLOUD.Extensions.MarkerEditor.prototype.addMarker=function(n){n.setParent(this.svgGroup);this.markers.push(n)};CLOUD.Extensions.MarkerEditor.prototype.deleteMarker=function(n){if(n){var t=this.markers.indexOf(n);t!==-1&&this.markers.splice(t,1);n.destroy()}};CLOUD.Extensions.MarkerEditor.prototype.selectMarker=function(n){this.selectedMarker!==n?(this.deselectMarker(),this.selectedMarker=n):this.deselectMarker();this.markerClickCallback&&(this.selectedMarker?this.markerClickCallback(this.selectedMarker.toNewObject()):this.markerClickCallback(null))};CLOUD.Extensions.MarkerEditor.prototype.deselectMarker=function(){this.selectedMarker&&(this.selectedMarker.deselect(),this.selectedMarker=null)};CLOUD.Extensions.MarkerEditor.prototype.getSceneMatrix=function(){return this.scene.getMatrixGlobal()};CLOUD.Extensions.MarkerEditor.prototype.getInverseSceneMatrix=function(){var t=this.getSceneMatrix(),n=new THREE.Matrix4;return n.getInverse(t),n};CLOUD.Extensions.MarkerEditor.prototype.worldToClient=function(n){var i=this.getDomContainerBounds(),r=this.cameraEditor.camera,u=this.getSceneMatrix(),t=new THREE.Vector3(n.x,n.y,n.z);return(t.applyMatrix4(u),t.project(r),Math.abs(t.z)>1)?null:(t.x=Math.round(.5*(t.x+1)*i.width),t.y=Math.round(-.5*(t.y-1)*i.height),t.z=0,t)};CLOUD.Extensions.MarkerEditor.prototype.clientToWorld=function(n){var i=this.getDomContainerBounds(),u=this.cameraEditor.camera,t=new THREE.Vector3,r;return t.x=n.x/i.width*2-1,t.y=-n.y/i.height*2+1,t.z=0,t.unproject(u),r=this.getInverseSceneMatrix(),t.applyMatrix4(r),t};CLOUD.Extensions.MarkerEditor.prototype.clientToViewport=function(n){var i=this.getDomContainerBounds(),t=new THREE.Vector3;return t.x=n.x/i.width*2-1,t.y=-n.y/i.height*2+1,t.z=0,t};CLOUD.Extensions.MarkerEditor.prototype.enableSVGPaint=function(n){n?this.svg&&this.svg.setAttribute("pointer-events","painted"):this.svg&&this.svg.setAttribute("pointer-events","none")};CLOUD.Extensions.MarkerEditor.prototype.getDomContainerBounds=function(){return CLOUD.DomUtil.getContainerOffsetToClient(this.domElement)};CLOUD.Extensions.MarkerEditor.prototype.getMarkerColor=function(n,t){var i=this.bubbleColors.red;n<0&&n>1&&(n=0);t>2&&(t-=3);t<0&&t>2&&(t=0);switch(t){case 0:i=n===0?this.bubbleColors.red:this.flagColors.red;break;case 1:i=n===0?this.bubbleColors.green:this.flagColors.green;break;case 2:i=n===0?this.bubbleColors.gray:this.flagColors.yellow}return i};CLOUD.Extensions.MarkerEditor.prototype.createMarkerByIntersect=function(n,t,i){var r=this.generateMarkerId(),u=n.userId,f=n.worldPosition||n.object.point,e=n.worldBoundingBox||n.object.boundingBox,o={id:r,userId:u,position:f,boundingBox:e,shapeType:t,state:i};this.createMarker(o)};CLOUD.Extensions.MarkerEditor.prototype.createMarker=function(n){var i,t,r;n&&(i=CLOUD.Extensions.Marker.getDefaultStyle(),i["fill-color"]=this.getMarkerColor(n.shapeType,n.state),t=n.id,r=CLOUD.Extensions.Marker.shapeTypes.BUBBLE===n.shapeType?new CLOUD.Extensions.MarkerBubble(t,this):CLOUD.Extensions.Marker.shapeTypes.FLAG===n.shapeType?new CLOUD.Extensions.MarkerFlag(t,this):new CLOUD.Extensions.MarkerCommon(t,this,n.state),r.set(n.userId,n.position,n.boundingBox,i),this.addMarker(r))};CLOUD.Extensions.MarkerEditor.prototype.getMarkersBoundingBox=function(){var t,n,i,r;if(this.markers.length<1)return null;for(t=new THREE.Box3,n=0,i=this.markers.length;n<i;n++)r=this.markers[n],t.union(r.getBoundingBox());return t};CLOUD.Extensions.MarkerEditor.prototype.getMarkerInfoList=function(){for(var i=[],t=0,r=this.markers.length;t<r;t++){var n=this.markers[t],u=n.userId+"_"+t,f={id:n.id||u,userId:n.userId,shapeType:n.shapeType,position:n.position,boundingBox:n.boundingBox,state:n.state};i.push(f)}return i};CLOUD.Extensions.MarkerEditor.prototype.loadMarkers=function(n){var r,u,f;for(this.clear(),r=0,u=n.length;r<u;r++){var t=n[r],e=t.userId+"_"+r,o=t.id||e,s=t.userId,h=t.shapeType,c=t.state,l=t.position,i=new THREE.Box3;i.max.x=t.boundingBox.max.x;i.max.y=t.boundingBox.max.y;i.max.z=t.boundingBox.max.z;i.min.x=t.boundingBox.min.x;i.min.y=t.boundingBox.min.y;i.min.z=t.boundingBox.min.z;f={id:o,userId:s,position:l,boundingBox:i,shapeType:h,state:c};this.createMarker(f)}};CLOUD.Extensions.MarkerEditor.prototype.loadMarkersFromIntersect=function(n,t,i){this.clear();this.createMarkerByIntersect(n,t,i)};CLOUD.Extensions.MarkerEditor.prototype.unloadMarkers=function(){this.clear()};CLOUD.Extensions.MarkerEditor.prototype.updateMarkers=function(){for(var i,n=0,t=this.markers.length;n<t;n++)i=this.markers[n],i.update()};CLOUD.Extensions.MarkerEditor.prototype.getMarker=function(n){for(var i=this.markers,r=i.length,t=0;t<r;++t)if(i[t].id==n)return i[t];return null};CLOUD.Extensions.MarkerEditor.prototype.setMarkerClickCallback=function(n){this.markerClickCallback=n};CLOUD.Extensions.MiniMapHelper=function(n){this.viewer=n;this.miniMaps={};this.defaultMiniMap=null};CLOUD.Extensions.MiniMapHelper.prototype={constructor:CLOUD.Extensions.MiniMapHelper,destroy:function(){this.destroyAllMiniMap();this.viewer=null;this.miniMaps={};this.defaultMiniMap=null},createMiniMap:function(n,t,i,r,u,f,e){var o=this.miniMaps[n];o||(o=this.miniMaps[n]=new CLOUD.MiniMap(this.viewer),o.setCameraChangedCallback(f),o.setClickOnAxisGridCallback(e));t=t||this.viewer.domElement;t&&o.init(t,i,r,u);this.defaultMiniMap||(this.defaultMiniMap=this.miniMaps[n])},destroyMiniMap:function(n){var t=this.miniMaps[n];t&&(t.uninit(),this.defaultMiniMap===t&&(this.defaultMiniMap=null),delete this.miniMaps[n])},destroyAllMiniMap:function(){for(var n in this.miniMaps)this.destroyMiniMap(n)},removeMiniMap:function(n){var t=this.miniMaps[n];t&&t.remove()},appendMiniMap:function(n){var t=this.miniMaps[n];t&&t.append()},getMiniMaps:function(){return this.miniMaps},getMiniMap:function(n){return this.miniMaps[n]},renderMiniMap:function(){var t,n;for(t in this.miniMaps)n=this.miniMaps[t],n&&n.render()},setFloorPlaneData:function(n){CLOUD.MiniMap.setFloorPlaneData(n)},generateFloorPlane:function(n,t){var i=this.miniMaps[n];i&&i.generateFloorPlane(t)},setAxisGridData:function(n){CLOUD.MiniMap.setAxisGridData(n)},generateAxisGrid:function(n){var t=this.miniMaps[n];t&&t.generateAxisGrid()},showAxisGrid:function(n,t){var i=this.miniMaps[n];i&&(t?i.showAxisGird():i.hideAxisGird())},enableAxisGridEvent:function(n,t){var i=this.miniMaps[n];i&&i.enableMouseEvent(t)},enableMiniMapCameraNode:function(n,t){var i=this.miniMaps[n];i&&i.enableCameraNode(t)},flyBypAxisGridNumber:function(n,t,i){var r=this.miniMaps[n];r&&r.flyByAxisGridNumber(t,i)},getAxisGridInfoByPoint:function(n){var t=this.defaultMiniMap,i=null;return t&&(i=t.getAxisGridInfoByPoint(n)),i},getAxisGridInfoByIntersect:function(n){var t=this.defaultMiniMap;t&&(n.axisGridInfo=t.getAxisGridInfoByPoint(n.point))}};CLOUD.Extensions.MarkerHelper=function(n){this.viewer=n;this.markerClickCallback=null};CLOUD.Extensions.MarkerHelper.prototype={constructor:CLOUD.Extensions.MarkerHelper,destroy:function(){this.uninitMarkerEditor();this.markerEditor=null;this.markerClickCallback=null;this.viewer=null},initMarkerEditor:function(){var n=this.viewer;this.markerEditor||(this.markerEditor=new CLOUD.Extensions.MarkerEditor(n));this.markerEditor.isInitialized()||this.markerEditor.init();this.markerClickCallback&&this.markerEditor.setMarkerClickCallback(this.markerClickCallback)},uninitMarkerEditor:function(){this.markerEditor&&this.markerEditor.isInitialized()&&this.markerEditor.uninit()},zoomToSelectedMarkers:function(){if(this.markerEditor){var n=this.markerEditor.getMarkersBoundingBox();n&&this.viewer.zoomToBBox(n,.05);this.markerEditor.updateMarkers()}},loadMarkers:function(n){n?(this.initMarkerEditor(),this.markerEditor.loadMarkers(n)):this.uninitMarkerEditor()},loadMarkersFromIntersect:function(n,t,i){n?(this.initMarkerEditor(),this.markerEditor.loadMarkersFromIntersect(n,t,i)):this.uninitMarkerEditor()},getMarkerInfoList:function(){return this.markerEditor?this.markerEditor.getMarkerInfoList():null},resizeMarkers:function(){if(this.markerEditor)return this.markerEditor.onResize()},renderMarkers:function(){if(this.markerEditor)return this.markerEditor.updateMarkers()},getMarkersBoundingBox:function(){if(this.markerEditor)return this.markerEditor.getMarkersBoundingBox()},selectMarkerById:function(n){if(this.markerEditor){var t=this.markerEditor.getMarker(n);t.highlight(!0);this.markerEditor.selectMarker(t)}},setMarkerClickCallback:function(n){this.markerClickCallback=n}};CLOUD.Extensions.DwgHelper=function(){this.dwgContainer=null;this.annotationContainer=null;this.defaultStyle={"stroke-width":3,"stroke-color":"#ff0000","stroke-opacity":1,"fill-color":"#ff0000","fill-opacity":0,"font-family":"Arial","font-size":16,"font-style":"","font-weight":""};this.isDblClickCloseCloud=!0};CLOUD.Extensions.DwgHelper.prototype={constructor:CLOUD.Extensions.DwgHelper,destroy:function(){this.uninitAnnotation();this.editor=null;this.dwgContainer=null;this.annotationContainer=null},setDomContainer:function(n,t){this.dwgContainer=n;this.annotationContainer=t?t:n},initAnnotation:function(n,t){var u=this,r=this.annotationContainer,i;this.editor?this.editor.setDomContainer(r):this.editor=new CLOUD.Extensions.AnnotationEditor2D(r);this.editor.enableDblClickCloseCloud(this.isDblClickCloseCloud);this.editor.isInitialized()||(i={beginEditCallback:n,endEditCallback:t,changeEditorModeCallback:function(){u.uninitAnnotation()}},this.editor.init(i),this.editor.setSvgZIndex(),i=null)},uninitAnnotation:function(){this.editor&&this.editor.isInitialized()&&this.editor.uninit()},setAnnotationBackgroundColor:function(n,t){this.editor&&this.editor.setBackgroundColor(n,t)},editAnnotationBegin:function(n,t,i){this.initAnnotation(t,i);n&&this.editor.setAbsoluteBasePoint(n);this.editor.editBegin()},editAnnotationEnd:function(){this.editor&&this.editor.editEnd()},setAnnotationType:function(n){this.editor&&this.editor.setAnnotationType(n)},setAnnotationStyle:function(n,t){if(this.editor){for(var i in n)i in this.defaultStyle&&(this.defaultStyle[i]=n[i]);this.editor.setAnnotationStyle(this.defaultStyle,t)}},loadAnnotations:function(n,t,i,r){n?(this.initAnnotation(i,r),t&&this.editor.setAbsoluteBasePoint(t),this.editor.loadAnnotations(n)):this.uninitAnnotation()},getAnnotationInfoList:function(){return this.editor?this.editor.getAnnotationInfoList():null},resizeAnnotations:function(){this.editor&&this.editor.isInitialized()&&this.editor.onResize()},clearAnnotations:function(){this.editor&&this.editor.isInitialized()&&this.editor.onCameraChange()},enableDblClickCloseCloud:function(n){this.isDblClickCloseCloud=n},captureAnnotationsScreenSnapshot:function(n){var i=this,r=this.editor&&this.editor.isInitialized(),t=this.dwgContainer;if(!t||!r){n(null);return}html2canvas(t,{logging:!0,onrendered:function(t){var r=t.toDataURL("image/png");i.editor.getScreenSnapshot(r,n)}})},canvas2image:function(n){this.captureAnnotationsScreenSnapshot(n)},setAbsoluteBasePoint:function(n){this.initAnnotation();n&&this.editor.setAbsoluteBasePoint(n)},setScreenBasePoint:function(n){this.initAnnotation();n&&this.editor.setScreenBasePoint(n)},setZoomFactor:function(n,t){t=t||n;this.initAnnotation();this.editor.setZoomFactor(n,t)}};CLOUD.Extensions.AnnotationHelper2D=function(){this.domContainer=null;this.defaultStyle={"stroke-width":3,"stroke-color":"#ff0000","stroke-opacity":1,"fill-color":"#ff0000","fill-opacity":0,"font-family":"Arial","font-size":16,"font-style":"","font-weight":""};this.isDblClickCloseCloud=!1};CLOUD.Extensions.AnnotationHelper2D.prototype={constructor:CLOUD.Extensions.AnnotationHelper2D,destroy:function(){this.uninitAnnotation();this.editor=null;this.domContainer=null;this.beginEditCallback=null;this.endEditCallback=null;this.stateChangeCallback=null;this.defaultStyle=null},setDomContainer:function(n){this.domContainer=n},setEditCallback:function(n,t,i){this.beginEditCallback=n;this.endEditCallback=t;this.stateChangeCallback=i},initAnnotation:function(){var n=this,i=this.domContainer,t;this.editor?this.editor.setDomContainer(i):this.editor=new CLOUD.Extensions.AnnotationEditor2D(i);this.editor.enableDblClickCloseCloud(this.isDblClickCloseCloud);this.editor.isInitialized()||(t={beginEditCallback:n.beginEditCallback,endEditCallback:n.endEditCallback,changeEditorModeCallback:n.stateChangeCallback},this.editor.init(t),t=null)},uninitAnnotation:function(){this.editor&&this.editor.isInitialized()&&this.editor.uninit()},setAnnotationBackgroundColor:function(n,t){this.initAnnotation();this.editor.setBackgroundColor(n,t)},editAnnotationBegin:function(n,t,i){this.initAnnotation();n&&this.editor.setAbsoluteBasePoint(n);t&&this.editor.setScreenBasePoint(t);i&&this.editor.setZoomFactor(i.x,i.y);this.editor.editBegin()},editAnnotationEnd:function(){this.editor&&this.editor.editEnd()},setAnnotationType:function(n){this.initAnnotation();this.editor.setAnnotationType(n)},setAnnotationStyle:function(n,t){this.initAnnotation();for(var i in n)i in this.defaultStyle&&(this.defaultStyle[i]=n[i]);this.editor.setAnnotationStyle(this.defaultStyle,t)},loadAnnotations:function(n,t,i,r){n?(this.initAnnotation(),t&&this.editor.setAbsoluteBasePoint(t),i&&this.editor.setScreenBasePoint(i),r&&this.editor.setZoomFactor(r.x,r.y),this.editor.loadAnnotations(n)):this.uninitAnnotation()},getAnnotationInfoList:function(){return this.editor?this.editor.getAnnotationInfoList():null},getAnnotationInfoListWithBox:function(){var i,n,u,h,e,a,v;if(this.editor){if(i=this.editor.getAnnotationInfoList(),i.length===0)return null;for(n=new THREE.Box2,u=0,h=i.length;u<h;u++){var f=i[u],y=f.shapeType,t=f.position,r=f.size,c=f.rotation||0;if(y===CLOUD.Extensions.Annotation.shapeTypes.ARROW){e=new THREE.Vector2(Math.cos(c),Math.sin(c));e.multiplyScalar(r.width*.5);var l=new THREE.Vector2(t.x,t.y),o=l.clone().sub(e),s=l.clone().add(e);o.y=-o.y;s.y=-s.y;n.expandByPoint(o);n.expandByPoint(s)}else a=new THREE.Vector2(t.x-.5*r.width,-t.y-.5*r.height),v=new THREE.Vector2(t.x+.5*r.width,-t.y+.5*r.height),n.expandByPoint(a),n.expandByPoint(v)}return{boundingBox:n,annotations:i}}return null},resizeAnnotations:function(){this.editor&&this.editor.isInitialized()&&this.editor.onResize()},renderAnnotations:function(){this.editor&&this.editor.isInitialized()&&this.editor.onCameraChange()},enableDblClickCloseCloud:function(n){this.isDblClickCloseCloud=n},captureAnnotationsScreenSnapshot:function(n,t){return this.editor.getScreenSnapshot(n,t)},setAbsoluteBasePoint:function(n){this.initAnnotation();n&&this.editor.setAbsoluteBasePoint(n)},setScreenBasePoint:function(n){this.initAnnotation();n&&this.editor.setScreenBasePoint(n)},setZoomFactor:function(n,t){t=t||n;this.initAnnotation();this.editor.setZoomFactor(n,t)}};CLOUD.Extensions.AnnotationHelper3D=function(n){this.viewer=n;this.defaultStyle={"stroke-width":3,"stroke-color":"#ff0000","stroke-opacity":1,"fill-color":"#ff0000","fill-opacity":0,"font-family":"Arial","font-size":16,"font-style":"","font-weight":""};this.isDblClickCloseCloud=!0;this.resizeBind=this.resizeAnnotations.bind(this);this.renderBind=this.renderAnnotations.bind(this)};CLOUD.Extensions.AnnotationHelper3D.prototype={constructor:CLOUD.Extensions.AnnotationHelper3D,destroy:function(){this.uninitAnnotation();this.editor=null;this.viewer=null;this.resizeBind=null;this.renderBind=null},hasAnnotations:function(){return this.editor&&this.editor.isInitialized()},initAnnotation:function(){var n=this.viewer,i=this,t;this.editor||(this.editor=new CLOUD.Extensions.AnnotationEditor3D(n.domElement,n.camera));this.editor.enableDblClickCloseCloud(this.isDblClickCloseCloud);this.editor.isInitialized()||(t={beginEditCallback:function(t){n.editorManager.unregisterDomEventListeners(t)},endEditCallback:function(t){n.editorManager.registerDomEventListeners(t)},changeEditorModeCallback:function(){i.uninitAnnotation()}},this.viewer.addCallbacks("resize",this.resizeBind),this.viewer.addCallbacks("render",this.renderBind),this.editor.init(t),t=null)},uninitAnnotation:function(){this.editor&&this.editor.isInitialized()&&(this.viewer.removeCallbacks("resize",this.resizeBind),this.viewer.removeCallbacks("render",this.renderBind),this.editor.uninit())},setAnnotationBackgroundColor:function(n,t){this.editor&&this.editor.setBackgroundColor(n,t)},editAnnotationBegin:function(){this.initAnnotation();this.editor.editBegin()},editAnnotationEnd:function(){this.editor&&this.editor.editEnd()},setAnnotationType:function(n){this.editor&&this.editor.setAnnotationType(n)},setAnnotationStyle:function(n,t){if(this.editor){for(var i in n)i in this.defaultStyle&&(this.defaultStyle[i]=n[i]);this.editor.setAnnotationStyle(this.defaultStyle,t)}},loadAnnotations:function(n){n?(this.initAnnotation(),this.editor.loadAnnotations(n)):this.uninitAnnotation()},getAnnotationInfoList:function(){return this.editor?this.editor.getAnnotationInfoList():null},resizeAnnotations:function(){this.editor&&this.editor.isInitialized()&&this.editor.onResize()},renderAnnotations:function(){this.editor&&this.editor.isInitialized()&&this.editor.onCameraChange()},enableDblClickCloseCloud:function(n){this.isDblClickCloseCloud=n},captureAnnotationsScreenSnapshot:function(n,t){var i,r;return t?(i=this,this.viewer.getRenderBufferScreenShot(n,function(n){i.editor.getScreenSnapshot(n,t)}),null):(r=this.viewer.getRenderBufferScreenShot(n),this.editor.getScreenSnapshot(r))}};